-- liquibase formatted sql

-- changeset root:1753259446745-1
CREATE TABLE PRF_RUOLO_CATEGORIA (ID_RUOLO_CATEGORIA NUMBER NOT NULL, ID_RUOLO NUMBER NOT NULL, TI_CATEG_RUOLO VARCHAR2(20 BYTE) NOT NULL, CONSTRAINT PK_PRF_RUOLO_CATEG PRIMARY KEY (ID_RUOLO_CATEGORIA));

-- changeset root:1753259446745-2
CREATE TABLE ORG_AMBITO_TERRIT (ID_AMBITO_TERRIT NUMBER NOT NULL, CD_AMBITO_TERRIT VARCHAR2(100 BYTE), TI_AMBITO_TERRIT VARCHAR2(20 BYTE) NOT NULL, ID_AMBITO_TERRIT_PADRE NUMBER, CONSTRAINT PK_AMB_TRT PRIMARY KEY (ID_AMBITO_TERRIT));

-- changeset root:1753259446745-3
CREATE TABLE ORG_TARIFFA_AA_ACCORDO (ID_TARIFFA_AA_ACCORDO NUMBER NOT NULL, ID_AA_ACCORDO NUMBER NOT NULL, ID_TIPO_SERVIZIO NUMBER NOT NULL, IM_TARIFFA_AA_ACCORDO NUMBER(14, 6) NOT NULL, CONSTRAINT PK_ORG_TARIF_AA_ACC PRIMARY KEY (ID_TARIFFA_AA_ACCORDO));

-- changeset root:1753259446745-4
CREATE TABLE ORG_AA_ACCORDO (ID_AA_ACCORDO NUMBER NOT NULL, ID_ACCORDO_ENTE NUMBER NOT NULL, AA_ANNO_ACCORDO NUMBER(4, 0) NOT NULL, MM_AA_ACCORDO NUMBER(2, 0) NOT NULL, CD_CIG_AA_ACCORDO VARCHAR2(100 BYTE), CD_CUP_AA_ACCORDO VARCHAR2(100 BYTE), CD_ODA_AA_ACCORDO VARCHAR2(100 BYTE), DS_NOTA_AA_ACCORDO VARCHAR2(250 BYTE), IM_CANONE_AA_ACCORDO NUMBER(14, 6), DS_ATTO_AA_ACCORDO VARCHAR2(250 BYTE), CD_CAPITOLO_AA_ACCORDO VARCHAR2(100 BYTE), DS_IMPEGNO_AA_ACCORDO VARCHAR2(250 BYTE), CONSTRAINT PK_ORG_AA_ACCORDO PRIMARY KEY (ID_AA_ACCORDO));

-- changeset root:1753259446745-5
CREATE TABLE ORG_TARIFFA_ACCORDO (ID_TARIFFA_ACCORDO NUMBER NOT NULL, ID_ACCORDO_ENTE NUMBER NOT NULL, ID_TIPO_SERVIZIO NUMBER NOT NULL, IM_TARIFFA_ACCORDO NUMBER(14, 6) NOT NULL, CONSTRAINT PK_TARIFFA_ACCOR PRIMARY KEY (ID_TARIFFA_ACCORDO));

-- changeset root:1753259446745-6
CREATE SEQUENCE SLOG_JOB START WITH 940167 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-7
CREATE SEQUENCE SLOG_USER_DA_REPLIC START WITH 204288 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-8
CREATE SEQUENCE SUSR_OLD_PSW START WITH 3529 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-9
CREATE TABLE ORG_AMBIENTE_ENTE_CONVENZ (ID_AMBIENTE_ENTE_CONVENZ NUMBER NOT NULL, NM_AMBIENTE_ENTE_CONVENZ VARCHAR2(100 BYTE) NOT NULL, DS_AMBIENTE_ENTE_CONVENZ VARCHAR2(254 BYTE) NOT NULL, DT_INI_VAL date DEFAULT to_date('01/01/2019', 'dd/mm/yyyy') NOT NULL, DT_FINE_VAL date DEFAULT to_date('31/12/2444', 'dd/mm/yyyy') NOT NULL, ID_ENTE_CONSERV NUMBER, ID_ENTE_GESTORE NUMBER, DS_NOTE VARCHAR2(254 CHAR), CONSTRAINT PK_AMB_ENTE_CONVENZ PRIMARY KEY (ID_AMBIENTE_ENTE_CONVENZ));

-- changeset root:1753259446745-10
CREATE TABLE USR_DICH_ABIL_ENTE_CONVENZ (ID_DICH_ABIL_ENTE_CONVENZ NUMBER NOT NULL, ID_USER_IAM NUMBER NOT NULL, TI_SCOPO_DICH_ABIL_ENTE VARCHAR2(20 BYTE) NOT NULL, ID_AMBIENTE_ENTE_CONVENZ NUMBER, ID_ENTE_CONVENZ NUMBER, ID_APPART_COLLEG_ENTI NUMBER, DS_CAUSALE_DICH VARCHAR2(254 BYTE), CONSTRAINT PK_DICH_ABIL_ENTE PRIMARY KEY (ID_DICH_ABIL_ENTE_CONVENZ));

-- changeset root:1753259446745-11
CREATE TABLE ORG_SUPT_ESTERNO_ENTE_CONVENZ (ID_SUPT_EST_ENTE_CONVENZ NUMBER NOT NULL, ID_ENTE_FORNIT_EST NUMBER NOT NULL, ID_ENTE_PRODUT NUMBER NOT NULL, DT_INI_VAL date NOT NULL, DT_FIN_VAL date NOT NULL, CONSTRAINT PK_SUPT_EST_ENTE_CONV PRIMARY KEY (ID_SUPT_EST_ENTE_CONVENZ));

-- changeset root:1753259446745-12
CREATE TABLE USR_ABIL_ENTE_SIAM (ID_ABIL_ENTE_SIAM NUMBER NOT NULL, ID_USER_IAM NUMBER NOT NULL, ID_ENTE_SIAM NUMBER NOT NULL, ID_DICH_ABIL_ENTE_CONVENZ NUMBER, ID_APPART_COLLEG_ENTI NUMBER, ID_SUPT_EST_ENTE_CONVENZ NUMBER, ID_ACCORDO_VIGIL NUMBER, FL_ABIL_AUTOMATICA CHAR(1 BYTE) DEFAULT '0' NOT NULL, DS_CAUSALE_ABIL VARCHAR2(254 BYTE), CONSTRAINT PK_ABIL_ENTE PRIMARY KEY (ID_ABIL_ENTE_SIAM));

-- changeset root:1753259446745-13
CREATE TABLE ORG_ACCORDO_VIGIL (ID_ACCORDO_VIGIL NUMBER NOT NULL, ID_ENTE_ORGANO_VIGIL NUMBER NOT NULL, ID_ENTE_CONSERV NUMBER NOT NULL, DT_INI_VAL date NOT NULL, DT_FIN_VAL date NOT NULL, DS_NOTE_ENTE_ACCORDO VARCHAR2(254 BYTE), CD_REGISTRO_REPERTORIO VARCHAR2(100 BYTE), AA_REPERTORIO NUMBER(4, 0), CD_KEY_REPERTORIO VARCHAR2(100 BYTE), DS_FIRMATARIO_ENTE VARCHAR2(254 BYTE), DT_REG_ACCORDO date, NM_ENTE VARCHAR2(100 BYTE), NM_STRUT VARCHAR2(100 BYTE), CONSTRAINT PK_ACC_VIG PRIMARY KEY (ID_ACCORDO_VIGIL));

-- changeset root:1753259446745-14
CREATE TABLE ORG_VIGIL_ENTE_PRODUT (ID_VIGIL_ENTE_PRODUT NUMBER NOT NULL, ID_ACCORDO_VIGIL NUMBER NOT NULL, ID_ENTE_PRODUT NUMBER NOT NULL, DT_INI_VAL date NOT NULL, DT_FIN_VAL date NOT NULL, CONSTRAINT PK_VIG_ENTE_PRODUT PRIMARY KEY (ID_VIGIL_ENTE_PRODUT));

-- changeset root:1753259446745-15
CREATE TABLE ORG_APPART_COLLEG_ENTI (ID_APPART_COLLEG_ENTI NUMBER NOT NULL, ID_COLLEG_ENTI_CONVENZ NUMBER NOT NULL, ID_ENTE_CONVENZ NUMBER NOT NULL, DT_INI_VAL date NOT NULL, DT_FIN_VAL date NOT NULL, CONSTRAINT PK_APP_COLLEG_ENTI PRIMARY KEY (ID_APPART_COLLEG_ENTI));

-- changeset root:1753259446745-16
CREATE TABLE ORG_COLLEG_ENTI_CONVENZ (ID_COLLEG_ENTI_CONVENZ NUMBER NOT NULL, NM_COLLEG VARCHAR2(100 BYTE) NOT NULL, DS_COLLEG VARCHAR2(254 BYTE) NOT NULL, TI_COLLEG VARCHAR2(20 BYTE) NOT NULL, ID_ENTE_CONVENZ_CAPOFILA NUMBER, DT_INI_VAL date NOT NULL, DT_FIN_VAL date NOT NULL, CONSTRAINT PK_COLLEG_ENTI_CONV PRIMARY KEY (ID_COLLEG_ENTI_CONVENZ));

-- changeset root:1753259446745-17
CREATE TABLE ORG_CD_IVA (ID_CD_IVA NUMBER NOT NULL, CD_IVA VARCHAR2(100 BYTE) NOT NULL, DS_IVA VARCHAR2(254 BYTE) NOT NULL, CONSTRAINT PK_CD_IVA PRIMARY KEY (ID_CD_IVA));

-- changeset root:1753259446745-18
CREATE TABLE ORG_ENTE_ARK_RIF (ID_ENTE_ARK_RIF NUMBER NOT NULL, ID_ENTE_CONVENZ NUMBER NOT NULL, ID_USER_IAM NUMBER NOT NULL, DL_NOTE VARCHAR2(254 BYTE), FL_REFERENTE CHAR(1 BYTE) DEFAULT 0 NOT NULL, CONSTRAINT PK_ENTE_ARK_RIF PRIMARY KEY (ID_ENTE_ARK_RIF));

-- changeset root:1753259446745-19
CREATE TABLE APL_SISTEMA_VERS_ARK_RIF (ID_SISTEMA_VERS_ARK_RIF NUMBER NOT NULL, ID_SISTEMA_VERSANTE NUMBER NOT NULL, ID_USER_IAM NUMBER NOT NULL, CONSTRAINT PK_SIST_VERS_ARK_RIF PRIMARY KEY (ID_SISTEMA_VERS_ARK_RIF));

-- changeset root:1753259446745-20
CREATE TABLE ORG_PAGAM_FATTURA_ENTE (ID_PAGAM_FATTURA_ENTE NUMBER NOT NULL, ID_FATTURA_ENTE NUMBER NOT NULL, PG_PAGAM NUMBER NOT NULL, CD_PROVV_PAGAM VARCHAR2(100 BYTE), CD_REV_PAGAM VARCHAR2(100 BYTE), DT_PAGAM date NOT NULL, IM_PAGAM NUMBER(10, 2) NOT NULL, NT_PAGAM VARCHAR2(1024 BYTE), CONSTRAINT PK_PAG_FATT_ENTE PRIMARY KEY (ID_PAGAM_FATTURA_ENTE));

-- changeset root:1753259446745-21
CREATE TABLE ORG_STATO_FATTURA_ENTE (ID_STATO_FATTURA_ENTE NUMBER NOT NULL, ID_FATTURA_ENTE NUMBER NOT NULL, DT_REG_STATO_FATTURA_ENTE date, TI_STATO_FATTURA_ENTE VARCHAR2(30 BYTE) NOT NULL, CONSTRAINT PK_STATO_FATT_ENTE PRIMARY KEY (ID_STATO_FATTURA_ENTE));

-- changeset root:1753259446745-22
CREATE TABLE ORG_AA_FATTURA (ID_AA_FATTURA NUMBER NOT NULL, AA_FATTURA NUMBER(4, 0) NOT NULL, CONSTRAINT PK_AA_FATT PRIMARY KEY (ID_AA_FATTURA));

-- changeset root:1753259446745-23
CREATE TABLE ORG_TIPI_GESTIONE_ACCORDO (ID_TIPO_GESTIONE_ACCORDO NUMBER NOT NULL, CD_TIPO_GESTIONE_ACCORDO VARCHAR2(256 BYTE) NOT NULL, CONSTRAINT PK_ORG_TIPI_GESTIONE_ACCORDO PRIMARY KEY (ID_TIPO_GESTIONE_ACCORDO));

-- changeset root:1753259446745-24
CREATE TABLE USR_ABIL_DATI (ID_ABIL_DATI NUMBER NOT NULL, ID_USO_USER_APPLIC NUMBER NOT NULL, ID_TIPO_DATO_IAM NUMBER NOT NULL, ID_DICH_ABIL_DATI NUMBER, ID_APPART_COLLEG_ENTI NUMBER, ID_SUPT_EST_ENTE_CONVENZ NUMBER, ID_VIGIL_ENTE_PRODUT NUMBER, FL_ABIL_AUTOMATICA CHAR(1 BYTE) DEFAULT '0' NOT NULL, DS_CAUSALE_ABIL VARCHAR2(254 BYTE), CONSTRAINT PK_ABIL_DATI PRIMARY KEY (ID_ABIL_DATI));

-- changeset root:1753259446745-25
CREATE TABLE IAM_PARAM_APPLIC (ID_PARAM_APPLIC NUMBER NOT NULL, NM_PARAM_APPLIC VARCHAR2(100 BYTE) NOT NULL, DS_PARAM_APPLIC VARCHAR2(254 BYTE) NOT NULL, TI_PARAM_APPLIC VARCHAR2(40 BYTE) NOT NULL, TI_GESTIONE_PARAM VARCHAR2(30 BYTE) DEFAULT 'amministrazione' NOT NULL, FL_APPART_APPLIC CHAR(1 BYTE) DEFAULT '0' NOT NULL, FL_APPART_AMBIENTE CHAR(1 BYTE) DEFAULT '0' NOT NULL, FL_APPARTE_ENTE CHAR(1 BYTE) DEFAULT '0' NOT NULL, DS_LISTA_VALORI_AMMESSI VARCHAR2(4000 BYTE), TI_VALORE_PARAM_APPLIC VARCHAR2(100 BYTE) DEFAULT 'STRINGA' NOT NULL, CD_VERSIONE_APP_INI VARCHAR2(11 BYTE) DEFAULT '1.0.0' NOT NULL, CD_VERSIONE_APP_FINE VARCHAR2(11 BYTE), CONSTRAINT PK_PAR_APL PRIMARY KEY (ID_PARAM_APPLIC));

-- changeset root:1753259446745-26
CREATE TABLE USR_ABIL_ORGANIZ (ID_ABIL_ORGANIZ NUMBER NOT NULL, ID_USO_USER_APPLIC NUMBER NOT NULL, ID_ORGANIZ_IAM NUMBER NOT NULL, ID_DICH_ABIL_ORGANIZ NUMBER, ID_APPART_COLLEG_ENTI NUMBER, ID_SUPT_EST_ENTE_CONVENZ NUMBER, ID_VIGIL_ENTE_PRODUT NUMBER, FL_ABIL_AUTOMATICA CHAR(1 BYTE) DEFAULT '0' NOT NULL, DS_CAUSALE_ABIL VARCHAR2(254 BYTE), CONSTRAINT PK_ABIL_ORG PRIMARY KEY (ID_ABIL_ORGANIZ));

-- changeset root:1753259446745-27
CREATE TABLE ORG_ENTE_CONVENZ_ORG (ID_ENTE_CONVENZ_ORG NUMBER NOT NULL, ID_ENTE_CONVENZ NUMBER NOT NULL, ID_ORGANIZ_IAM NUMBER NOT NULL, DT_INI_VAL date NOT NULL, DT_FINE_VAL date NOT NULL, CONSTRAINT PK_STRUT_ENTE_CONVENZ PRIMARY KEY (ID_ENTE_CONVENZ_ORG));

-- changeset root:1753259446745-28
CREATE TABLE ORG_TARIFFA (ID_TARIFFA NUMBER NOT NULL, ID_TARIFFARIO NUMBER NOT NULL, NM_TARIFFA VARCHAR2(100 BYTE) NOT NULL, DS_TARIFFA VARCHAR2(254 BYTE) NOT NULL, ID_TIPO_SERVIZIO NUMBER NOT NULL, ID_CLASSE_ENTE_CONVENZ NUMBER, TIPO_TARIFFA VARCHAR2(40 BYTE) NOT NULL, NI_QUANTITA_UNIT NUMBER, IM_VALORE_FISSO_TARIFFA NUMBER(12, 6), CONSTRAINT PK_TARIFFA PRIMARY KEY (ID_TARIFFA));

-- changeset root:1753259446745-29
CREATE TABLE ORG_TARIFFARIO (ID_TARIFFARIO NUMBER NOT NULL, ID_TIPO_ACCORDO NUMBER NOT NULL, DT_INI_VAL date NOT NULL, DT_FINE_VAL date NOT NULL, NM_TARIFFARIO VARCHAR2(100 BYTE) DEFAULT '--' NOT NULL, CONSTRAINT PK_TARIF PRIMARY KEY (ID_TARIFFARIO));

-- changeset root:1753259446745-30
CREATE TABLE ORG_TIPO_ACCORDO (ID_TIPO_ACCORDO NUMBER NOT NULL, CD_TIPO_ACCORDO VARCHAR2(100 BYTE) NOT NULL, DS_TIPO_ACCORDO VARCHAR2(254 BYTE) NOT NULL, FL_PAGAMENTO CHAR(1 BYTE) NOT NULL, DT_ISTITUZ date NOT NULL, DT_SOPPRES date NOT NULL, CD_ALGO_TARIFFARIO VARCHAR2(40 BYTE) DEFAULT ('NO_CLASSE_ENTE') NOT NULL, CONSTRAINT PK_TI_ACCOR PRIMARY KEY (ID_TIPO_ACCORDO));

-- changeset root:1753259446745-31
CREATE TABLE ORG_TIPO_SERVIZIO (ID_TIPO_SERVIZIO NUMBER NOT NULL, CD_TIPO_SERVIZIO VARCHAR2(100 BYTE) NOT NULL, DS_TIPO_SERVIZIO VARCHAR2(254 BYTE) NOT NULL, TI_CLASSE_TIPO_SERVIZIO VARCHAR2(30 BYTE) NOT NULL, TIPO_FATTURAZIONE VARCHAR2(30 BYTE) NOT NULL, GG_FATTURAZIONE CHAR(5 BYTE), TI_DOC_TIPO_SERVIZIO VARCHAR2(30 BYTE), FL_TARIFFA_ACCORDO CHAR(1 BYTE) DEFAULT '0' NOT NULL, FL_TARIFFA_ANNUALITA CHAR(1 BYTE) DEFAULT '0' NOT NULL, CONSTRAINT PK_TI_SERV PRIMARY KEY (ID_TIPO_SERVIZIO));

-- changeset root:1753259446745-32
CREATE TABLE ORG_ENTE_SIAM (ID_ENTE_SIAM NUMBER NOT NULL, NM_ENTE_SIAM VARCHAR2(254 BYTE) NOT NULL, DT_INI_VAL date NOT NULL, CD_FISC VARCHAR2(11 BYTE), CD_ENTE_CONVENZ VARCHAR2(100 BYTE), DS_VIA_SEDE_LEGALE VARCHAR2(254 BYTE), DS_CITTA_SEDE_LEGALE VARCHAR2(254 BYTE), ID_AMBITO_TERRIT NUMBER, ID_CATEG_ENTE NUMBER, DT_CESSAZIONE date, ID_ENTE_CONVENZ_NUOVO NUMBER, ID_PROV_SEDE_LEGALE NUMBER, CD_NAZIONE_SEDE_LEGALE VARCHAR2(254 BYTE) DEFAULT 'IT' NOT NULL, TI_CD_ENTE_CONVENZ VARCHAR2(20 BYTE), CD_CAP_SEDE_LEGALE VARCHAR2(5 BYTE), ID_AMBIENTE_ENTE_CONVENZ NUMBER, TI_ENTE CHAR(18 BYTE) DEFAULT 'CONVENZIONATO' NOT NULL, TI_ENTE_CONVENZ VARCHAR2(20 BYTE) DEFAULT 'PRODUTTORE', TI_ENTE_NON_CONVENZ VARCHAR2(20 BYTE), ID_ENTE_CONVENZ_CREAZIONE NUMBER, ID_ENTE_PRODUT_CORRISP NUMBER, DS_NOTE VARCHAR2(254 CHAR), DT_RICH_MODULO_INFO date, CD_UFE VARCHAR2(100 BYTE), DS_UFE VARCHAR2(254 BYTE), ID_CD_IVA NUMBER, TI_MOD_PAGAM VARCHAR2(100 BYTE), DT_INI_VAL_APPART_AMBIENTE date, DT_FIN_VAL_APPART_AMBIENTE date, CONSTRAINT PK_ENTE_SIAM PRIMARY KEY (ID_ENTE_SIAM));

-- changeset root:1753259446745-33
CREATE TABLE ORG_FATTURA_ENTE (ID_FATTURA_ENTE NUMBER NOT NULL, ID_ENTE_CONVENZ NUMBER NOT NULL, AA_FATTURA NUMBER(4, 0) NOT NULL, PG_FATTURA NUMBER NOT NULL, IM_TOT_FATTURA NUMBER(10, 2) NOT NULL, CD_REGISTRO_EMIS_FATTURA VARCHAR2(100 BYTE), AA_EMISS_FATTURA NUMBER(4, 0), CD_EMIS_FATTURA VARCHAR2(100 BYTE), ID_STATO_FATTURA_ENTE_COR NUMBER, DT_EMIS_FATTURA date, DS_TESTO_FATTURA VARCHAR2(1024 BYTE), NT_EMIS_FATTURA VARCHAR2(1024 BYTE), DT_SCAD_FATTURA date, CD_REGISTRO_EMIS_NOTA_CREDITO VARCHAR2(100 BYTE), AA_EMISS_NOTA_CREDITO NUMBER(4, 0), CD_EMIS_NOTA_CREDITO VARCHAR2(100 BYTE), DT_EMIS_NOTA_CREDITO date, NT_EMIS_NOTA_CREDITO VARCHAR2(1024 BYTE), NT_FATTURA VARCHAR2(1024 BYTE), ID_FATTURA_ENTE_STORNATA NUMBER, CD_FATTURA VARCHAR2(100 BYTE) NOT NULL, IM_TOT_DA_PAGARE NUMBER(10, 2) NOT NULL, CD_FATTURA_SAP VARCHAR2(100 BYTE), FL_DA_RIEMIS CHAR(1 BYTE), IM_TOT_IVA NUMBER(10, 2) DEFAULT 0 NOT NULL, NM_ENTE VARCHAR2(100 BYTE), NM_STRUT VARCHAR2(100 BYTE), CONSTRAINT PK_FATT_ENTE PRIMARY KEY (ID_FATTURA_ENTE));

-- changeset root:1753259446745-34
CREATE TABLE ORG_SCAGLIONE_TARIFFA (ID_SCAGLIONE_TARIFFA NUMBER NOT NULL, ID_TARIFFA NUMBER NOT NULL, NI_INI_SCAGLIONE NUMBER NOT NULL, NI_FINE_SCAGLIONE NUMBER NOT NULL, IM_SCAGLIONE NUMBER(12, 6) NOT NULL, CONSTRAINT PK_SCG_TARIFFA PRIMARY KEY (ID_SCAGLIONE_TARIFFA));

-- changeset root:1753259446745-35
CREATE TABLE APL_SISTEMA_VERSANTE_USER_REF (ID_SISTEMA_VERSANTE_USER_REF NUMBER NOT NULL, ID_SISTEMA_VERSANTE NUMBER NOT NULL, ID_USER_IAM_REF NUMBER NOT NULL, CONSTRAINT PK_SIS_VERS_USR_REF PRIMARY KEY (ID_SISTEMA_VERSANTE_USER_REF));

-- changeset root:1753259446745-36
CREATE TABLE ORG_SERVIZIO_EROG (ID_SERVIZIO_EROGATO NUMBER NOT NULL, ID_ACCORDO_ENTE NUMBER NOT NULL, NM_SERVIZIO_EROGATO VARCHAR2(150 BYTE) NOT NULL, ID_TIPO_SERVIZIO NUMBER NOT NULL, ID_SISTEMA_VERSANTE NUMBER, FL_PAGAMENTO CHAR(1 BYTE) NOT NULL, ID_TARIFFA NUMBER, DT_EROG date, IM_VALORE_TARIFFA NUMBER(12, 6) NOT NULL, NT_SERVIZIO_EROG VARCHAR2(1024 BYTE), ID_TARIFFA_ACCORDO NUMBER, ID_TARIFFA_AA_ACCORDO NUMBER, CONSTRAINT PK_SERV_EROG PRIMARY KEY (ID_SERVIZIO_EROGATO));

-- changeset root:1753259446745-37
CREATE TABLE ORG_SERVIZIO_FATTURA (ID_SERVIZIO_FATTURA NUMBER NOT NULL, ID_FATTURA_ENTE NUMBER NOT NULL, ID_SERVIZIO_EROGATO NUMBER NOT NULL, IM_SERVIZIO_FATTURA NUMBER(14, 6) NOT NULL, QT_SCAGLIONE_SERVIZIO_FATTURA NUMBER NOT NULL, QT_UNIT_SERVIZIO_FATTURA NUMBER, AA_SERVIZIO_FATTURA NUMBER(4, 0) NOT NULL, DT_EROG date NOT NULL, NM_SERVIZIO_FATTURA VARCHAR2(150 BYTE) NOT NULL, NT_SERVIZIO_FATTURA VARCHAR2(1024 BYTE), ID_CD_IVA NUMBER NOT NULL, IM_IVA NUMBER(14, 6) DEFAULT 0 NOT NULL, CONSTRAINT PK_SERV_FATT PRIMARY KEY (ID_SERVIZIO_FATTURA));

-- changeset root:1753259446745-38
CREATE TABLE APL_APPLIC (ID_APPLIC NUMBER NOT NULL, NM_APPLIC VARCHAR2(100 BYTE) NOT NULL, DS_APPLIC VARCHAR2(254 BYTE) NOT NULL, DS_URL_REPLICA_USER VARCHAR2(254 BYTE), NM_USER_REPLICA_USER VARCHAR2(100 BYTE), CD_PSW_REPLICA_USER VARCHAR2(100 BYTE), CD_VERSIONE_COMP VARCHAR2(100 BYTE) NOT NULL, CONSTRAINT PK_APL PRIMARY KEY (ID_APPLIC));

-- changeset root:1753259446745-39
CREATE TABLE APL_SISTEMA_VERSANTE (ID_SISTEMA_VERSANTE NUMBER NOT NULL, NM_SISTEMA_VERSANTE VARCHAR2(100 BYTE) NOT NULL, CD_VERSIONE VARCHAR2(100 BYTE), DS_SISTEMA_VERSANTE VARCHAR2(254 BYTE) NOT NULL, DS_EMAIL VARCHAR2(254 BYTE), FL_PEC CHAR(1 BYTE) DEFAULT '0' NOT NULL, FL_INTEGRAZIONE CHAR(1 BYTE) DEFAULT 0 NOT NULL, FL_ASSOCIA_PERSONA_FISICA CHAR(1 BYTE) DEFAULT 0 NOT NULL, ID_ENTE_SIAM NUMBER NOT NULL, DT_INI_VAL date NOT NULL, DT_FINE_VAL date NOT NULL, DS_NOTE VARCHAR2(254 CHAR), CONSTRAINT PK_SIS_VERS PRIMARY KEY (ID_SISTEMA_VERSANTE));

-- changeset root:1753259446745-40
CREATE TABLE APL_AZIONE_PAGINA (ID_AZIONE_PAGINA NUMBER NOT NULL, ID_PAGINA_WEB NUMBER NOT NULL, NM_AZIONE_PAGINA VARCHAR2(100 BYTE) NOT NULL, DS_AZIONE_PAGINA VARCHAR2(254 BYTE) NOT NULL, ID_TIPO_EVENTO NUMBER, CONSTRAINT PK_AZN_PAG PRIMARY KEY (ID_AZIONE_PAGINA));

-- changeset root:1753259446745-41
CREATE TABLE APL_CLASSE_TIPO_DATO (ID_CLASSE_TIPO_DATO NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, NM_CLASSE_TIPO_DATO VARCHAR2(100 BYTE) NOT NULL, CONSTRAINT PK_CLA_TI_DATO PRIMARY KEY (ID_CLASSE_TIPO_DATO));

-- changeset root:1753259446745-42
CREATE TABLE ORG_ACCORDO_ENTE (ID_ACCORDO_ENTE NUMBER NOT NULL, ID_ENTE_CONVENZ NUMBER NOT NULL, DT_REG_ACCORDO date, ID_TIPO_ACCORDO NUMBER, ID_TARIFFARIO NUMBER, ID_CLASSE_ENTE_CONVENZ NUMBER, NI_ABITANTI NUMBER, DT_SCAD_ACCORDO date, DS_FIRMATARIO_ENTE VARCHAR2(254 BYTE), FL_PAGAMENTO CHAR(1 BYTE) NOT NULL, CD_REGISTRO_REPERTORIO VARCHAR2(100 BYTE), AA_REPERTORIO NUMBER(4, 0), CD_KEY_REPERTORIO VARCHAR2(100 BYTE), DS_NOTE_ACCORDO VARCHAR2(4000 BYTE), CD_UFE VARCHAR2(100 BYTE), DS_UFE VARCHAR2(254 BYTE), CD_CIG VARCHAR2(100 BYTE), CD_CUP VARCHAR2(100 BYTE), ID_CD_IVA NUMBER, CD_RIF_CONTAB VARCHAR2(254 BYTE), CD_ODA VARCHAR2(100 BYTE), DT_DEC_ACCORDO date, DT_RICH_MODULO_INFO date, FL_RECESSO CHAR(1 BYTE) DEFAULT '0' NOT NULL, DS_ATTO_ACCORDO VARCHAR2(254 BYTE) DEFAULT 'Da definire' NOT NULL, DT_ATTO_ACCORDO date DEFAULT to_date('01/01/1900', 'dd/mm/yyyy'), TI_SCOPO_ACCORDO VARCHAR2(20 BYTE) DEFAULT 'CONSERVAZIONE' NOT NULL, ID_ENTE_CONVENZ_AMMINISTRATORE NUMBER NOT NULL, ID_ENTE_CONVENZ_CONSERV NUMBER NOT NULL, ID_ENTE_CONVENZ_GESTORE NUMBER NOT NULL, DS_NOTA_RECESSO VARCHAR2(4000 BYTE), DS_NOTA_FATTURAZIONE VARCHAR2(4000 BYTE), CD_CLIENTE_FATTURAZIONE VARCHAR2(100 BYTE), DT_FINE_VALID_ACCORDO date NOT NULL, FL_ACCORDO_CHIUSO CHAR(1 BYTE) DEFAULT '0' NOT NULL, ID_CLUSTER_ACCORDO NUMBER, ID_FASCIA_STORAGE_STANDARD_ACCORDO NUMBER, ID_FASCIA_STORAGE_MANUALE_ACCORDO NUMBER, NI_TIPO_UD_STANDARD NUMBER(10, 0), NI_TIPO_UD_MANUALE NUMBER(10, 0), NI_REFERTI_STANDARD NUMBER(10, 0), NI_REFERTI_MANUALE NUMBER(10, 0), DS_NOTA_ATTIVAZIONE VARCHAR2(4000 BYTE), CD_DDT VARCHAR2(100 BYTE), CD_CAPITOLO VARCHAR2(100 BYTE), CD_COGE VARCHAR2(100 BYTE), NI_STUDIO_DICOM NUMBER(10, 0), DS_NOTE_ENTE_ACCORDO VARCHAR2(254 CHAR), NM_ENTE VARCHAR2(100 BYTE), NM_STRUT VARCHAR2(100 BYTE), IM_ATTIV_DOC_AMM NUMBER(10, 2), IM_ATTIV_DOC_SANI NUMBER(10, 2), NI_STUDIO_DICOM_PREV NUMBER(10, 0), CD_REGISTRO_DETERMINA VARCHAR2(100 BYTE), AA_DETERMINA NUMBER(4, 0), CD_KEY_DETERMINA VARCHAR2(100 BYTE), DT_DETERMINA date, DT_DEC_ACCORDO_INFO date, CONSTRAINT PK_ACCOR_ENTE PRIMARY KEY (ID_ACCORDO_ENTE));

-- changeset root:1753259446745-43
CREATE TABLE APL_ENTRY_MENU (ID_ENTRY_MENU NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, NM_ENTRY_MENU VARCHAR2(100 BYTE) NOT NULL, DS_ENTRY_MENU VARCHAR2(254 BYTE) NOT NULL, NI_LIVELLO_ENTRY_MENU NUMBER NOT NULL, NI_ORD_ENTRY_MENU NUMBER NOT NULL, ID_ENTRY_MENU_PADRE NUMBER, DL_LINK_ENTRY_MENU VARCHAR2(2000 BYTE), CONSTRAINT PK_ENT_MENU PRIMARY KEY (ID_ENTRY_MENU));

-- changeset root:1753259446745-44
CREATE TABLE ORG_CLASSE_ENTE_CONVENZ (ID_CLASSE_ENTE_CONVENZ NUMBER NOT NULL, CD_CLASSE_ENTE_CONVENZ VARCHAR2(100 BYTE) NOT NULL, DS_CLASSE_ENTE_CONVENZ VARCHAR2(254 BYTE) NOT NULL, NI_MIN_ABIT NUMBER, NI_MAX_ABIT NUMBER, CONSTRAINT PK_CLA_ENTE_CONVENZ PRIMARY KEY (ID_CLASSE_ENTE_CONVENZ));

-- changeset root:1753259446745-45
CREATE TABLE APL_PAGINA_WEB (ID_PAGINA_WEB NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, NM_PAGINA_WEB VARCHAR2(100 BYTE) NOT NULL, DS_PAGINA_WEB VARCHAR2(254 BYTE) NOT NULL, TI_HELP_ON_LINE VARCHAR2(20 BYTE) DEFAULT 'HELP_PAGINA' NOT NULL, ID_ENTRY_MENU NUMBER NOT NULL, CONSTRAINT PK_PAG PRIMARY KEY (ID_PAGINA_WEB));

-- changeset root:1753259446745-46
CREATE TABLE APL_SERVIZIO_WEB (ID_SERVIZIO_WEB NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, NM_SERVIZIO_WEB VARCHAR2(100 BYTE) NOT NULL, DS_SERVIZIO_WEB VARCHAR2(254 BYTE) NOT NULL, CONSTRAINT PK_SRV PRIMARY KEY (ID_SERVIZIO_WEB));

-- changeset root:1753259446745-47
CREATE TABLE APL_TIPO_ORGANIZ (ID_TIPO_ORGANIZ NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, NM_TIPO_ORGANIZ VARCHAR2(100 BYTE) NOT NULL, FL_LAST_LIVELLO CHAR(1 BYTE) NOT NULL, CONSTRAINT PK_TI_ORG PRIMARY KEY (ID_TIPO_ORGANIZ));

-- changeset root:1753259446745-48
CREATE TABLE LOG_JOB (ID_LOG_JOB NUMBER NOT NULL, NM_JOB VARCHAR2(100 BYTE) NOT NULL, TI_REG_LOG_JOB VARCHAR2(20 BYTE) NOT NULL, DT_REG_LOG_JOB date NOT NULL, DL_MSG_ERR VARCHAR2(1024 BYTE), CD_IND_IP_SERVER VARCHAR2(100 BYTE), DT_VIRTUAL_REG VARCHAR2(10 BYTE), CD_IND_SERVER VARCHAR2(100 BYTE), CONSTRAINT PK_LOG_JOB PRIMARY KEY (ID_LOG_JOB));

-- changeset root:1753259446745-49
CREATE TABLE LOG_USER_DA_REPLIC (ID_LOG_USER_DA_REPLIC NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, ID_USER_IAM NUMBER NOT NULL, NM_USERID VARCHAR2(100 BYTE) NOT NULL, TI_OPER_REPLIC VARCHAR2(20 BYTE) NOT NULL, TI_STATO_REPLIC VARCHAR2(30 BYTE) NOT NULL, DT_LOG_USER_DA_REPLIC TIMESTAMP(6) NOT NULL, CD_ERR VARCHAR2(100 BYTE), DS_MSG_ERR VARCHAR2(4000 BYTE), DT_ERR date, ID_LOG_JOB NUMBER, DT_CHIUSURA_REPLICA date, CONSTRAINT PK_USR_DA_REPLIC PRIMARY KEY (ID_LOG_USER_DA_REPLIC));

-- changeset root:1753259446745-50
CREATE TABLE PRF_AUTOR (ID_AUTOR NUMBER NOT NULL, ID_USO_RUOLO_APPLIC NUMBER NOT NULL, TI_DICH_AUTOR VARCHAR2(20 BYTE) NOT NULL, ID_ENTRY_MENU NUMBER, ID_PAGINA_WEB NUMBER, ID_AZIONE_PAGINA NUMBER, ID_SERVIZIO_WEB NUMBER, CONSTRAINT PK_AUT PRIMARY KEY (ID_AUTOR));

-- changeset root:1753259446745-51
CREATE TABLE PRF_DICH_AUTOR (ID_DICH_AUTOR NUMBER NOT NULL, ID_USO_RUOLO_APPLIC NUMBER NOT NULL, TI_DICH_AUTOR VARCHAR2(20 BYTE) NOT NULL, TI_SCOPO_DICH_AUTOR VARCHAR2(22 BYTE) NOT NULL, ID_ENTRY_MENU_PADRE NUMBER, ID_ENTRY_MENU_FOGLIA NUMBER, ID_PAGINA_WEB NUMBER, ID_AZIONE_PAGINA NUMBER, ID_SERVIZIO_WEB NUMBER, CONSTRAINT PK_DICH_AUT PRIMARY KEY (ID_DICH_AUTOR));

-- changeset root:1753259446745-52
CREATE TABLE APL_TIPO_EVENTO_OGGETTO_TRIG (ID_TIPO_EVENTO_OGGETTO_TRIG NUMBER NOT NULL, ID_TIPO_EVENTO_OGGETTO NUMBER NOT NULL, ID_TIPO_EVENTO_TRIG NUMBER NOT NULL, ID_TIPO_OGGETTO_TRIG NUMBER NOT NULL, ID_QUERY_TIPO_OGGETTO_TRIG NUMBER, ID_QUERY_TIPO_OGGETTO_SEL NUMBER NOT NULL, CONSTRAINT PK_TI_EVN_OGG_TRIG PRIMARY KEY (ID_TIPO_EVENTO_OGGETTO_TRIG));

-- changeset root:1753259446745-53
CREATE TABLE APL_TIPO_OGGETTO (ID_TIPO_OGGETTO NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, NM_TIPO_OGGETTO VARCHAR2(100 BYTE) NOT NULL, ID_TIPO_OGGETTO_PADRE NUMBER, CONSTRAINT PK_TI_OGG PRIMARY KEY (ID_TIPO_OGGETTO));

-- changeset root:1753259446745-54
CREATE TABLE PRF_RUOLO (ID_RUOLO NUMBER NOT NULL, NM_RUOLO VARCHAR2(100 BYTE) NOT NULL, DS_RUOLO VARCHAR2(254 BYTE) NOT NULL, TI_RUOLO VARCHAR2(20 BYTE) DEFAULT 'PERSONA_FISICA' NOT NULL, TI_STATO_RICH_ALLINEA_RUOLI_1 VARCHAR2(30 BYTE) DEFAULT 'ALLINEAMENTO_COMPLETO' NOT NULL, TI_STATO_RICH_ALLINEA_RUOLI_2 VARCHAR2(30 BYTE) DEFAULT 'ALLINEAMENTO_COMPLETO' NOT NULL, FL_ALLINEAMENTO_IN_CORSO CHAR(1 BYTE) DEFAULT '0' NOT NULL, DS_ESITO_RICH_ALLINEA_RUOLI_1 VARCHAR2(4000 BYTE), DS_ESITO_RICH_ALLINEA_RUOLI_2 VARCHAR2(4000 BYTE), DS_MSG_ALLINEAMENTO_PARZ VARCHAR2(4000 BYTE), CONSTRAINT PK_RUO PRIMARY KEY (ID_RUOLO));

-- changeset root:1753259446745-55
CREATE TABLE LOG_AGENTE (ID_AGENTE NUMBER NOT NULL, NM_AGENTE VARCHAR2(100 BYTE) NOT NULL, TIPO_AGENTE_PREMIS VARCHAR2(30 BYTE) NOT NULL, TIPO_ORIGINE_AGENTE VARCHAR2(30 BYTE) NOT NULL, CONSTRAINT PK_AGENT PRIMARY KEY (ID_AGENTE));

-- changeset root:1753259446745-56
CREATE TABLE PRF_USO_RUOLO_APPLIC (ID_USO_RUOLO_APPLIC NUMBER NOT NULL, ID_RUOLO NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, CONSTRAINT PK_USO_RUO_APL PRIMARY KEY (ID_USO_RUOLO_APPLIC));

-- changeset root:1753259446745-57
CREATE TABLE USR_DICH_ABIL_DATI (ID_DICH_ABIL_DATI NUMBER NOT NULL, ID_USO_USER_APPLIC NUMBER NOT NULL, TI_SCOPO_DICH_ABIL_DATI VARCHAR2(20 BYTE) NOT NULL, ID_ORGANIZ_IAM NUMBER, ID_TIPO_DATO_IAM NUMBER, ID_CLASSE_TIPO_DATO NUMBER NOT NULL, ID_APPART_COLLEG_ENTI NUMBER, ID_SUPT_EST_ENTE_CONVENZ NUMBER, ID_VIGIL_ENTE_PRODUT NUMBER, DS_CAUSALE_DICH VARCHAR2(254 BYTE), CONSTRAINT PK_DIC_ABIL_DATI PRIMARY KEY (ID_DICH_ABIL_DATI));

-- changeset root:1753259446745-58
CREATE TABLE USR_RICH_GEST_USER (ID_RICH_GEST_USER NUMBER NOT NULL, CD_REGISTRO_RICH_GEST_USER VARCHAR2(100 BYTE), AA_RICH_GEST_USER NUMBER(4, 0), CD_KEY_RICH_GEST_USER VARCHAR2(100 BYTE), CD_RICH_GEST_USER VARCHAR2(100 BYTE), ID_ENTE_RICH NUMBER NOT NULL, TI_RICH_GEST_USER VARCHAR2(30 BYTE) NOT NULL, DT_RICH_GEST_USER date NOT NULL, NT_RICH_GEST_USER VARCHAR2(4000 BYTE), TI_USER_RICH VARCHAR2(20 BYTE) NOT NULL, NM_USER_RICH VARCHAR2(100 BYTE), DS_EMAIL_RICH VARCHAR2(254 BYTE), ID_USER_IAM_RICH NUMBER, TI_STATO_RICH_GEST_USER VARCHAR2(20 BYTE) NOT NULL, BL_RICH_GEST_USER BLOB, ID_NOTIFICA_RICH_EVASA NUMBER, NM_FILE_RICH_GEST_USER VARCHAR2(100 BYTE), ID_ORGANIZ_IAM NUMBER, CONSTRAINT PK_RICH_GEST_USR PRIMARY KEY (ID_RICH_GEST_USER));

-- changeset root:1753259446745-59
CREATE TABLE APL_AZIONE_COMP_SW (ID_AZIONE_COMP_SW NUMBER NOT NULL, ID_COMP_SW NUMBER NOT NULL, NM_AZIONE_COMP_SW VARCHAR2(100 BYTE) NOT NULL, DS_AZIONE_COMP_SW VARCHAR2(254 BYTE) NOT NULL, ID_TIPO_EVENTO NUMBER, CONSTRAINT PK_AZN_COMP_SW PRIMARY KEY (ID_AZIONE_COMP_SW));

-- changeset root:1753259446745-60
CREATE TABLE USR_DICH_ABIL_ORGANIZ (ID_DICH_ABIL_ORGANIZ NUMBER NOT NULL, ID_USO_USER_APPLIC NUMBER NOT NULL, TI_SCOPO_DICH_ABIL_ORGANIZ VARCHAR2(20 BYTE) NOT NULL, ID_ORGANIZ_IAM NUMBER, ID_APPART_COLLEG_ENTI NUMBER, ID_SUPT_EST_ENTE_CONVENZ NUMBER, ID_VIGIL_ENTE_PRODUT NUMBER, DS_CAUSALE_DICH VARCHAR2(254 BYTE), CONSTRAINT PK_DICH_ABIL_STRUT PRIMARY KEY (ID_DICH_ABIL_ORGANIZ));

-- changeset root:1753259446745-61
CREATE TABLE APL_COMP_SW (ID_COMP_SW NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, NM_COMP_SW VARCHAR2(100 BYTE) NOT NULL, ID_AGENTE NUMBER NOT NULL, CONSTRAINT PK_COMP_SW PRIMARY KEY (ID_COMP_SW));

-- changeset root:1753259446745-62
CREATE TABLE APL_TIPO_EVENTO (ID_TIPO_EVENTO NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, NM_TIPO_EVENTO VARCHAR2(100 BYTE) NOT NULL, TIPO_ORIGINE_EVENTO VARCHAR2(20 BYTE) NOT NULL, TIPO_CLASSE_EVENTO VARCHAR2(30 BYTE) NOT NULL, TIPO_CLASSE_PREMIS_EVENTO VARCHAR2(50 BYTE), CONSTRAINT PK_TI_EVN PRIMARY KEY (ID_TIPO_EVENTO));

-- changeset root:1753259446745-63
CREATE TABLE APL_TIPO_EVENTO_OGGETTO (ID_TIPO_EVENTO_OGGETTO NUMBER NOT NULL, ID_TIPO_EVENTO NUMBER NOT NULL, ID_TIPO_OGGETTO NUMBER NOT NULL, ID_QUERY_TIPO_OGGETTO_FOTO NUMBER, CONSTRAINT PK_TI_EVN_OGG PRIMARY KEY (ID_TIPO_EVENTO_OGGETTO));

-- changeset root:1753259446745-64
CREATE TABLE USR_ORGANIZ_IAM (ID_ORGANIZ_IAM NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, ID_ORGANIZ_APPLIC NUMBER NOT NULL, ID_TIPO_ORGANIZ NUMBER NOT NULL, NM_ORGANIZ VARCHAR2(100 BYTE) NOT NULL, DS_ORGANIZ VARCHAR2(254 BYTE) NOT NULL, ID_ORGANIZ_IAM_PADRE NUMBER, ID_ENTE_CONSERV NUMBER, ID_ENTE_GESTORE NUMBER, CONSTRAINT PK_ORG PRIMARY KEY (ID_ORGANIZ_IAM));

-- changeset root:1753259446745-65
CREATE TABLE USR_TIPO_DATO_IAM (ID_TIPO_DATO_IAM NUMBER NOT NULL, ID_ORGANIZ_IAM NUMBER NOT NULL, NM_TIPO_DATO VARCHAR2(100 BYTE) NOT NULL, DS_TIPO_DATO VARCHAR2(1024 BYTE) NOT NULL, ID_TIPO_DATO_APPLIC NUMBER NOT NULL, ID_CLASSE_TIPO_DATO NUMBER NOT NULL, CONSTRAINT PK_TI_DATO PRIMARY KEY (ID_TIPO_DATO_IAM));

-- changeset root:1753259446745-66
CREATE TABLE USR_USER (ID_USER_IAM NUMBER NOT NULL, NM_USERID VARCHAR2(100 BYTE) NOT NULL, CD_PSW VARCHAR2(100 BYTE) NOT NULL, NM_COGNOME_USER VARCHAR2(100 BYTE) NOT NULL, NM_NOME_USER VARCHAR2(100 BYTE) NOT NULL, FL_ATTIVO CHAR(1 BYTE) NOT NULL, DT_REG_PSW date NOT NULL, DT_SCAD_PSW date NOT NULL, CD_SALT VARCHAR2(100 BYTE), FL_USER_ADMIN CHAR(1 BYTE) DEFAULT '0' NOT NULL, CD_FISC VARCHAR2(16 BYTE), DS_EMAIL VARCHAR2(254 BYTE) NOT NULL, FL_CONTR_IP CHAR(1 BYTE) DEFAULT '0' NOT NULL, TIPO_USER VARCHAR2(20 BYTE) DEFAULT 'PERSONA_FISICA' NOT NULL, ID_SISTEMA_VERSANTE NUMBER, ID_AGENTE NUMBER NOT NULL, ID_ENTE_SIAM NUMBER NOT NULL, ID_STATO_USER_COR NUMBER, FL_RESP_ENTE_CONVENZ CHAR(1 BYTE) DEFAULT '0' NOT NULL, FL_UTENTE_DITTA CHAR(1 BYTE) DEFAULT '0' NOT NULL, CD_PSW_DA_NOTIF VARCHAR2(100 BYTE), FL_ABIL_ENTI_COLLEG_AUTOM CHAR(1 BYTE), FL_ABIL_ORGANIZ_AUTOM CHAR(1 BYTE), FL_ABIL_FORNIT_AUTOM CHAR(1 BYTE), DS_EMAIL_SECONDARIA VARCHAR2(254 BYTE), TIPO_AUTH VARCHAR2(20 BYTE), DT_INI_CERT date, DT_FIN_CERT date, DL_CERT_CLIENT CLOB, CONSTRAINT PK_USR PRIMARY KEY (ID_USER_IAM));

-- changeset root:1753259446745-67
CREATE TABLE ORG_GESTIONE_ACCORDO (ID_GEST_ACCORDO NUMBER NOT NULL, ID_ACCORDO_ENTE NUMBER NOT NULL, CD_REGISTRO_GEST_ACCORDO VARCHAR2(100 BYTE), AA_GEST_ACCORDO NUMBER(4, 0), CD_KEY_GEST_ACCORDO VARCHAR2(100 BYTE), DT_GEST_ACCORDO date NOT NULL, DS_GEST_ACCORDO VARCHAR2(4000 BYTE) NOT NULL, DS_NOTA_GEST_ACCORDO VARCHAR2(4000 BYTE), BL_GEST_ACCORDO BLOB, NM_FILE_GEST_ACCORDO VARCHAR2(100 BYTE), PG_GEST_ACCORDO NUMBER(4, 0) DEFAULT 1 NOT NULL, ID_TIPO_GESTIONE_ACCORDO NUMBER NOT NULL, TIPO_TRASMISSIONE VARCHAR2(100 BYTE) NOT NULL, ID_GEST_ACCORDO_RISPOSTA NUMBER, ENTE_GEST_ACCORDO VARCHAR2(100 BYTE), STRUTTURA_GEST_ACCORDO VARCHAR2(100 BYTE), CONSTRAINT PK_VAR_ACC PRIMARY KEY (ID_GEST_ACCORDO));

-- changeset root:1753259446745-68
CREATE TABLE USR_USO_RUOLO_DICH (ID_USO_RUOLO_DICH NUMBER NOT NULL, ID_DICH_ABIL_ORGANIZ NUMBER NOT NULL, ID_RUOLO NUMBER NOT NULL, TI_SCOPO_RUOLO VARCHAR2(20 BYTE) NOT NULL, ID_ORGANIZ_IAM_RUOLO NUMBER NOT NULL, CONSTRAINT PK_USO_RUO_DICH PRIMARY KEY (ID_USO_RUOLO_DICH));

-- changeset root:1753259446745-69
CREATE TABLE IAM_VALORE_PARAM_APPLIC (ID_VALORE_PARAM_APPLIC NUMBER NOT NULL, ID_PARAM_APPLIC NUMBER NOT NULL, TI_APPART VARCHAR2(20 BYTE) NOT NULL, DS_VALORE_PARAM_APPLIC VARCHAR2(254 BYTE) NOT NULL, ID_AMBIENTE_ENTE_CONVENZ NUMBER, ID_ENTE_CONVENZ NUMBER, CONSTRAINT PK_VAL_PAR_APL_IAM PRIMARY KEY (ID_VALORE_PARAM_APPLIC));

-- changeset root:1753259446745-70
CREATE TABLE USR_USO_RUOLO_USER_DEFAULT (ID_USO_RUOLO_USER_DEFAULT NUMBER NOT NULL, ID_USO_USER_APPLIC NUMBER NOT NULL, ID_RUOLO NUMBER NOT NULL, CONSTRAINT PK_USO_RUO_USR_DEF PRIMARY KEY (ID_USO_RUOLO_USER_DEFAULT));

-- changeset root:1753259446745-71
CREATE TABLE USR_USO_USER_APPLIC (ID_USO_USER_APPLIC NUMBER NOT NULL, ID_USER_IAM NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, CONSTRAINT PK_USO_USR_APL PRIMARY KEY (ID_USO_USER_APPLIC));

-- changeset root:1753259446745-72
CREATE TABLE ORG_MODULO_INFO_ACCORDO (ID_MODULO_INFO_ACCORDO NUMBER NOT NULL, ID_ACCORDO_ENTE NUMBER, DT_RICEV date NOT NULL, CD_REGISTRO_MODULO_INFO VARCHAR2(100 BYTE), AA_MODULO_INFO NUMBER(4, 0), CD_KEY_MODULO_INFO VARCHAR2(100 BYTE), CD_MODULO_INFO VARCHAR2(100 BYTE), BL_MODULO_INFO BLOB, NM_FILE_MODULO_INFO VARCHAR2(100 BYTE), DS_MODULO_INFO VARCHAR2(1024 BYTE), NM_ENTE VARCHAR2(100 BYTE), NM_STRUT VARCHAR2(100 BYTE), ID_ENTE_CONVENZ NUMBER, CONSTRAINT PK_MOD_INFO_ACCOR PRIMARY KEY (ID_MODULO_INFO_ACCORDO));

-- changeset root:1753259446745-73
CREATE TABLE PRF_ALLINEA_RUOLO (ID_ALLINEA_RUOLO NUMBER NOT NULL, ID_RUOLO NUMBER NOT NULL, NM_APPLIC VARCHAR2(100 BYTE) NOT NULL, TI_DICH_AUTOR VARCHAR2(20 BYTE) NOT NULL, TI_SCOPO_DICH_AUTOR VARCHAR2(22 BYTE) NOT NULL, DS_PATH_ENTRY_MENU_PADRE VARCHAR2(1024 BYTE), DS_PATH_ENTRY_MENU_FOGLIA VARCHAR2(1024 BYTE), NM_PAGINA_WEB VARCHAR2(100 BYTE), NM_AZIONE_PAGINA VARCHAR2(100 BYTE), NM_SERVIZIO_WEB VARCHAR2(100 BYTE), CONSTRAINT PK_ALLINEA_RUO PRIMARY KEY (ID_ALLINEA_RUOLO));

-- changeset root:1753259446745-74
CREATE TABLE USR_OLD_PSW (ID_OLD_PSW NUMBER NOT NULL, ID_USER_IAM NUMBER NOT NULL, PG_OLD_PSW NUMBER NOT NULL, CD_PSW VARCHAR2(100 BYTE) NOT NULL, CD_SALT VARCHAR2(100 BYTE) NOT NULL, CONSTRAINT PK_OLD_PSW PRIMARY KEY (ID_OLD_PSW));

-- changeset root:1753259446745-75
CREATE TABLE APL_QUERY_TIPO_OGGETTO (ID_QUERY_TIPO_OGGETTO NUMBER NOT NULL, ID_TIPO_OGGETTO NUMBER NOT NULL, NM_QUERY_TIPO_OGGETTO VARCHAR2(100 BYTE) NOT NULL, TIPO_USO_QUERY VARCHAR2(30 BYTE) NOT NULL, BL_QUERY_TIPO_OGGETTO CLOB NOT NULL, ID_TIPO_OGGETTO_ACCESSO NUMBER, ID_TIPO_OGGETTO_SEL NUMBER, CONSTRAINT PK_QRY_TI_OGG PRIMARY KEY (ID_QUERY_TIPO_OGGETTO));

-- changeset root:1753259446745-76
CREATE TABLE USR_APPART_USER_RICH (ID_APPART_USER_RICH NUMBER NOT NULL, ID_RICH_GEST_USER NUMBER NOT NULL, TI_APPART_USER_RICH VARCHAR2(30 BYTE) NOT NULL, NM_NOME_USER VARCHAR2(100 BYTE), NM_COGNOME_USER VARCHAR2(100 BYTE), NM_USERID VARCHAR2(100 BYTE), ID_USER_IAM NUMBER, TI_AZIONE_RICH VARCHAR2(100 BYTE) NOT NULL, FL_AZIONE_RICH_EVASA CHAR(1 BYTE) DEFAULT '0' NOT NULL, ID_NOTIFICA_AZIONE_1 NUMBER, ID_NOTIFICA_AZIONE_2 NUMBER, ID_ENTE_USER NUMBER NOT NULL, CONSTRAINT PK_APP_USR_RICH PRIMARY KEY (ID_APPART_USER_RICH));

-- changeset root:1753259446745-77
CREATE TABLE USR_STATO_USER (ID_STATO_USER NUMBER NOT NULL, ID_USER_IAM NUMBER NOT NULL, TS_STATO TIMESTAMP(6) NOT NULL, TI_STATO_USER VARCHAR2(30 BYTE) NOT NULL, ID_RICH_GEST_USER NUMBER, ID_NOTIFICA NUMBER, CONSTRAINT PK_STATO_USR PRIMARY KEY (ID_STATO_USER));

-- changeset root:1753259446745-78
CREATE TABLE ORG_ENTE_USER_RIF (ID_ENTE_USER_RIF NUMBER NOT NULL, ID_ENTE_CONVENZ NUMBER NOT NULL, ID_USER_IAM NUMBER NOT NULL, DL_NOTE VARCHAR2(254 BYTE), QUALIFICA_USER VARCHAR2(40 BYTE), CD_REGISTRO_ENTE_USER_RIF VARCHAR2(100 BYTE), AA_ENTE_USER_RIF NUMBER(4, 0), CD_KEY_ENTE_USER_RIF VARCHAR2(100 BYTE), DT_REG_ENTE_USER_RIF date, CD_ENTE_USER_RIF VARCHAR2(100 BYTE), BL_ENTE_USER_RIF BLOB, NM_FILE_ENTE_USER_RIF VARCHAR2(100 BYTE), DS_ENTE_USER_RIF VARCHAR2(1024 BYTE), CONSTRAINT PK_ENTE_USR_RIF PRIMARY KEY (ID_ENTE_USER_RIF));

-- changeset root:1753259446745-79
CREATE TABLE APL_HELP_ON_LINE (ID_HELP_ON_LINE NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, TI_HELP_ON_LINE VARCHAR2(20 BYTE) NOT NULL, DT_INI_VAL date NOT NULL, DT_FINE_VAL date NOT NULL, ID_PAGINA_WEB NUMBER NOT NULL, ID_ENTRY_MENU NUMBER, DS_FILE_HELP_ON_LINE VARCHAR2(254 BYTE) NOT NULL, BL_HELP_ON_LINE CLOB NOT NULL, BL_SORGENTE_HELP_ON_LINE BLOB NOT NULL, CONSTRAINT PK_HELP_OL PRIMARY KEY (ID_HELP_ON_LINE));

-- changeset root:1753259446745-80
CREATE TABLE ORG_FASCIA_STORAGE_ACCORDO (ID_FASCIA_STORAGE_ACCORDO NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL, TI_FASCIA VARCHAR2(20 BYTE) NOT NULL, NI_FASCIA_DA NUMBER NOT NULL, NI_FASCIA_A NUMBER NOT NULL, CONSTRAINT PK_FAS_STOR_ACCORDO PRIMARY KEY (ID_FASCIA_STORAGE_ACCORDO));

-- changeset root:1753259446745-81
CREATE OR REPLACE FORCE VIEW "PRF_V_LIS_RUOLO" ("ID_USO_RUOLO_APPLIC", "ID_RUOLO", "NM_RUOLO", "DS_RUOLO", "NM_APPLIC", "DS_APPLIC", "ID_USER_IAM_CORR", "TI_RUOLO", "TI_CATEG", "TI_CATEG_RUOLO", "TI_STATO_RICH_ALLINEA_RUOLI_1", "TI_STATO_RICH_ALLINEA_RUOLI_2", "FL_ALLINEAMENTO_IN_CORSO", "DS_ESITO_RICH_ALLINEA_RUOLI_1", "DS_ESITO_RICH_ALLINEA_RUOLI_2", "DS_MSG_ALLINEAMENTO_PARZ") AS select
 uso_ruo.id_uso_ruolo_applic,
 ruo.id_ruolo,
 ruo.nm_ruolo,
 ruo.ds_ruolo,
 apl.nm_applic,
 case
	when 1 = (select count (*)
			from PRF_USO_RUOLO_APPLIC uso_ruo_1
			where uso_ruo_1.id_ruolo = ruo.id_ruolo) then apl.nm_applic
	else 'Usato da più di una applicazione'
 end ds_applic,
 usr_corr.id_user_iam,
 
 ruo.ti_ruolo,
 ruolo_categ.ti_categ_ruolo,
 case
	when 1 = (select count (*)
			from PRF_RUOLO_CATEGORIA ruolo_categ
			where ruolo_categ.id_ruolo = ruo.id_ruolo) then ruolo_categ.ti_categ_ruolo
	else 'Più di una categoria'
 end ti_categ_ruolo,
 
 ruo.ti_stato_rich_allinea_ruoli_1, ruo.ti_stato_rich_allinea_ruoli_2, ruo.fl_allineamento_in_corso,
 ruo.ds_esito_rich_allinea_ruoli_1, ruo.ds_esito_rich_allinea_ruoli_2, ruo.ds_msg_allineamento_parz
 
from PRF_RUOLO ruo
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo)
 join PRF_RUOLO_CATEGORIA ruolo_categ
 on (ruolo_categ.id_ruolo = ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic  = uso_ruo.id_applic)
join USR_USER usr_corr
 on (usr_corr.nm_userid like '%')
where not exists (select *
				from PRF_USO_RUOLO_APPLIC uso_ruo_1
				where uso_ruo_1.id_ruolo = ruo.id_ruolo
				and not exists (select *
								from USR_USO_USER_APPLIC uso_usr_corr
								where uso_usr_corr.id_user_iam = usr_corr.id_user_iam
								and uso_usr_corr.id_applic = uso_ruo_1.id_applic));

-- changeset root:1753259446745-82
COMMENT ON COLUMN PRF_V_LIS_RUOLO.ID_USO_RUOLO_APPLIC IS 'PK.1 relativa a tabella PRF_USO_RUOLO_APPLIC';

-- changeset root:1753259446745-83
CREATE OR REPLACE FORCE VIEW "ORG_V_TREE_AMBITO_TERRIT" ("ID_AMBITO_TERRIT", "CD_AMBITO_TERRIT", "TI_AMBITO_TERRIT", "ID_AMBITO_TERRIT_PADRE", "DS_TREE_CD_AMBITO_TERRIT", "DS_TREE_ID_AMBITO_TERRIT") AS select 
	id_ambito_territ,
    cd_ambito_territ,
    ti_ambito_territ,
    id_ambito_territ_padre,
	ltrim(sys_connect_by_path (trt.cd_ambito_territ, ' - '), ' - ') ds_tree_cd_ambito_territ,
	sys_connect_by_path (trt.id_ambito_territ, '/') ds_tree_id_ambito_territ

from org_ambito_territ trt

start with trt.id_ambito_territ_padre is null
connect by prior trt.id_ambito_territ = trt.id_ambito_territ_padre;

-- changeset root:1753259446745-84
COMMENT ON COLUMN ORG_V_TREE_AMBITO_TERRIT.ID_AMBITO_TERRIT IS 'PK.1';

-- changeset root:1753259446745-85
CREATE OR REPLACE FORCE VIEW "ORG_V_VIS_FATTURA" ("ID_STATO_CALC", "ID_FATTURA_ENTE", "NM_AMBIENTE_ENTE_CONVENZ", "ID_AMBIENTE_ENTE_CONVENZ", "ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "CD_ENTE_CONVENZ", "TI_CD_ENTE_CONVENZ", "CD_FISC", "CD_CLIENTE_SAP", "CD_CATEG_ENTE", "CD_TIPO_ACCORDO", "DT_DEC_ACCORDO_INFO", "DT_DEC_ACCORDO", "DT_SCAD_ACCORDO", "DT_FINE_VALID_ACCORDO", "FL_PAGAMENTO", "NM_TARIFFARIO", "CD_CLASSE_ENTE_CONVENZ", "NI_ABITANTI", "DS_NOTE_ACCORDO", "CD_UFE", "DS_UFE", "CD_IVA", "DS_IVA", "CD_CIG", "CD_CUP", "CD_RIF_CONTAB", "CD_COGE", "CD_CAPITOLO", "TI_STATO_FATTURA_ENTE", "DT_REG_STATO_FATTURA_ENTE", "AA_FATTURA", "PG_FATTURA", "CD_FATTURA", "DT_CREAZIONE", "CD_REGISTRO_EMIS_FATTURA", "AA_EMISS_FATTURA", "CD_EMIS_FATTURA", "DT_EMIS_FATTURA", "DT_SCAD_FATTURA", "NT_EMIS_FATTURA", "CD_FATTURA_SAP", "IM_TOT_NETTO", "IM_TOT_IVA", "IM_TOT_FATTURA", "IM_TOT_DA_PAGARE", "IM_TOT_PAGAM", "FL_SUPERAMENTO_SCAGLIONE", "CD_REGISTRO_EMIS_NOTA_CREDITO", "AA_EMISS_NOTA_CREDITO", "CD_EMIS_NOTA_CREDITO", "DT_EMIS_NOTA_CREDITO", "NT_EMIS_NOTA_CREDITO", "FL_DA_RIEMIS", "NM_AMBIENTE", "NM_ENTE", "NM_STRUT") AS SELECT stato_calc.id_stato_fattura_ente,
           fattura.id_fattura_ente,
           -- info ente convenzionato
           amb.nm_ambiente_ente_convenz,
           enteconvenz.id_ambiente_ente_convenz,
           enteconvenz.id_ente_siam,
           enteconvenz.nm_ente_siam,
           enteconvenz.cd_ente_convenz,
           enteconvenz.ti_cd_ente_convenz,
           enteconvenz.cd_fisc,
           accordo.cd_cliente_fatturazione,
           categoria.cd_categ_ente,
           -- info dati accordo colonna sinistra
           ti_accordo.cd_tipo_accordo,
           accordo.DT_DEC_ACCORDO_INFO,
           accordo.dt_dec_accordo,
           accordo.dt_scad_accordo,
           accordo.dt_fine_valid_accordo,
           accordo.fl_pagamento,
           tariffario.nm_tariffario,
           classe.cd_classe_ente_convenz,
           accordo.ni_abitanti,
           accordo.ds_note_accordo,
           -- info dati accordo colonna destra
           accordo.cd_ufe,
           accordo.ds_ufe,
           iva.cd_iva,
           iva.ds_iva,
           accordo.cd_cig,
           accordo.cd_cup,
           accordo.cd_rif_contab,
           accordo.cd_coge,
           accordo.cd_capitolo,
           -- info dati stato_cor fattura
           stato_cor.ti_stato_fattura_ente,
           stato_cor.dt_reg_stato_fattura_ente,
           --info dati fattura temporanea
           fattura.aa_fattura,
           fattura.pg_fattura,
           fattura.cd_fattura,
           stato_calc.dt_reg_stato_fattura_ente
               AS dt_creazione,
           -- info dati fattura emessa
           -- ambiente ente struttura configurati
           fattura.cd_registro_emis_fattura,
           fattura.aa_emiss_fattura,
           fattura.cd_emis_fattura,
           fattura.dt_emis_fattura,
           fattura.dt_scad_fattura,
           fattura.nt_emis_fattura,
           fattura.cd_fattura_sap,
           -- info dati importi
           fattura.im_tot_fattura - fattura.im_tot_iva
               AS im_tot_netto,
           fattura.im_tot_iva,
           fattura.im_tot_fattura,
           fattura.im_tot_da_pagare,
           (SELECT SUM (pagamenti.im_pagam)
              FROM ORG_PAGAM_FATTURA_ENTE pagamenti
             WHERE pagamenti.id_fattura_ente = fattura.id_fattura_ente)
               AS im_tot_pagam,
           --superamento scaglione
           CASE
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_SERVIZIO_FATTURA  servizio_fatt
                                JOIN ORG_SERVIZIO_EROG serv_erog
                                    ON (serv_erog.id_servizio_erogato =
                                        servizio_fatt.id_servizio_erogato)
                                JOIN ORG_TIPO_SERVIZIO ti_serv
                                    ON (    ti_serv.id_tipo_servizio =
                                            serv_erog.id_tipo_servizio
                                        AND ti_serv.ti_classe_tipo_servizio =
                                            'CONSERVAZIONE')
                                JOIN ORG_TARIFFA tariffa
                                    ON (    tariffa.id_tariffa =
                                            serv_erog.id_tariffa
                                        AND tariffa.tipo_tariffa IN
                                                ('VALORE_SCAGLIONI_STORAGE',
                                                 'VALORE_UNITARIO_SCAGLIONI_STORAGE',
                                                 'VALORE_SCAGLIONI_UD_VERSATE'))
                                JOIN ORG_SCAGLIONE_TARIFFA scg_last
                                    ON (scg_last.id_tariffa =
                                        tariffa.id_tariffa)
                          WHERE     servizio_fatt.id_fattura_ente =
                                    fattura.id_fattura_ente
                                AND scg_last.ni_ini_scaglione =
                                    (SELECT MAX (scg_max.ni_ini_scaglione) -- prendo ultimo scaglione della tariffa
                                       FROM ORG_SCAGLIONE_TARIFFA scg_max
                                      WHERE scg_max.id_tariffa =
                                            tariffa.id_tariffa)
                                AND servizio_fatt.qt_scaglione_servizio_fattura >
                                    scg_last.ni_fine_scaglione)
               THEN
                   '1'
               ELSE
                   '0'
           END
               fl_superamento_scaglione,
           -- info dati storno
           fattura.cd_registro_emis_nota_credito,
           fattura.aa_emiss_nota_credito,
           fattura.cd_emis_nota_credito,
           fattura.dt_emis_nota_credito,
           fattura.nt_emis_nota_credito,
           fl_da_riemis,
           fattura.NM_AMBIENTE,
           fattura.NM_ENTE,
           fattura.NM_STRUT
      FROM ORG_FATTURA_ENTE  fattura
           JOIN ORG_ENTE_SIAM enteconvenz
               ON (fattura.id_ente_convenz = enteconvenz.id_ente_siam)
           JOIN ORG_AMBIENTE_ENTE_CONVENZ amb
               ON (amb.ID_AMBIENTE_ENTE_CONVENZ =
                   enteconvenz.ID_AMBIENTE_ENTE_CONVENZ)
           JOIN sacer.ORG_CATEG_ENTE categoria
               ON (enteconvenz.ID_CATEG_ENTE = categoria.id_categ_ente)
           JOIN ORG_ACCORDO_ENTE accordo
               ON (accordo.id_ente_convenz = enteconvenz.id_ente_siam)
           JOIN ORG_TIPO_ACCORDO ti_accordo
               ON (ti_accordo.id_tipo_accordo = accordo.id_tipo_accordo)
           LEFT JOIN ORG_TARIFFARIO tariffario
               ON (tariffario.id_tariffario = accordo.ID_TARIFFARIO)
           LEFT JOIN ORG_CLASSE_ENTE_CONVENZ classe
               ON (classe.ID_CLASSE_ENTE_CONVENZ =
                   accordo.id_classe_ente_convenz)
           LEFT JOIN ORG_CD_IVA iva ON (iva.id_cd_iva = accordo.id_cd_iva)
           JOIN ORG_STATO_FATTURA_ENTE stato_cor
               ON (stato_cor.id_stato_fattura_ente =
                   fattura.id_stato_fattura_ente_cor)
           JOIN ORG_STATO_FATTURA_ENTE stato_calc
               ON (    stato_calc.id_fattura_ente = fattura.id_fattura_ente
                   AND stato_calc.ti_stato_fattura_ente = 'CALCOLATA')
     WHERE (   accordo.dt_dec_accordo =
               (SELECT MAX (accordo_max.dt_dec_accordo)
                  FROM ORG_ACCORDO_ENTE accordo_max
                 WHERE accordo_max.id_ente_convenz = enteconvenz.id_ente_siam)
            OR accordo.dt_dec_accordo IS NULL);

-- changeset root:1753259446745-86
COMMENT ON COLUMN ORG_V_VIS_FATTURA.ID_STATO_CALC IS 'PK.1';

-- changeset root:1753259446745-87
COMMENT ON COLUMN ORG_V_VIS_FATTURA.ID_FATTURA_ENTE IS 'PK.2';

-- changeset root:1753259446745-88
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_AMB_ENTE_XENTE" ("ID_USER_IAM", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ") AS select
 usr.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz
 
from USR_USER usr
join USR_DICH_ABIL_ENTE_CONVENZ dich_all_ambienti
 on (dich_all_ambienti.id_user_iam = usr.id_user_iam
 and dich_all_ambienti.ti_scopo_dich_abil_ente = 'ALL_AMBIENTI')

join ORG_AMBIENTE_ENTE_CONVENZ amb
 on (amb.nm_ambiente_ente_convenz like '%'
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))

UNION

select 
 usr.id_user_iam, 
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz
from USR_USER usr
join USR_DICH_ABIL_ENTE_CONVENZ dich_un_ambiente
 on (dich_un_ambiente.id_user_iam = usr.id_user_iam
 and dich_un_ambiente.ti_scopo_dich_abil_ente = 'UN_AMBIENTE')

join ORG_AMBIENTE_ENTE_CONVENZ amb
 on (amb.id_ambiente_ente_convenz = dich_un_ambiente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate));

-- changeset root:1753259446745-89
COMMENT ON COLUMN USR_V_ABIL_AMB_ENTE_XENTE.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-90
COMMENT ON COLUMN USR_V_ABIL_AMB_ENTE_XENTE.ID_AMBIENTE_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-91
CREATE OR REPLACE FORCE VIEW "IAM_V_GETVAL_PARAM_BY_AMB" ("TI_APPART", "ID_PARAM_APPLIC", "NM_PARAM_APPLIC", "ID_VALORE_PARAM_APPLIC", "DS_VALORE_PARAM_APPLIC", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ") AS select
 'AMBIENTE' ti_appart,
 par.id_param_applic, par.nm_param_applic,
 val.id_valore_param_applic, val.ds_valore_param_applic,
 amb.id_ambiente_ente_convenz, amb.nm_ambiente_ente_convenz
 
from IAM_PARAM_APPLIC par
join IAM_VALORE_PARAM_APPLIC val
	on (val.id_param_applic = par.id_param_applic)
join ORG_AMBIENTE_ENTE_CONVENZ amb
	on (amb.id_ambiente_ente_convenz = val.id_ambiente_ente_convenz)
where par.fl_appart_applic in ('1', '0')
and par.fl_appart_ambiente = '1'
and par.fl_apparte_ente = '0'

and val.ti_appart = 'AMBIENTE'

UNION

select
 'APPLIC' ti_appart,
 par.id_param_applic, par.nm_param_applic,
 val.id_valore_param_applic, val.ds_valore_param_applic,
 amb.id_ambiente_ente_convenz, amb.nm_ambiente_ente_convenz
 
from IAM_PARAM_APPLIC par
join IAM_VALORE_PARAM_APPLIC val
	on (val.id_param_applic = par.id_param_applic)
join ORG_AMBIENTE_ENTE_CONVENZ amb
	on (amb.nm_ambiente_ente_convenz like '%')
	
where par.fl_appart_applic = '1'
and par.fl_appart_ambiente = '1'
and par.fl_apparte_ente = '0'

and val.ti_appart = 'APPLIC'

and not exists (select *
				from IAM_VALORE_PARAM_APPLIC val_amb
				where val_amb.id_param_applic = par.id_param_applic
				and val_amb.id_ambiente_ente_convenz = amb.id_ambiente_ente_convenz
				and val_amb.ti_appart = 'AMBIENTE'
				);

-- changeset root:1753259446745-92
COMMENT ON COLUMN IAM_V_GETVAL_PARAM_BY_AMB.ID_VALORE_PARAM_APPLIC IS 'PK.1';

-- changeset root:1753259446745-93
CREATE OR REPLACE FORCE VIEW "USR_V_UNENTE_BY_CONSERV" ("ID_USER_IAM_COR", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ", "ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_ENTE_CONSERV", "ID_APPART_COLLEG_ENTI", "ID_ENTE_PRODUT_COLLEG", "DS_CAUSALE_DICH") AS select												-- enti a cui utente corrente e' abilitato appartenenti ad ambienti validi con ente conserv quello dell'utente inserito / modificato
 user_cor.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 ente.id_ente_siam,
 ente.nm_ente_siam,
 amb.id_ente_conserv,
 null id_appart_colleg_enti,
 null id_ente_produt_colleg,
 'Appartenenza ad ente conservatore' ds_causale_dich

from USR_USER user_cor
join USR_ABIL_ENTE_SIAM abil_ente
	on (abil_ente.id_user_iam = user_cor.id_user_iam)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = abil_ente.id_ente_siam
	and ente.ti_ente ='CONVENZIONATO')						-- qualunque ente convenzionato abilitato ad utente corrente
join ORG_AMBIENTE_ENTE_CONVENZ amb							-- ambienti validi
 on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))

UNION

select												-- enti a cui utente corrente e' abilitato appartenenti ad ambienti validi con ente gestore quello dell'utente inserito / modificato
 user_cor.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 ente.id_ente_siam,
 ente.nm_ente_siam,
 amb.id_ente_gestore id_ente_conserv,
 null id_appart_colleg_enti,
 null id_ente_produt_colleg,
 'Appartenenza ad ente conservatore' ds_causale_dich

from USR_USER user_cor
join USR_ABIL_ENTE_SIAM abil_ente
	on (abil_ente.id_user_iam = user_cor.id_user_iam)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = abil_ente.id_ente_siam
	and ente.ti_ente ='CONVENZIONATO')						-- qualunque ente convenzionato abilitato ad utente corrente
join ORG_AMBIENTE_ENTE_CONVENZ amb							-- ambienti validi
 on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))

UNION

select  											-- enti a cui utente corrente e' abilitato collegati ad ente conserv dell'utente inserito / modificato
 user_cor.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 ente.id_ente_siam,
 ente.nm_ente_siam,
 app_colleg_produt.id_ente_convenz id_ente_conserv,
 app_colleg.id_appart_colleg_enti,
 app_colleg.id_ente_convenz id_ente_produt_colleg,
 'Ente produttore collegato ad ente a cui appartiene utente' ds_causale_dich

from ORG_APPART_COLLEG_ENTI app_colleg_produt						-- colleg del ente produt dell'utente inserito / modificato 
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join ORG_APPART_COLLEG_ENTI app_colleg								-- enti produt collegati
	on (app_colleg.id_colleg_enti_convenz = app_colleg_produt.id_colleg_enti_convenz
	and app_colleg.dt_ini_val <= trunc(sysdate)
	and app_colleg.dt_fin_val >= trunc(sysdate)
	and app_colleg.id_ente_convenz != app_colleg_produt.id_ente_convenz)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = app_colleg.id_ente_convenz)
join ORG_AMBIENTE_ENTE_CONVENZ amb							-- ambienti validi
 on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))

where app_colleg_produt.dt_ini_val <= trunc(sysdate)
and app_colleg_produt.dt_fin_val >= trunc(sysdate)

and ente.id_ente_siam in (select abil_ente.id_ente_siam				-- ente abilitati ad utente corrente
						 from USR_ABIL_ENTE_SIAM abil_ente
						 where abil_ente.id_user_iam = user_cor.id_user_iam
						 );

-- changeset root:1753259446745-94
COMMENT ON COLUMN USR_V_UNENTE_BY_CONSERV.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-95
COMMENT ON COLUMN USR_V_UNENTE_BY_CONSERV.ID_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-96
CREATE OR REPLACE FORCE VIEW "USR_V_UNAMB_BY_AMMIN" ("ID_USER_IAM_COR", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ", "DS_CAUSALE_DICH") AS select
 user_cor.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 'Appartenenza ad ente amministratore' ds_causale_dich
 
from USR_USER user_cor
join USR_DICH_ABIL_ENTE_CONVENZ dich_abil_ente
 on (dich_abil_ente.id_user_iam = user_cor.id_user_iam
 and dich_abil_ente.ti_scopo_dich_abil_ente = 'ALL_AMBIENTI')
join ORG_AMBIENTE_ENTE_CONVENZ amb
 on (amb.id_ambiente_ente_convenz > 0
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))


UNION

select
 user_cor.id_user_iam, 
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 'Appartenenza ad ente amministratore' ds_causale_dich
 
from USR_USER user_cor
join USR_DICH_ABIL_ENTE_CONVENZ dich_abil_ente
 on (dich_abil_ente.id_user_iam = user_cor.id_user_iam
 and dich_abil_ente.ti_scopo_dich_abil_ente = 'UN_AMBIENTE')
join ORG_AMBIENTE_ENTE_CONVENZ amb
 on (amb.id_ambiente_ente_convenz = dich_abil_ente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate));

-- changeset root:1753259446745-97
COMMENT ON COLUMN USR_V_UNAMB_BY_AMMIN.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-98
COMMENT ON COLUMN USR_V_UNAMB_BY_AMMIN.ID_AMBIENTE_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-99
CREATE OR REPLACE FORCE VIEW "USR_V_UNAMB_BY_CONSERV" ("ID_USER_IAM_COR", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ", "ID_ENTE_CONSERV", "DS_CAUSALE_DICH") AS select												-- ambienti abilitati ad utente corr ALL_AMBIENTI con ente conservatore come ente conservatore
 user_cor.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 amb.id_ente_conserv,
 'Appartenenza ad ente conservatore' ds_causale_dich
 
from USR_USER user_cor
join USR_DICH_ABIL_ENTE_CONVENZ dich_abil_ente
 on (dich_abil_ente.id_user_iam = user_cor.id_user_iam
 and dich_abil_ente.ti_scopo_dich_abil_ente = 'ALL_AMBIENTI')
join ORG_AMBIENTE_ENTE_CONVENZ amb
 on (amb.id_ambiente_ente_convenz > 0
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))

UNION

select													-- ambienti abilitati ad utente corr ALL_AMBIENTI con ente conservatore come ente gestore
 user_cor.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 amb.id_ente_gestore id_ente_conserv,
 'Appartenenza ad ente conservatore' ds_causale_dich
 
from USR_USER user_cor
join USR_DICH_ABIL_ENTE_CONVENZ dich_abil_ente
 on (dich_abil_ente.id_user_iam = user_cor.id_user_iam
 and dich_abil_ente.ti_scopo_dich_abil_ente = 'ALL_AMBIENTI')
join ORG_AMBIENTE_ENTE_CONVENZ amb
 on (amb.id_ambiente_ente_convenz > 0
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))
 

UNION

select												-- ambiente abilitato ad utente corr UN_AMBIENTE con ente conservatore come ente conservatore
 user_cor.id_user_iam, 
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 amb.id_ente_conserv,
 'Appartenenza ad ente conservatore' ds_causale_dich
 
from USR_USER user_cor
join USR_DICH_ABIL_ENTE_CONVENZ dich_abil_ente
 on (dich_abil_ente.id_user_iam = user_cor.id_user_iam
 and dich_abil_ente.ti_scopo_dich_abil_ente = 'UN_AMBIENTE')
join ORG_AMBIENTE_ENTE_CONVENZ amb
 on (amb.id_ambiente_ente_convenz = dich_abil_ente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))
 
UNION

select													-- ambiente abilitato ad utente corr UN_AMBIENTE con ente conservatore come ente gestore
 user_cor.id_user_iam, 
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 amb.id_ente_gestore id_ente_conserv,
 'Appartenenza ad ente conservatore' ds_causale_dich
 
from USR_USER user_cor
join USR_DICH_ABIL_ENTE_CONVENZ dich_abil_ente
 on (dich_abil_ente.id_user_iam = user_cor.id_user_iam
 and dich_abil_ente.ti_scopo_dich_abil_ente = 'UN_AMBIENTE')
join ORG_AMBIENTE_ENTE_CONVENZ amb
 on (amb.id_ambiente_ente_convenz = dich_abil_ente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate));

-- changeset root:1753259446745-100
COMMENT ON COLUMN USR_V_UNAMB_BY_CONSERV.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-101
COMMENT ON COLUMN USR_V_UNAMB_BY_CONSERV.ID_AMBIENTE_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-102
CREATE OR REPLACE FORCE VIEW "USR_V_UNAMB_BY_GESTORE" ("ID_USER_IAM_COR", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ", "ID_ENTE_GESTORE", "DS_CAUSALE_DICH") AS select
 user_cor.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 amb.id_ente_gestore,
 'Appartenenza ad ente gestore' ds_causale_dich
 
from USR_USER user_cor
join USR_DICH_ABIL_ENTE_CONVENZ dich_abil_ente
 on (dich_abil_ente.id_user_iam = user_cor.id_user_iam
 and dich_abil_ente.ti_scopo_dich_abil_ente = 'ALL_AMBIENTI')
join ORG_AMBIENTE_ENTE_CONVENZ amb
 on (amb.id_ambiente_ente_convenz > 0
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))


UNION

select
 user_cor.id_user_iam, 
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 amb.id_ente_gestore,
 'Appartenenza ad ente gestore' ds_causale_dich
 
from USR_USER user_cor
join USR_DICH_ABIL_ENTE_CONVENZ dich_abil_ente
 on (dich_abil_ente.id_user_iam = user_cor.id_user_iam
 and dich_abil_ente.ti_scopo_dich_abil_ente = 'UN_AMBIENTE')
join ORG_AMBIENTE_ENTE_CONVENZ amb
 on (amb.id_ambiente_ente_convenz = dich_abil_ente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate));

-- changeset root:1753259446745-103
COMMENT ON COLUMN USR_V_UNAMB_BY_GESTORE.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-104
COMMENT ON COLUMN USR_V_UNAMB_BY_GESTORE.ID_AMBIENTE_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-105
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_ENTI_CONVENZ_SERVITI" ("ID_ENTE_CONVENZ_SERVENTE", "ID_ENTE_CONVENZ_SERVITO", "NM_ENTE_CONVENZ_SERVITO", "ID_AMBIENTE_SERVITO", "NM_AMBIENTE_SERVITO", "DS_AMBIENTE_SERVITO") AS select 										-- ente servente e' amministratore: enti serviti tutti
ente_servente.id_ente_siam id_ente_convenz_servente,
ente_servito.id_ente_siam id_ente_siam_servito, ente_servito.nm_ente_siam nm_ente_siam_servito, 
amb_servito.id_ambiente_ente_convenz id_ambiente_servito, amb_servito.nm_ambiente_ente_convenz nm_ambiente_servito, amb_servito.ds_ambiente_ente_convenz ds_ambiente_servito

from ORG_ENTE_SIAM ente_servente

join ORG_ENTE_SIAM ente_servito
	on (ente_servito.id_ente_siam > 0
	and ente_servito.ti_ente = 'CONVENZIONATO')
join ORG_AMBIENTE_ENTE_CONVENZ amb_servito
	on (amb_servito.id_ambiente_ente_convenz = ente_servito.id_ambiente_ente_convenz)

where ente_servente.ti_ente_convenz = 'AMMINISTRATORE'

UNION

select 										-- ente servente e' conservatore: enti serviti quelli appartenenti ad ambiente con tale ente conservatore (come conservatore o gestore)
ente_servente.id_ente_siam id_ente_convenz_servente,
ente_servito.id_ente_siam id_ente_siam_servito, ente_servito.nm_ente_siam nm_ente_siam_servito, 
amb_servito.id_ambiente_ente_convenz id_ambiente_servito, amb_servito.nm_ambiente_ente_convenz nm_ambiente_servito, amb_servito.ds_ambiente_ente_convenz ds_ambiente_servito

from ORG_ENTE_SIAM ente_servente

join ORG_ENTE_SIAM ente_servito
	on (ente_servito.id_ente_siam > 0
	and ente_servito.ti_ente = 'CONVENZIONATO')
join ORG_AMBIENTE_ENTE_CONVENZ amb_servito
	on (amb_servito.id_ambiente_ente_convenz = ente_servito.id_ambiente_ente_convenz
	and (amb_servito.id_ente_conserv = ente_servente.id_ente_siam
	or amb_servito.id_ente_gestore = ente_servente.id_ente_siam))

where ente_servente.ti_ente_convenz = 'CONSERVATORE'

UNION

select 										-- ente servente e' gestore: enti serviti quelli appartenenti ad ambiente con tale ente gestore
ente_servente.id_ente_siam id_ente_convenz_servente,
ente_servito.id_ente_siam id_ente_siam_servito, ente_servito.nm_ente_siam nm_ente_siam_servito, 
amb_servito.id_ambiente_ente_convenz id_ambiente_servito, amb_servito.nm_ambiente_ente_convenz nm_ambiente_servito, amb_servito.ds_ambiente_ente_convenz ds_ambiente_servito

from ORG_ENTE_SIAM ente_servente

join ORG_ENTE_SIAM ente_servito
	on (ente_servito.id_ente_siam > 0
	and ente_servito.ti_ente = 'CONVENZIONATO')
join ORG_AMBIENTE_ENTE_CONVENZ amb_servito
	on (amb_servito.id_ambiente_ente_convenz = ente_servito.id_ambiente_ente_convenz
	and amb_servito.id_ente_gestore = ente_servente.id_ente_siam)

where ente_servente.ti_ente_convenz = 'GESTORE'

UNION

select 										-- ente servente e' produttore: se stesso
ente_servente.id_ente_siam id_ente_convenz_servente,
ente_servito.id_ente_siam id_ente_siam_servito, ente_servito.nm_ente_siam nm_ente_siam_servito, 
amb_servito.id_ambiente_ente_convenz id_ambiente_servito, amb_servito.nm_ambiente_ente_convenz nm_ambiente_servito, amb_servito.ds_ambiente_ente_convenz ds_ambiente_servito

from ORG_ENTE_SIAM ente_servente

join ORG_ENTE_SIAM ente_servito
	on (ente_servito.id_ente_siam = ente_servente.id_ente_siam
	and ente_servito.ti_ente = 'CONVENZIONATO')
join ORG_AMBIENTE_ENTE_CONVENZ amb_servito
	on (amb_servito.id_ambiente_ente_convenz = ente_servito.id_ambiente_ente_convenz)

where ente_servente.ti_ente_convenz = 'PRODUTTORE';

-- changeset root:1753259446745-106
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_ABIL_ENTE" ("ID_USER_IAM_GESTITO", "ID_ENTE_UTENTE", "TI_SCOPO_ABIL", "ID_AMBIENTE_ENTE_CONVENZ", "ID_ENTE_SIAM", "NM_COMPOSITO_ENTE", "DS_CAUSALE_ABIL", "FL_ABIL_AUTOMATICA", "ID_APPART_COLLEG_ENTI", "ID_SUPT_EST_ENTE_CONVENZ", "ID_ACCORDO_VIGIL") AS select 
 tmp.id_user_iam_gestito,
 tmp.id_ente_utente,
 
 tmp.ti_scopo_abil,
 tmp.id_ambiente_ente_convenz, tmp.id_ente_siam,
 tmp.nm_composito_ente,
 tmp.ds_causale_abil,
 
 tmp.fl_abil_automatica,
 tmp.id_appart_colleg_enti,
 tmp.id_supt_est_ente_convenz,
 tmp.id_accordo_vigil
 
 from (
		select 
		 usr.id_user_iam id_user_iam_gestito,
		 usr.id_ente_siam id_ente_utente,

		 'UN_AMBIENTE' ti_scopo_abil,
		 amb.id_ambiente_ente_convenz,
		 0 id_ente_siam,
		 amb.nm_ambiente_ente_convenz nm_composito_ente,
		 
		 dich_abil_ente.ds_causale_dich ds_causale_abil,
		 '0' fl_abil_automatica,
		 dich_abil_ente.id_appart_colleg_enti,
		 null id_supt_est_ente_convenz,
		 null id_accordo_vigil

		from USR_USER usr
		join USR_DICH_ABIL_ENTE_CONVENZ dich_abil_ente
			on (dich_abil_ente.id_user_iam = usr.id_user_iam
			and dich_abil_ente.ti_scopo_dich_abil_ente = 'ALL_AMBIENTI')
		join ORG_AMBIENTE_ENTE_CONVENZ amb
			on (amb.id_ambiente_ente_convenz > 0)
			
		UNION

		select 
		 usr.id_user_iam id_user_iam_gestito,
		 usr.id_ente_siam id_ente_utente,

		 'UN_AMBIENTE' ti_scopo_abil,
		 amb.id_ambiente_ente_convenz,
		 0 id_ente_siam,
		 amb.nm_ambiente_ente_convenz nm_composito_ente,
		 
		 dich_abil_ente.ds_causale_dich ds_causale_abil,
		 '0' fl_abil_automatica,
		 dich_abil_ente.id_appart_colleg_enti,
		 null id_supt_est_ente_convenz,
		 null id_accordo_vigil

		from USR_USER usr
		join USR_DICH_ABIL_ENTE_CONVENZ dich_abil_ente
			on (dich_abil_ente.id_user_iam = usr.id_user_iam
			and dich_abil_ente.ti_scopo_dich_abil_ente = 'UN_AMBIENTE')
		join ORG_AMBIENTE_ENTE_CONVENZ amb
			on (amb.id_ambiente_ente_convenz = dich_abil_ente.id_ambiente_ente_convenz)
			
		UNION

		select 
		 usr.id_user_iam id_user_iam_gestito,
		 usr.id_ente_siam id_ente_utente,

		 'UN_ENTE' ti_scopo_abil,
		 amb.id_ambiente_ente_convenz,
		 ente.id_ente_siam,
		 amb.nm_ambiente_ente_convenz || '/' || ente.nm_ente_siam nm_composito_ente,
		 
		 dich_abil_ente.ds_causale_dich ds_causale_abil,
		 '0' fl_abil_automatica,
		 dich_abil_ente.id_appart_colleg_enti,
		 null id_supt_est_ente_convenz,
		 null id_accordo_vigil

		from USR_USER usr
		join USR_DICH_ABIL_ENTE_CONVENZ dich_abil_ente
			on (dich_abil_ente.id_user_iam = usr.id_user_iam
			and dich_abil_ente.ti_scopo_dich_abil_ente = 'UN_ENTE')
		join ORG_ENTE_SIAM ente
			on (ente.id_ente_siam = dich_abil_ente.id_ente_convenz)
		join ORG_AMBIENTE_ENTE_CONVENZ amb
			on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz)
			
			
		UNION

		select 
		 usr.id_user_iam id_user_iam_gestito,
		 usr.id_ente_siam id_ente_utente,

		 'UN_ENTE' ti_scopo_abil,
		 case
			when amb.nm_ambiente_ente_convenz is not null
				then amb.id_ambiente_ente_convenz
				else 0
		 end id_ambiente_ente_convenz,
		 ente.id_ente_siam,
		 case
			when amb.nm_ambiente_ente_convenz is not null
				then amb.nm_ambiente_ente_convenz || '/' || ente.nm_ente_siam
				else ente.nm_ente_siam
		 end nm_composito_ente,
		 abil_ente.ds_causale_abil,
		 abil_ente.fl_abil_automatica,
		 abil_ente.id_appart_colleg_enti,
		 abil_ente.id_supt_est_ente_convenz,
		 abil_ente.id_accordo_vigil

		from USR_USER usr
		join USR_ABIL_ENTE_SIAM abil_ente
			on (abil_ente.id_user_iam = usr.id_user_iam
			and abil_ente.id_dich_abil_ente_convenz is null)
		join ORG_ENTE_SIAM ente
			on (ente.id_ente_siam = abil_ente.id_ente_siam)
		left join ORG_AMBIENTE_ENTE_CONVENZ amb
			on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz)
	) tmp;

-- changeset root:1753259446745-107
COMMENT ON COLUMN USR_V_LIS_ABIL_ENTE.ID_USER_IAM_GESTITO IS 'PK.1';

-- changeset root:1753259446745-108
COMMENT ON COLUMN USR_V_LIS_ABIL_ENTE.ID_AMBIENTE_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-109
COMMENT ON COLUMN USR_V_LIS_ABIL_ENTE.ID_ENTE_SIAM IS 'PK.3';

-- changeset root:1753259446745-110
CREATE OR REPLACE FORCE VIEW "ORG_V_RIC_ACCORDO_ENTE" ("ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "ID_USER_IAM_COR", "ID_TIPO_ACCORDO", "CD_TIPO_ACCORDO", "ID_TIPO_GESTIONE_ACCORDO", "CD_TIPO_GESTIONE_ACCORDO", "ID_ACCORDO_ENTE", "CD_REGISTRO_REPERTORIO", "AA_REPERTORIO", "CD_KEY_REPERTORIO", "FL_RECESSO", "DT_DEC_ACCORDO_INFO", "DT_SCAD_ACCORDO", "DT_DEC_ACCORDO", "DT_FINE_VALID_ACCORDO", "DS_NOTA_FATTURAZIONE", "TI_FASCIA_STANDARD", "TI_FASCIA_MANUALE", "FL_ESISTONO_GEST_ACC", "FL_ESISTE_NOTA_FATTURAZIONE", "FL_FASCIA_MANUALE", "FL_ESISTONO_SAE", "FL_ESISTONO_SUE", "TI_STATO_ACCORDO") AS SELECT DISTINCT
           ente.id_ente_siam,
           ente.nm_ente_siam,
           ente.id_ambiente_ente_convenz,
           ambiente.nm_ambiente_ente_convenz,
           abil_ente.id_user_iam
               id_user_iam_cor,
           ti_accordo.id_tipo_accordo,
           ti_accordo.cd_tipo_accordo,
           --tipigestacc.id_tipo_gestione_accordo,
            (SELECT LISTAGG (tga.id_tipo_gestione_accordo, ';')
                    WITHIN GROUP (ORDER BY
                                      tga.id_tipo_gestione_accordo)
               FROM ORG_TIPI_GESTIONE_ACCORDO  tga
                    JOIN ORG_GESTIONE_ACCORDO ga
                        ON (ga.id_tipo_gestione_accordo =
                            tga.id_tipo_gestione_accordo)
              WHERE ga.id_accordo_ente = accordo.id_accordo_ente)
               id_tipo_gestione_accordo,
           --tipigestacc.cd_tipo_gestione_accordo,
            (SELECT LISTAGG (tga.cd_tipo_gestione_accordo, '; ')
                        WITHIN GROUP (ORDER BY tga.cd_tipo_gestione_accordo)
               FROM ORG_TIPI_GESTIONE_ACCORDO  tga
                    JOIN ORG_GESTIONE_ACCORDO ga
                        ON (ga.id_tipo_gestione_accordo =
                            tga.id_tipo_gestione_accordo)
              WHERE ga.id_accordo_ente = accordo.id_accordo_ente)
               cd_tipo_gestione_accordo,
           accordo.id_accordo_ente,
           accordo.cd_registro_repertorio,
           accordo.aa_repertorio,
           accordo.cd_key_repertorio,
           accordo.fl_recesso,
           accordo.dt_dec_accordo_info,
           accordo.dt_scad_accordo,
           accordo.dt_dec_accordo,
           accordo.dt_fine_valid_accordo,
           accordo.ds_nota_fatturazione,
           fascia_standard.ti_fascia,
           fascia_manuale.ti_fascia,
           CASE
               WHEN EXISTS
                        (SELECT NVL (gestacc.cd_key_gest_accordo, NULL)
                           FROM ORG_GESTIONE_ACCORDO  gestacc
                                JOIN org_accordo_ente accordo1
                                    ON (gestacc.id_accordo_ente =
                                        accordo1.id_accordo_ente)
                          WHERE     accordo1.id_ente_convenz =
                                    ente.id_ente_siam
                                AND accordo.id_accordo_ente =
                                    accordo1.id_accordo_ente)
               THEN
                   '1'
               ELSE
                   '0'
           END
               fl_esistono_gest_acc,
           CASE
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE     accordo_ente.id_ente_convenz =
                                    ente.id_ente_siam
                                AND accordo.ds_nota_fatturazione IS NOT NULL)
               THEN
                   '1'
               ELSE
                   '0'
           END
               fl_esiste_nota_fatturazione,
           CASE
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE     accordo_ente.id_ente_convenz =
                                    ente.id_ente_siam
                                AND accordo.id_accordo_ente =
                                    accordo_ente.id_accordo_ente
                                AND accordo.id_fascia_storage_manuale_accordo
                                        IS NOT NULL)
               THEN
                   '1'
               ELSE
                   '0'
           END
               fl_fascia_manuale,
           CASE
               WHEN EXISTS
                        (SELECT NVL (dt_erog, NULL)
                           --WHEN EXISTS (select *
                           FROM ORG_SERVIZIO_EROG  serviziosae
                                JOIN ORG_ACCORDO_ENTE accordi
                                    ON (    accordi.id_accordo_ente =
                                            serviziosae.id_accordo_ente
                                        AND serviziosae.dt_erog IS NOT NULL)
                                JOIN ORG_TIPO_SERVIZIO tipo_servizio
                                    ON (    tipo_servizio.id_tipo_servizio =
                                            serviziosae.id_tipo_servizio
                                        AND tipo_servizio.tipo_fatturazione IN
                                                ('ANNUALE'))
                          WHERE     accordi.id_ente_convenz =
                                    ente.id_ente_siam
                                AND accordi.id_accordo_ente =
                                    accordo.id_accordo_ente)
               --AND tipo_servizio.tipo_fatturazione IN ('ANNUALE'))
               --and serviziosae.dt_erog is not null
               --and tipo_servizio.tipo_fatturazione = 'ANNUALE')
               THEN
                   '1'
               ELSE
                   '0'
           END
               fl_esistono_sae,
           CASE
               --WHEN EXISTS (select nvl (dt_erog, null)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_SERVIZIO_EROG  serviziosue
                                JOIN ORG_ACCORDO_ENTE accordi
                                    ON (    accordi.id_accordo_ente =
                                            serviziosue.id_accordo_ente
                                        AND serviziosue.dt_erog IS NOT NULL)
                                JOIN ORG_TIPO_SERVIZIO tipo_servizio
                                    ON (    tipo_servizio.id_tipo_servizio =
                                            serviziosue.id_tipo_servizio
                                        AND tipo_servizio.tipo_fatturazione IN
                                                ('UNA_TANTUM'))
                          WHERE     accordi.id_ente_convenz =
                                    ente.id_ente_siam
                                AND accordi.id_accordo_ente =
                                    accordo.id_accordo_ente)
               --and serviziosue.dt_erog is not null)
               --and tipo_servizio.tipo_fatturazione = 'UNA_TANTUM')
               THEN
                   '1'
               ELSE
                   '0'
           END
               fl_esistono_sue,
           CASE
               --a) Accordo valido (data corrente compresa tra data decorrenza e data fine validità e < data scadenza)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE     accordo_ente.id_ente_convenz =
                                    ente.id_ente_siam
                                AND accordo_ente.dt_fine_valid_accordo >=
                                    TRUNC (SYSDATE)
                                AND accordo_ente.dt_dec_accordo <=
                                    TRUNC (SYSDATE)
                                AND accordo_ente.dt_scad_accordo >
                                    TRUNC (SYSDATE))
               THEN
                   'Accordo valido'
               --b) Accordo valido in corso di rinnovo (data corrente > data scadenza e < data fine validità)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE     accordo_ente.id_ente_convenz =
                                    ente.id_ente_siam
                                AND TRUNC (SYSDATE) <
                                    accordo_ente.dt_fine_valid_accordo
                                --and accordo_ente.dt_dec_accordo < trunc (sysdate)
                                AND TRUNC (SYSDATE) >
                                    accordo_ente.dt_scad_accordo)
               THEN
                   'Accordo valido in corso rinnovo'
               --c) Accordo non valido per recesso (data fine validità < data scadenza e data corrente > data fine validità)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE     accordo_ente.id_ente_convenz =
                                    ente.id_ente_siam
                                AND accordo_ente.dt_fine_valid_accordo <
                                    accordo_ente.dt_scad_accordo
                                AND TRUNC (SYSDATE) >
                                    accordo_ente.dt_fine_valid_accordo)
               THEN
                   'Accordo non valido per recesso'
               --d) Accordo non valido per scadenza (data fine validità >= data scadenza =< data corrente)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE     accordo_ente.id_ente_convenz =
                                    ente.id_ente_siam
                                AND accordo_ente.dt_fine_valid_accordo >=
                                    accordo_ente.dt_scad_accordo
                                AND TRUNC (SYSDATE) >
                                    accordo_ente.dt_fine_valid_accordo)
               THEN
                   'Accordo non valido per scadenza'
               --e) Accordo in corso di stipula (data corrente < data decorrenza e dt_registrazione is null o > data corrente)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE        accordo_ente.id_ente_convenz =
                                       ente.id_ente_siam
                                   AND TRUNC (SYSDATE) <
                                       accordo_ente.dt_dec_accordo
                                   AND accordo_ente.dt_reg_accordo IS NULL
                                OR accordo_ente.dt_reg_accordo > SYSDATE)
               THEN
                   'Accordo in corso di stipula'
               ELSE
                   --Accordo non valido (data corrente < data decorrenza o > data fine validità)
                   'Accordo non valido'
           END
               ti_stato_accordo
      FROM ORG_ENTE_SIAM  ente
           JOIN ORG_AMBIENTE_ENTE_CONVENZ ambiente
               ON (ambiente.id_ambiente_ente_convenz =
                   ente.id_ambiente_ente_convenz)
           JOIN USR_ABIL_ENTE_SIAM abil_ente
               ON (abil_ente.id_ente_siam = ente.id_ente_siam)
           LEFT JOIN ORG_ACCORDO_ENTE accordo
               ON (accordo.id_ente_convenz = ente.id_ente_siam)
           LEFT JOIN ORG_FASCIA_STORAGE_ACCORDO fascia_standard
               ON (accordo.id_fascia_storage_standard_accordo =
                   fascia_standard.id_fascia_storage_accordo)
           LEFT JOIN ORG_FASCIA_STORAGE_ACCORDO fascia_manuale
               ON (accordo.id_fascia_storage_manuale_accordo =
                   fascia_manuale.id_fascia_storage_accordo)
           LEFT JOIN ORG_TIPO_ACCORDO ti_accordo
               ON (ti_accordo.id_tipo_accordo = accordo.id_tipo_accordo)
           LEFT JOIN org_ente_ark_rif archivisti
               ON (archivisti.id_ente_convenz = ente.id_ente_siam)
           LEFT JOIN usr_user utente_ark
               ON (utente_ark.id_user_iam = archivisti.id_user_iam)
           LEFT JOIN ORG_GESTIONE_ACCORDO gestacc
               ON (gestacc.id_accordo_ente = accordo.id_accordo_ente)
           LEFT JOIN ORG_TIPI_GESTIONE_ACCORDO tipigestacc
               ON (tipigestacc.id_tipo_gestione_accordo =
                   gestacc.id_tipo_gestione_accordo)
     WHERE     ente.ti_ente = 'CONVENZIONATO'
           AND accordo.id_accordo_ente IS NOT NULL;

-- changeset root:1753259446745-111
COMMENT ON COLUMN ORG_V_RIC_ACCORDO_ENTE.ID_USER_IAM_COR IS 'PK.2';

-- changeset root:1753259446745-112
COMMENT ON COLUMN ORG_V_RIC_ACCORDO_ENTE.ID_ACCORDO_ENTE IS 'PK.1';

-- changeset root:1753259446745-113
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_AMB_ENTE_CONVENZ" ("ID_USER_IAM", "NM_USERID", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ") AS select distinct
usr.id_user_iam, usr.nm_userid,
ente.id_ambiente_ente_convenz, amb_ente.nm_ambiente_ente_convenz,
amb_ente.ds_ambiente_ente_convenz

from USR_USER usr
join USR_ABIL_ENTE_SIAM abil_ente
 on (abil_ente.id_user_iam = usr.id_user_iam)
join ORG_ENTE_SIAM ente
 on (ente.id_ente_siam = abil_ente.id_ente_siam)
join ORG_AMBIENTE_ENTE_CONVENZ amb_ente
 on (amb_ente.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz);

-- changeset root:1753259446745-114
COMMENT ON COLUMN USR_V_ABIL_AMB_ENTE_CONVENZ.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-115
COMMENT ON COLUMN USR_V_ABIL_AMB_ENTE_CONVENZ.ID_AMBIENTE_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-116
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ENTE_CONVENZ" ("ID_USER_IAM", "NM_USERID", "ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ") AS select 
usr.id_user_iam, usr.nm_userid,
abil_ente.id_ente_siam, ente.nm_ente_siam,
ente.id_ambiente_ente_convenz, amb_ente.nm_ambiente_ente_convenz

from USR_USER usr
join USR_ABIL_ENTE_SIAM abil_ente
 on (abil_ente.id_user_iam = usr.id_user_iam)
join ORG_ENTE_SIAM ente
 on (ente.id_ente_siam = abil_ente.id_ente_siam)
join ORG_AMBIENTE_ENTE_CONVENZ amb_ente
 on (amb_ente.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz);

-- changeset root:1753259446745-117
COMMENT ON COLUMN USR_V_ABIL_ENTE_CONVENZ.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-118
COMMENT ON COLUMN USR_V_ABIL_ENTE_CONVENZ.ID_ENTE_CONVENZ IS 'PK.1';

-- changeset root:1753259446745-119
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ENTE_TO_ADD" ("ID_USER_IAM", "ID_ENTE_CONVENZ", "ID_DICH_ABIL_ENTE_CONVENZ", "ID_APPART_COLLEG_ENTI", "DS_CAUSALE_ABIL") AS select
tmp.id_user_iam, tmp.id_ente_siam, tmp.id_dich_abil_ente_convenz,
tmp.id_appart_colleg_enti,
tmp.ds_causale_dich

from (	select usr.id_user_iam, ente.id_ente_siam, dich.id_dich_abil_ente_convenz,
		dich.id_appart_colleg_enti,
		dich.ds_causale_dich
		from USR_USER usr
		join USR_DICH_ABIL_ENTE_CONVENZ dich
		 on (dich.id_user_iam = usr.id_user_iam
		 and dich.ti_scopo_dich_abil_ente = 'ALL_AMBIENTI')
		
		join ORG_AMBIENTE_ENTE_CONVENZ amb_ente
		 on (amb_ente.id_ambiente_ente_convenz like '%')
		join ORG_ENTE_SIAM ente
		 on (ente.id_ambiente_ente_convenz = amb_ente.id_ambiente_ente_convenz)
		 
		UNION
		
		select usr.id_user_iam, ente.id_ente_siam, dich.id_dich_abil_ente_convenz,
		dich.id_appart_colleg_enti,
		dich.ds_causale_dich
		from USR_USER usr
		join USR_DICH_ABIL_ENTE_CONVENZ dich
		 on (dich.id_user_iam = usr.id_user_iam
		 and dich.ti_scopo_dich_abil_ente = 'UN_AMBIENTE')
		
		join ORG_AMBIENTE_ENTE_CONVENZ amb_ente
		 on (amb_ente.id_ambiente_ente_convenz = dich.id_ambiente_ente_convenz)
		join ORG_ENTE_SIAM ente
		 on (ente.id_ambiente_ente_convenz = amb_ente.id_ambiente_ente_convenz)
		 
		UNION
		
		select usr.id_user_iam, ente.id_ente_siam, dich.id_dich_abil_ente_convenz,
		dich.id_appart_colleg_enti,
		dich.ds_causale_dich
		from USR_USER usr
		join USR_DICH_ABIL_ENTE_CONVENZ dich
		 on (dich.id_user_iam = usr.id_user_iam
		 and dich.ti_scopo_dich_abil_ente = 'UN_ENTE')
		
		join ORG_ENTE_SIAM ente
		 on (ente.id_ente_siam = dich.id_ente_convenz)
	 ) tmp
where not exists (select *
				  from USR_ABIL_ENTE_SIAM abil_ente
				  where abil_ente.id_user_iam = tmp.id_user_iam
				  and abil_ente.id_ente_siam = tmp.id_ente_siam
				  );

-- changeset root:1753259446745-120
COMMENT ON COLUMN USR_V_ABIL_ENTE_TO_ADD.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-121
COMMENT ON COLUMN USR_V_ABIL_ENTE_TO_ADD.ID_ENTE_CONVENZ IS 'PK.1';

-- changeset root:1753259446745-122
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ENTE_COLLEG_TO_ADD" ("ID_USER_IAM_COR", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ", "ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_USER_IAM_GESTITO", "ID_APPART_COLLEG_ENTI", "ID_ENTE_PRODUT_COLLEG", "DS_CAUSALE_ABIL") AS select  											-- enti a cui utente corrente e' abilitato collegati ad ente produt dell'utente inserito / modificato
 user_cor.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 ente.id_ente_siam,
 ente.nm_ente_siam,

 user_gestito.id_user_iam id_user_iam_gestito,

 app_colleg.id_appart_colleg_enti,
 app_colleg.id_ente_convenz id_ente_produt_colleg,
 'Ente produttore collegato ad ente a cui appartiene utente' ds_causale_abil

from USR_USER user_gestito
join ORG_APPART_COLLEG_ENTI app_colleg_produt						-- colleg del ente produt dell'utente inserito / modificato 
	on (app_colleg_produt.id_ente_convenz = user_gestito.id_ente_siam
	and app_colleg_produt.dt_ini_val <= trunc(sysdate)
	and app_colleg_produt.dt_fin_val >= trunc(sysdate))
join ORG_APPART_COLLEG_ENTI app_colleg								-- enti produt collegati
	on (app_colleg.id_colleg_enti_convenz = app_colleg_produt.id_colleg_enti_convenz
	and app_colleg.dt_ini_val <= trunc(sysdate)
	and app_colleg.dt_fin_val >= trunc(sysdate)
	and app_colleg.id_ente_convenz != app_colleg_produt.id_ente_convenz)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = app_colleg.id_ente_convenz)
join ORG_AMBIENTE_ENTE_CONVENZ amb									-- ambienti validi
 on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)

where ente.id_ente_siam in (select abil_ente.id_ente_siam				-- ente abilitati ad utente corrente
							 from USR_ABIL_ENTE_SIAM abil_ente
							 where abil_ente.id_user_iam = user_cor.id_user_iam
							 )
and ente.id_ente_siam not in (select abil_ente.id_ente_siam				-- ente non abilitati ad utente gestito
							 from USR_ABIL_ENTE_SIAM abil_ente
							 where abil_ente.id_user_iam = user_gestito.id_user_iam
							 );

-- changeset root:1753259446745-123
COMMENT ON COLUMN USR_V_ABIL_ENTE_COLLEG_TO_ADD.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-124
COMMENT ON COLUMN USR_V_ABIL_ENTE_COLLEG_TO_ADD.ID_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-125
COMMENT ON COLUMN USR_V_ABIL_ENTE_COLLEG_TO_ADD.ID_USER_IAM_GESTITO IS 'PK.1';

-- changeset root:1753259446745-126
CREATE OR REPLACE FORCE VIEW "ORG_V_MEDIA_ANNUALE_ENTE_CONVENZ" ("AMBIENTE_ENTE", "NM_AMBIENTE_ENTE_CONVENZ", "NM_ENTE_SIAM", "ID_ACCORDO_ENTE", "DT_DEC_ACCORDO", "CD_TIPO_ACCORDO", "MESI_VALIDITA", "NUM_UD", "NUM_DOC", "NUM_COMP", "DIM_BYTES", "DIM_BYTES_MEDIA_ANNO") AS SELECT
	struts.NM_AMBIENTE_ENTE_CONVENZ ||' / '||struts.NM_ENTE_SIAM as ambiente_ente,
	struts.nm_ambiente_ente_convenz,
    struts.nm_ente_siam,
    struts.id_accordo_ente,
    struts.dt_dec_accordo,
    struts.cd_tipo_accordo,
    round(months_between(sysdate, struts.dt_dec_accordo)) AS mesi_validita,
    SUM(mon.ni_unita_doc_vers) - SUM(mon.ni_unita_doc_annul) AS num_ud,
    SUM(mon.ni_doc_vers) + SUM(mon.ni_doc_agg) - SUM(mon.ni_doc_annul_ud) AS num_doc,
    SUM(mon.ni_comp_vers) + SUM(mon.ni_comp_agg) - SUM(mon.ni_comp_annul_ud) AS num_comp,
    SUM(mon.ni_size_vers) + SUM(mon.ni_size_agg) - SUM(mon.ni_size_annul_ud) AS dim_bytes,
    trunc(12 *((SUM(mon.ni_size_vers) + SUM(mon.ni_size_agg) - SUM(mon.ni_size_annul_ud)) / round(months_between(sysdate, struts.dt_dec_accordo)))) AS dim_bytes_media_anno -- media annuale sul numero di anni "interi" già trascorsi    
   
FROM
    sacer.mon_conta_ud_doc_comp    mon,
    (
        SELECT
            str.id_strut,
			ambiente.nm_ambiente_ente_convenz,
            ente.nm_ente_siam,
            str.nm_strut,            
            acc.id_accordo_ente,
            acc.dt_dec_accordo,
            acc.id_cluster_accordo,
            acc.id_fascia_storage_standard_accordo,
            acc.id_fascia_storage_manuale_accordo,
            tipo_acc.cd_tipo_accordo
        FROM
            sacer_iam.org_accordo_ente acc
            join sacer_iam.org_ente_siam ente on (acc.id_ente_convenz = ente.id_ente_siam)
			join sacer_iam.org_ambiente_ente_convenz ambiente on (ambiente.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz)
            join sacer_iam.org_tipo_accordo tipo_acc on (tipo_acc.id_tipo_accordo = acc.id_tipo_accordo),            
            sacer.org_strut               str			
        WHERE
            acc.id_ente_convenz = ente.id_ente_siam            
			AND ente.ti_ente_convenz = 'PRODUTTORE'
            AND nvl(acc.fl_recesso, 0) = 0
            AND nvl(acc.dt_dec_accordo, sysdate) <= sysdate			
            AND nvl(acc.dt_fine_valid_accordo, sysdate + 1) > sysdate 
            AND str.id_ente_convenz = ente.id_ente_siam
    )                              struts
WHERE
        mon.id_strut = struts.id_strut
    AND mon.dt_rif_conta >= struts.dt_dec_accordo
    AND struts.dt_dec_accordo+365<SYSDATE -- accordi validi da almeno un anno
GROUP BY
	struts.nm_ambiente_ente_convenz,
    struts.nm_ente_siam,
    struts.id_accordo_ente,
    struts.dt_dec_accordo,
    struts.cd_tipo_accordo,
    round(months_between(sysdate, struts.dt_dec_accordo));

-- changeset root:1753259446745-127
COMMENT ON COLUMN ORG_V_MEDIA_ANNUALE_ENTE_CONVENZ.ID_ACCORDO_ENTE IS 'PK.1';

-- changeset root:1753259446745-128
CREATE OR REPLACE FORCE VIEW "USR_V_UNENTE_BY_PRODUT" ("ID_USER_IAM_COR", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ", "ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_ENTE_PRODUT", "ID_APPART_COLLEG_ENTI", "ID_ENTE_PRODUT_COLLEG", "DS_CAUSALE_DICH") AS select											-- ente a cui utente corrente e' abilitato appartenente ad ambiente valido che e' ente produt dell'utente inserito / modificato
 user_cor.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 ente.id_ente_siam,
 ente.nm_ente_siam,
 ente_produt.id_ente_siam id_ente_produt,
 null id_appart_colleg_enti,
 null id_ente_produt_colleg,
 'Appartenenza ad ente produttore' ds_causale_dich

from USR_USER user_cor
join USR_ABIL_ENTE_SIAM abil_ente
	on (abil_ente.id_user_iam = user_cor.id_user_iam)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = abil_ente.id_ente_siam
	and ente.ti_ente ='CONVENZIONATO')						-- qualunque ente convenzionato abilitato ad utente corrente
join ORG_AMBIENTE_ENTE_CONVENZ amb							-- ambienti validi
 on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))
join ORG_ENTE_SIAM ente_produt							-- ente produt dell'utente inserito / modificato
	on (ente_produt.id_ente_siam = abil_ente.id_ente_siam
	and ente_produt.ti_ente = 'CONVENZIONATO')

UNION

select  											-- enti a cui utente corrente e' abilitato collegati ad ente produt dell'utente inserito / modificato
 user_cor.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 ente.id_ente_siam,
 ente.nm_ente_siam,
 app_colleg_produt.id_ente_convenz id_ente_produt,
 app_colleg.id_appart_colleg_enti,
 app_colleg.id_ente_convenz id_ente_produt_colleg,
 'Ente produttore collegato ad ente a cui appartiene utente' ds_causale_dich

from ORG_APPART_COLLEG_ENTI app_colleg_produt						-- colleg del ente produt dell'utente inserito / modificato 
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join ORG_APPART_COLLEG_ENTI app_colleg								-- enti produt collegati
	on (app_colleg.id_colleg_enti_convenz = app_colleg_produt.id_colleg_enti_convenz
	and app_colleg.dt_ini_val <= trunc(sysdate)
	and app_colleg.dt_fin_val >= trunc(sysdate)
	and app_colleg.id_ente_convenz != app_colleg_produt.id_ente_convenz)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = app_colleg.id_ente_convenz)
join ORG_AMBIENTE_ENTE_CONVENZ amb							-- ambienti validi
 on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))

where app_colleg_produt.dt_ini_val <= trunc(sysdate)
and app_colleg_produt.dt_fin_val >= trunc(sysdate)

and ente.id_ente_siam in (select abil_ente.id_ente_siam				-- ente abilitati ad utente corrente
						 from USR_ABIL_ENTE_SIAM abil_ente
						 where abil_ente.id_user_iam = user_cor.id_user_iam
						 );

-- changeset root:1753259446745-129
COMMENT ON COLUMN USR_V_UNENTE_BY_PRODUT.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-130
COMMENT ON COLUMN USR_V_UNENTE_BY_PRODUT.ID_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-131
CREATE OR REPLACE FORCE VIEW "USR_V_UNENTE_BY_AMMIN" ("ID_USER_IAM_COR", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ", "ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "DS_CAUSALE_DICH") AS select
 user_cor.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 ente.id_ente_siam,
 ente.nm_ente_siam,
 'Appartenenza ad ente amministratore' ds_causale_dich
 
from USR_USER user_cor
join USR_ABIL_ENTE_SIAM abil_ente
	on (abil_ente.id_user_iam = user_cor.id_user_iam)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = abil_ente.id_ente_siam
	and ente.ti_ente ='CONVENZIONATO')						-- qualunque ente convenzionato abilitato ad utente corrente
join ORG_AMBIENTE_ENTE_CONVENZ amb							-- ambienti validi
 on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate));

-- changeset root:1753259446745-132
COMMENT ON COLUMN USR_V_UNENTE_BY_AMMIN.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-133
COMMENT ON COLUMN USR_V_UNENTE_BY_AMMIN.ID_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-134
CREATE OR REPLACE FORCE VIEW "USR_V_UNENTE_BY_GESTORE" ("ID_USER_IAM_COR", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ", "ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_ENTE_GESTORE", "ID_APPART_COLLEG_ENTI", "ID_ENTE_PRODUT_COLLEG", "DS_CAUSALE_DICH") AS select												-- enti a cui utente corrente e' abilitato appartenenti ad ambienti validi con ente gestore dell'utente inserito / modificato
 user_cor.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 ente.id_ente_siam,
 ente.nm_ente_siam,
 amb.id_ente_gestore,
 null id_appart_colleg_enti,
 null id_ente_produt_colleg,
 'Appartenenza ad ente gestore' ds_causale_dich

from USR_USER user_cor
join USR_ABIL_ENTE_SIAM abil_ente
	on (abil_ente.id_user_iam = user_cor.id_user_iam)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = abil_ente.id_ente_siam
	and ente.ti_ente ='CONVENZIONATO')						-- qualunque ente convenzionato abilitato ad utente corrente
join ORG_AMBIENTE_ENTE_CONVENZ amb							-- ambienti validi
 on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))

UNION

select  											-- enti a cui utente corrente e' abilitato collegati ad ente gestore dell'utente inserito / modificato
 user_cor.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 ente.id_ente_siam,
 ente.nm_ente_siam,
 app_colleg_produt.id_ente_convenz id_ente_gestore,
 app_colleg.id_appart_colleg_enti,
 app_colleg.id_ente_convenz id_ente_produt_colleg,
 'Ente produttore collegato ad ente a cui appartiene utente' ds_causale_dich

from ORG_APPART_COLLEG_ENTI app_colleg_produt						-- colleg del ente produt dell'utente inserito / modificato 
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join ORG_APPART_COLLEG_ENTI app_colleg								-- enti produt collegati
	on (app_colleg.id_colleg_enti_convenz = app_colleg_produt.id_colleg_enti_convenz
	and app_colleg.dt_ini_val <= trunc(sysdate)
	and app_colleg.dt_fin_val >= trunc(sysdate)
	and app_colleg.id_ente_convenz != app_colleg_produt.id_ente_convenz)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = app_colleg.id_ente_convenz)
join ORG_AMBIENTE_ENTE_CONVENZ amb							-- ambienti validi
 on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))

where app_colleg_produt.dt_ini_val <= trunc(sysdate)
and app_colleg_produt.dt_fin_val >= trunc(sysdate)

and ente.id_ente_siam in (select abil_ente.id_ente_siam				-- ente abilitati ad utente corrente
						 from USR_ABIL_ENTE_SIAM abil_ente
						 where abil_ente.id_user_iam = user_cor.id_user_iam
						 );

-- changeset root:1753259446745-135
COMMENT ON COLUMN USR_V_UNENTE_BY_GESTORE.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-136
COMMENT ON COLUMN USR_V_UNENTE_BY_GESTORE.ID_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-137
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ENTE_SUPPORTO_TO_ADD" ("ID_USER_IAM_COR", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ", "ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_USER_IAM_GESTITO", "ID_SUPT_EST_ENTE_CONVENZ", "ID_ENTE_FORNIT_EST", "DS_CAUSALE_ABIL") AS select  											-- enti che supportano ente cui l'utente appartiene
 user_cor.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 ente.id_ente_siam,
 ente.nm_ente_siam,
 
 user_gestito.id_user_iam id_user_iam_gestito,
 
 app_supporto.id_supt_est_ente_convenz,
 app_supporto.id_ente_fornit_est, --,
 'Ente produttore supportato da ente a cui appartiene utente' ds_causale_abil

from USR_USER user_gestito
join org_supt_esterno_ente_convenz app_supporto_produt						-- ente dell'utente inserito / modificato 
	on (app_supporto_produt.id_ente_fornit_est = user_gestito.id_ente_siam
	and app_supporto_produt.dt_ini_val <= trunc(sysdate)
	and app_supporto_produt.dt_fin_val >= trunc(sysdate))
join org_supt_esterno_ente_convenz app_supporto								
	on (app_supporto.id_ente_produt = app_supporto_produt.id_ente_produt
	and app_supporto.dt_ini_val <= trunc(sysdate)
	and app_supporto.dt_fin_val >= trunc(sysdate))

join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = app_supporto.id_ente_produt)
join ORG_AMBIENTE_ENTE_CONVENZ amb									-- ambienti validi
 on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz
 and amb.dt_ini_val <= trunc(sysdate)
 and amb.dt_fine_val >= trunc(sysdate))
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)

where ente.id_ente_siam in (select abil_ente.id_ente_siam				-- ente abilitati ad utente corrente
							 from USR_ABIL_ENTE_SIAM abil_ente
							 where abil_ente.id_user_iam = user_cor.id_user_iam
							 )
and ente.id_ente_siam not in (select abil_ente.id_ente_siam				-- ente non abilitati ad utente gestito
							 from USR_ABIL_ENTE_SIAM abil_ente
							 where abil_ente.id_user_iam = user_gestito.id_user_iam
							 );

-- changeset root:1753259446745-138
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_AMB_CONVENZ_XENTE" ("ID_USER_IAM", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ", "DT_INI_VAL", "DT_FINE_VAL", "ID_ENTE_CONSERV", "ID_ENTE_GESTORE", "NM_ENTE_CONSERV", "NM_ENTE_GESTORE") AS select
 usr.id_user_iam,
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 amb.dt_ini_val,
 amb.dt_fine_val, amb.id_ente_conserv, amb.id_ente_gestore,
 ente_conserv.nm_ente_siam ,
 ente_gestore.nm_ente_siam 
 
from USR_USER usr

join USR_DICH_ABIL_ENTE_CONVENZ abil_enteconvenz
 on (abil_enteconvenz.id_user_iam = usr.id_user_iam
 and abil_enteconvenz.ti_scopo_dich_abil_ente = 'ALL_AMBIENTI')

join ORG_AMBIENTE_ENTE_CONVENZ amb
 on (amb.NM_AMBIENTE_ENTE_CONVENZ like '%')
 
left join ORG_ENTE_SIAM ente_conserv 
	on (amb.id_ente_conserv = ente_conserv.id_ente_siam)
left  join ORG_ENTE_SIAM ente_gestore 
	on (amb.id_ente_gestore = ente_gestore.id_ente_siam)

UNION

select
 usr.id_user_iam, 
 amb.id_ambiente_ente_convenz,
 amb.nm_ambiente_ente_convenz,
 amb.ds_ambiente_ente_convenz,
 amb.dt_ini_val,
 amb.dt_fine_val, amb.id_ente_conserv, amb.id_ente_gestore,
 ente_conserv.nm_ente_siam ,
 ente_gestore.nm_ente_siam 
 
from USR_USER usr

join USR_DICH_ABIL_ENTE_CONVENZ abil_enteconvenz
 on (abil_enteconvenz.id_user_iam = usr.id_user_iam
 and abil_enteconvenz.ti_scopo_dich_abil_ente = 'UN_AMBIENTE')

join ORG_AMBIENTE_ENTE_CONVENZ amb
 on (amb.id_ambiente_ente_convenz = abil_enteconvenz.id_ambiente_ente_convenz)
 
left join ORG_ENTE_SIAM ente_conserv 
	on (amb.id_ente_conserv = ente_conserv.id_ente_siam)
left  join ORG_ENTE_SIAM ente_gestore 
	on (amb.id_ente_gestore = ente_gestore.id_ente_siam);

-- changeset root:1753259446745-139
COMMENT ON COLUMN USR_V_ABIL_AMB_CONVENZ_XENTE.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-140
COMMENT ON COLUMN USR_V_ABIL_AMB_CONVENZ_XENTE.ID_AMBIENTE_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-141
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_ENTI_SIAM_APP_ENTE" ("ID_USER_IAM_COR", "ID_ENTE_SIAM", "NM_ENTE_SIAM", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ") AS select 
 abil_ente.id_user_iam id_user_iam_cor,
 ente.id_ente_siam, ente.nm_ente_siam, 
 amb.id_ambiente_ente_convenz, amb.nm_ambiente_ente_convenz, amb.ds_ambiente_ente_convenz

from USR_ABIL_ENTE_SIAM abil_ente
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = abil_ente.id_ente_siam)
left join ORG_AMBIENTE_ENTE_CONVENZ amb
	on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz);

-- changeset root:1753259446745-142
COMMENT ON COLUMN USR_V_LIS_ENTI_SIAM_APP_ENTE.ID_ENTE_SIAM IS 'PK.1';

-- changeset root:1753259446745-143
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_ENTI_SIAM_CREA_USER" ("ID_RICH_GEST_USER", "ID_USER_IAM_COR", "ID_ENTE_SIAM", "NM_ENTE_SIAM", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ") AS select										-- ente della richiesta
rich.id_rich_gest_user,
user_cor.id_user_iam id_user_iam_cor,
ente.id_ente_siam, ente.nm_ente_siam, 
amb.id_ambiente_ente_convenz, amb.nm_ambiente_ente_convenz, amb.ds_ambiente_ente_convenz

from USR_RICH_GEST_USER rich
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = rich.id_ente_rich)
left join ORG_AMBIENTE_ENTE_CONVENZ amb
	on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz)

UNION

select										-- ente convenzionati collegati ad ente richiesta ed abilitati per utente corrente
rich.id_rich_gest_user,
abil_ente.id_user_iam id_user_iam_cor,
ente.id_ente_siam, ente.nm_ente_siam, 
amb.id_ambiente_ente_convenz, amb.nm_ambiente_ente_convenz, amb.ds_ambiente_ente_convenz

from USR_RICH_GEST_USER rich
join ORG_APPART_COLLEG_ENTI app_colleg_ente_rich
	on (app_colleg_ente_rich.id_ente_convenz = rich.id_ente_rich
	and app_colleg_ente_rich.dt_ini_val <= trunc(sysdate)
	and app_colleg_ente_rich.dt_fin_val >= trunc(sysdate))
join ORG_APPART_COLLEG_ENTI app_colleg
	on (app_colleg.id_colleg_enti_convenz = app_colleg_ente_rich.id_colleg_enti_convenz
	and app_colleg.dt_ini_val <= trunc(sysdate)
	and app_colleg.dt_fin_val >= trunc(sysdate)
	and app_colleg.id_ente_convenz != rich.id_ente_rich)
	
join USR_ABIL_ENTE_SIAM abil_ente
	on (abil_ente.id_ente_siam = app_colleg.id_ente_convenz)

join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = abil_ente.id_ente_siam)
join ORG_AMBIENTE_ENTE_CONVENZ amb
	on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz);

-- changeset root:1753259446745-144
COMMENT ON COLUMN USR_V_LIS_ENTI_SIAM_CREA_USER.ID_USER_IAM_COR IS 'PK.2';

-- changeset root:1753259446745-145
COMMENT ON COLUMN USR_V_LIS_ENTI_SIAM_CREA_USER.ID_ENTE_SIAM IS 'PK.1';

-- changeset root:1753259446745-146
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_ENTI_MODIF_APP_ENTE" ("ID_RICH_GEST_USER", "ID_USER_IAM_MODIF", "ID_USER_IAM_COR", "ID_ENTE_SIAM", "NM_ENTE_SIAM", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ") AS select													-- ente della richiesta (diverso da ente dell'utente in modifica)
rich.id_rich_gest_user,
user_modif.id_user_iam id_user_iam_modif,
user_cor.id_user_iam id_user_iam_cor,
ente.id_ente_siam, ente.nm_ente_siam, 
amb.id_ambiente_ente_convenz, amb.nm_ambiente_ente_convenz, amb.ds_ambiente_ente_convenz

from USR_RICH_GEST_USER rich
join USR_USER user_modif
	on (user_modif.id_user_iam > 0)
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = rich.id_ente_rich)
left join ORG_AMBIENTE_ENTE_CONVENZ amb
	on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz)

UNION

select												-- ente convenzionati collegati ad ente richiesta ed abilitati per utente corrente (diverso da ente dell'utente in modifica)
rich.id_rich_gest_user,
user_modif.id_user_iam id_user_iam_modif,
abil_ente.id_user_iam id_user_iam_cor,
ente.id_ente_siam, ente.nm_ente_siam, 
amb.id_ambiente_ente_convenz, amb.nm_ambiente_ente_convenz, amb.ds_ambiente_ente_convenz

from USR_RICH_GEST_USER rich
join USR_USER user_modif
	on (user_modif.id_user_iam > 0)
join ORG_APPART_COLLEG_ENTI app_colleg_ente_rich
	on (app_colleg_ente_rich.id_ente_convenz = rich.id_ente_rich
	and app_colleg_ente_rich.dt_ini_val <= trunc(sysdate)
	and app_colleg_ente_rich.dt_fin_val >= trunc(sysdate))
join ORG_APPART_COLLEG_ENTI app_colleg
	on (app_colleg.id_colleg_enti_convenz = app_colleg_ente_rich.id_colleg_enti_convenz
	and app_colleg.dt_ini_val <= trunc(sysdate)
	and app_colleg.dt_fin_val >= trunc(sysdate)
	and app_colleg.id_ente_convenz != rich.id_ente_rich
	and app_colleg.id_ente_convenz != user_modif.id_ente_siam)
	
join USR_ABIL_ENTE_SIAM abil_ente
	on (abil_ente.id_ente_siam = app_colleg.id_ente_convenz)

join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = abil_ente.id_ente_siam)
join ORG_AMBIENTE_ENTE_CONVENZ amb
	on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz)

UNION

select 												-- ente serviti dall'ente della richiesta ed abilitati per utente corrente (diverso da ente dell'utente in modifica)
rich.id_rich_gest_user,
user_modif.id_user_iam id_user_iam_modif,
abil_ente.id_user_iam id_user_iam_cor,
ente_servito.id_ente_convenz_servito, ente_servito.nm_ente_convenz_servito, 
ente_servito.id_ambiente_servito, ente_servito.nm_ambiente_servito, ente_servito.ds_ambiente_servito

from USR_RICH_GEST_USER rich
join USR_USER user_modif
	on (user_modif.id_user_iam > 0)
join USR_V_LIS_ENTI_CONVENZ_SERVITI ente_servito
	on (ente_servito.id_ente_convenz_servente = rich.id_ente_rich
	and ente_servito.id_ente_convenz_servito != rich.id_ente_rich
	and ente_servito.id_ente_convenz_servito != user_modif.id_ente_siam)
	
join USR_ABIL_ENTE_SIAM abil_ente
	on (abil_ente.id_ente_siam = ente_servito.id_ente_convenz_servito)
	
UNION 

select distinct 									-- fornitori che supportano gli enti serviti dall'ente della richiesta ed abilitati per utente corrente (diverso da ente dell'utente in modifica)
rich.id_rich_gest_user,
user_modif.id_user_iam id_user_iam_modif,
abil_ente.id_user_iam id_user_iam_cor,
ente.id_ente_siam, ente.nm_ente_siam, 
null id_ambiente_ente_convenz, null nm_ambiente_ente_convenz, null ds_ambiente_ente_convenz

from USR_RICH_GEST_USER rich
join USR_USER user_modif
	on (user_modif.id_user_iam > 0)
join USR_V_LIS_ENTI_CONVENZ_SERVITI ente_servito
	on (ente_servito.id_ente_convenz_servente = rich.id_ente_rich)
join ORG_SUPT_ESTERNO_ENTE_CONVENZ supt
	on (supt.id_ente_produt = ente_servito.id_ente_convenz_servito
	and supt.dt_ini_val <= trunc(sysdate)
	and supt.dt_fin_val >= trunc(sysdate)
	and supt.id_ente_fornit_est != rich.id_ente_rich
	and supt.id_ente_fornit_est != user_modif.id_ente_siam)
join USR_ABIL_ENTE_SIAM abil_ente
	on (abil_ente.id_ente_siam = supt.id_ente_fornit_est)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = abil_ente.id_ente_siam)
	
UNION

select distinct									-- organi di vigilanza che vigilano gli enti serviti dall'ente della richiesta ed abilitati per utente corrente (diverso da ente dell'utente in modifica)
rich.id_rich_gest_user,
user_modif.id_user_iam id_user_iam_modif,
abil_ente.id_user_iam id_user_iam_cor,
ente.id_ente_siam, ente.nm_ente_siam, 
null id_ambiente_ente_convenz, null nm_ambiente_ente_convenz, null ds_ambiente_ente_convenz

from USR_RICH_GEST_USER rich
join USR_USER user_modif
	on (user_modif.id_user_iam > 0)
join USR_V_LIS_ENTI_CONVENZ_SERVITI ente_servito
	on (ente_servito.id_ente_convenz_servente = rich.id_ente_rich)
join ORG_VIGIL_ENTE_PRODUT vigil
	on (vigil.id_ente_produt = ente_servito.id_ente_convenz_servito
	and vigil.dt_ini_val <= trunc(sysdate)
	and vigil.dt_fin_val >= trunc(sysdate))
join ORG_ACCORDO_VIGIL acc_vigil
	on (acc_vigil.id_accordo_vigil = vigil.id_accordo_vigil
	and acc_vigil.id_ente_organo_vigil != rich.id_ente_rich
	and acc_vigil.id_ente_organo_vigil != user_modif.id_ente_siam)
	
join USR_ABIL_ENTE_SIAM abil_ente
	on (abil_ente.id_user_iam > 0
	and abil_ente.id_ente_siam = acc_vigil.id_ente_organo_vigil)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = abil_ente.id_ente_siam)
	
UNION

select distinct									-- ente dell'utente in modifica
rich.id_rich_gest_user,
user_modif.id_user_iam id_user_iam_modif,
user_cor.id_user_iam id_user_iam_cor,
ente.id_ente_siam, ente.nm_ente_siam, 
amb.id_ambiente_ente_convenz, amb.nm_ambiente_ente_convenz, amb.ds_ambiente_ente_convenz

from USR_RICH_GEST_USER rich
join USR_USER user_modif
	on (user_modif.id_user_iam > 0)
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = user_modif.id_ente_siam)
left join ORG_AMBIENTE_ENTE_CONVENZ amb
	on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz);

-- changeset root:1753259446745-147
COMMENT ON COLUMN USR_V_LIS_ENTI_MODIF_APP_ENTE.ID_USER_IAM_COR IS 'PK.2';

-- changeset root:1753259446745-148
COMMENT ON COLUMN USR_V_LIS_ENTI_MODIF_APP_ENTE.ID_ENTE_SIAM IS 'PK.1';

-- changeset root:1753259446745-149
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_ENTI_SIAM_PER_AZIO" ("ID_RICH_GEST_USER", "ID_USER_IAM_COR", "ID_ENTE_SIAM", "NM_ENTE_SIAM", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "DS_AMBIENTE_ENTE_CONVENZ") AS SELECT                                             -- ente della richiesta
           rich.id_rich_gest_user,
           user_cor.id_user_iam     id_user_iam_cor,
           ente.id_ente_siam,
           ente.nm_ente_siam,
           amb.id_ambiente_ente_convenz,
           amb.nm_ambiente_ente_convenz,
           amb.ds_ambiente_ente_convenz
      FROM USR_RICH_GEST_USER  rich
           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
           JOIN ORG_ENTE_SIAM ente ON (ente.id_ente_siam = rich.id_ente_rich)
           LEFT JOIN ORG_AMBIENTE_ENTE_CONVENZ amb
               ON (amb.id_ambiente_ente_convenz =
                   ente.id_ambiente_ente_convenz)
    UNION
    SELECT -- ente convenzionati collegati ad ente richiesta ed abilitati per utente corrente
           rich.id_rich_gest_user,
           abil_ente.id_user_iam     id_user_iam_cor,
           ente.id_ente_siam,
           ente.nm_ente_siam,
           amb.id_ambiente_ente_convenz,
           amb.nm_ambiente_ente_convenz,
           amb.ds_ambiente_ente_convenz
      FROM USR_RICH_GEST_USER  rich
           JOIN ORG_APPART_COLLEG_ENTI app_colleg_ente_rich
               ON (    app_colleg_ente_rich.id_ente_convenz =
                       rich.id_ente_rich
                   AND app_colleg_ente_rich.dt_ini_val <= TRUNC (SYSDATE)
                   AND app_colleg_ente_rich.dt_fin_val >= TRUNC (SYSDATE))
           JOIN ORG_APPART_COLLEG_ENTI app_colleg
               ON (    app_colleg.id_colleg_enti_convenz =
                       app_colleg_ente_rich.id_colleg_enti_convenz
                   AND app_colleg.dt_ini_val <= TRUNC (SYSDATE)
                   AND app_colleg.dt_fin_val >= TRUNC (SYSDATE)
                   AND app_colleg.id_ente_convenz != rich.id_ente_rich)
           JOIN USR_ABIL_ENTE_SIAM abil_ente
               ON (abil_ente.id_ente_siam = app_colleg.id_ente_convenz)
           JOIN ORG_ENTE_SIAM ente
               ON (ente.id_ente_siam = abil_ente.id_ente_siam)
           JOIN ORG_AMBIENTE_ENTE_CONVENZ amb
               ON (amb.id_ambiente_ente_convenz =
                   ente.id_ambiente_ente_convenz)
    UNION
    SELECT -- ente serviti dall'ente della richiesta ed abilitati per utente corrente
           rich.id_rich_gest_user,
           abil_ente.id_user_iam     id_user_iam_cor,
           ente_servito.id_ente_convenz_servito,
           ente_servito.nm_ente_convenz_servito,
           ente_servito.id_ambiente_servito,
           ente_servito.nm_ambiente_servito,
           ente_servito.ds_ambiente_servito
      FROM USR_RICH_GEST_USER  rich
           JOIN USR_V_LIS_ENTI_CONVENZ_SERVITI ente_servito
               ON (ente_servito.id_ente_convenz_servente = rich.id_ente_rich)
           JOIN USR_ABIL_ENTE_SIAM abil_ente
               ON (abil_ente.id_ente_siam =
                   ente_servito.id_ente_convenz_servito)
    UNION
    SELECT DISTINCT -- fornitori che supportano l'ente della richiesta ed abilitati per utente corrente
                    rich.id_rich_gest_user,
                    abil_ente.id_user_iam     id_user_iam_cor,
                    ente.id_ente_siam,
                    ente.nm_ente_siam,
                    NULL                      id_ambiente_ente_convenz,
                    NULL                      nm_ambiente_ente_convenz,
                    NULL                      ds_ambiente_ente_convenz
      FROM USR_RICH_GEST_USER  rich
           JOIN USR_V_LIS_ENTI_CONVENZ_SERVITI ente_servito
               ON (ente_servito.id_ente_convenz_servente = rich.id_ente_rich)
           JOIN ORG_SUPT_ESTERNO_ENTE_CONVENZ supt
               ON (    supt.id_ente_produt =
                       ente_servito.id_ente_convenz_servito
                   AND supt.dt_ini_val <= TRUNC (SYSDATE)
                   AND supt.dt_fin_val >= TRUNC (SYSDATE))
           JOIN USR_ABIL_ENTE_SIAM abil_ente
               ON (    abil_ente.id_user_iam > 0
                   AND abil_ente.id_ente_siam = supt.id_ente_fornit_est)
           JOIN ORG_ENTE_SIAM ente
               ON (ente.id_ente_siam = abil_ente.id_ente_siam)
    UNION
    SELECT DISTINCT -- organi di vigilanza che vigilano l'ente della richiesta ed abilitati per utente corrente
                    rich.id_rich_gest_user,
                    abil_ente.id_user_iam     id_user_iam_cor,
                    ente.id_ente_siam,
                    ente.nm_ente_siam,
                    NULL                      id_ambiente_ente_convenz,
                    NULL                      nm_ambiente_ente_convenz,
                    NULL                      ds_ambiente_ente_convenz
      FROM USR_RICH_GEST_USER  rich
           JOIN USR_V_LIS_ENTI_CONVENZ_SERVITI ente_servito
               ON (ente_servito.id_ente_convenz_servente = rich.id_ente_rich)
           JOIN ORG_VIGIL_ENTE_PRODUT vigil
               ON (    vigil.id_ente_produt =
                       ente_servito.id_ente_convenz_servito
                   AND vigil.dt_ini_val <= TRUNC (SYSDATE)
                   AND vigil.dt_fin_val >= TRUNC (SYSDATE))
           JOIN ORG_ACCORDO_VIGIL acc_vigil
               ON (acc_vigil.id_accordo_vigil = vigil.id_accordo_vigil)
           JOIN USR_ABIL_ENTE_SIAM abil_ente
               ON (    abil_ente.id_user_iam > 0
                   AND abil_ente.id_ente_siam =
                       acc_vigil.id_ente_organo_vigil)
           JOIN ORG_ENTE_SIAM ente
               ON (ente.id_ente_siam = abil_ente.id_ente_siam)
    UNION
    SELECT DISTINCT -- organi di vigilanza che abbiano come ente corrispondente l'ente della richiesta ed abilitati per utente corrente
                    rich.id_rich_gest_user,
                    abil_ente.id_user_iam     id_user_iam_cor,
                    ente.id_ente_siam,
                    ente.nm_ente_siam,
                    NULL                      id_ambiente_ente_convenz,
                    NULL                      nm_ambiente_ente_convenz,
                    NULL                      ds_ambiente_ente_convenz
      FROM USR_RICH_GEST_USER  rich
           JOIN ORG_ENTE_SIAM ente
               ON (rich.id_ente_rich = ente.id_ente_produt_corrisp)
           JOIN USR_ABIL_ENTE_SIAM abil_ente
               ON (    abil_ente.id_user_iam > 0
                   AND abil_ente.id_ente_siam = ente.id_ente_siam);

-- changeset root:1753259446745-150
CREATE OR REPLACE FORCE VIEW "LOG_V_RIC_ACCESSI" ("ID_EVENTO", "NM_USERID", "CD_IND_IP_CLIENT", "CD_IND_SERVER", "DT_EVENTO", "TIPO_EVENTO", "DS_EVENTO", "NM_NOME_USER", "NM_COGNOME_USER", "CD_FISC_USER", "DS_EMAIL_USER", "CD_ID_ESTERNO", "TIPO_USER") AS SELECT "ID_EVENTO",
           "NM_USERID",
           "CD_IND_IP_CLIENT",
           "CD_IND_SERVER",
           "DT_EVENTO",
           "TIPO_EVENTO",
           "DS_EVENTO",
           "NM_NOME_USER",
           "NM_COGNOME_USER",
           "CD_FISC_USER",
           "DS_EMAIL_USER",
           "CD_ID_ESTERNO",
           "TIPO_USER"
      FROM (SELECT evento.id_evento_login_user     id_evento,
                   evento.nm_userid                nm_userid,
                   evento.cd_ind_ip_client         cd_ind_ip_client,
                   evento.cd_ind_server            cd_ind_server,
                   evento.dt_evento                dt_evento,
                   evento.tipo_evento              tipo_evento,
                   evento.ds_evento                ds_evento,
                   evento.nm_nome_user             nm_nome_user,
                   evento.nm_cognome_user          nm_cognome_user,
                   evento.cd_fisc_user             cd_fisc_user,
                   evento.ds_email_user            ds_email_user,
                   evento.cd_id_esterno            cd_id_esterno,
                   usr.tipo_user                   tipo_user
              FROM sacer_log.LOG_EVENTO_LOGIN_USER  evento
                   JOIN sacer_iam.USR_USER usr
                       ON (evento.nm_userid = usr.nm_userid)
            UNION
            SELECT log_login.id_login_user       id_evento,
                   log_login.nm_userid           nm_userid,
                   log_login.cd_ind_ip_client    cd_ind_ip_client,
                   log_login.cd_ind_server       cd_ind_server,
                   log_login.dt_evento           dt_evento,
                   CASE log_login.tipo_evento
                       WHEN 'LOGIN' THEN 'LOGIN_OK'
                       ELSE log_login.tipo_evento
                   END                           AS tipo_evento,
                      'Login SPID (Federa), id esterno: '
                   || log_login.CD_ID_ESTERNO    ds_evento,
                   ''                            nm_nome_user,
                   ''                            nm_cognome_user,
                   ''                            cd_fisc_user,
                   ''                            ds_email_user,
                   ''                            cd_id_esterno,
                   ''                            tipo_user
              FROM sacer_log.LOG_LOGIN_USER  log_login
                   JOIN sacer_iam.USR_USER usr
                       ON (log_login.nm_userid = usr.nm_userid)
             WHERE log_login.TIPO_UTENTE_AUTH = 'SPID_FEDERA'
            UNION
            SELECT evento.id_evento_login_user     id_evento,
                   evento.nm_userid                nm_userid,
                   evento.cd_ind_ip_client         cd_ind_ip_client,
                   evento.cd_ind_server            cd_ind_server,
                   evento.dt_evento                dt_evento,
                   evento.tipo_evento              tipo_evento,
                   evento.ds_evento                ds_evento,
                   evento.nm_nome_user             nm_nome_user,
                   evento.nm_cognome_user          nm_cognome_user,
                   evento.cd_fisc_user             cd_fisc_user,
                   evento.ds_email_user            ds_email_user,
                   evento.cd_id_esterno            cd_id_esterno,
                   ' '                             tipo_user -- Ci deve esssere lo spazio altrimenti lo considera NULL e non funzionano le query!!
              FROM sacer_log.LOG_EVENTO_LOGIN_USER evento
             WHERE evento.tipo_evento = 'BAD_CF');

-- changeset root:1753259446745-151
CREATE OR REPLACE FORCE VIEW "APL_V_LIS_SIST_VERS_PER_AUTOMA" ("ID_SISTEMA_VERSANTE", "NM_SISTEMA_VERSANTE", "CD_VERSIONE", "DS_SISTEMA_VERSANTE", "ID_ENTE_UTENTE") AS select 
 sis.id_sistema_versante,
 sis.nm_sistema_versante,
 sis.cd_versione,
 sis.ds_sistema_versante,
 sis.id_ente_siam id_ente_utente

from APL_SISTEMA_VERSANTE sis
where sis.fl_associa_persona_fisica = 0

UNION

select distinct
 sis.id_sistema_versante,
 sis.nm_sistema_versante,
 sis.cd_versione,
 sis.ds_sistema_versante,
 supt.id_ente_produt id_ente_utente

from APL_SISTEMA_VERSANTE sis
join ORG_ENTE_SIAM ente_fornit
	on (ente_fornit.id_ente_siam = sis.id_ente_siam)
join ORG_SUPT_ESTERNO_ENTE_CONVENZ supt
	on (supt.id_ente_fornit_est = ente_fornit.id_ente_siam
	and supt.dt_ini_val <= sysdate
	and supt.dt_fin_val >= sysdate)
	
where sis.fl_associa_persona_fisica = 0 
and sis.dt_fine_val >= trunc(sysdate)  
and sis.dt_ini_val <= trunc (sysdate)


UNION
select distinct
 sis.id_sistema_versante,
 sis.nm_sistema_versante,
 sis.cd_versione,
 sis.ds_sistema_versante,
 ente_fornit.id_ente_produt_corrisp id_ente_utente

from APL_SISTEMA_VERSANTE sis
join ORG_ENTE_SIAM ente_fornit
	on (ente_fornit.id_ente_siam = sis.id_ente_siam)
where sis.fl_associa_persona_fisica = 0 
and sis.dt_fine_val >= trunc(sysdate)  
and sis.dt_ini_val <= trunc (sysdate);

-- changeset root:1753259446745-152
COMMENT ON COLUMN APL_V_LIS_SIST_VERS_PER_AUTOMA.ID_SISTEMA_VERSANTE IS 'PK.1';

-- changeset root:1753259446745-153
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_DATI_SUPPORTO_TO_ADD" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_USER_IAM_GESTITO", "ID_USO_USER_APPLIC_GESTITO", "ID_ORGANIZ_IAM_STRUT", "ID_TIPO_DATO_IAM", "ID_ENTE_FORNIT_EST", "ID_ENTE_PRODUT_SUPP", "DS_CAUSALE_DICH") AS select 										-- strut sacer appartenenti ad enti produt supportati da fornitore dell'utente inserito / modificato
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,

 user_gestito.id_user_iam id_user_iam_gestito,
 uso_apl_gestito.id_uso_user_applic,

 strut_app_ente.id_organiz_iam id_organiz_iam_strut,
 tipo_dato.id_tipo_dato_iam,
 produt_supportati.id_supt_est_ente_convenz,
 produt_supportati.id_ente_produt id_ente_produt_supp,
 'Ente produttore supportato da fornitore' ds_causale_dich

from USR_USER user_gestito

join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join APL_APPLIC apl_cor
	on (apl_cor.nm_applic = 'SACER')	
join USR_USO_USER_APPLIC uso_apl_gestito
	on (uso_apl_gestito.id_user_iam = user_gestito.id_user_iam
	and uso_apl_gestito.id_applic = apl_cor.id_applic)

join ORG_SUPT_ESTERNO_ENTE_CONVENZ produt_supportati
	on (produt_supportati.dt_ini_val <= sysdate
	and produt_supportati.dt_fin_val >= sysdate)

join ORG_ENTE_CONVENZ_ORG strut_app_ente
	on (strut_app_ente.id_ente_convenz = produt_supportati.id_ente_produt
	and strut_app_ente.dt_ini_val <= trunc(sysdate)
	and strut_app_ente.dt_fine_val >= trunc(sysdate))
join USR_ORGANIZ_IAM org
  on (org.id_organiz_iam = strut_app_ente.id_organiz_iam
  and org.id_applic = apl_cor.id_applic)

join USR_TIPO_DATO_IAM tipo_dato
	on (tipo_dato.id_organiz_iam = org.id_organiz_iam)

where tipo_dato.id_tipo_dato_iam in (select abil_dati.id_tipo_dato_iam			-- tipi dato Sacer abilitati ad utente corrente
									 from USR_USO_USER_APPLIC uso_apl
									 join USR_ABIL_DATI abil_dati
											on (abil_dati.id_uso_user_applic = uso_apl.id_uso_user_applic)
									 where uso_apl.id_user_iam = user_cor.id_user_iam
									 and uso_apl.id_applic = apl_cor.id_applic
									 )
and tipo_dato.id_tipo_dato_iam not in (select abil_dati.id_tipo_dato_iam
									  from USR_USO_USER_APPLIC uso_apl
									  join USR_ABIL_DATI abil_dati
											on (abil_dati.id_uso_user_applic = uso_apl.id_uso_user_applic)
									  where uso_apl.id_user_iam = user_gestito.id_user_iam
									  and uso_apl.id_applic = apl_cor.id_applic
									  );

-- changeset root:1753259446745-154
COMMENT ON COLUMN USR_V_ABIL_DATI_SUPPORTO_TO_ADD.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-155
COMMENT ON COLUMN USR_V_ABIL_DATI_SUPPORTO_TO_ADD.ID_USER_IAM_GESTITO IS 'PK.2';

-- changeset root:1753259446745-156
COMMENT ON COLUMN USR_V_ABIL_DATI_SUPPORTO_TO_ADD.ID_TIPO_DATO_IAM IS 'PK.3';

-- changeset root:1753259446745-157
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_SUPPORTO_TO_ADD" ("ID_USER_IAM_COR", "ID_ENTE_FORNIT_EST", "NM_ENTE_FORNIT_EST", "ID_USER_IAM_GESTITO", "ID_USO_USER_APPLIC_GESTITO", "ID_ORGANIZ_IAM_STRUT", "ID_SUPT_EST_ENTE_CONVENZ", "ID_ENTE_PRODUT", "DS_CAUSALE_ABIL") AS select  											-- fornit esterni a cui utente corrente e' abilitato che supportano ente produt dell'utente inserito / modificato
 user_cor.id_user_iam,
 ente.id_ente_siam id_ente_fornit_est,
 ente.nm_ente_siam nm_ente_fornit_est,
 user_gestito.id_user_iam id_user_iam_gestito,
 uso_apl_gestito.id_uso_user_applic id_uso_user_applic_gestito,

 strut_app_ente.id_organiz_iam id_organiz_iam_strut,
 supt.id_supt_est_ente_convenz,
 supt.id_ente_produt,
 'Fornitore esterno che supporta ente a cui appartiene utente' ds_causale_abil

from USR_USER user_gestito
join APL_APPLIC apl_cor
	on (apl_cor.nm_applic in ( 'SACER', 'SACER_PING'))
join USR_USO_USER_APPLIC uso_apl_gestito
	on (uso_apl_gestito.id_user_iam = user_gestito.id_user_iam
	and uso_apl_gestito.id_applic = apl_cor.id_applic)
join ORG_SUPT_ESTERNO_ENTE_CONVENZ supt
	on (supt.id_ente_fornit_est = user_gestito.id_ente_siam
	and supt.dt_ini_val <= trunc(sysdate)
	and supt.dt_fin_val >= trunc(sysdate))
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = supt.id_ente_fornit_est)
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
	join ORG_ENTE_CONVENZ_ORG strut_app_ente
	on (strut_app_ente.id_ente_convenz = supt.id_ente_produt
	and strut_app_ente.dt_ini_val <= trunc(sysdate)
	and strut_app_ente.dt_fine_val >= trunc(sysdate))
	join USR_ORGANIZ_IAM org
  on (org.id_organiz_iam = strut_app_ente.id_organiz_iam
  and org.id_applic = apl_cor.id_applic)

where strut_app_ente.id_organiz_iam in (select abil_org.id_organiz_iam				-- strutture Sacer abilitate ad utente corrente
										 from USR_USO_USER_APPLIC uso_apl
										 join USR_ABIL_ORGANIZ abil_org
											on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)
										 where uso_apl.id_user_iam = user_cor.id_user_iam
										 and uso_apl.id_applic = apl_cor.id_applic
										 )
and strut_app_ente.id_organiz_iam not in (select abil_org.id_organiz_iam
										  from USR_USO_USER_APPLIC uso_apl
										 join USR_ABIL_ORGANIZ abil_org
											on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)
										 where uso_apl.id_user_iam = user_gestito.id_user_iam
										 and uso_apl.id_applic = apl_cor.id_applic
										 );

-- changeset root:1753259446745-158
COMMENT ON COLUMN USR_V_ABIL_SUPPORTO_TO_ADD.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-159
COMMENT ON COLUMN USR_V_ABIL_SUPPORTO_TO_ADD.ID_ENTE_FORNIT_EST IS 'PK.3';

-- changeset root:1753259446745-160
COMMENT ON COLUMN USR_V_ABIL_SUPPORTO_TO_ADD.ID_USER_IAM_GESTITO IS 'PK.2';

-- changeset root:1753259446745-161
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ENTE_FORNIT_TO_ADD" ("ID_USER_IAM_COR", "ID_ENTE_FORNIT_EST", "NM_ENTE_FORNIT_EST", "ID_USER_IAM_GESTITO", "ID_SUPT_EST_ENTE_CONVENZ", "ID_ENTE_PRODUT", "DS_CAUSALE_ABIL") AS SELECT -- fornit esterni a cui utente corrente e' abilitato che supportano ente produt dell'utente inserito / modificato
           user_cor.id_user_iam,
           ente.id_ente_siam           id_ente_fornit_est,
           ente.nm_ente_siam           nm_ente_fornit_est,
           user_gestito.id_user_iam    id_user_iam_gestito,
           supt.id_supt_est_ente_convenz,
           supt.id_ente_produt,
           CASE ti_ente_non_convenz
               WHEN 'FORNITORE_ESTERNO'
               THEN
                   'Fornitore esterno che supporta ente a cui appartiene utente'
               WHEN 'SOGGETTO_ATTUATORE'
               THEN
                   'Soggetto attuatore che coadiuva ente a cui appartiene utente'
               ELSE
                   ' '
           END                         AS DS_CAUSALE_ABIL
      FROM USR_USER  user_gestito
           JOIN ORG_SUPT_ESTERNO_ENTE_CONVENZ supt
               ON (    supt.id_ente_produt = user_gestito.id_ente_siam
                   AND supt.dt_ini_val <= TRUNC (SYSDATE)
                   AND supt.dt_fin_val >= TRUNC (SYSDATE))
           JOIN ORG_ENTE_SIAM ente
               ON (ente.id_ente_siam = supt.id_ente_fornit_est)
           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
     WHERE     supt.id_ente_fornit_est IN
                   (SELECT abil_ente.id_ente_siam -- fornit esterni abilitati ad utente corrente
                      FROM USR_ABIL_ENTE_SIAM abil_ente
                     WHERE abil_ente.id_user_iam = user_cor.id_user_iam)
           AND supt.id_ente_fornit_est NOT IN
                   (SELECT abil_ente.id_ente_siam -- fornit esterni non abilitati ad utente gestito
                      FROM USR_ABIL_ENTE_SIAM abil_ente
                     WHERE abil_ente.id_user_iam = user_gestito.id_user_iam);

-- changeset root:1753259446745-162
COMMENT ON COLUMN USR_V_ABIL_ENTE_FORNIT_TO_ADD.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-163
COMMENT ON COLUMN USR_V_ABIL_ENTE_FORNIT_TO_ADD.ID_ENTE_FORNIT_EST IS 'PK.3';

-- changeset root:1753259446745-164
COMMENT ON COLUMN USR_V_ABIL_ENTE_FORNIT_TO_ADD.ID_USER_IAM_GESTITO IS 'PK.2';

-- changeset root:1753259446745-165
CREATE OR REPLACE FORCE VIEW "USR_V_UNAORG_BY_FORNIT_COR" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ENTE_FORNITORE_EST", "ID_ORGANIZ_IAM_STRUT", "ID_ENTE_PRODUT_CORRISP", "DS_CAUSALE_DICH") AS SELECT -- strutture Sacer appartenenti ad ente produt corrispondente a fornitore esterno dell'utente inserito / modificato
           user_cor.id_user_iam             id_user_iam_cor,
           apl_cor.id_applic,
           apl_cor.nm_applic,
           ente_non_convenz.id_ente_siam    id_ente_fornitore_est,
           strut_app_ente.id_organiz_iam    id_organiz_iam_strut,
           ente_non_convenz.id_ente_produt_corrisp,
           --'Ente produttore supportato a fornitore esterno'    ds_causale_dich
           CASE
               WHEN ti_ente_non_convenz = 'FORNITORE_ESTERNO'
               THEN
                   'Ente produttore supportato da fornitore esterno'
               WHEN ti_ente_non_convenz = 'SOGGETTO_ATTUATORE'
               THEN
                   'Ente produttore coadiuvato da soggetto attuatore '
               ELSE
                   ''
           END                              AS ds_causale_dich
      FROM ORG_ENTE_SIAM  ente_non_convenz
           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
           JOIN APL_APPLIC apl_cor ON (apl_cor.nm_applic = 'SACER')
           JOIN org_supt_esterno_ente_convenz supt
               ON (supt.id_ente_fornit_est = ente_non_convenz.id_ente_siam)
           JOIN ORG_ENTE_CONVENZ_ORG strut_app_ente
               ON (    strut_app_ente.id_ente_convenz = supt.id_ente_produt
                   AND strut_app_ente.dt_ini_val <= TRUNC (SYSDATE)
                   AND strut_app_ente.dt_fine_val >= TRUNC (SYSDATE))
           JOIN USR_ORGANIZ_IAM org
               ON (    org.id_organiz_iam = strut_app_ente.id_organiz_iam
                   AND org.id_applic = apl_cor.id_applic)
     WHERE strut_app_ente.id_organiz_iam IN
               (SELECT abil_org.id_organiz_iam -- strutture Sacer abilitate ad utente corrente
                  FROM USR_USO_USER_APPLIC  uso_apl
                       JOIN USR_ABIL_ORGANIZ abil_org
                           ON (abil_org.id_uso_user_applic =
                               uso_apl.id_uso_user_applic)
                 WHERE     uso_apl.id_user_iam = user_cor.id_user_iam
                       AND uso_apl.id_applic = apl_cor.id_applic)

                       UNION

                      SELECT -- versatori Ping appartenenti ad ente produt corrispondente a fornitore esterno dell'utente inserito / modificato
           user_cor.id_user_iam             id_user_iam_cor,
           apl_cor.id_applic,
           apl_cor.nm_applic,
           ente_non_convenz.id_ente_siam    id_ente_fornitore_est,
           strut_app_ente.id_organiz_iam    id_organiz_iam_strut,
           ente_non_convenz.id_ente_produt_corrisp,
           --'Ente produttore supportato a fornitore esterno'    ds_causale_dich
           CASE
               WHEN ti_ente_non_convenz = 'FORNITORE_ESTERNO'
               THEN
                   'Ente produttore supportato da fornitore esterno'
               WHEN ti_ente_non_convenz = 'SOGGETTO_ATTUATORE'
               THEN
                   'Ente produttore coadiuvato da soggetto attuatore '
               ELSE
                   ''
           END                              AS ds_causale_dich
      FROM ORG_ENTE_SIAM  ente_non_convenz
           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
           JOIN APL_APPLIC apl_cor ON (apl_cor.nm_applic = 'SACER_PREINGEST')
           JOIN org_supt_esterno_ente_convenz supt
               ON (supt.id_ente_fornit_est = ente_non_convenz.id_ente_siam)
           JOIN ORG_ENTE_CONVENZ_ORG strut_app_ente
               ON (    strut_app_ente.id_ente_convenz = supt.id_ente_produt
                   AND strut_app_ente.dt_ini_val <= TRUNC (SYSDATE)
                   AND strut_app_ente.dt_fine_val >= TRUNC (SYSDATE))
           JOIN USR_ORGANIZ_IAM org
               ON (    org.id_organiz_iam = strut_app_ente.id_organiz_iam
                   AND org.id_applic = apl_cor.id_applic)
     WHERE strut_app_ente.id_organiz_iam IN
               (SELECT abil_org.id_organiz_iam -- versatori Ping abilitati ad utente corrente
                  FROM USR_USO_USER_APPLIC  uso_apl
                       JOIN USR_ABIL_ORGANIZ abil_org
                           ON (abil_org.id_uso_user_applic =
                               uso_apl.id_uso_user_applic)
                 WHERE     uso_apl.id_user_iam = user_cor.id_user_iam
                       AND uso_apl.id_applic = apl_cor.id_applic)


                        UNION
    SELECT -- versatori Ping appartenenti ad ente fornitore esterno dell'utente inserito / modificato







           user_cor.id_user_iam             id_user_iam_cor,
           apl_cor.id_applic,
           apl_cor.nm_applic,
           vers_app_ente.id_ente_convenz    id_ente_fornit_est,
           vers_app_ente.id_organiz_iam     id_organiz_iam_strut,
           NULL                             id_ente_produt_corrisp,         
           --'Appartenenza a ente fornitore esterno'     ds_causale_dich,
           CASE
               WHEN ente_non_convenz.ti_ente_non_convenz =
                    'FORNITORE_ESTERNO'
               THEN
                   'Appartenenza a ente fornitore esterno'
               WHEN ente_non_convenz.ti_ente_non_convenz =
                    'SOGGETTO_ATTUATORE'
               THEN
                   'Appartenenza a ente soggetto attuatore'
               ELSE
                   ''
           END                              AS ds_causale_dich
           --rich.id_rich_gest_user
      FROM ORG_ENTE_CONVENZ_ORG  vers_app_ente
           JOIN ORG_ENTE_SIAM ente_non_convenz
               ON ente_non_convenz.id_ente_siam =
                  vers_app_ente.id_ente_convenz
           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
           JOIN APL_APPLIC apl_cor ON (apl_cor.nm_applic = 'SACER_PREINGEST')
           JOIN USR_ORGANIZ_IAM org
               ON (    org.id_organiz_iam = vers_app_ente.id_organiz_iam
                   AND org.id_applic = apl_cor.id_applic)
           JOIN USR_RICH_GEST_USER rich ON (rich.id_rich_gest_user > 0)
     WHERE     vers_app_ente.dt_ini_val <= TRUNC (SYSDATE)
           AND vers_app_ente.dt_fine_val >= TRUNC (SYSDATE)
           AND vers_app_ente.id_organiz_iam IN
                   (SELECT abil_org.id_organiz_iam -- versatori Ping abilitati ad utente corrente
                      FROM USR_USO_USER_APPLIC  uso_apl
                           JOIN USR_ABIL_ORGANIZ abil_org
                               ON (abil_org.id_uso_user_applic =
                                   uso_apl.id_uso_user_applic)
                     WHERE     uso_apl.id_user_iam = user_cor.id_user_iam
                           AND uso_apl.id_applic = apl_cor.id_applic);

-- changeset root:1753259446745-166
COMMENT ON COLUMN USR_V_UNAORG_BY_FORNIT_COR.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-167
COMMENT ON COLUMN USR_V_UNAORG_BY_FORNIT_COR.ID_ORGANIZ_IAM_STRUT IS 'PK.2';

-- changeset root:1753259446745-168
CREATE OR REPLACE FORCE VIEW "USR_V_UNAORG_BY_FORNIT" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ENTE_FORNIT_EST", "ID_ORGANIZ_IAM_STRUT", "ID_ENTE_PRODUT_CORRISP", "ID_SUPT_EST_ENTE_CONVENZ", "ID_ENTE_PRODUT_SUPT", "DS_CAUSALE_DICH", "ID_RICH_GEST_USER") AS SELECT -- strutture Sacer appartenenti ad ente produt corrispondente ad fornitore esterno dell'utente inserito / modificato 
           user_cor.id_user_iam             id_user_iam_cor,
           apl_cor.id_applic,
           apl_cor.nm_applic,
           ente_non_convenz.id_ente_siam    id_ente_fornit_est,
           strut_app_ente.id_organiz_iam    id_organiz_iam_strut,
           ente_non_convenz.id_ente_produt_corrisp,
           NULL                             id_supt_est_ente_convenz,
           NULL                             id_ente_produt_supt,
           CASE ente_non_convenz.ti_ente_non_convenz
               WHEN 'FORNITORE_ESTERNO'
               THEN
                   'Fornitore esterno che supporta ente a cui appartiene utente'
               WHEN 'SOGGETTO_ATTUATORE'
               THEN
                   'Soggetto attuatore che coadiuva ente a cui appartiene utente'
               ELSE
                   ' '
           END                              AS ds_causale_dich,
           rich.id_rich_gest_user
      FROM ORG_ENTE_SIAM  ente_non_convenz
           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
           JOIN APL_APPLIC apl_cor ON (apl_cor.nm_applic = 'SACER')
           JOIN ORG_ENTE_CONVENZ_ORG strut_app_ente
               ON (    strut_app_ente.id_ente_convenz =
                       ente_non_convenz.id_ente_produt_corrisp
                   AND strut_app_ente.dt_ini_val <= TRUNC (SYSDATE)
                   AND strut_app_ente.dt_fine_val >= TRUNC (SYSDATE))
           JOIN USR_ORGANIZ_IAM org
               ON (    org.id_organiz_iam = strut_app_ente.id_organiz_iam
                   AND org.id_applic = apl_cor.id_applic)
           JOIN USR_RICH_GEST_USER rich ON (rich.id_rich_gest_user > 0)
     WHERE strut_app_ente.id_organiz_iam IN
               (SELECT abil_org.id_organiz_iam -- strutture Sacer abilitate ad utente corrente
                  FROM USR_USO_USER_APPLIC  uso_apl
                       JOIN USR_ABIL_ORGANIZ abil_org
                           ON (abil_org.id_uso_user_applic =
                               uso_apl.id_uso_user_applic)
                 WHERE     uso_apl.id_user_iam = user_cor.id_user_iam
                       AND uso_apl.id_applic = apl_cor.id_applic)
    UNION
    SELECT -- strutture sacer appartenenti ad enti produt supportati da fornitore dell'utente inserito / modificato
           user_cor.id_user_iam             id_user_iam_cor,
           apl_cor.id_applic,
           apl_cor.nm_applic,
           supt_esterno.id_ente_fornit_est,
           strut_app_ente.id_organiz_iam    id_organiz_iam_strut,
           NULL                             id_ente_produt_corrisp,
           supt_esterno.id_supt_est_ente_convenz,
           supt_esterno.id_ente_produt      id_ente_produt_supt,
           CASE ente_non_convenz.ti_ente_non_convenz
               WHEN 'FORNITORE_ESTERNO'
               THEN
                   'Ente produttore supportato da fornitore esterno'
               WHEN 'SOGGETTO_ATTUATORE'
               THEN
                   'Ente produttore coadiuvato da soggetto attuatore '
               ELSE
                   ''
           END                              AS ds_causale_dich,
           rich.id_rich_gest_user
      FROM ORG_SUPT_ESTERNO_ENTE_CONVENZ  supt_esterno
           JOIN ORG_ENTE_SIAM ente_non_convenz
               ON ente_non_convenz.id_ente_siam =
                  supt_esterno.ID_ENTE_FORNIT_EST          
           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
           JOIN APL_APPLIC apl_cor ON (apl_cor.nm_applic = 'SACER')
           JOIN ORG_ENTE_CONVENZ_ORG strut_app_ente
               ON (    strut_app_ente.id_ente_convenz =
                       supt_esterno.id_ente_produt
                   AND strut_app_ente.dt_ini_val <= TRUNC (SYSDATE)
                   AND strut_app_ente.dt_fine_val >= TRUNC (SYSDATE))
           JOIN USR_ORGANIZ_IAM org
               ON (    org.id_organiz_iam = strut_app_ente.id_organiz_iam
                   AND org.id_applic = apl_cor.id_applic)
           JOIN USR_RICH_GEST_USER rich ON (rich.id_rich_gest_user > 0)
     WHERE     supt_esterno.dt_ini_val <= TRUNC (SYSDATE)
           AND supt_esterno.dt_fin_val >= TRUNC (SYSDATE)
           AND strut_app_ente.id_organiz_iam IN
                   (SELECT abil_org.id_organiz_iam -- strutture Sacer abilitate ad utente corrente
                      FROM USR_USO_USER_APPLIC  uso_apl
                           JOIN USR_ABIL_ORGANIZ abil_org
                               ON (abil_org.id_uso_user_applic =
                                   uso_apl.id_uso_user_applic)
                     WHERE     uso_apl.id_user_iam = user_cor.id_user_iam
                           AND uso_apl.id_applic = apl_cor.id_applic)
           AND supt_esterno.id_ente_produt IN
                   (SELECT ente_servito.id_ente_convenz_servito -- ente produt delle strutture servito da ente della richiesta
                      FROM USR_V_LIS_ENTI_CONVENZ_SERVITI ente_servito
                     WHERE ente_servito.id_ente_convenz_servente =
                           rich.id_ente_rich)
    UNION
    SELECT -- strutture sacer appartenenti agli enti collegati dell'ente della richiesta e supportati dall'ente di appartenenza dell'utente
           user_cor.id_user_iam             id_user_iam_cor,
           apl_cor.id_applic,
           apl_cor.nm_applic,
           supt_esterno.id_ente_fornit_est,
           strut_app_ente.id_organiz_iam    id_organiz_iam_strut,
           NULL                             id_ente_produt_corrisp,
           supt_esterno.id_supt_est_ente_convenz,
           supt_esterno.id_ente_produt      id_ente_produt_supt,
           CASE ente_non_convenz.ti_ente_non_convenz
               WHEN 'FORNITORE_ESTERNO'
               THEN
                   'Ente produttore supportato da fornitore esterno'
               WHEN 'SOGGETTO_ATTUATORE'
               THEN
                   'Ente produttore coadiuvato da soggetto attuatore '
               ELSE
                   ''
           END                              AS ds_causale_dich,
           rich.id_rich_gest_user
      FROM ORG_SUPT_ESTERNO_ENTE_CONVENZ  supt_esterno
           JOIN ORG_ENTE_SIAM ente_non_convenz
               ON ente_non_convenz.id_ente_siam =
                  supt_esterno.ID_ENTE_FORNIT_EST
                  
                  
                  
           JOIN USR_RICH_GEST_USER rich ON (rich.id_rich_gest_user > 0)          
           JOIN ORG_APPART_COLLEG_ENTI appart_colleg
               ON (appart_colleg.id_ente_convenz = rich.id_ente_rich)
           JOIN ORG_COLLEG_ENTI_CONVENZ colleg
               ON (appart_colleg.id_colleg_enti_convenz = colleg.id_colleg_enti_convenz)
            
            
                
           
           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
           JOIN APL_APPLIC apl_cor ON (apl_cor.nm_applic = 'SACER')
          
          -- da qui ricavo le strutture SACER
           JOIN ORG_ENTE_CONVENZ_ORG strut_app_ente
               ON (    strut_app_ente.id_ente_convenz =                      
                       supt_esterno.id_ente_produt
                   AND strut_app_ente.dt_ini_val <= TRUNC (SYSDATE)
                   AND strut_app_ente.dt_fine_val >= TRUNC (SYSDATE))
          
          
           JOIN USR_ORGANIZ_IAM org
               ON (    org.id_organiz_iam = strut_app_ente.id_organiz_iam
                   AND org.id_applic = apl_cor.id_applic)
           
     WHERE     supt_esterno.dt_ini_val <= TRUNC (SYSDATE)
           AND supt_esterno.dt_fin_val >= TRUNC (SYSDATE)          
           AND strut_app_ente.id_organiz_iam IN
                   (SELECT abil_org.id_organiz_iam -- strutture Sacer abilitate ad utente corrente
                      FROM USR_USO_USER_APPLIC  uso_apl
                           JOIN USR_ABIL_ORGANIZ abil_org
                               ON (abil_org.id_uso_user_applic =
                                   uso_apl.id_uso_user_applic)
                     WHERE     uso_apl.id_user_iam = user_cor.id_user_iam
                           AND uso_apl.id_applic = apl_cor.id_applic)
           AND appart_colleg.id_ente_convenz IN
                   (SELECT ente_servito.id_ente_convenz_servito -- ente produt delle strutture servito da ente della richiesta
                      FROM USR_V_LIS_ENTI_CONVENZ_SERVITI ente_servito
                     WHERE ente_servito.id_ente_convenz_servente =
                           rich.id_ente_rich)
     UNION
    SELECT -- versatori Ping appartenenti ad ente fornitore esterno dell'utente inserito / modificato
           user_cor.id_user_iam             id_user_iam_cor,
           apl_cor.id_applic,
           apl_cor.nm_applic,
           vers_app_ente.id_ente_convenz    id_ente_fornit_est,
           vers_app_ente.id_organiz_iam     id_organiz_iam_strut,
           NULL                             id_ente_produt_corrisp,
           NULL                             id_supt_est_ente_convenz,
           NULL                             id_ente_produt_supt,
           --'Appartenenza a ente fornitore esterno'     ds_causale_dich,
           CASE
               WHEN ente_non_convenz.ti_ente_non_convenz =
                    'FORNITORE_ESTERNO'
               THEN
                   'Appartenenza a ente fornitore esterno'
               WHEN ente_non_convenz.ti_ente_non_convenz =
                    'SOGGETTO_ATTUATORE'
               THEN
                   'Appartenenza a ente soggetto attuatore'
               ELSE
                   ''
           END                              AS ds_causale_dich,
           rich.id_rich_gest_user
      FROM ORG_ENTE_CONVENZ_ORG  vers_app_ente
           JOIN ORG_ENTE_SIAM ente_non_convenz
               ON ente_non_convenz.id_ente_siam =
                  vers_app_ente.id_ente_convenz
           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
           JOIN APL_APPLIC apl_cor ON (apl_cor.nm_applic = 'SACER_PREINGEST')
           JOIN USR_ORGANIZ_IAM org
               ON (    org.id_organiz_iam = vers_app_ente.id_organiz_iam
                   AND org.id_applic = apl_cor.id_applic)
           JOIN USR_RICH_GEST_USER rich ON (rich.id_rich_gest_user > 0)
     WHERE     vers_app_ente.dt_ini_val <= TRUNC (SYSDATE)
           AND vers_app_ente.dt_fine_val >= TRUNC (SYSDATE)
           AND vers_app_ente.id_organiz_iam IN
                   (SELECT abil_org.id_organiz_iam -- versatori Ping abilitati ad utente corrente
                      FROM USR_USO_USER_APPLIC  uso_apl
                           JOIN USR_ABIL_ORGANIZ abil_org
                               ON (abil_org.id_uso_user_applic =
                                   uso_apl.id_uso_user_applic)
                     WHERE     uso_apl.id_user_iam = user_cor.id_user_iam
                           AND uso_apl.id_applic = apl_cor.id_applic)
    UNION
    SELECT -- versatori PING appartenenti ad ente produt corrispondente ad fornitore esterno dell'utente inserito / modificato
           user_cor.id_user_iam             id_user_iam_cor,
           apl_cor.id_applic,
           apl_cor.nm_applic,
           ente_non_convenz.id_ente_siam    id_ente_fornit_est,
           strut_app_ente.id_organiz_iam    id_organiz_iam_strut,
           ente_non_convenz.id_ente_produt_corrisp,
           NULL                             id_supt_est_ente_convenz,
           NULL                             id_ente_produt_supt,
           CASE ente_non_convenz.ti_ente_non_convenz
               WHEN 'FORNITORE_ESTERNO'
               THEN
                   'Fornitore esterno che supporta ente a cui appartiene utente'
               WHEN 'SOGGETTO_ATTUATORE'
               THEN
                   'Soggetto attuatore che coadiuva ente a cui appartiene utente'
               ELSE
                   ' '
           END                              AS ds_causale_dich,
           rich.id_rich_gest_user
      FROM ORG_ENTE_SIAM  ente_non_convenz
           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
           JOIN APL_APPLIC apl_cor ON (apl_cor.nm_applic = 'SACER_PREINGEST')
           JOIN ORG_ENTE_CONVENZ_ORG strut_app_ente
               ON (    strut_app_ente.id_ente_convenz =
                       ente_non_convenz.id_ente_produt_corrisp
                   AND strut_app_ente.dt_ini_val <= TRUNC (SYSDATE)
                   AND strut_app_ente.dt_fine_val >= TRUNC (SYSDATE))
           JOIN USR_ORGANIZ_IAM org
               ON (    org.id_organiz_iam = strut_app_ente.id_organiz_iam
                   AND org.id_applic = apl_cor.id_applic)
           JOIN USR_RICH_GEST_USER rich ON (rich.id_rich_gest_user > 0)
     WHERE strut_app_ente.id_organiz_iam IN
               (SELECT abil_org.id_organiz_iam -- strutture Sacer abilitate ad utente corrente
                  FROM USR_USO_USER_APPLIC  uso_apl
                       JOIN USR_ABIL_ORGANIZ abil_org
                           ON (abil_org.id_uso_user_applic =
                               uso_apl.id_uso_user_applic)
                 WHERE     uso_apl.id_user_iam = user_cor.id_user_iam
                       AND uso_apl.id_applic = apl_cor.id_applic)
    UNION
    SELECT -- versatori PING appartenenti ad enti produt supportati da fornitore dell'utente inserito / modificato
           user_cor.id_user_iam             id_user_iam_cor,
           apl_cor.id_applic,
           apl_cor.nm_applic,
           supt_esterno.id_ente_fornit_est,
           strut_app_ente.id_organiz_iam    id_organiz_iam_strut,
           NULL                             id_ente_produt_corrisp,
           supt_esterno.id_supt_est_ente_convenz,
           supt_esterno.id_ente_produt      id_ente_produt_supt,
           CASE ente_non_convenz.ti_ente_non_convenz
               WHEN 'FORNITORE_ESTERNO'
               THEN
                   'Ente produttore supportato da fornitore esterno'
               WHEN 'SOGGETTO_ATTUATORE'
               THEN
                   'Ente produttore coadiuvato da soggetto attuatore '
               ELSE
                   ''
           END                              AS ds_causale_dich,
           rich.id_rich_gest_user
      FROM ORG_SUPT_ESTERNO_ENTE_CONVENZ  supt_esterno
           JOIN ORG_ENTE_SIAM ente_non_convenz
               ON ente_non_convenz.id_ente_siam =
                  supt_esterno.ID_ENTE_FORNIT_EST
           -- MAC 23640
           JOIN ORG_APPART_COLLEG_ENTI colleg
               ON (colleg.id_ente_convenz = supt_esterno.id_ente_produt)
           -- MAC 23640


           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
           JOIN APL_APPLIC apl_cor ON (apl_cor.nm_applic = 'SACER_PREINGEST')
           JOIN ORG_ENTE_CONVENZ_ORG strut_app_ente
               ON (    strut_app_ente.id_ente_convenz =
                       supt_esterno.id_ente_produt
                   AND strut_app_ente.dt_ini_val <= TRUNC (SYSDATE)
                   AND strut_app_ente.dt_fine_val >= TRUNC (SYSDATE))
           JOIN USR_ORGANIZ_IAM org
               ON (    org.id_organiz_iam = strut_app_ente.id_organiz_iam
                   AND org.id_applic = apl_cor.id_applic)
           JOIN USR_RICH_GEST_USER rich ON (rich.id_rich_gest_user > 0)
     WHERE     supt_esterno.dt_ini_val <= TRUNC (SYSDATE)
           AND supt_esterno.dt_fin_val >= TRUNC (SYSDATE)
           AND strut_app_ente.id_organiz_iam IN
                   (SELECT abil_org.id_organiz_iam -- strutture Sacer abilitate ad utente corrente
                      FROM USR_USO_USER_APPLIC  uso_apl
                           JOIN USR_ABIL_ORGANIZ abil_org
                               ON (abil_org.id_uso_user_applic =
                                   uso_apl.id_uso_user_applic)
                     WHERE     uso_apl.id_user_iam = user_cor.id_user_iam
                           AND uso_apl.id_applic = apl_cor.id_applic)
           AND supt_esterno.id_ente_produt IN
                   (SELECT ente_servito.id_ente_convenz_servito -- ente produt delle strutture servito da ente della richiesta
                      FROM USR_V_LIS_ENTI_CONVENZ_SERVITI ente_servito
                     WHERE ente_servito.id_ente_convenz_servente =
                           rich.id_ente_rich);

-- changeset root:1753259446745-169
CREATE OR REPLACE FORCE VIEW "USR_V_ENTI_SACER_BY_FORNIT" ("ID_ENTE_FORNIT_EST", "ID_ORGANIZ_IAM_ENTE", "ID_SUPT_EST_ENTE_CONVENZ", "ID_ENTE_PRODUT_SUPT", "TI_ENTE_NON_CONVENZ") AS SELECT DISTINCT -- enti sacer di strut appartenenti ad enti produt supportati da fornitore dell'utente inserito / modificato
                    supt_esterno.id_ente_fornit_est,
                    org_strut.id_organiz_iam_padre     id_organiz_iam_ente,
                    supt_esterno.id_supt_est_ente_convenz,
                    supt_esterno.id_ente_produt        id_ente_produt_supt,
                    org_ente_Siam.TI_ENTE_NON_CONVENZ
      FROM ORG_SUPT_ESTERNO_ENTE_CONVENZ  supt_esterno
           JOIN ORG_ENTE_CONVENZ_ORG strut_app_ente
               ON (    strut_app_ente.id_ente_convenz =
                       supt_esterno.id_ente_produt
                   AND strut_app_ente.dt_ini_val <= TRUNC (SYSDATE)
                   AND strut_app_ente.dt_fine_val >= TRUNC (SYSDATE))
           JOIN org_ente_Siam
               ON org_ente_Siam.ID_ENTE_SIAM =
                  supt_esterno.ID_ENTE_FORNIT_EST
           JOIN USR_ORGANIZ_IAM org_strut
               ON (org_strut.id_organiz_iam = strut_app_ente.id_organiz_iam)
     WHERE     supt_esterno.dt_ini_val <= TRUNC (SYSDATE)
           AND supt_esterno.dt_fin_val >= TRUNC (SYSDATE);

-- changeset root:1753259446745-170
COMMENT ON COLUMN USR_V_ENTI_SACER_BY_FORNIT.ID_ORGANIZ_IAM_ENTE IS 'PK.1';

-- changeset root:1753259446745-171
CREATE OR REPLACE FORCE VIEW "ORG_V_RIC_ENTE_CONVENZ" ("ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_CATEG_ENTE", "ID_AMBITO_TERRIT", "DT_INI_VAL", "DT_CESSAZIONE", "CD_ENTE_CONVENZ", "ID_TIPO_ACCORDO", "CD_TIPO_ACCORDO", "DT_RICH_MODULO_INFO", "FL_ESISTONO_MODULI", "FL_RECESSO", "FL_CHIUSO", "ENTE_ATTIVO", "ARCHIVISTA", "ID_USER_IAM_ARK", "ID_USER_IAM_COR", "ID_AMBIENTE_ENTE_CONVENZ", "DT_DEC_ACCORDO", "DT_SCAD_ACCORDO", "FL_NON_CONVENZ", "FL_ESISTONO_GEST_ACC", "TIPO_GESTIONE_ACCORDO", "FL_GEST_ACC_NO_RISP", "TI_ENTE_CONVENZ", "ID_ENTE_GESTORE", "ID_ENTE_CONSERV", "DT_FINE_VALID_ACCORDO", "TI_STATO_ACCORDO", "DT_DEC_ACCORDO_INFO", "CD_FISC") AS SELECT ente.id_ente_siam,
           ente.nm_ente_siam,
           ente.id_categ_ente,
           ente.id_ambito_territ,
           ente.dt_ini_val,
           ente.dt_cessazione,
           ente.cd_ente_convenz,
           ti_accordo.id_tipo_accordo,
           ti_accordo.cd_tipo_accordo,
           ente.dt_rich_modulo_info,
           CASE
               WHEN EXISTS
                        (SELECT NVL (dt_ricev, NULL)
                           FROM ORG_MODULO_INFO_ACCORDO modulo
                          WHERE modulo.id_ente_convenz = ente.id_ente_siam) THEN
                   '1'
               ELSE
                   '0'
           END                       fl_esistono_moduli,
           accordo.fl_recesso,
           accordo.fl_accordo_chiuso,
           CASE
               WHEN EXISTS
                        (SELECT NVL (dt_erog, NULL)
                           FROM ORG_SERVIZIO_EROG  servizio
                                JOIN ORG_ACCORDO_ENTE accordi
                                    ON (accordi.id_accordo_ente =
                                        servizio.id_accordo_ente)
                          WHERE accordi.id_ente_convenz = ente.id_ente_siam
                            AND dt_erog IS NOT NULL) THEN
                   '1'
               ELSE
                   '0'
           END                       ente_attivo,
           CASE
               WHEN (SELECT NVL (COUNT (*), 0)
                       FROM org_ente_ark_rif count_archivisti
                      WHERE ente.id_ente_siam =
                            count_archivisti.id_ente_convenz) =
                    1 THEN
                   (SELECT ute_ark.nm_userid
                      FROM USR_USER ute_ark
                     WHERE ute_ark.id_user_iam = archivisti.id_user_iam)
               WHEN (SELECT NVL (COUNT (*), 0)
                       FROM org_ente_ark_rif count_archivisti
                      WHERE ente.id_ente_siam =
                            count_archivisti.id_ente_convenz) =
                    0 THEN
                   'Nessun archivista definito'
               ELSE
                   'Ente con più di un archivista di riferimento'
           END                       archivista,
           utente_ark.id_user_iam    id_user_iam_ark,
           abil_ente.id_user_iam     id_user_iam_cor,
           ente.id_ambiente_ente_convenz,
           accordo.dt_dec_accordo,
           accordo.dt_scad_accordo,
           /*case
           when exists (select *
               from ORG_ACCORDO_ENTE accordo_ente
               where accordo_ente.id_ente_convenz = ente.id_ente_siam
              )

            and accordo.dt_dec_accordo is null
            then '1'
            else '0'
           end fl_in_corso_convenz, */
           CASE
               WHEN NOT EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE accordo_ente.id_ente_convenz =
                                ente.id_ente_siam
                            AND accordo.dt_fine_valid_accordo >=
                                TRUNC (SYSDATE)
                            AND accordo.dt_dec_accordo < TRUNC (SYSDATE)) THEN
                   '1'
               ELSE
                   '0'
           END                       fl_non_convenz,
           CASE
               WHEN EXISTS
                        (SELECT NVL (gestacc.cd_key_gest_accordo, NULL)
                           FROM ORG_GESTIONE_ACCORDO  gestacc
                                JOIN org_accordo_ente accordo
                                    ON (gestacc.id_accordo_ente =
                                        accordo.id_accordo_ente)
                          WHERE accordo.id_ente_convenz = ente.id_ente_siam) THEN
                   '1'
               ELSE
                   '0'
           END                       fl_esistono_gest_acc,
           tipigestacc.cd_tipo_gestione_accordo,
           CASE
               WHEN gestacc.id_gest_accordo_risposta IS NULL THEN '1'
               ELSE '0'
           END                       fl_gest_acc_no_risp,
           ente.ti_ente_convenz,
           accordo.id_ente_convenz_gestore,
           accordo.id_ente_convenz_conserv,
           accordo.dt_fine_valid_accordo,
           CASE
               --a) Accordo valido (data corrente compresa tra data decorrenza e data fine validità e < data scadenza)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE accordo_ente.id_ente_convenz =
                                ente.id_ente_siam
                            AND accordo_ente.dt_fine_valid_accordo >=
                                TRUNC (SYSDATE)
                            AND accordo_ente.dt_dec_accordo <=
                                TRUNC (SYSDATE)
                            AND accordo_ente.dt_scad_accordo >
                                TRUNC (SYSDATE)) THEN
                   'Accordo valido'
               --b) Accordo valido in corso di rinnovo (data corrente > data scadenza e < data fine validità)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE accordo_ente.id_ente_convenz =
                                ente.id_ente_siam
                            AND TRUNC (SYSDATE) <
                                accordo_ente.dt_fine_valid_accordo
                            --and accordo_ente.dt_dec_accordo < trunc (sysdate)
                            AND TRUNC (SYSDATE) >
                                accordo_ente.dt_scad_accordo) THEN
                   'Accordo valido in corso rinnovo'
               --c) Accordo non valido per recesso (data fine validità < data scadenza e data corrente > data fine validità)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE accordo_ente.id_ente_convenz =
                                ente.id_ente_siam
                            AND accordo_ente.dt_fine_valid_accordo <
                                accordo_ente.dt_scad_accordo
                            AND TRUNC (SYSDATE) >
                                accordo_ente.dt_fine_valid_accordo) THEN
                   'Accordo non valido per recesso'
               --d) Accordo non valido per scadenza (data fine validità >= data scadenza =< data corrente)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE accordo_ente.id_ente_convenz =
                                ente.id_ente_siam
                            AND accordo_ente.dt_fine_valid_accordo >=
                                accordo_ente.dt_scad_accordo
                            AND TRUNC (SYSDATE) >
                                accordo_ente.dt_fine_valid_accordo) THEN
                   'Accordo non valido per scadenza'
               --e) Accordo in corso di stipula (data corrente < data decorrenza e dt_registrazione is null o > data corrente)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE accordo_ente.id_ente_convenz =
                                ente.id_ente_siam
                            AND TRUNC (SYSDATE) < accordo_ente.dt_dec_accordo
                            AND accordo_ente.dt_reg_accordo IS NULL
                             OR accordo_ente.dt_reg_accordo > SYSDATE) THEN
                   'Accordo in corso di stipula'
               ELSE
                   --Accordo non valido (data corrente < data decorrenza o > data fine validità)
                   'Accordo non valido'
           END                       ti_stato_accordo,
           accordo.dt_dec_accordo_info,
	   ente.CD_FISC
      FROM ORG_ENTE_SIAM  ente
           JOIN USR_ABIL_ENTE_SIAM abil_ente
               ON (abil_ente.id_ente_siam = ente.id_ente_siam)
           LEFT JOIN ORG_ACCORDO_ENTE accordo
               ON (accordo.id_ente_convenz = ente.id_ente_siam)
           LEFT JOIN ORG_TIPO_ACCORDO ti_accordo
               ON (ti_accordo.id_tipo_accordo = accordo.id_tipo_accordo)
           LEFT JOIN org_ente_ark_rif archivisti
               ON (archivisti.id_ente_convenz = ente.id_ente_siam)
           LEFT JOIN usr_user utente_ark
               ON (utente_ark.id_user_iam = archivisti.id_user_iam)
           LEFT JOIN ORG_GESTIONE_ACCORDO gestacc
               ON (gestacc.id_accordo_ente = accordo.id_accordo_ente)
           LEFT JOIN ORG_TIPI_GESTIONE_ACCORDO tipigestacc
               ON (tipigestacc.id_tipo_gestione_accordo =
                   gestacc.id_tipo_gestione_accordo)
     WHERE ente.ti_ente = 'CONVENZIONATO'
       AND ((accordo.dt_dec_accordo =
             (SELECT MAX (accordo_max.dt_dec_accordo)
                FROM ORG_ACCORDO_ENTE accordo_max
               WHERE accordo_max.id_ente_convenz = ente.id_ente_siam --and accordo_max.dt_dec_accordo <= sysdate --condizione rimmossa in data 10/12/2020 poichè introduce una regressione
                                                                    )
         AND NOT EXISTS
                 (SELECT *
                    FROM ORG_ACCORDO_ENTE accordo_null
                   WHERE accordo_null.id_ente_convenz = ente.id_ente_siam
                     AND accordo_null.dt_dec_accordo IS NULL))
         OR accordo.dt_dec_accordo IS NULL);

-- changeset root:1753259446745-172
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ENTE_NOCONV_TO_ADD" ("ID_USER_IAM_COR", "ID_ENTE_NON_CONVENZ", "NM_ENTE_NON_CONVENZ", "ID_USER_IAM_GESTITO", "ID_ENTE_AMMIN", "DS_CAUSALE_ABIL") AS SELECT -- enti non convenz a cui utente corrente e' abilitato perchè appartenente ad ente ammin o conservatore dell'utente inserito / modificato
           user_cor.id_user_iam,
           ente.id_ente_siam                                       id_ente_non_convenz,
           ente.nm_ente_siam                                       nm_ente_non_convenz,
           user_gestito.id_user_iam                                id_user_iam_gestito,
           user_gestito.id_ente_siam                               id_ente_ammin,
           'Appartenenza ad ente amministratore o conservatore'    ds_causale_abil
      FROM USR_USER  user_gestito
           JOIN ORG_ENTE_SIAM ente
               ON (    ente.ti_ente = 'NON_CONVENZIONATO')
--                   AND ente.dt_ini_val <= TRUNC (SYSDATE)
--                   AND ente.dt_cessazione >= TRUNC (SYSDATE))

           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
     WHERE     ente.id_ente_siam IN
                   (SELECT abil_ente.id_ente_siam -- enti non convenz abilitati ad utente corrente
                      FROM USR_ABIL_ENTE_SIAM abil_ente
                     WHERE abil_ente.id_user_iam = user_cor.id_user_iam)
           AND ente.id_ente_siam NOT IN
                   (SELECT abil_ente.id_ente_siam -- enti non convenz non abilitati ad utente gestito
                      FROM USR_ABIL_ENTE_SIAM abil_ente
                     WHERE abil_ente.id_user_iam = user_gestito.id_user_iam);

-- changeset root:1753259446745-173
COMMENT ON COLUMN USR_V_ABIL_ENTE_NOCONV_TO_ADD.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-174
COMMENT ON COLUMN USR_V_ABIL_ENTE_NOCONV_TO_ADD.ID_ENTE_NON_CONVENZ IS 'PK.3';

-- changeset root:1753259446745-175
COMMENT ON COLUMN USR_V_ABIL_ENTE_NOCONV_TO_ADD.ID_USER_IAM_GESTITO IS 'PK.2';

-- changeset root:1753259446745-176
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ENTE_COLLEG_TO_DEL" ("ID_USER_IAM", "ID_ABIL_ENTE_SIAM", "ID_ENTE_SIAM", "ID_DICH_ABIL_ENTE_CONVENZ", "ID_APPART_COLLEG_ENTI", "ID_SUPT_EST_ENTE_CONVENZ", "ID_ACCORDO_VIGIL", "FL_ABIL_AUTOMATICA", "DS_CAUSALE_ABIL") AS select 
 usr.id_user_iam,
 abil_ente.id_abil_ente_siam,
 abil_ente.id_ente_siam,
 abil_ente.id_dich_abil_ente_convenz,
 abil_ente.id_appart_colleg_enti,
 abil_ente.id_supt_est_ente_convenz,
 abil_ente.id_accordo_vigil,
 abil_ente.fl_abil_automatica,
 abil_ente.ds_causale_abil

from USR_USER usr
join USR_ABIL_ENTE_SIAM abil_ente
	on (abil_ente.id_user_iam = usr.id_user_iam)

where abil_ente.id_dich_abil_ente_convenz is null
and abil_ente.id_appart_colleg_enti is not null
and abil_ente.fl_abil_automatica = '1';

-- changeset root:1753259446745-177
COMMENT ON COLUMN USR_V_ABIL_ENTE_COLLEG_TO_DEL.ID_ABIL_ENTE_SIAM IS 'PK.1';

-- changeset root:1753259446745-178
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ENTE_CORRISP_TO_ADD" ("ID_USER_IAM_COR", "ID_ENTE_SIAM", "NM_ENTE_SIAM", "ID_USER_IAM_GESTITO", "ID_ENTE_UTENTE", "DS_CAUSALE_ABIL") AS select  											-- ente non convenz a cui appartiene l'utente inserito / modificato
 user_cor.id_user_iam,
 ente_utente.id_ente_siam,
 ente_utente.nm_ente_siam,
 user_gestito.id_user_iam id_user_iam_gestito,
 user_gestito.id_ente_siam id_ente_utente,
 'Appartenenza ad ente non convenzionato' ds_causale_abil

from USR_USER user_gestito
join ORG_ENTE_SIAM ente_utente
	on (ente_utente.id_ente_siam = user_gestito.id_ente_siam)
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)

where ente_utente.id_ente_siam in (select abil_ente.id_ente_siam					-- ente non convenz abilitati ad utente corrente
							 from USR_ABIL_ENTE_SIAM abil_ente
							 where abil_ente.id_user_iam = user_cor.id_user_iam
							 )
and ente_utente.id_ente_siam not in (select abil_ente.id_ente_siam					-- ente non convenz non abilitati ad utente gestito
							 from USR_ABIL_ENTE_SIAM abil_ente
							 where abil_ente.id_user_iam = user_gestito.id_user_iam
							 )
							 
UNION

select  											-- ente convenz corrispondente ad ente a cui appartiene l'utente inserito / modificato
 user_cor.id_user_iam,
 ente_corrip.id_ente_siam,
 ente_corrip.nm_ente_siam,
 user_gestito.id_user_iam id_user_iam_gestito,
 user_gestito.id_ente_siam id_ente_utente,
 'Ente convenzionato corrispondente ad ente a cui appartiene utente' ds_causale_abil

from USR_USER user_gestito
join ORG_ENTE_SIAM ente_utente
	on (ente_utente.id_ente_siam = user_gestito.id_ente_siam)
join ORG_ENTE_SIAM ente_corrip
	on (ente_corrip.id_ente_siam = ente_utente.id_ente_produt_corrisp)
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)

where ente_corrip.id_ente_siam in (select abil_ente.id_ente_siam					-- ente convenz abilitati ad utente corrente
							 from USR_ABIL_ENTE_SIAM abil_ente
							 where abil_ente.id_user_iam = user_cor.id_user_iam
							 )
and ente_corrip.id_ente_siam not in (select abil_ente.id_ente_siam					-- ente convenz non abilitati ad utente gestito
							 from USR_ABIL_ENTE_SIAM abil_ente
							 where abil_ente.id_user_iam = user_gestito.id_user_iam
							 );

-- changeset root:1753259446745-179
COMMENT ON COLUMN USR_V_ABIL_ENTE_CORRISP_TO_ADD.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-180
COMMENT ON COLUMN USR_V_ABIL_ENTE_CORRISP_TO_ADD.ID_ENTE_SIAM IS 'PK.3';

-- changeset root:1753259446745-181
COMMENT ON COLUMN USR_V_ABIL_ENTE_CORRISP_TO_ADD.ID_USER_IAM_GESTITO IS 'PK.2';

-- changeset root:1753259446745-182
CREATE OR REPLACE FORCE VIEW "USR_V_CHECK_DICH_ABIL_ENTE" ("ID_DICH_ABIL_ENTE_AGGIUNTA", "ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_USER_IAM_CORRENTE") AS select
 abil_aggiunta.id_dich_abil_ente_convenz id_dich_abil_ente_aggiunta,
 abil_aggiunta.id_ente_siam id_ente_convenz,
 ente_convenz.nm_ente_siam nm_ente_convenz, 
 
 usr_corrente.id_user_iam id_user_iam_corrente
 
from USR_ABIL_ENTE_SIAM abil_aggiunta

join ORG_ENTE_SIAM ente_convenz
 on (ente_convenz.id_ente_siam = abil_aggiunta.id_ente_siam)

join USR_USER usr_corrente
 on (usr_corrente.nm_userid like '%')
 
where abil_aggiunta.id_ente_siam not in (select id_ente_siam
										   from USR_ABIL_ENTE_SIAM abil_corrente
										   where abil_corrente.id_user_iam = usr_corrente.id_user_iam
										   );

-- changeset root:1753259446745-183
COMMENT ON COLUMN USR_V_CHECK_DICH_ABIL_ENTE.ID_DICH_ABIL_ENTE_AGGIUNTA IS 'PK.1';

-- changeset root:1753259446745-184
COMMENT ON COLUMN USR_V_CHECK_DICH_ABIL_ENTE.ID_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-185
COMMENT ON COLUMN USR_V_CHECK_DICH_ABIL_ENTE.ID_USER_IAM_CORRENTE IS 'PK.3';

-- changeset root:1753259446745-186
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ENTE_VIGIL_TO_ADD" ("ID_USER_IAM_COR", "ID_ENTE_ORGANO_VIGIL", "NM_ENTE_ORGANO_VIGIL", "ID_USER_IAM_GESTITO", "ID_ACCORDO_VIGIL", "ID_ENTE_CONSERV", "DS_CAUSALE_ABIL") AS select  											-- organi vigil a cui utente corrente e' abilitato con accordo valido con ente conserv dell'utente inserito / modificato
 user_cor.id_user_iam,
 ente.id_ente_siam id_ente_organo_vigil,
 ente.nm_ente_siam nm_ente_organo_vigil,
 user_gestito.id_user_iam id_user_iam_gestito,
 acc.id_accordo_vigil,
 acc.id_ente_conserv,
 'Organo di vigilanza con accordo valido con ente a cui appartiene utente' ds_causale_abil

from USR_USER user_gestito
join ORG_ACCORDO_VIGIL acc
	on (acc.id_ente_conserv = user_gestito.id_ente_siam
	and acc.dt_ini_val <= trunc(sysdate)
	and acc.dt_fin_val >= trunc(sysdate))
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = acc.id_ente_organo_vigil)
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)

where acc.id_ente_organo_vigil in (select abil_ente.id_ente_siam					-- organi vigil abilitati ad utente corrente
								 from USR_ABIL_ENTE_SIAM abil_ente
								 where abil_ente.id_user_iam = user_cor.id_user_iam
								 )
and acc.id_ente_organo_vigil not in (select abil_ente.id_ente_siam				-- organi vigil non abilitati ad utente gestito
									 from USR_ABIL_ENTE_SIAM abil_ente
									 where abil_ente.id_user_iam = user_gestito.id_user_iam
									 );

-- changeset root:1753259446745-187
COMMENT ON COLUMN USR_V_ABIL_ENTE_VIGIL_TO_ADD.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-188
COMMENT ON COLUMN USR_V_ABIL_ENTE_VIGIL_TO_ADD.ID_ENTE_ORGANO_VIGIL IS 'PK.3';

-- changeset root:1753259446745-189
COMMENT ON COLUMN USR_V_ABIL_ENTE_VIGIL_TO_ADD.ID_USER_IAM_GESTITO IS 'PK.2';

-- changeset root:1753259446745-190
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ENTE_SUPPORTO_TO_DEL" ("ID_USER_IAM", "ID_ABIL_ENTE_SIAM", "ID_ENTE_SIAM", "ID_DICH_ABIL_ENTE_CONVENZ", "ID_APPART_COLLEG_ENTI", "ID_SUPT_EST_ENTE_CONVENZ", "ID_ACCORDO_VIGIL", "FL_ABIL_AUTOMATICA", "DS_CAUSALE_ABIL") AS select 
 usr.id_user_iam,
 abil_ente.id_abil_ente_siam,
 abil_ente.id_ente_siam,
 abil_ente.id_dich_abil_ente_convenz,
 abil_ente.id_appart_colleg_enti,
 abil_ente.id_supt_est_ente_convenz,
 abil_ente.id_accordo_vigil,
 abil_ente.fl_abil_automatica,
 abil_ente.ds_causale_abil

from USR_USER usr
join USR_ABIL_ENTE_SIAM abil_ente
	on (abil_ente.id_user_iam = usr.id_user_iam)

where abil_ente.id_dich_abil_ente_convenz is null
and abil_ente.id_supt_est_ente_convenz is not null
and abil_ente.fl_abil_automatica = '1';

-- changeset root:1753259446745-191
CREATE OR REPLACE FORCE VIEW "ORG_V_RIC_ENTE_NON_CONVENZ" ("ID_ENTE_SIAM", "NM_ENTE_SIAM", "DT_INI_VAL", "DT_CESSAZIONE", "ARCHIVISTA", "ID_USER_IAM_COR", "TI_ENTE_NON_CONVENZ", "ID_USER_IAM_ARK", "NM_USERID_ARK") AS select 
	ente.id_ente_siam,
	ente.nm_ente_siam,	
	ente.dt_ini_val,
	ente.dt_cessazione,
	
	case
		when (select nvl (count(*),0)
			  from org_ente_ark_rif count_archivisti
			  where ente.id_ente_siam = count_archivisti.id_ente_convenz
			 ) = 1
		  then (select ute_ark.nm_userid 
				from USR_USER ute_ark 
				where ute_ark.id_user_iam = archivisti.id_user_iam
				)
		when (select nvl (count(*),0)
			  from org_ente_ark_rif count_archivisti
			  where ente.id_ente_siam = count_archivisti.id_ente_convenz
			 ) = 0
		  then 'Nessun archivista definito'
		 else 'Ente con più di un archivista di riferimento'
 end archivista,
 
 abil_ente.id_user_iam id_user_iam_cor, 
 ente.ti_ente_non_convenz,
 
 utentearch.id_user_iam id_user_iam_ark, 
 utentearch.nm_userid nm_userid_ark 

from ORG_ENTE_SIAM ente
join USR_ABIL_ENTE_SIAM abil_ente 
 on (abil_ente.id_ente_siam = ente.id_ente_siam)
 
left join org_ente_ark_rif archivisti
 on (archivisti.id_ente_convenz = ente.id_ente_siam)
left join usr_user utentearch
 on (utentearch.id_user_iam = archivisti.id_user_iam)

where ti_ente = 'NON_CONVENZIONATO';

-- changeset root:1753259446745-192
COMMENT ON COLUMN ORG_V_RIC_ENTE_NON_CONVENZ.ID_ENTE_SIAM IS 'PK.1';

-- changeset root:1753259446745-193
CREATE OR REPLACE FORCE VIEW "ORG_V_RIC_ENTE_CONVENZ_BY_EST" ("ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_CATEG_ENTE", "ID_AMBITO_TERRIT", "DT_INI_VAL", "DT_CESSAZIONE", "FL_RECESSO", "ENTE_ATTIVO", "ID_USER_IAM_COR", "ID_AMBIENTE_ENTE_CONVENZ", "DT_DEC_ACCORDO", "DT_SCAD_ACCORDO", "FL_IN_CORSO_CONVENZ", "FL_NON_CONVENZ", "TI_ENTE_CONVENZ", "ID_ENTE_GESTORE", "ID_ENTE_CONSERV", "DT_FINE_VALID_ACCORDO") AS SELECT ente.id_ente_siam,
           ente.nm_ente_siam,
           ente.id_categ_ente,
           ente.id_ambito_territ,
           ente.dt_ini_val,
           ente.dt_cessazione,
           accordo.fl_recesso,
           CASE
               WHEN EXISTS
                        (SELECT NVL (dt_erog, NULL)
                           FROM ORG_SERVIZIO_EROG  servizio
                                JOIN ORG_ACCORDO_ENTE accordi
                                    ON (accordi.id_accordo_ente =
                                        servizio.id_accordo_ente)
                          WHERE     accordi.id_ente_convenz =
                                    ente.id_ente_siam
                                AND dt_erog IS NOT NULL)
               THEN
                   '1'
               ELSE
                   '0'
           END                      ente_attivo,
           abil_ente.id_user_iam    id_user_iam_cor,
           ente.id_ambiente_ente_convenz,
           accordo.dt_dec_accordo,
           accordo.dt_scad_accordo,
           CASE
               WHEN     EXISTS
                            (SELECT *
                               FROM ORG_ACCORDO_ENTE accordo_ente
                              WHERE accordo_ente.id_ente_convenz =
                                    ente.id_ente_siam)
                    AND accordo.dt_dec_accordo IS NULL
               THEN
                   '1'
               ELSE
                   '0'
           END                      fl_in_corso_convenz,
           CASE
               --Accordo valido (data corrente compresa tra data decorrenza e data fine validità e < data scadenza)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE     accordo_ente.id_ente_convenz =
                                    ente.id_ente_siam
                                AND accordo.dt_fine_valid_accordo >=
                                    TRUNC (SYSDATE)
                                AND accordo.dt_dec_accordo < TRUNC (SYSDATE)
                                AND accordo.dt_scad_accordo > TRUNC (SYSDATE))
               THEN
                   '0'
               --b) Accordo valido in corso di rinnovo (data corrente > data scadenza e < data fine validità)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE     accordo_ente.id_ente_convenz =
                                    ente.id_ente_siam
                                AND TRUNC (SYSDATE) <
                                    accordo.dt_fine_valid_accordo
                                --and accordo.dt_dec_accordo < trunc (sysdate)
                                AND TRUNC (SYSDATE) > accordo.dt_scad_accordo)
               THEN
                   '0'
               ELSE
                   '1'
           END                      fl_non_convenz,
           ente.ti_ente_convenz,
           accordo.id_ente_convenz_gestore,
           accordo.id_ente_convenz_conserv,
           accordo.dt_fine_valid_accordo
      FROM ORG_ENTE_SIAM  ente
           JOIN USR_ABIL_ENTE_SIAM abil_ente
               ON (abil_ente.id_ente_siam = ente.id_ente_siam)
           LEFT JOIN ORG_ACCORDO_ENTE accordo
               ON (accordo.id_ente_convenz = ente.id_ente_siam)
     WHERE     ente.ti_ente = 'CONVENZIONATO'
           AND (   (    accordo.dt_dec_accordo =
                        (SELECT MAX (accordo_max.dt_dec_accordo)
                           FROM ORG_ACCORDO_ENTE accordo_max
                          WHERE     accordo_max.id_ente_convenz =
                                    ente.id_ente_siam
                             --   AND accordo_max.dt_dec_accordo <= SYSDATE -- rimosso in data 10/12/2020
                             )
                    AND NOT EXISTS
                            (SELECT *
                               FROM ORG_ACCORDO_ENTE accordo_null
                              WHERE     accordo_null.id_ente_convenz =
                                        ente.id_ente_siam
                                    AND accordo_null.dt_dec_accordo IS NULL))
                OR accordo.dt_dec_accordo IS NULL);

-- changeset root:1753259446745-194
COMMENT ON COLUMN ORG_V_RIC_ENTE_CONVENZ_BY_EST.ID_ENTE_CONVENZ IS 'PK.1';

-- changeset root:1753259446745-195
CREATE OR REPLACE FORCE VIEW "USR_V_ENTI_SACER_BY_VIGIL" ("ID_ENTE_ORGANO_VIGIL", "ID_ORGANIZ_IAM_ENTE", "ID_VIGIL_ENTE_PRODUT", "ID_ENTE_PRODUT_VIGIL") AS select distinct										-- enti sacer di strut appartenenti ad enti produt vigilati da organo di vigilanza dell'utente inserito / modificato
acc_vigil.id_ente_organo_vigil,
org_strut.id_organiz_iam_padre id_organiz_iam_ente,
produt_vigil.id_vigil_ente_produt,
produt_vigil.id_ente_produt id_ente_produt_vigil

from ORG_ACCORDO_VIGIL acc_vigil
join ORG_VIGIL_ENTE_PRODUT produt_vigil
	on (produt_vigil.id_accordo_vigil = acc_vigil.id_accordo_vigil
	and produt_vigil.dt_ini_val <= trunc(sysdate)
	and produt_vigil.dt_fin_val >= trunc(sysdate))

join ORG_ENTE_CONVENZ_ORG strut_app_ente
	on (strut_app_ente.id_ente_convenz = produt_vigil.id_ente_produt
	and strut_app_ente.dt_ini_val <= trunc(sysdate)
	and strut_app_ente.dt_fine_val >= trunc(sysdate))
join USR_ORGANIZ_IAM org_strut
	on (org_strut.id_organiz_iam = strut_app_ente.id_organiz_iam)
where acc_vigil.dt_ini_val <= trunc(sysdate)
and acc_vigil.dt_fin_val >= trunc(sysdate);

-- changeset root:1753259446745-196
COMMENT ON COLUMN USR_V_ENTI_SACER_BY_VIGIL.ID_ORGANIZ_IAM_ENTE IS 'PK.1';

-- changeset root:1753259446745-197
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ORG_VIGIL_TO_ADD" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_USER_IAM_GESTITO", "ID_USO_USER_APPLIC_GESTITO", "ID_ORGANIZ_IAM_STRUT", "ID_VIGIL_ENTE_PRODUT", "ID_ENTE_PRODUT_VIGIL", "DS_CAUSALE_DICH") AS select 										-- strut sacer appartenenti ad enti produt vigilati da organo di vigilanza dell'utente inserito / modificato
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,

 user_gestito.id_user_iam id_user_iam_gestito,
 uso_apl_gestito.id_uso_user_applic id_uso_user_applic_gestito,

 strut_app_ente.id_organiz_iam id_organiz_iam_strut,
 produt_vigil.id_vigil_ente_produt,
 produt_vigil.id_ente_produt id_ente_produt_vigil,
 'Ente produttore vigilato da organo di vigilanza' ds_causale_dich

from USR_USER user_gestito
join ORG_ACCORDO_VIGIL acc_vigil
	on (acc_vigil.id_ente_organo_vigil = user_gestito.id_ente_siam
	and acc_vigil.dt_ini_val <= trunc(sysdate)
	and acc_vigil.dt_fin_val >= trunc(sysdate))
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join APL_APPLIC apl_cor
	on (apl_cor.nm_applic = 'SACER')
join USR_USO_USER_APPLIC uso_apl_gestito
	on (uso_apl_gestito.id_user_iam = user_gestito.id_user_iam
	and uso_apl_gestito.id_applic = apl_cor.id_applic)

join ORG_VIGIL_ENTE_PRODUT produt_vigil
	on (produt_vigil.id_accordo_vigil = acc_vigil.id_accordo_vigil
	and produt_vigil.dt_ini_val <= trunc(sysdate)
	and produt_vigil.dt_fin_val >= trunc(sysdate))

join ORG_ENTE_CONVENZ_ORG strut_app_ente
	on (strut_app_ente.id_ente_convenz = produt_vigil.id_ente_produt
	and strut_app_ente.dt_ini_val <= trunc(sysdate)
	and strut_app_ente.dt_fine_val >= trunc(sysdate))
join USR_ORGANIZ_IAM org
  on (org.id_organiz_iam = strut_app_ente.id_organiz_iam
  and org.id_applic = apl_cor.id_applic)

where strut_app_ente.id_organiz_iam in (select abil_org.id_organiz_iam				-- strutture Sacer abilitate ad utente corrente
										 from USR_USO_USER_APPLIC uso_apl
										 join USR_ABIL_ORGANIZ abil_org
											on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)
										 where uso_apl.id_user_iam = user_cor.id_user_iam
										 and uso_apl.id_applic = apl_cor.id_applic
										 )
and strut_app_ente.id_organiz_iam not in (select abil_org.id_organiz_iam
										  from USR_USO_USER_APPLIC uso_apl
										 join USR_ABIL_ORGANIZ abil_org
											on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)
										 where uso_apl.id_user_iam = user_gestito.id_user_iam
										 and uso_apl.id_applic = apl_cor.id_applic
										 );

-- changeset root:1753259446745-198
COMMENT ON COLUMN USR_V_ABIL_ORG_VIGIL_TO_ADD.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-199
COMMENT ON COLUMN USR_V_ABIL_ORG_VIGIL_TO_ADD.ID_USER_IAM_GESTITO IS 'PK.2';

-- changeset root:1753259446745-200
COMMENT ON COLUMN USR_V_ABIL_ORG_VIGIL_TO_ADD.ID_ORGANIZ_IAM_STRUT IS 'PK.3';

-- changeset root:1753259446745-201
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_USER_VIGIL_BY_STRUT" ("ID_ORGANIZ_IAM", "ID_ENTE_PRODUT", "ID_ACCORDO_VIGIL", "ID_ENTE_ORGANO_VIGIL", "ID_USER_IAM") AS select distinct
 org.id_organiz_iam,
 vigil_ente.id_ente_produt,
 acc_vigil.id_accordo_vigil,
 acc_vigil.id_ente_organo_vigil,
 usr.id_user_iam
from USR_ORGANIZ_IAM org
join APL_APPLIC apl
	on (apl.id_applic = org.id_applic
	and apl.nm_applic = 'SACER')
join ORG_ENTE_CONVENZ_ORG ente_org
	on (ente_org.id_organiz_iam = org.id_organiz_iam
	and ente_org.dt_ini_val <= trunc(sysdate)
	and ente_org.dt_fine_val >= trunc(sysdate))
join ORG_VIGIL_ENTE_PRODUT vigil_ente
	on (vigil_ente.id_ente_produt = ente_org.id_ente_convenz
	and vigil_ente.dt_ini_val <= trunc(sysdate)
	and vigil_ente.dt_fin_val >= trunc(sysdate))
join ORG_ACCORDO_VIGIL acc_vigil
	on (acc_vigil.id_accordo_vigil = vigil_ente.id_accordo_vigil
	and acc_vigil.dt_ini_val <= trunc(sysdate)
	and acc_vigil.dt_fin_val >= trunc(sysdate))
join USR_USER usr
	on (usr.id_ente_siam = acc_vigil.id_ente_organo_vigil
	and usr.tipo_user = 'PERSONA_FISICA'
	and usr.fl_abil_organiz_autom = '1')
join USR_STATO_USER stato_usr
	on (stato_usr.id_stato_user = usr.id_stato_user_cor
	and stato_usr.ti_stato_user != 'CESSATO');

-- changeset root:1753259446745-202
COMMENT ON COLUMN USR_V_LIS_USER_VIGIL_BY_STRUT.ID_ORGANIZ_IAM IS 'PK.1';

-- changeset root:1753259446745-203
COMMENT ON COLUMN USR_V_LIS_USER_VIGIL_BY_STRUT.ID_USER_IAM IS 'PK.2';

-- changeset root:1753259446745-204
CREATE OR REPLACE FORCE VIEW "USR_V_UNAORG_BY_VIGIL" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ENTE_ORGANO_VIGIL", "ID_ORGANIZ_IAM_STRUT", "ID_ENTE_PRODUT_CORRISP", "ID_VIGIL_ENTE_PRODUT", "ID_ENTE_PRODUT_VIGIL", "DS_CAUSALE_DICH", "ID_RICH_GEST_USER") AS select   														-- strut Sacer appartenenti ad ente produt corrispondente ad organo di vigilanza dell'utente inserito / modificato
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,

 ente_non_convenz.id_ente_siam id_ente_organo_vigil,
 strut_app_ente.id_organiz_iam id_organiz_iam_strut,
 ente_non_convenz.id_ente_produt_corrisp,
 null id_vigil_ente_produt,
 null id_ente_produt_vigil,
 'Ente produttore corrispondente ad organo di vigilanza' ds_causale_dich,

 rich.id_rich_gest_user

from ORG_ENTE_SIAM ente_non_convenz	
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join APL_APPLIC apl_cor
	on (apl_cor.nm_applic = 'SACER')						
join ORG_ENTE_CONVENZ_ORG strut_app_ente
	on (strut_app_ente.id_ente_convenz = ente_non_convenz.id_ente_produt_corrisp)
join USR_ORGANIZ_IAM org
  on (org.id_organiz_iam = strut_app_ente.id_organiz_iam
  and org.id_applic = apl_cor.id_applic)

join USR_RICH_GEST_USER rich
	on (rich.id_rich_gest_user > 0)

where strut_app_ente.dt_ini_val <= trunc(sysdate)
and strut_app_ente.dt_fine_val >= trunc(sysdate)
and strut_app_ente.id_organiz_iam in (select abil_org.id_organiz_iam				-- strutture Sacer abilitate ad utente corrente
									 from USR_USO_USER_APPLIC uso_apl
								     join USR_ABIL_ORGANIZ abil_org
										on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)
									 where uso_apl.id_user_iam = user_cor.id_user_iam
									 and uso_apl.id_applic = apl_cor.id_applic
									 )

UNION

select 										-- strut sacer appartenenti ad enti produt vigilati da organo di vigilanza dell'utente inserito / modificato
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,

 acc_vigil.id_ente_organo_vigil,
 strut_app_ente.id_organiz_iam id_organiz_iam_strut,
 null id_ente_produt_corrisp,
 produt_vigil.id_vigil_ente_produt,
 produt_vigil.id_ente_produt id_ente_produt_vigil,
 'Ente produttore vigilato da organo di vigilanza' ds_causale_dich,

 rich.id_rich_gest_user

from ORG_ACCORDO_VIGIL acc_vigil
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join APL_APPLIC apl_cor
	on (apl_cor.nm_applic = 'SACER')	

join ORG_VIGIL_ENTE_PRODUT produt_vigil
	on (produt_vigil.id_accordo_vigil = acc_vigil.id_accordo_vigil
	and produt_vigil.dt_ini_val <= trunc(sysdate)
	and produt_vigil.dt_fin_val >= trunc(sysdate))

join ORG_ENTE_CONVENZ_ORG strut_app_ente
	on (strut_app_ente.id_ente_convenz = produt_vigil.id_ente_produt
	and strut_app_ente.dt_ini_val <= trunc(sysdate)
	and strut_app_ente.dt_fine_val >= trunc(sysdate))
join USR_ORGANIZ_IAM org
  on (org.id_organiz_iam = strut_app_ente.id_organiz_iam
  and org.id_applic = apl_cor.id_applic)

join USR_RICH_GEST_USER rich
	on (rich.id_rich_gest_user > 0)

where acc_vigil.dt_ini_val <= trunc(sysdate)
and acc_vigil.dt_fin_val >= trunc(sysdate)
and strut_app_ente.id_organiz_iam in (select abil_org.id_organiz_iam				-- strutture Sacer abilitate ad utente corrente
									 from USR_USO_USER_APPLIC uso_apl
								     join USR_ABIL_ORGANIZ abil_org
										on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)
									 where uso_apl.id_user_iam = user_cor.id_user_iam
									 and uso_apl.id_applic = apl_cor.id_applic
									 )

and produt_vigil.id_ente_produt in (select ente_servito.id_ente_convenz_servito			-- ente produt delle strutture servito da ente della richiesta
								   from USR_V_LIS_ENTI_CONVENZ_SERVITI ente_servito
								   where ente_servito.id_ente_convenz_servente = rich.id_ente_rich
								   );

-- changeset root:1753259446745-205
COMMENT ON COLUMN USR_V_UNAORG_BY_VIGIL.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-206
COMMENT ON COLUMN USR_V_UNAORG_BY_VIGIL.ID_ORGANIZ_IAM_STRUT IS 'PK.2';

-- changeset root:1753259446745-207
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_DATI_VIGIL_TO_ADD" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_USER_IAM_GESTITO", "ID_USO_USER_APPLIC_GESTITO", "ID_ORGANIZ_IAM_STRUT", "ID_TIPO_DATO_IAM", "ID_VIGIL_ENTE_PRODUT", "ID_ENTE_PRODUT_VIGIL", "DS_CAUSALE_DICH") AS select 										-- strut sacer appartenenti ad enti produt vigilati da organo di vigilanza dell'utente inserito / modificato
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,

 user_gestito.id_user_iam id_user_iam_gestito,
 uso_apl_gestito.id_uso_user_applic,

 strut_app_ente.id_organiz_iam id_organiz_iam_strut,
 tipo_dato.id_tipo_dato_iam,
 produt_vigil.id_vigil_ente_produt,
 produt_vigil.id_ente_produt id_ente_produt_vigil,
 'Ente produttore vigilato da organo di vigilanza' ds_causale_dich

from USR_USER user_gestito
join ORG_ACCORDO_VIGIL acc_vigil
	on (acc_vigil.id_ente_organo_vigil = user_gestito.id_ente_siam
	and acc_vigil.dt_ini_val <= trunc(sysdate)
	and acc_vigil.dt_fin_val >= trunc(sysdate))
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join APL_APPLIC apl_cor
	on (apl_cor.nm_applic = 'SACER')	
join USR_USO_USER_APPLIC uso_apl_gestito
	on (uso_apl_gestito.id_user_iam = user_gestito.id_user_iam
	and uso_apl_gestito.id_applic = apl_cor.id_applic)

join ORG_VIGIL_ENTE_PRODUT produt_vigil
	on (produt_vigil.id_accordo_vigil = acc_vigil.id_accordo_vigil
	and produt_vigil.dt_ini_val <= sysdate
	and produt_vigil.dt_fin_val >= sysdate)

join ORG_ENTE_CONVENZ_ORG strut_app_ente
	on (strut_app_ente.id_ente_convenz = produt_vigil.id_ente_produt
	and strut_app_ente.dt_ini_val <= trunc(sysdate)
	and strut_app_ente.dt_fine_val >= trunc(sysdate))
join USR_ORGANIZ_IAM org
  on (org.id_organiz_iam = strut_app_ente.id_organiz_iam
  and org.id_applic = apl_cor.id_applic)

join USR_TIPO_DATO_IAM tipo_dato
	on (tipo_dato.id_organiz_iam = org.id_organiz_iam)

where tipo_dato.id_tipo_dato_iam in (select abil_dati.id_tipo_dato_iam			-- tipi dato Sacer abilitati ad utente corrente
									 from USR_USO_USER_APPLIC uso_apl
									 join USR_ABIL_DATI abil_dati
											on (abil_dati.id_uso_user_applic = uso_apl.id_uso_user_applic)
									 where uso_apl.id_user_iam = user_cor.id_user_iam
									 and uso_apl.id_applic = apl_cor.id_applic
									 )
and tipo_dato.id_tipo_dato_iam not in (select abil_dati.id_tipo_dato_iam
									  from USR_USO_USER_APPLIC uso_apl
									  join USR_ABIL_DATI abil_dati
											on (abil_dati.id_uso_user_applic = uso_apl.id_uso_user_applic)
									  where uso_apl.id_user_iam = user_gestito.id_user_iam
									  and uso_apl.id_applic = apl_cor.id_applic
									  );

-- changeset root:1753259446745-208
COMMENT ON COLUMN USR_V_ABIL_DATI_VIGIL_TO_ADD.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-209
COMMENT ON COLUMN USR_V_ABIL_DATI_VIGIL_TO_ADD.ID_USER_IAM_GESTITO IS 'PK.2';

-- changeset root:1753259446745-210
COMMENT ON COLUMN USR_V_ABIL_DATI_VIGIL_TO_ADD.ID_TIPO_DATO_IAM IS 'PK.3';

-- changeset root:1753259446745-211
CREATE OR REPLACE FORCE VIEW "USR_V_ENTI_SACER_BY_COLLEG" ("ID_ENTE_PRODUT", "ID_ORGANIZ_IAM_ENTE", "ID_ENTE_PRODUT_COLLEG", "ID_APPART_COLLEG_ENTI") AS select distinct															-- enti sacer di strut appartenenti ad ente produt collegati all'ente produt dell'utente inserito / modificato
app_colleg_produt.id_ente_convenz id_ente_produt,
org_strut.id_organiz_iam_padre id_organiz_iam_ente,
app_colleg.id_ente_convenz id_ente_produt_colleg,
app_colleg.id_appart_colleg_enti

from ORG_APPART_COLLEG_ENTI app_colleg_produt						-- colleg del ente produt dell'utente inserito / modificato 
join ORG_APPART_COLLEG_ENTI app_colleg								-- enti produt collegati
	on (app_colleg.id_colleg_enti_convenz = app_colleg_produt.id_colleg_enti_convenz
	and app_colleg.dt_ini_val <= trunc(sysdate)
	and app_colleg.dt_fin_val >= trunc(sysdate)
	and app_colleg.id_ente_convenz != app_colleg_produt.id_ente_convenz)
join ORG_ENTE_CONVENZ_ORG strut_app_ente							-- strut appartenenti ad enti colleg
	on (strut_app_ente.id_ente_convenz = app_colleg.id_ente_convenz
	and strut_app_ente.dt_ini_val <= trunc(sysdate)
	and strut_app_ente.dt_fine_val >= trunc(sysdate))
join USR_ORGANIZ_IAM org_strut
	on (org_strut.id_organiz_iam = strut_app_ente.id_organiz_iam)
where app_colleg_produt.dt_ini_val <= trunc(sysdate)
and app_colleg_produt.dt_fin_val >= trunc(sysdate);

-- changeset root:1753259446745-212
COMMENT ON COLUMN USR_V_ENTI_SACER_BY_COLLEG.ID_ORGANIZ_IAM_ENTE IS 'PK.1';

-- changeset root:1753259446745-213
CREATE OR REPLACE FORCE VIEW "ORG_V_CHK_REF_ENTE" ("ID_ENTE_REF", "ID_USER_IAM", "FL_REF_OK") AS select
 ente_cor.id_ente_siam id_ente_ref,
 usr_ref_ente.id_user_iam,
 case
	when ente_cor.ti_ente = 'CONVENZIONATO'
		then 
			case
				when ente_cor.id_ente_siam = usr_ref_ente.id_ente_siam
					then '1'
				when ente_cor.id_ente_siam != usr_ref_ente.id_ente_siam
				and exists (select *
							from org_appart_colleg_enti colleg_ente_cor
							join org_colleg_enti_convenz colleg
								on (colleg.id_colleg_enti_convenz = colleg_ente_cor.id_colleg_enti_convenz)
							join org_appart_colleg_enti colleg_ente_usr
								on (colleg_ente_usr.id_colleg_enti_convenz = colleg.id_colleg_enti_convenz
								and colleg_ente_usr.id_ente_convenz = usr_ref_ente.id_ente_siam)
							where colleg_ente_cor.id_ente_convenz = ente_cor.id_ente_siam
							)
					then '1'
					else '0'
			end
	when ente_cor.ti_ente = 'NON_CONVENZIONATO'
		then 
			case
				when ente_cor.id_ente_siam = usr_ref_ente.id_ente_siam
					then '1'
				when ente_cor.id_ente_siam != usr_ref_ente.id_ente_siam
				and ente_cor.id_ente_produt_corrisp = usr_ref_ente.id_ente_siam
					then '1'
					else '0'
			end
 end fl_ref_ok
from ORG_ENTE_SIAM ente_cor
join USR_USER usr_ref_ente
	on (usr_ref_ente.id_user_iam > 0);

-- changeset root:1753259446745-214
COMMENT ON COLUMN ORG_V_CHK_REF_ENTE.ID_ENTE_REF IS 'PK.1';

-- changeset root:1753259446745-215
COMMENT ON COLUMN ORG_V_CHK_REF_ENTE.ID_USER_IAM IS 'PK.2';

-- changeset root:1753259446745-216
CREATE OR REPLACE FORCE VIEW "USR_V_UNAORG_BY_PRODUT" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ENTE_PRODUT", "ID_ORGANIZ_IAM_STRUT", "ID_APPART_COLLEG_ENTI", "ID_ENTE_PRODUT_COLLEG", "DS_CAUSALE_DICH") AS select   																		-- strutture Sacer / versatori Ping appartenenti ad ente produt dell'utente inserito / modificato
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,

 org_app_ente.id_ente_convenz id_ente_produt,
 org_app_ente.id_organiz_iam id_organiz_iam_strut,
 null id_appart_colleg_enti,
 null id_ente_produt_colleg,
 'Appartenenza ad ente produttore' ds_causale_dich

from ORG_ENTE_CONVENZ_ORG org_app_ente	
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join APL_APPLIC apl_cor
	on (apl_cor.id_applic > 0)
join usr_organiz_iam org
  on (org.id_organiz_iam = org_app_ente.id_organiz_iam
  and org.id_applic = apl_cor.id_applic)
where org_app_ente.dt_ini_val <= trunc(sysdate)
and org_app_ente.dt_fine_val >= trunc(sysdate)
and org_app_ente.id_organiz_iam in (select abil_org.id_organiz_iam				-- strutture Sacer / versatori Ping abilitati ad utente corrente
									 from USR_USO_USER_APPLIC uso_apl
								     join USR_ABIL_ORGANIZ abil_org
										on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)
									 where uso_apl.id_user_iam = user_cor.id_user_iam
									 and uso_apl.id_applic = apl_cor.id_applic
									 )

UNION


select distinct															-- strutture Sacer appartenenti ad ente produt collegati all'ente produt dell'utente inserito / modificato
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,

app_colleg_produt.id_ente_convenz id_ente_produt,
strut_app_ente.id_organiz_iam id_organiz_iam_strut,
app_colleg.id_appart_colleg_enti,
app_colleg.id_ente_convenz id_ente_produt_colleg,
 'Ente produttore collegato ad ente a cui appartiene utente' ds_causale_dich

from ORG_APPART_COLLEG_ENTI app_colleg_produt						-- colleg del ente produt dell'utente inserito / modificato 
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join APL_APPLIC apl_cor
	on (apl_cor.nm_applic = 'SACER')
join ORG_APPART_COLLEG_ENTI app_colleg								-- enti produt collegati
	on (app_colleg.id_colleg_enti_convenz = app_colleg_produt.id_colleg_enti_convenz
	and app_colleg.dt_ini_val <= trunc(sysdate)
	and app_colleg.dt_fin_val >= trunc(sysdate)
	and app_colleg.id_ente_convenz != app_colleg_produt.id_ente_convenz)
join ORG_ENTE_CONVENZ_ORG strut_app_ente							-- strut appartenenti ad enti colleg
	on (strut_app_ente.id_ente_convenz = app_colleg.id_ente_convenz
	and strut_app_ente.dt_ini_val <= trunc(sysdate)
	and strut_app_ente.dt_fine_val >= trunc(sysdate))
join usr_organiz_iam org
  on (org.id_organiz_iam = strut_app_ente.id_organiz_iam
  and org.id_applic = apl_cor.id_applic)

where app_colleg_produt.dt_ini_val <= trunc(sysdate)
and app_colleg_produt.dt_fin_val >= trunc(sysdate)

and strut_app_ente.id_organiz_iam in (select abil_org.id_organiz_iam				-- strutture Sacer abilitate ad utente corrente
									 from USR_USO_USER_APPLIC uso_apl
								     join USR_ABIL_ORGANIZ abil_org
										on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)
									 where uso_apl.id_user_iam = user_cor.id_user_iam
									 and uso_apl.id_applic = apl_cor.id_applic
									 )

UNION


select distinct															-- versatori ping appartenenti ad ente produt collegati all'ente produt dell'utente inserito / modificato
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,

app_colleg_produt.id_ente_convenz id_ente_produt,
strut_app_ente.id_organiz_iam id_organiz_iam_strut,
app_colleg.id_appart_colleg_enti,
app_colleg.id_ente_convenz id_ente_produt_colleg,
 'Ente produttore collegato ad ente a cui appartiene utente' ds_causale_dich

from ORG_APPART_COLLEG_ENTI app_colleg_produt						-- colleg del ente produt dell'utente inserito / modificato 
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join APL_APPLIC apl_cor
	on (apl_cor.nm_applic = 'SACER_PREINGEST')
join ORG_APPART_COLLEG_ENTI app_colleg								-- enti produt collegati
	on (app_colleg.id_colleg_enti_convenz = app_colleg_produt.id_colleg_enti_convenz
	and app_colleg.dt_ini_val <= trunc(sysdate)
	and app_colleg.dt_fin_val >= trunc(sysdate)
	and app_colleg.id_ente_convenz != app_colleg_produt.id_ente_convenz)
join ORG_ENTE_CONVENZ_ORG strut_app_ente							-- versatori appartenenti ad enti colleg
	on (strut_app_ente.id_ente_convenz = app_colleg.id_ente_convenz
	and strut_app_ente.dt_ini_val <= trunc(sysdate)
	and strut_app_ente.dt_fine_val >= trunc(sysdate))
join usr_organiz_iam org
  on (org.id_organiz_iam = strut_app_ente.id_organiz_iam
  and org.id_applic = apl_cor.id_applic)

where app_colleg_produt.dt_ini_val <= trunc(sysdate)
and app_colleg_produt.dt_fin_val >= trunc(sysdate)

and strut_app_ente.id_organiz_iam in (select abil_org.id_organiz_iam				-- strutture Sacer abilitate ad utente corrente
									 from USR_USO_USER_APPLIC uso_apl
								     join USR_ABIL_ORGANIZ abil_org
										on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)
									 where uso_apl.id_user_iam = user_cor.id_user_iam
									 and uso_apl.id_applic = apl_cor.id_applic
									 );

-- changeset root:1753259446745-217
COMMENT ON COLUMN USR_V_UNAORG_BY_PRODUT.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-218
COMMENT ON COLUMN USR_V_UNAORG_BY_PRODUT.ID_ORGANIZ_IAM_STRUT IS 'PK.2';

-- changeset root:1753259446745-219
CREATE OR REPLACE FORCE VIEW "USR_V_UNAORG_BY_GESTORE" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ORGANIZ_IAM", "ID_ENTE_GESTORE", "DS_CAUSALE_DICH") AS select  																		-- strutture Sacer su cui l'utente corrente e' abilitato per qualunque dichiarazione
 user_cor.id_user_iam id_user_iam_cor,
 apl.id_applic, apl.nm_applic,
 abil_org.id_organiz_iam,
 org_amb.id_ente_gestore,
 'Appartenenza ad ente gestore' ds_causale_dich
  
from SACER_IAM.USR_USER user_cor
join SACER_IAM.USR_USO_USER_APPLIC uso_apl
	on (uso_apl.id_user_iam = user_cor.id_user_iam)
join SACER_IAM.APL_APPLIC apl
	on (apl.id_applic = uso_apl.id_applic
	and apl.nm_applic = 'SACER')
join SACER_IAM.USR_ABIL_ORGANIZ abil_org
	on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)

join SACER_IAM.USR_ORGANIZ_IAM org_strut
	on (org_strut.id_organiz_iam = abil_org.id_organiz_iam)
join SACER_IAM.USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam = org_strut.id_organiz_iam_padre)
join SACER_IAM.USR_ORGANIZ_IAM org_amb
	on (org_amb.id_organiz_iam = org_ente.id_organiz_iam_padre)
        
UNION

select  																		
 user_cor.id_user_iam id_user_iam_cor,
 apl.id_applic, apl.nm_applic,
 abil_org.id_organiz_iam,
 strut.id_ente_convenz,
 'Appartenenza ad ente gestore' ds_causale_dich
  
from SACER_IAM.USR_USER user_cor
join SACER_IAM.USR_USO_USER_APPLIC uso_apl
	on (uso_apl.id_user_iam = user_cor.id_user_iam)
join SACER_IAM.APL_APPLIC apl
	on (apl.id_applic = uso_apl.id_applic
	and apl.nm_applic = 'SACER')
join SACER_IAM.USR_ABIL_ORGANIZ abil_org
	on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)

join SACER_IAM.USR_ORGANIZ_IAM org_strut
	on (org_strut.id_organiz_iam = abil_org.id_organiz_iam)
join SACER_IAM.USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam = org_strut.id_organiz_iam_padre)
join SACER_IAM.USR_ORGANIZ_IAM org_amb
	on (org_amb.id_organiz_iam = org_ente.id_organiz_iam_padre)
        
JOIN SACER_IAM.APL_TIPO_ORGANIZ tipo_organiz
on(org_strut.id_tipo_organiz = tipo_organiz.id_tipo_organiz)

JOIN SACER_IAM.ORG_ENTE_CONVENZ_ORG ente_convenz_org
on(org_strut.id_organiz_iam = ente_convenz_org.id_organiz_iam)

JOIN SACER.ORG_STRUT strut
    on(strut.id_strut = org_strut.id_organiz_applic
    and apl.nm_applic = 'SACER'
    and tipo_organiz.nm_tipo_organiz = 'STRUTTURA')
	
WHERE ente_convenz_org.dt_ini_val <= sysdate and ente_convenz_org.dt_fine_val >= sysdate
    
    UNION

select  																		-- versatori Ping su cui l'utente corrente e' abilitato per qualunque dichiarazione
 user_cor.id_user_iam id_user_iam_cor,
 apl.id_applic, apl.nm_applic,
 abil_org.id_organiz_iam,
 org_amb.id_ente_gestore,
 'Appartenenza ad ente gestore' ds_causale_dich
  
from SACER_IAM.USR_USER user_cor
join SACER_IAM.USR_USO_USER_APPLIC uso_apl
	on (uso_apl.id_user_iam = user_cor.id_user_iam)
join SACER_IAM.APL_APPLIC apl
	on (apl.id_applic = uso_apl.id_applic
	and apl.nm_applic = 'SACER_PREINGEST')
join SACER_IAM.USR_ABIL_ORGANIZ abil_org
	on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)

join SACER_IAM.USR_ORGANIZ_IAM org_vers
	on (org_vers.id_organiz_iam = abil_org.id_organiz_iam)
join SACER_IAM.USR_ORGANIZ_IAM org_amb
	on (org_amb.id_organiz_iam = org_vers.id_organiz_iam_padre)
    
    UNION
    
   select  																		-- versatori Ping su cui l'utente corrente e' abilitato per qualunque dichiarazione
 user_cor.id_user_iam id_user_iam_cor,
 apl.id_applic, apl.nm_applic,
 abil_org.id_organiz_iam,
 vers.id_ente_convenz,
 'Appartenenza ad ente gestore' ds_causale_dich
  
from SACER_IAM.USR_USER user_cor
join SACER_IAM.USR_USO_USER_APPLIC uso_apl
	on (uso_apl.id_user_iam = user_cor.id_user_iam)
join SACER_IAM.APL_APPLIC apl
	on (apl.id_applic = uso_apl.id_applic
	and apl.nm_applic = 'SACER_PREINGEST')
join SACER_IAM.USR_ABIL_ORGANIZ abil_org
	on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)

join SACER_IAM.USR_ORGANIZ_IAM org_vers
	on (org_vers.id_organiz_iam = abil_org.id_organiz_iam)
join SACER_IAM.USR_ORGANIZ_IAM org_amb
	on (org_amb.id_organiz_iam = org_vers.id_organiz_iam_padre)

JOIN SACER_IAM.APL_TIPO_ORGANIZ tipo_organiz
on(org_vers.id_tipo_organiz = tipo_organiz.id_tipo_organiz)

JOIN SACER_IAM.ORG_ENTE_CONVENZ_ORG ente_convenz_org
on(org_vers.id_organiz_iam = ente_convenz_org.id_organiz_iam)

JOIN sacer_ping.PIG_VERS vers
    on(vers.id_vers = org_vers.id_organiz_applic
    and apl.nm_applic = 'SACER_PREINGEST'
    and tipo_organiz.nm_tipo_organiz = 'VERSATORE')
	
WHERE ente_convenz_org.dt_ini_val <= sysdate and ente_convenz_org.dt_fine_val >= sysdate;

-- changeset root:1753259446745-220
CREATE OR REPLACE FORCE VIEW "ORG_V_CALC_TOT_FATT" ("ID_FATTURA_ENTE", "IM_TOT_FATTURA", "IM_TOT_DA_PAGARE", "IM_TOT_IVA") AS select 
 tmp.id_fattura_ente,
 tmp.im_tot_netto + tmp.im_tot_iva im_tot_fattura,
 tmp.im_tot_netto + im_tot_iva_da_pagare im_tot_da_pagare,
 tmp.im_tot_iva

from (
		select
		 fatt.id_fattura_ente,
		 
		 (select round(sum(im_servizio_netto), 2)
		 from (
			 select im_servizio_fattura im_servizio_netto
			 from ORG_SERVIZIO_FATTURA serv_fatt
			 where serv_fatt.id_fattura_ente = fatt.id_fattura_ente
			)
		 ) im_tot_netto,

		 (select round(sum(im_iva_da_pagare), 2)
		 from (
			 select case
					when iva.cd_iva = 'NOIVA'
						then 0
					when iva.cd_iva = 'PB'
						then 0
					when iva.cd_iva = 'HB'
						then im_iva
					when iva.cd_iva = 'GB'
						then im_iva
				  end im_iva_da_pagare
			 from ORG_SERVIZIO_FATTURA serv_fatt
			 join ORG_CD_IVA iva
			  on (iva.id_cd_iva  = serv_fatt.id_cd_iva)
			 where serv_fatt.id_fattura_ente = fatt.id_fattura_ente
			)
		 ) im_tot_iva_da_pagare,
		 
		 (select round(sum(im_iva), 2)
		 from (
			 select im_iva im_iva
			 from ORG_SERVIZIO_FATTURA serv_fatt
			 where serv_fatt.id_fattura_ente = fatt.id_fattura_ente
			)
		 ) im_tot_iva

		from ORG_FATTURA_ENTE fatt
		) tmp;

-- changeset root:1753259446745-221
COMMENT ON COLUMN ORG_V_CALC_TOT_FATT.ID_FATTURA_ENTE IS 'PK.1';

-- changeset root:1753259446745-222
CREATE OR REPLACE FORCE VIEW "ORG_V_LIS_SERV_FATTURA" ("ID_FATTURA_ENTE", "ID_SERVIZIO_FATTURA", "AA_SERVIZIO_FATTURA", "NM_SERVIZIO_FATTURA", "IM_NETTO", "NI_BYTE_VERS", "NI_UNITÀ_DOC_VERS", "NI_ABITANTI", "DT_EROG", "MM_FATTURA", "CD_IVA", "IM_IVA", "FL_SUPERAMENTO_SCAGLIONE", "CD_DDT", "CD_ODA", "NM_SERVIZIO_EROGATO", "FL_PAGAMENTO", "TIPO_FATTURAZIONE", "NM_TARIFFA", "IM_VALORE_TARIFFA", "CD_TIPO_SERVIZIO", "NM_SISTEMA_VERSANTE", "DT_EROG_SERV_EROG", "GG_FATTURAZIONE") AS SELECT serv_fatt.id_fattura_ente,
           serv_fatt.id_servizio_fattura,
           serv_fatt.aa_servizio_fattura,
           serv_fatt.nm_servizio_fattura,
           serv_fatt.im_servizio_fattura    im_netto,
           --  quantità usate per calcolo importo netto
           CASE
               WHEN tariffa.tipo_tariffa IN
                        ('VALORE_SCAGLIONI_STORAGE',
                         'VALORE_UNITARIO_SCAGLIONI_STORAGE')
               THEN
                   serv_fatt.qt_scaglione_servizio_fattura
               ELSE
                   NULL
           END                              ni_byte_vers,
           CASE
               WHEN tariffa.tipo_tariffa = 'VALORE_SCAGLIONI_UD_VERSATE'
               THEN
                   serv_fatt.qt_scaglione_servizio_fattura
               ELSE
                   NULL
           END                              ni_unità_doc_vers,
           CASE
               WHEN tariffa.tipo_tariffa =
                    'VALORE_UNITARIO_SCAGLIONI_STORAGE'
               THEN
                   serv_fatt.qt_unit_servizio_fattura
               ELSE
                   NULL
           END                              ni_abitanti,
           --  data erogazione e mesi fatturati

           serv_fatt.dt_erog,
           CASE
               WHEN ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE'
               THEN
                   CASE
                       WHEN serv_fatt.aa_servizio_fattura <
                            --extract (year from acc.dt_scad_accordo)
                            EXTRACT (
                                YEAR FROM (SELECT MIN (t.col)
                                             FROM (SELECT t.dt_scad_accordo    AS col
                                                     FROM org_accordo_ente t
                                                    WHERE t.id_accordo_ente =
                                                          acc.id_accordo_ente
                                                   UNION ALL
                                                   SELECT t.dt_fine_valid_accordo    AS col
                                                     FROM org_accordo_ente t
                                                    WHERE t.id_accordo_ente =
                                                          acc.id_accordo_ente)
                                                  t))
                       THEN
                           CASE
                               WHEN EXTRACT (YEAR FROM serv_fatt.dt_erog) <
                                    serv_fatt.aa_servizio_fattura
                               --then 12
                               --else 12 - extract (month from serv_fatt.dt_erog)
                               THEN
                                   CASE
                                       WHEN EXTRACT (
                                                YEAR FROM acc.dt_dec_accordo) =
                                            serv_fatt.aa_servizio_fattura
                                       THEN
                                             -- controllo data inizio
                                             12
                                           - EXTRACT (
                                                 MONTH FROM acc.dt_dec_accordo)
                                       ELSE
                                           12
                                   END
                               ELSE
                                     12
                                   - EXTRACT (MONTH FROM serv_fatt.dt_erog)
                           END
                       WHEN serv_fatt.aa_servizio_fattura =
                            --extract (year from acc.dt_scad_accordo)
                            EXTRACT (
                                YEAR FROM (SELECT MIN (t.col)
                                             FROM (SELECT t.dt_scad_accordo    AS col
                                                     FROM org_accordo_ente t
                                                    WHERE t.id_accordo_ente =
                                                          acc.id_accordo_ente
                                                   UNION ALL
                                                   SELECT t.dt_fine_valid_accordo    AS col
                                                     FROM org_accordo_ente t
                                                    WHERE t.id_accordo_ente =
                                                          acc.id_accordo_ente)
                                                  t))
                       THEN
                           CASE
                               WHEN EXTRACT (YEAR FROM serv_fatt.dt_erog) <
                                    serv_fatt.aa_servizio_fattura
                               THEN
                                   EXTRACT  --(month from acc.dt_scad_accordo)
                                           (
                                       MONTH FROM (SELECT MIN (t.col)
                                                     FROM (SELECT t.dt_scad_accordo    AS col
                                                             FROM org_accordo_ente
                                                                  t
                                                            WHERE t.id_accordo_ente =
                                                                  acc.id_accordo_ente
                                                           UNION ALL
                                                           SELECT t.dt_fine_valid_accordo    AS col
                                                             FROM org_accordo_ente
                                                                  t
                                                            WHERE t.id_accordo_ente =
                                                                  acc.id_accordo_ente)
                                                          t))
                               ELSE
                                     EXTRACT --(month from acc.dt_scad_accordo)
                                             (
                                         MONTH FROM (SELECT MIN (t.col)
                                                       FROM (SELECT t.dt_scad_accordo    AS col
                                                               FROM org_accordo_ente
                                                                    t
                                                              WHERE t.id_accordo_ente =
                                                                    acc.id_accordo_ente
                                                             UNION ALL
                                                             SELECT t.dt_fine_valid_accordo    AS col
                                                               FROM org_accordo_ente
                                                                    t
                                                              WHERE t.id_accordo_ente =
                                                                    acc.id_accordo_ente)
                                                            t))
                                   - EXTRACT (MONTH FROM serv_fatt.dt_erog)
                                   - 1
                           END
                       ELSE
                           NULL
                   END
               ELSE
                   NULL
           END                              mm_fattura,
           --  info su IVA

           iva.cd_iva,
           serv_fatt.im_iva,
           --  superamento scaglione

           CASE
               WHEN     ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE'
                    AND tariffa.tipo_tariffa IN
                            ('VALORE_SCAGLIONI_STORAGE',
                             'VALORE_UNITARIO_SCAGLIONI_STORAGE',
                             'VALORE_SCAGLIONI_UD_VERSATE')
               THEN
                   CASE
                       WHEN EXISTS
                                (SELECT *
                                   FROM ORG_SCAGLIONE_TARIFFA scg_last
                                  WHERE     scg_last.id_tariffa =
                                            tariffa.id_tariffa
                                        AND scg_last.ni_ini_scaglione =
                                            (SELECT MAX (
                                                        scg_max.ni_ini_scaglione) -- prendo ultimo scaglione della tariffa
                                               FROM ORG_SCAGLIONE_TARIFFA
                                                    scg_max
                                              WHERE scg_max.id_tariffa =
                                                    tariffa.id_tariffa)
                                        AND serv_fatt.qt_scaglione_servizio_fattura >
                                            scg_last.ni_fine_scaglione)
                       THEN
                           '1'
                       ELSE
                           '0'
                   END
               ELSE
                   NULL
           END                              fl_superamento_scaglione,
           acc.cd_ddt,
           acc.cd_oda,
           serv_erog.nm_servizio_erogato,
           serv_erog.fl_pagamento,
           ti_serv.tipo_fatturazione,
           tariffa.nm_tariffa,
           serv_erog.im_valore_tariffa,
           ti_serv.cd_tipo_servizio,
           apl.nm_sistema_versante,
           serv_erog.dt_erog                AS dt_erog_serv_erog,
           ti_serv.gg_fatturazione
      FROM ORG_SERVIZIO_FATTURA  serv_fatt
           JOIN ORG_CD_IVA iva ON (iva.id_cd_iva = serv_fatt.id_cd_iva)
           JOIN ORG_SERVIZIO_EROG serv_erog
               ON (serv_erog.id_servizio_erogato =
                   serv_fatt.id_servizio_erogato)
           JOIN ORG_TIPO_SERVIZIO ti_serv
               ON (ti_serv.id_tipo_servizio = serv_erog.id_tipo_servizio)
           left JOIN ORG_TARIFFA tariffa
               ON (tariffa.id_tariffa = serv_erog.id_tariffa)
           JOIN ORG_ACCORDO_ENTE acc
               ON (acc.id_accordo_ente = serv_erog.id_accordo_ente)
           LEFT JOIN APL_SISTEMA_VERSANTE apl
               ON (serv_erog.id_sistema_versante = apl.id_sistema_versante);

-- changeset root:1753259446745-223
CREATE OR REPLACE FORCE VIEW "ORG_V_CREA_SERV_FATT_UNA_PREC" ("ID_FATTURA_ENTE", "ID_ACCORDO_ENTE", "ID_SERVIZIO_EROGATO", "AA_SERVIZIO_FATTURA", "AA_SERVIZIO_FATTURA_PREC", "NM_SERVIZIO_FATTURA", "IM_SERVIZIO_FATTURA", "QT_SCAGLIONE_SERVIZIO_FATTURA", "QT_UNIT_SERVIZIO_FATTURA", "DT_EROG", "NT_SERVIZIO_FATTURA", "ID_CD_IVA", "IM_IVA") AS select
 fatt.id_fattura_ente,
 acc.id_accordo_ente,
 
 serv.id_servizio_erogato,
 aa_serv.aa_fattura aa_servizio_fattura,
 extract (year from serv.dt_erog) aa_servizio_fattura_prec,
 case
	when ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE' and ti_serv.ti_doc_tipo_servizio = 'AMMINISTRATIVA'
		then 'Canone annuo ' || aa_serv.aa_fattura || ' conservaz. docum. amministrativa'
	when ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE' and ti_serv.ti_doc_tipo_servizio = 'SANITARIA'
		then 'Canone annuo ' || aa_serv.aa_fattura || ' conservaz. docum. sanitaria'
	when ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE' and ti_serv.ti_doc_tipo_servizio = 'SANITARIA_DICOM'
		then 'Canone annuo ' || aa_serv.aa_fattura || ' conservaz. immagini diagnostiche'	
	when ti_serv.ti_classe_tipo_servizio = 'ALTRO_ANNUALITA'
		then 'Quota anno ' || aa_serv.aa_fattura || ''
	when ti_serv.ti_classe_tipo_servizio = 'ALTRO'
		then 'Quota anno ' || aa_serv.aa_fattura || ' conservaz. docum. amministrativa'
	when ti_serv.ti_classe_tipo_servizio = 'ATTIVAZIONE_SISTEMA_VERSANTE'
		then 'Una tantum attivazione sistema ' || (select sis_vers.nm_sistema_versante
												   from apl_sistema_versante sis_vers
												   where sis_vers.id_sistema_versante  = serv.id_sistema_versante
													)
	when ti_serv.ti_classe_tipo_servizio = 'ATTIVAZIONE_TIPO_UD'
		then 'Costo di avviamento (Una Tantum)' 
	else 'da definire'
 end nm_servizio_fattura,
 
 serv.im_valore_tariffa im_servizio_fattura,
 
 1 qt_scaglione_servizio_fattura,
 null qt_unit_servizio_fattura,
 
 serv.dt_erog,
 null nt_servizio_fattura,
 
 ente_convenz.id_cd_iva,
 case
	when iva.cd_iva = 'NOIVA'
		then 0
		else round ((serv.im_valore_tariffa * 22 / 100), 2)
 end im_iva

from org_fattura_ente fatt
join ORG_AA_FATTURA aa_serv
 on (aa_serv.aa_fattura > 0)														-- anno dei servizi

join org_ente_siam ente_convenz
 on (ente_convenz.id_ente_siam = fatt.id_ente_convenz)
join org_accordo_ente acc
 on (acc.id_ente_convenz = ente_convenz.id_ente_siam)								--	accordo per cui creo fattura (valido nell'anno dei servizi)

join org_servizio_erog serv															-- servizi dell'accordo erogati prima dell'anno dei servizi
 on (serv.id_accordo_ente = acc.id_accordo_ente
 and extract (year from serv.dt_erog) < aa_serv.aa_fattura 
 and serv.fl_pagamento = '1')
join org_tipo_servizio ti_serv 
 on (ti_serv.id_tipo_servizio = serv.id_tipo_servizio
 and ti_serv.tipo_fatturazione = 'UNA_TANTUM')

join ORG_CD_IVA iva
 on (iva.id_cd_iva = ente_convenz.id_cd_iva)

where not exists (select *															-- servizio non già fatturato in fatture precedenti
				  from ORG_SERVIZIO_FATTURA serv_fatt_prec
				  where serv_fatt_prec.id_servizio_erogato = serv.id_servizio_erogato
				  )

and not exists (select *															-- servizio non già fatturato nella fattura
				from ORG_SERVIZIO_FATTURA serv_fatt
				where serv_fatt.id_fattura_ente = fatt.id_fattura_ente
				and serv_fatt.aa_servizio_fattura = extract (year from serv.dt_erog)
				and serv_fatt.id_servizio_erogato = serv.id_servizio_erogato
				);

-- changeset root:1753259446745-224
CREATE OR REPLACE FORCE VIEW "ORG_V_CREA_SERV_FATT_UNATANTUM" ("ID_FATTURA_ENTE", "ID_ACCORDO_ENTE", "ID_SERVIZIO_EROGATO", "AA_SERVIZIO_FATTURA", "NM_SERVIZIO_FATTURA", "IM_SERVIZIO_FATTURA", "QT_SCAGLIONE_SERVIZIO_FATTURA", "QT_UNIT_SERVIZIO_FATTURA", "DT_EROG", "NT_SERVIZIO_FATTURA", "ID_CD_IVA", "IM_IVA") AS select
 fatt.id_fattura_ente,
 acc.id_accordo_ente,

 serv.id_servizio_erogato,
 aa_serv.aa_fattura aa_servizio_fattura,
 case
	when ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE' and ti_serv.ti_doc_tipo_servizio = 'AMMINISTRATIVA'
		then 'Canone annuo ' || aa_serv.aa_fattura || ' conservaz. docum. amministrativa'
	when ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE' and ti_serv.ti_doc_tipo_servizio = 'SANITARIA'
		then 'Canone annuo ' || aa_serv.aa_fattura || ' conservaz. docum. sanitaria'
	when ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE' and ti_serv.ti_doc_tipo_servizio = 'SANITARIA_DICOM'
		then 'Canone annuo ' || aa_serv.aa_fattura || ' conservaz. immagini diagnostiche'	
	when ti_serv.ti_classe_tipo_servizio = 'ALTRO_ANNUALITA'
		then 'Quota anno ' || aa_serv.aa_fattura || ''
	when ti_serv.ti_classe_tipo_servizio = 'ALTRO'
		then 'Quota anno ' || aa_serv.aa_fattura || ' conservaz. docum. amministrativa'
	when ti_serv.ti_classe_tipo_servizio = 'ATTIVAZIONE_SISTEMA_VERSANTE'
		then 'Una tantum attivazione sistema ' || (select sis_vers.nm_sistema_versante
												   from apl_sistema_versante sis_vers
												   where sis_vers.id_sistema_versante  = serv.id_sistema_versante
													)
	when ti_serv.ti_classe_tipo_servizio = 'ATTIVAZIONE_TIPO_UD'
		then 'Costo di avviamento (Una Tantum)' 
	else 'da definire'
 end nm_servizio_fattura,
 
 serv.im_valore_tariffa im_servizio_fattura,
  1 qt_scaglione_servizio_fattura,
 null qt_unit_servizio_fattura,
 
 serv.dt_erog,
 null nt_servizio_fattura,
 
 ente_convenz.id_cd_iva,
 case
	when iva.cd_iva = 'NOIVA'
		then 0
		else round ((serv.im_valore_tariffa * 22 / 100), 2)
	end im_iva

from org_fattura_ente fatt
join ORG_AA_FATTURA aa_serv
 on (aa_serv.aa_fattura > 0)												-- anno dei servizi

join org_ente_siam ente_convenz
 on (ente_convenz.id_ente_siam = fatt.id_ente_convenz)
join org_accordo_ente acc
 on (acc.id_ente_convenz = ente_convenz.id_ente_siam)							--	accordo per cui creo fattura (valido nell'anno dei servizi)

join org_servizio_erog serv														-- servizi dell'accordo erogati nell'anno dei servizi
 on (serv.id_accordo_ente = acc.id_accordo_ente
 and extract (year from serv.dt_erog) = aa_serv.aa_fattura 
 and serv.fl_pagamento = '1')
join org_tipo_servizio ti_serv 
 on (ti_serv.id_tipo_servizio = serv.id_tipo_servizio
 and ti_serv.tipo_fatturazione = 'UNA_TANTUM')

join ORG_CD_IVA iva
 on (iva.id_cd_iva = ente_convenz.id_cd_iva)

where not exists (select *														-- servizio non già fatturato nella fattura
				from ORG_SERVIZIO_FATTURA serv_fatt
				where serv_fatt.id_fattura_ente = fatt.id_fattura_ente
				and serv_fatt.aa_servizio_fattura = aa_serv.aa_fattura
				and serv_fatt.id_servizio_erogato = serv.id_servizio_erogato
				);

-- changeset root:1753259446745-225
CREATE OR REPLACE FORCE VIEW "ORG_V_CALC_DT_EROG" ("ID_SERVIZIO_EROGATO", "NM_SERVIZIO_EROGATO", "DT_DEC_ACCORDO", "DT_SCAD_ACCORDO", "DT_EROG") AS SELECT      -- servizio di tipo CONSERVAZIONE e tipo accordo CLASSE_ENTE
             serv.id_servizio_erogato,
             serv.nm_servizio_erogato,
             acc.dt_dec_accordo,
             acc.dt_scad_accordo,
             MIN (conta.dt_rif_conta)
        FROM ORG_SERVIZIO_EROG serv
             JOIN ORG_TIPO_SERVIZIO ti_serv
                 ON (    ti_serv.id_tipo_servizio = serv.id_tipo_servizio
                     AND ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE')
             JOIN ORG_ACCORDO_ENTE acc
                 ON (acc.id_accordo_ente = serv.id_accordo_ente)
             JOIN ORG_TIPO_ACCORDO ti_acc
                 ON (    ti_acc.id_tipo_accordo = acc.id_tipo_accordo
                     AND ti_acc.cd_algo_tariffario = 'CLASSE_ENTE')
             JOIN ORG_ENTE_CONVENZ_ORG strut_ente -- si considerano tutte le strutture appartenenti all'ente nel corso della validità dell'accordo del servizio
                 ON (    strut_ente.id_ente_convenz = acc.id_ente_convenz
                     AND strut_ente.dt_ini_val <= acc.dt_scad_accordo
                     AND strut_ente.dt_fine_val >= acc.dt_dec_accordo)
             JOIN USR_ORGANIZ_IAM strut
                 ON (strut.id_organiz_iam = strut_ente.id_organiz_iam)
             JOIN APL_APPLIC apl
                 ON (    apl.id_applic = strut.id_applic
                     AND apl.nm_applic = 'SACER')
             JOIN sacer.DEC_TIPO_UNITA_DOC tipo_ud
                 ON (    tipo_ud.id_strut = strut.id_organiz_applic
                     AND tipo_ud.id_tipo_servizio = ti_serv.id_tipo_servizio)
             JOIN sacer.MON_CONTA_UD_DOC_COMP conta
                 ON (conta.id_tipo_unita_doc = tipo_ud.id_tipo_unita_doc)
    GROUP BY serv.id_servizio_erogato,
             serv.nm_servizio_erogato,
             acc.dt_dec_accordo,
             acc.dt_scad_accordo
    UNION
      SELECT   -- servizio di tipo CONSERVAZIONE e tipo accordo NO_CLASSE_ENTE
             serv.id_servizio_erogato,
             serv.nm_servizio_erogato,
             acc.dt_dec_accordo,
             acc.dt_scad_accordo,
             MIN (conta.dt_rif_conta)
        FROM ORG_SERVIZIO_EROG serv
             JOIN ORG_TIPO_SERVIZIO ti_serv
                 ON (    ti_serv.id_tipo_servizio = serv.id_tipo_servizio
                     AND ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE')
             JOIN ORG_ACCORDO_ENTE acc
                 ON (acc.id_accordo_ente = serv.id_accordo_ente)
             JOIN ORG_TIPO_ACCORDO ti_acc
                 ON (    ti_acc.id_tipo_accordo = acc.id_tipo_accordo
                     AND ti_acc.cd_algo_tariffario = 'NO_CLASSE_ENTE')
             JOIN ORG_ENTE_CONVENZ_ORG strut_ente -- si considerano tutte le strutture appartenenti all'ente nel corso della validità dell'accordo del servizio
                 ON (    strut_ente.id_ente_convenz = acc.id_ente_convenz
                     AND strut_ente.dt_ini_val <= acc.dt_scad_accordo
                     AND strut_ente.dt_fine_val >= acc.dt_dec_accordo)
             JOIN USR_ORGANIZ_IAM strut
                 ON (strut.id_organiz_iam = strut_ente.id_organiz_iam)
             JOIN APL_APPLIC apl
                 ON (    apl.id_applic = strut.id_applic
                     AND apl.nm_applic = 'SACER')
             JOIN sacer.DEC_TIPO_UNITA_DOC tipo_ud
                 ON (    tipo_ud.id_strut = strut.id_organiz_applic
                     AND tipo_ud.id_tipo_serv_conserv_tipo_ud =
                         ti_serv.id_tipo_servizio)
             JOIN sacer.MON_CONTA_UD_DOC_COMP conta
                 ON (conta.id_tipo_unita_doc = tipo_ud.id_tipo_unita_doc)
    GROUP BY serv.id_servizio_erogato,
             serv.nm_servizio_erogato,
             acc.dt_dec_accordo,
             acc.dt_scad_accordo
      HAVING acc.dt_scad_accordo >= MIN (conta.dt_rif_conta)
    UNION
      SELECT -- servizio di tipo ATTIVAZIONE_SISTEMA_VERSANTE e tipo accordo CLASSE_ENTE
             serv.id_servizio_erogato,
             serv.nm_servizio_erogato,
             acc.dt_dec_accordo,
             acc.dt_scad_accordo,
             MIN (conta.dt_rif_conta)
        FROM ORG_SERVIZIO_EROG serv
             JOIN ORG_TIPO_SERVIZIO ti_serv
                 ON (    ti_serv.id_tipo_servizio = serv.id_tipo_servizio
                     AND ti_serv.ti_classe_tipo_servizio =
                         'ATTIVAZIONE_SISTEMA_VERSANTE')
             JOIN ORG_ACCORDO_ENTE acc
                 ON (acc.id_accordo_ente = serv.id_accordo_ente)
             JOIN ORG_TIPO_ACCORDO ti_acc
                 ON (    ti_acc.id_tipo_accordo = acc.id_tipo_accordo
                     AND ti_acc.cd_algo_tariffario = 'CLASSE_ENTE')
             JOIN ORG_ENTE_CONVENZ_ORG strut_ente -- si considerano tutte le strutture appartenenti all'ente nel corso della validità dell'accordo del servizio
                 ON (    strut_ente.id_ente_convenz = acc.id_ente_convenz
                     AND strut_ente.dt_ini_val <= acc.dt_scad_accordo
                     AND strut_ente.dt_fine_val >= acc.dt_dec_accordo)
             JOIN USR_ORGANIZ_IAM strut
                 ON (strut.id_organiz_iam = strut_ente.id_organiz_iam)
             JOIN APL_APPLIC apl
                 ON (    apl.id_applic = strut.id_applic
                     AND apl.nm_applic = 'SACER')
             JOIN sacer.DEC_TIPO_UNITA_DOC tipo_ud
                 ON (    tipo_ud.id_strut = strut.id_organiz_applic
                     AND tipo_ud.id_tipo_servizio_attiv =
                         ti_serv.id_tipo_servizio)
             JOIN sacer.MON_TIPO_UNITA_DOC_USER_VERS conta
                 ON (conta.id_tipo_unita_doc = tipo_ud.id_tipo_unita_doc)
             JOIN USR_USER usr
                 ON (    usr.id_user_iam = conta.id_user_iam
                     AND usr.id_sistema_versante = serv.id_sistema_versante)
    GROUP BY serv.id_servizio_erogato,
             serv.nm_servizio_erogato,
             acc.dt_dec_accordo,
             acc.dt_scad_accordo
    UNION
      SELECT -- servizio di tipo ATTIVAZIONE_TIPO_UD e tipo accordo NO_CLASSE_ENTE
             serv.id_servizio_erogato,
             serv.nm_servizio_erogato,
             acc.dt_dec_accordo,
             acc.dt_scad_accordo,
             MIN (conta.dt_rif_conta)
        FROM ORG_SERVIZIO_EROG serv
             JOIN ORG_TIPO_SERVIZIO ti_serv
                 ON (    ti_serv.id_tipo_servizio = serv.id_tipo_servizio
                     AND ti_serv.ti_classe_tipo_servizio =
                         'ATTIVAZIONE_TIPO_UD')
             JOIN ORG_ACCORDO_ENTE acc
                 ON (acc.id_accordo_ente = serv.id_accordo_ente)
             JOIN ORG_TIPO_ACCORDO ti_acc
                 ON (    ti_acc.id_tipo_accordo = acc.id_tipo_accordo
                     AND ti_acc.cd_algo_tariffario = 'NO_CLASSE_ENTE')
             JOIN ORG_ENTE_CONVENZ_ORG strut_ente -- si considerano tutte le strutture appartenenti all'ente nel corso della validità dell'accordo del servizio
                 ON (    strut_ente.id_ente_convenz = acc.id_ente_convenz
                     AND strut_ente.dt_ini_val <= acc.dt_scad_accordo
                     AND strut_ente.dt_fine_val >= acc.dt_dec_accordo)
             JOIN USR_ORGANIZ_IAM strut
                 ON (strut.id_organiz_iam = strut_ente.id_organiz_iam)
             JOIN APL_APPLIC apl
                 ON (    apl.id_applic = strut.id_applic
                     AND apl.nm_applic = 'SACER')
             JOIN sacer.DEC_TIPO_UNITA_DOC tipo_ud
                 ON (    tipo_ud.id_strut = strut.id_organiz_applic
                     AND tipo_ud.id_tipo_serv_attiv_tipo_ud =
                         ti_serv.id_tipo_servizio)
             JOIN sacer.MON_CONTA_UD_DOC_COMP conta
                 ON (conta.id_tipo_unita_doc = tipo_ud.id_tipo_unita_doc)
    GROUP BY serv.id_servizio_erogato,
             serv.nm_servizio_erogato,
             acc.dt_dec_accordo,
             acc.dt_scad_accordo
      HAVING MIN (conta.dt_rif_conta) BETWEEN acc.dt_dec_accordo
                                          AND acc.dt_scad_accordo;

-- changeset root:1753259446745-226
COMMENT ON COLUMN ORG_V_CALC_DT_EROG.ID_SERVIZIO_EROGATO IS 'PK.1';

-- changeset root:1753259446745-227
CREATE OR REPLACE FORCE VIEW "ORG_V_CREA_SERV_FATT_BY_FATT" ("ID_FATTURA_ENTE", "ID_SERVIZIO_EROGATO", "AA_SERVIZIO_FATTURA", "NM_SERVIZIO_FATTURA", "IM_SERVIZIO_FATTURA", "QT_SCAGLIONE_SERVIZIO_FATTURA", "QT_UNIT_SERVIZIO_FATTURA", "DT_EROG", "NT_SERVIZIO_FATTURA", "ID_CD_IVA") AS select
 fatt.id_fattura_ente,
 serv.id_servizio_erogato,
 fatt.aa_fattura,
 case
	when ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE' and ti_serv.cd_tipo_servizio like '%amministrativa%'
		then 'Canone annuo ' || fatt.aa_fattura || ' conservaz. docum. amministrativa'
	when ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE' and ti_serv.cd_tipo_servizio like '%sanitaria%'
		then 'Canone annuo ' || fatt.aa_fattura || ' conservaz. docum. sanitaria'
	when ti_serv.ti_classe_tipo_servizio = 'ALTRO'
		then 'Quota anno ' || fatt.aa_fattura || ' conservaz. docum. amministrativa'
	when ti_serv.ti_classe_tipo_servizio = 'ATTIVAZIONE_SISTEMA_VERSANTE'
		then 'Una tantum attivazione sistema ' || (select sis_vers.nm_sistema_versante
												   from apl_sistema_versante sis_vers
												   where sis_vers.id_sistema_versante  = serv.id_sistema_versante
													)
	else 'da definire'
 end nm_servizio_fattura,
 
 case
	when tariffa.tipo_tariffa = 'VALORE_FISSO'
		then tariffa.im_valore_fisso_tariffa
	else 0
 end im_servizio_fattura,
 
 1 qt_scaglione_servizio_fattura,
 null qt_unit_servizio_fattura,
 
 serv.dt_erog,
 null nt_servizio_fattura,
 ente_convenz.id_cd_iva
 
from org_fattura_ente fatt

join org_ente_siam ente_convenz
 on (ente_convenz.id_ente_siam = fatt.id_ente_convenz)
join org_accordo_ente acc
 on (acc.id_ente_convenz = ente_convenz.id_ente_siam
 and extract (year from acc.dt_dec_accordo) <= fatt.aa_fattura					-- accordi validi nell'anno di fattura
 and extract (year from acc.dt_scad_accordo) >= fatt.aa_fattura)
 
join org_servizio_erog serv														-- servizi dell'accordo erogati nell'anno di fattura
 on (serv.id_accordo_ente = acc.id_accordo_ente
 and extract (year from serv.dt_erog) = fatt.aa_fattura 
 and serv.fl_pagamento = '1')
join ORG_TARIFFA tariffa
 on (tariffa.id_tariffa = serv.id_tariffa)
 
join org_tipo_servizio ti_serv 
 on (ti_serv.id_tipo_servizio = serv.id_tipo_servizio
 and ti_serv.tipo_fatturazione = 'UNA_TANTUM')

and not exists (select *														-- servizio non già fatturato nell'anno di fattura
				from ORG_SERVIZIO_FATTURA serv_fatt
				where serv_fatt.aa_servizio_fattura = fatt.aa_fattura
				and serv_fatt.id_servizio_erogato = serv.id_servizio_erogato
				)

UNION

--			servizi ANNUALE, per la fattura in input

select 
tmp.id_fattura_ente,
tmp.id_servizio_erogato,
tmp.aa_servizio_fattura,
--tmp.tipo_tariffa,
tmp.nm_servizio_fattura,
			 
case
	when tmp.tipo_tariffa = 'VALORE_SCAGLIONI_STORAGE'									-- uso tutti gli scaglioni con estremo sx minore o uguale a quantità
		then round ( (select sum(scg.im_scaglione)
					  from org_scaglione_tariffa scg
					  where scg.id_tariffa = tmp.id_tariffa
					  and scg.ni_ini_scaglione <= tmp.qt_scaglione_servizio_fattura
					 ) * (tmp.mm_fattura / 12)											-- rapporto a mesi da fatturare
					, 2)

	when tmp.tipo_tariffa = 'VALORE_UNITARIO_SCAGLIONI_STORAGE'							-- uso solo lo scaglione in cui la quantità e' inclusa
		then round ( (select scg.im_scaglione
					  from org_scaglione_tariffa scg
					  where scg.id_tariffa = tmp.id_tariffa
					  and scg.ni_ini_scaglione <= tmp.qt_scaglione_servizio_fattura
					  and scg.ni_fine_scaglione >= tmp.qt_scaglione_servizio_fattura
					 )
					 * round (tmp.qt_unit_servizio_fattura / tmp.ni_quantita_unit) 		-- numero abitanti / 1000
					 * (tmp.mm_fattura / 12)											-- rapporto a mesi da fatturare
					, 2)

	when tmp.tipo_tariffa = 'VALORE_SCAGLIONI_UD_VERSATE'								-- uso tutti gli scaglioni con estremo sx minore o uguale a quantità
		then round ( (select sum(scg.im_scaglione)
					  from org_scaglione_tariffa scg
					  where scg.id_tariffa = tmp.id_tariffa
					  and scg.ni_ini_scaglione <= tmp.qt_scaglione_servizio_fattura
					 ) 
					 * (tmp.mm_fattura / 12)											-- rapporto a mesi da fatturare
					, 2)
	when tmp.tipo_tariffa = 'VALORE_FISSO'
		then round ( tmp.im_valore_fisso_tariffa
					* (tmp.mm_fattura / 12)												-- rapporto a mesi da fatturare
					, 2)
	else 0
end im_servizio_fattura,
tmp.qt_scaglione_servizio_fattura,
tmp.qt_unit_servizio_fattura,
tmp.dt_erog,
null nt_servizio_fattura,
tmp.id_cd_iva
--,
--tmp.mm_fattura,
--tmp.im_valore_fisso_tariffa,
--tmp.ni_quantita_unit,
--tmp.ni_abitanti

from 	(
			select
			 fatt.id_fattura_ente,
			 serv.id_servizio_erogato,
			 fatt.aa_fattura aa_servizio_fattura,
			 case
				when ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE' and ti_serv.cd_tipo_servizio like '%amministrativa%'
					then 'Canone annuo ' || fatt.aa_fattura || ' conservaz. docum. amministrativa'
				when ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE' and ti_serv.cd_tipo_servizio like '%sanitaria%'
					then 'Canone annuo ' || fatt.aa_fattura || ' conservaz. docum. sanitaria'
				when ti_serv.ti_classe_tipo_servizio = 'ALTRO'
					then 'Quota anno ' || fatt.aa_fattura || ' conservaz. docum. amministrativa'
				when ti_serv.ti_classe_tipo_servizio = 'ATTIVAZIONE_SISTEMA_VERSANTE'
					then 'Una tantum attivazione sistema ' || (select sis_vers.nm_sistema_versante
															   from apl_sistema_versante sis_vers
															   where sis_vers.id_sistema_versante  = serv.id_sistema_versante
																)
				else 'da definire'
			 end nm_servizio_fattura,

			 tariffa.id_tariffa,
			 tariffa.tipo_tariffa,
			 tariffa.im_valore_fisso_tariffa,
			 tariffa.ni_quantita_unit,
			 acc.ni_abitanti,
			 serv.dt_erog,
			 case
				when tariffa.tipo_tariffa in ('VALORE_SCAGLIONI_STORAGE', 'VALORE_UNITARIO_SCAGLIONI_STORAGE')
					then (select sum (conta.ni_size_vers + conta.ni_doc_agg - conta.ni_size_annul_ud)				-- somma byte versati e non annullati fino all'anno di fattura
						  from org_ente_convenz_org ente_org
						  join usr_organiz_iam org
							on (org.id_organiz_iam = ente_org.id_organiz_iam)
						  join sacer.dec_tipo_unita_doc tipo_ud
							on (tipo_ud.id_strut = org.id_organiz_applic
							and  tipo_ud.id_tipo_servizio = serv.id_tipo_servizio)
						  join sacer.MON_CONTA_UD_DOC_COMP conta
						   on (conta.id_tipo_unita_doc = tipo_ud.id_tipo_unita_doc
						   and extract(year from conta.dt_rif_conta) <= fatt.aa_fattura)

						  where ente_org.id_ente_convenz = ente_convenz.id_ente_siam
						  )

				when tariffa.tipo_tariffa in ('VALORE_SCAGLIONI_UD_VERSATE')										-- conta ud versate e non annullate nell'anno di fattura
					then (select sum (conta.ni_unita_doc_vers - conta.ni_unita_doc_annul)
						  from org_ente_convenz_org ente_org
						  join usr_organiz_iam org
							on (org.id_organiz_iam = ente_org.id_organiz_iam)
						  join sacer.dec_tipo_unita_doc tipo_ud
							on (tipo_ud.id_strut = org.id_organiz_applic
							and  tipo_ud.id_tipo_servizio = serv.id_tipo_servizio)
						  join sacer.MON_CONTA_UD_DOC_COMP conta
						   on (conta.id_tipo_unita_doc = tipo_ud.id_tipo_unita_doc
						   and extract(year from conta.dt_rif_conta) = fatt.aa_fattura)

						  where ente_org.id_ente_convenz = ente_convenz.id_ente_siam
						  )
				when tariffa.tipo_tariffa in ('VALORE_FISSO')
					then 1

				else 0
			 end qt_scaglione_servizio_fattura,

			 case
				when tariffa.tipo_tariffa in ('VALORE_UNITARIO_SCAGLIONI_STORAGE')
					then acc.ni_abitanti
				else null
			 end qt_unit_servizio_fattura,

			 case
				when fatt.aa_fattura < extract (year from acc.dt_scad_accordo)
					then
						case
							when extract (year from serv.dt_erog) < fatt.aa_fattura 
								then 12
								else 12 - extract (month from serv.dt_erog)
						end
				when fatt.aa_fattura = extract (year from acc.dt_scad_accordo)
					then extract (month from acc.dt_scad_accordo) - extract (month from serv.dt_erog) - 1
				else
					0
			 end mm_fattura,
			 ente_convenz.id_cd_iva

			from org_fattura_ente fatt

			join org_ente_siam ente_convenz
			 on (ente_convenz.id_ente_siam = fatt.id_ente_convenz)
			join org_accordo_ente acc
			 on (acc.id_ente_convenz = ente_convenz.id_ente_siam
			 and extract (year from acc.dt_dec_accordo) <= fatt.aa_fattura					-- accordi validi nell'anno di fattura
			 and extract (year from acc.dt_scad_accordo) >= fatt.aa_fattura)

			join org_servizio_erog serv														-- servizi dell'accordo erogati nell'anno o prima dell'anno di fattura
			 on (serv.id_accordo_ente = acc.id_accordo_ente
			 and extract (year from serv.dt_erog) <= fatt.aa_fattura 
			 and serv.fl_pagamento = '1')
			join ORG_TARIFFA tariffa
			 on (tariffa.id_tariffa = serv.id_tariffa)

			join org_tipo_servizio ti_serv 
			 on (ti_serv.id_tipo_servizio = serv.id_tipo_servizio
			 and ti_serv.tipo_fatturazione = 'ANNUALE')
		) tmp

where not exists (select *																	-- servizio non già fatturato nell'anno di fattura
				from ORG_SERVIZIO_FATTURA serv_fatt
				where serv_fatt.aa_servizio_fattura = tmp.aa_servizio_fattura
				and serv_fatt.id_servizio_erogato = tmp.id_servizio_erogato
				);

-- changeset root:1753259446745-228
CREATE OR REPLACE FORCE VIEW "ORG_V_CALC_SERV_FATT_ANNUALE" ("ID_FATTURA_ENTE", "ID_ACCORDO_ENTE", "ID_SERVIZIO_EROGATO", "AA_SERVIZIO_FATTURA", "NM_SERVIZIO_FATTURA", "ID_TARIFFA", "TIPO_TARIFFA", "IM_VALORE_FISSO_TARIFFA", "NI_QUANTITA_UNIT", "NI_ABITANTI", "DT_EROG", "QT_SCAGLIONE_SERVIZIO_FATTURA", "QT_UNIT_SERVIZIO_FATTURA", "MM_FATTURA", "ID_CD_IVA") AS SELECT fatt.id_fattura_ente,
           acc.id_accordo_ente,
           serv.id_servizio_erogato,
           aa_serv.aa_fattura    aa_servizio_fattura,
           CASE
               WHEN     ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE'
                    AND ti_serv.ti_doc_tipo_servizio = 'AMMINISTRATIVA'
               THEN
                      'Canone annuo '
                   || aa_serv.aa_fattura
                   || ' conservaz. docum. amministrativa'
               WHEN     ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE'
                    AND ti_serv.ti_doc_tipo_servizio = 'SANITARIA'
               THEN
                      'Canone annuo '
                   || aa_serv.aa_fattura
                   || ' conservaz. docum. sanitaria'
               WHEN ti_serv.ti_classe_tipo_servizio = 'ALTRO'
               THEN
                      'Quota anno '
                   || aa_serv.aa_fattura
                   || ' conservaz. docum. amministrativa'
               WHEN ti_serv.ti_classe_tipo_servizio =
                    'ATTIVAZIONE_SISTEMA_VERSANTE'
               THEN
                      'Una tantum attivazione sistema '
                   || (SELECT sis_vers.nm_sistema_versante
                         FROM apl_sistema_versante sis_vers
                        WHERE sis_vers.id_sistema_versante =
                              serv.id_sistema_versante)
               ELSE
                   'da definire'
           END                   nm_servizio_fattura,
           tariffa.id_tariffa,
           tariffa.tipo_tariffa,
           tariffa.im_valore_fisso_tariffa,
           tariffa.ni_quantita_unit,
           acc.ni_abitanti,
           serv.dt_erog,
           CASE
               WHEN tariffa.tipo_tariffa IN
                        ('VALORE_SCAGLIONI_STORAGE',
                         'VALORE_UNITARIO_SCAGLIONI_STORAGE')
               THEN
                   (SELECT SUM (
                                 conta.ni_size_vers
                               + conta.ni_doc_agg
                               - conta.ni_size_annul_ud) -- somma byte versati e non annullati fino all'anno dei servizi
                      FROM org_ente_convenz_org  ente_org
                           JOIN usr_organiz_iam org
                               ON (org.id_organiz_iam =
                                   ente_org.id_organiz_iam)
                           JOIN apl_applic apl
                               ON (    apl.id_applic = org.id_applic
                                   AND apl.nm_applic = 'SACER')
                           JOIN sacer.dec_tipo_unita_doc tipo_ud
                               ON (    tipo_ud.id_strut =
                                       org.id_organiz_applic
                                   AND tipo_ud.id_tipo_servizio =
                                       serv.id_tipo_servizio)
                           JOIN sacer.MON_CONTA_UD_DOC_COMP conta
                               ON (    conta.id_tipo_unita_doc =
                                       tipo_ud.id_tipo_unita_doc
                                   AND conta.dt_rif_conta <=
                                       TO_DATE (
                                              '31/12/'
                                           || TO_CHAR (aa_serv.aa_fattura),
                                           'dd/mm/yyyy'))
                     -- and extract(year from conta.dt_rif_conta) <= aa_serv.aa_fattura)

                     WHERE ente_org.id_ente_convenz =
                           ente_convenz.id_ente_siam)
               WHEN tariffa.tipo_tariffa IN ('VALORE_SCAGLIONI_UD_VERSATE') -- conta ud versate e non annullate nell'anno dei servizi
               THEN
                   (SELECT SUM (
                                 conta.ni_unita_doc_vers
                               - conta.ni_unita_doc_annul)
                      FROM org_ente_convenz_org  ente_org
                           JOIN usr_organiz_iam org
                               ON (org.id_organiz_iam =
                                   ente_org.id_organiz_iam)
                           JOIN apl_applic apl
                               ON (    apl.id_applic = org.id_applic
                                   AND apl.nm_applic = 'SACER')
                           JOIN sacer.dec_tipo_unita_doc tipo_ud
                               ON (    tipo_ud.id_strut =
                                       org.id_organiz_applic
                                   AND tipo_ud.id_tipo_servizio =
                                       serv.id_tipo_servizio)
                           JOIN sacer.MON_CONTA_UD_DOC_COMP conta
                               ON (    conta.id_tipo_unita_doc =
                                       tipo_ud.id_tipo_unita_doc
                                   AND conta.dt_rif_conta >=
                                       TO_DATE (
                                              '01/01/'
                                           || TO_CHAR (aa_serv.aa_fattura),
                                           'dd/mm/yyyy')
                                   AND conta.dt_rif_conta <=
                                       TO_DATE (
                                              '31/12/'
                                           || TO_CHAR (aa_serv.aa_fattura),
                                           'dd/mm/yyyy'))
                     -- and extract(year from conta.dt_rif_conta) = aa_serv.aa_fattura)

                     WHERE ente_org.id_ente_convenz =
                           ente_convenz.id_ente_siam)
               WHEN tariffa.tipo_tariffa IN ('VALORE_FISSO')
               THEN
                   1
               ELSE
                   0
           END                   qt_scaglione_servizio_fattura,
           CASE
               WHEN tariffa.tipo_tariffa IN
                        ('VALORE_UNITARIO_SCAGLIONI_STORAGE')
               THEN
                   acc.ni_abitanti
               ELSE
                   NULL
           END                   qt_unit_servizio_fattura,
           CASE
               WHEN aa_serv.aa_fattura <
                    --extract (year from acc.dt_fine_valid_accordo)
                    EXTRACT (
                        YEAR FROM (SELECT MIN (t.col)
                                     FROM (SELECT t.dt_scad_accordo    AS col
                                             FROM org_accordo_ente t
                                            WHERE t.id_accordo_ente =
                                                  acc.id_accordo_ente
                                           UNION ALL
                                           SELECT t.dt_fine_valid_accordo    AS col
                                             FROM org_accordo_ente t
                                            WHERE t.id_accordo_ente =
                                                  acc.id_accordo_ente) t))
               THEN
                   CASE
                       WHEN EXTRACT (YEAR FROM serv.dt_erog) <
                            aa_serv.aa_fattura
                       THEN
                           12
                       ELSE
                           12 - EXTRACT (MONTH FROM serv.dt_erog)
                   END
               WHEN aa_serv.aa_fattura =
                    --extract (year from acc.dt_fine_valid_accordo)
                    EXTRACT (
                        YEAR FROM (SELECT MIN (t.col)
                                     FROM (SELECT t.dt_scad_accordo    AS col
                                             FROM org_accordo_ente t
                                            WHERE t.id_accordo_ente =
                                                  acc.id_accordo_ente
                                           UNION ALL
                                           SELECT t.dt_fine_valid_accordo    AS col
                                             FROM org_accordo_ente t
                                            WHERE t.id_accordo_ente =
                                                  acc.id_accordo_ente) t))
               THEN
                   CASE
                       WHEN EXTRACT (YEAR FROM serv.dt_erog) <
                            aa_serv.aa_fattura
                       THEN
                           EXTRACT    --(month from acc.dt_fine_valid_accordo)
                                   (
                               MONTH FROM (SELECT MIN (t.col)
                                             FROM (SELECT t.dt_scad_accordo    AS col
                                                     FROM org_accordo_ente t
                                                    WHERE t.id_accordo_ente =
                                                          acc.id_accordo_ente
                                                   UNION ALL
                                                   SELECT t.dt_fine_valid_accordo    AS col
                                                     FROM org_accordo_ente t
                                                    WHERE t.id_accordo_ente =
                                                          acc.id_accordo_ente)
                                                  t))
                       ELSE
                             EXTRACT  --(month from acc.dt_fine_valid_accordo)
                                     (
                                 MONTH FROM (SELECT MIN (t.col)
                                               FROM (SELECT t.dt_scad_accordo    AS col
                                                       FROM org_accordo_ente
                                                            t
                                                      WHERE t.id_accordo_ente =
                                                            acc.id_accordo_ente
                                                     UNION ALL
                                                     SELECT t.dt_fine_valid_accordo    AS col
                                                       FROM org_accordo_ente
                                                            t
                                                      WHERE t.id_accordo_ente =
                                                            acc.id_accordo_ente)
                                                    t))
                           - EXTRACT (MONTH FROM serv.dt_erog)
                           - 1
                   END
               ELSE
                   0
           END                   mm_fattura,
           ente_convenz.id_cd_iva
      FROM org_fattura_ente  fatt
           JOIN ORG_AA_FATTURA aa_serv ON (aa_serv.aa_fattura > 0) -- anno dei servizi
           JOIN org_ente_siam ente_convenz
               ON (ente_convenz.id_ente_siam = fatt.id_ente_convenz)
           JOIN org_accordo_ente acc
               ON (    acc.id_ente_convenz = ente_convenz.id_ente_siam
                   AND EXTRACT (YEAR FROM acc.dt_dec_accordo) <=
                       aa_serv.aa_fattura -- accordi validi nell'anno dei servizi
                   --and extract (year from acc.dt_scad_accordo) >= aa_serv.aa_fattura)
                   AND EXTRACT (YEAR FROM acc.dt_fine_valid_accordo) >=
                       aa_serv.aa_fattura) -- accordo per cui creo fattura di tipo CLASSE_ENTE (valido nell'anno dei servizi)
           JOIN org_tipo_accordo ti_acc
               ON (    ti_acc.id_tipo_accordo = acc.id_tipo_accordo
                   AND ti_acc.cd_algo_tariffario = 'CLASSE_ENTE')
           JOIN org_servizio_erog serv -- servizi dell'accordo erogati nell'anno o prima dell'anno dei servizi
               ON (    serv.id_accordo_ente = acc.id_accordo_ente
                   AND EXTRACT (YEAR FROM serv.dt_erog) <= aa_serv.aa_fattura
                   AND serv.fl_pagamento = '1')
           JOIN org_tipo_servizio ti_serv
               ON (    ti_serv.id_tipo_servizio = serv.id_tipo_servizio
                   AND ti_serv.tipo_fatturazione = 'ANNUALE')
           JOIN ORG_TARIFFA tariffa ON (tariffa.id_tariffa = serv.id_tariffa)
     WHERE NOT EXISTS
               (SELECT *           -- servizio non già fatturato nella fattura
                  FROM ORG_SERVIZIO_FATTURA serv_fatt
                 WHERE     serv_fatt.id_fattura_ente = fatt.id_fattura_ente
                       AND serv_fatt.aa_servizio_fattura = aa_serv.aa_fattura
                       AND serv_fatt.id_servizio_erogato =
                           serv.id_servizio_erogato)
    UNION
    SELECT fatt.id_fattura_ente,
           acc.id_accordo_ente,
           serv.id_servizio_erogato,
           aa_serv.aa_fattura        aa_servizio_fattura,
           CASE
               WHEN     ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE'
                    AND ti_serv.ti_doc_tipo_servizio = 'AMMINISTRATIVA'
               THEN
                      'Canone annuo '
                   || aa_serv.aa_fattura
                   || ' conservaz. docum. amministrativa'
               WHEN     ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE'
                    AND ti_serv.ti_doc_tipo_servizio = 'SANITARIA'
               THEN
                      'Canone annuo '
                   || aa_serv.aa_fattura
                   || ' conservaz. docum. sanitaria'
               WHEN     ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE'
                    AND ti_serv.ti_doc_tipo_servizio = 'SANITARIA_DICOM'
               THEN
                      'Canone annuo '
                   || aa_serv.aa_fattura
                   || ' conservaz. immagini diagnostiche'
               WHEN ti_serv.ti_classe_tipo_servizio = 'ALTRO'
               THEN
                      'Quota anno '
                   || aa_serv.aa_fattura
                   || ' conservaz. docum. amministrativa'
               WHEN ti_serv.ti_classe_tipo_servizio = 'ATTIVAZIONE_TIPO_UD'
               THEN
                   'Costo di avviamento (Una Tantum)'
               WHEN ti_serv.ti_classe_tipo_servizio = 'ALTRO_ANNUALITA'
               THEN
                   'Quota anno ' || aa_serv.aa_fattura || ''
               ELSE
                   'da definire'
           END                       nm_servizio_fattura,
           CASE
               WHEN serv.id_tariffa_accordo IS NOT NULL
               THEN
                   serv.id_tariffa_accordo
               ELSE
                   serv.id_tariffa
           END                       id_tariffa,
           'VALORE_FISSO',
           serv.im_valore_tariffa    im_valore_fisso_tariffa,
           NULL                      ni_quantita_unit,
           NULL                      ni_abitanti,
           serv.dt_erog,
           NULL                      qt_scaglione_servizio_fattura,
           NULL                      qt_unit_servizio_fattura,
           CASE
               WHEN aa_serv.aa_fattura <
                    --extract (year from acc.dt_fine_valid_accordo)
                    EXTRACT (
                        YEAR FROM (SELECT MIN (t.col)
                                     FROM (SELECT t.dt_scad_accordo    AS col
                                             FROM org_accordo_ente t
                                            WHERE t.id_accordo_ente =
                                                  acc.id_accordo_ente
                                           UNION ALL
                                           SELECT t.dt_fine_valid_accordo    AS col
                                             FROM org_accordo_ente t
                                            WHERE t.id_accordo_ente =
                                                  acc.id_accordo_ente) t))
               THEN
                   CASE
                       WHEN EXTRACT (YEAR FROM serv.dt_erog) <
                            aa_serv.aa_fattura
                       THEN
                           --12 - EXTRACT (MONTH FROM acc.DT_DEC_ACCORDO)
                           --ELSE
                           --12 - EXTRACT (MONTH FROM serv.dt_erog)

                           CASE
                               WHEN EXTRACT (YEAR FROM acc.DT_DEC_ACCORDO) =
                                    aa_serv.aa_fattura
                               THEN
                                     12
                                   - EXTRACT (MONTH FROM acc.DT_DEC_ACCORDO)
                               WHEN     EXTRACT (
                                            YEAR FROM acc.DT_DEC_ACCORDO) <
                                        aa_serv.aa_fattura
                                    AND EXTRACT (
                                            YEAR FROM acc.DT_scad_ACCORDO) >
                                        aa_serv.aa_fattura
                               THEN
                                   12
                               ELSE
                                   EXTRACT (MONTH FROM acc.DT_scad_ACCORDO)
                           END
                       ELSE
                         case
                                WHEN EXTRACT (YEAR FROM serv.dt_erog) =  aa_serv.aa_fattura and 
                                     EXTRACT (YEAR FROM acc.dt_dec_accordo) <  aa_serv.aa_fattura and
                                     EXTRACT (YEAR FROM acc.dt_scad_accordo) >  aa_serv.aa_fattura 
                                THEN
                                     12
                                else
                                     12  - EXTRACT (MONTH FROM serv.dt_erog)
                            end
                   END
               WHEN aa_serv.aa_fattura =
                    --extract (year from acc.dt_fine_valid_accordo)
                    EXTRACT (
                        YEAR FROM (SELECT MIN (t.col)
                                     FROM (SELECT t.dt_scad_accordo    AS col
                                             FROM org_accordo_ente t
                                            WHERE t.id_accordo_ente =
                                                  acc.id_accordo_ente
                                           UNION ALL
                                           SELECT t.dt_fine_valid_accordo    AS col
                                             FROM org_accordo_ente t
                                            WHERE t.id_accordo_ente =
                                                  acc.id_accordo_ente) t))
               THEN
                   CASE
                       WHEN EXTRACT (YEAR FROM serv.dt_erog) <
                            aa_serv.aa_fattura
                       THEN
                           EXTRACT    --(month from acc.dt_fine_valid_accordo)
                                   (
                               MONTH FROM (SELECT MIN (t.col)
                                             FROM (SELECT t.dt_scad_accordo    AS col
                                                     FROM org_accordo_ente t
                                                    WHERE t.id_accordo_ente =
                                                          acc.id_accordo_ente
                                                   UNION ALL
                                                   SELECT t.dt_fine_valid_accordo    AS col
                                                     FROM org_accordo_ente t
                                                    WHERE t.id_accordo_ente =
                                                          acc.id_accordo_ente)
                                                  t))
                       ELSE
                             EXTRACT  --(month from acc.dt_fine_valid_accordo)
                                     (
                                 MONTH FROM (SELECT MIN (t.col)
                                               FROM (SELECT t.dt_scad_accordo    AS col
                                                       FROM org_accordo_ente
                                                            t
                                                      WHERE t.id_accordo_ente =
                                                            acc.id_accordo_ente
                                                     UNION ALL
                                                     SELECT t.dt_fine_valid_accordo    AS col
                                                       FROM org_accordo_ente
                                                            t
                                                      WHERE t.id_accordo_ente =
                                                            acc.id_accordo_ente)
                                                    t))
                           - EXTRACT (MONTH FROM serv.dt_erog)
                   END
               ELSE
                   0
           END                       mm_fattura,
           ente_convenz.id_cd_iva
      FROM org_fattura_ente  fatt
           JOIN ORG_AA_FATTURA aa_serv ON (aa_serv.aa_fattura > 0) -- anno dei servizi
           JOIN org_ente_siam ente_convenz
               ON (ente_convenz.id_ente_siam = fatt.id_ente_convenz)
           JOIN org_accordo_ente acc
               ON (acc.id_ente_convenz = ente_convenz.id_ente_siam) -- accordo per cui creo fattura di tipo NO_CLASSE_ENTE (valido nell'anno dei servizi)
           JOIN org_tipo_accordo ti_acc
               ON (    ti_acc.id_tipo_accordo = acc.id_tipo_accordo
                   AND ti_acc.cd_algo_tariffario = 'NO_CLASSE_ENTE')
           JOIN org_servizio_erog serv -- servizi dell'accordo erogati nell'anno o prima dell'anno dei servizi
               ON (    serv.id_accordo_ente = acc.id_accordo_ente
                   AND EXTRACT (YEAR FROM serv.dt_erog) <= aa_serv.aa_fattura
                   AND serv.fl_pagamento = '1')
           JOIN org_tipo_servizio ti_serv
               ON (    ti_serv.id_tipo_servizio = serv.id_tipo_servizio
                   AND ti_serv.tipo_fatturazione = 'ANNUALE')
     WHERE NOT EXISTS
               (SELECT *           -- servizio non già fatturato nella fattura
                  FROM ORG_SERVIZIO_FATTURA serv_fatt
                 WHERE     serv_fatt.id_fattura_ente = fatt.id_fattura_ente
                       AND serv_fatt.aa_servizio_fattura = aa_serv.aa_fattura
                       AND serv_fatt.id_servizio_erogato =
                           serv.id_servizio_erogato);

-- changeset root:1753259446745-229
CREATE OR REPLACE FORCE VIEW "USR_V_CHK_USER_CANC_IAM" ("ID_USER_IAM", "FL_CANC_OK") AS select 
id_user_iam,
case
	when not exists (select *
					 from USR_RICH_GEST_USER rich
					 where rich.id_user_iam_rich = usr.id_user_iam
					)
	and not exists 	(select *
					 from USR_APPART_USER_RICH app_rich
					 where app_rich.id_user_iam = usr.id_user_iam
					)
	and not exists (select *
					from ORG_ENTE_ARK_RIF ark_rif
					where ark_rif.id_user_iam = usr.id_user_iam
					)
	and not exists (select *
					from APL_SISTEMA_VERSANTE_USER_REF user_ref
					where user_ref.id_user_iam_ref = usr.id_user_iam
					)
	and not exists (select *
					from APL_SISTEMA_VERS_ARK_RIF ark_rif
					where ark_rif.id_user_iam = usr.id_user_iam
					)
	and not exists (select *
					from ORG_ENTE_USER_RIF usr_rif
					where usr_rif.id_user_iam = usr.id_user_iam
					)

		then '1'
		else '0'

end fl_canc_ok
from USR_USER usr;

-- changeset root:1753259446745-230
COMMENT ON COLUMN USR_V_CHK_USER_CANC_IAM.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-231
CREATE OR REPLACE FORCE VIEW "ORG_V_RIC_FATTURE" ("ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_ACCORDO_ENTE", "ID_TIPO_ACCORDO", "CD_TIPO_ACCORDO", "ID_FATTURA_ENTE", "AA_FATTURA", "PG_FATTURA", "CD_FATTURA", "CD_REGISTRO_EMIS_FATTURA", "AA_EMISS_FATTURA", "CD_EMIS_FATTURA", "DT_EMIS_FATTURA", "IM_TOT_FATTURA", "IM_TOT_PAGATO", "ID_STATO_FATTURA_ENTE", "TI_STATO_FATTURA_ENTE", "DT_REG_STATO_FATTURA_ENTE", "ID_SERVIZIO_FATTURA", "ID_SERVIZIO_EROGATO", "ID_TIPO_SERVIZIO", "CD_TIPO_SERVIZIO") AS select
	ente.id_ente_siam,
	ente.nm_ente_siam,
	
	accordo.id_accordo_ente,
	ti_accordo.id_tipo_accordo,
	ti_accordo.cd_tipo_accordo,
	
	fattura.id_fattura_ente,
	fattura.aa_fattura,
	fattura.pg_fattura, 
	fattura.cd_fattura,
	fattura.cd_registro_emis_fattura,
	fattura.aa_emiss_fattura,
	fattura.cd_emis_fattura, 
	fattura.dt_emis_fattura,
	fattura.im_tot_fattura,
	(select sum (pagamenti.im_pagam) 
	 from ORG_PAGAM_FATTURA_ENTE pagamenti
	 where pagamenti.id_fattura_ente = fattura.id_fattura_ente
	) im_tot_pagato,
	statofattura.id_stato_fattura_ente,
	statofattura.ti_stato_fattura_ente,
	statofattura.dt_reg_stato_fattura_ente,
	
	serv_fatt.id_servizio_fattura,
	servizio.id_servizio_erogato,
	
	tiposervizio.id_tipo_servizio, 
	tiposervizio.cd_tipo_servizio
  
from ORG_ENTE_SIAM ente
join ORG_ACCORDO_ENTE accordo
 on (accordo.id_ente_convenz = ente.id_ente_siam)
join ORG_TIPO_ACCORDO ti_accordo
 on (ti_accordo.id_tipo_accordo = accordo.id_tipo_accordo)

join ORG_FATTURA_ENTE fattura
 on (ente.id_ente_siam = fattura.id_ente_convenz)
join ORG_STATO_FATTURA_ENTE statofattura
 on (fattura.id_stato_fattura_ente_cor = statofattura.id_stato_fattura_ente)

join ORG_SERVIZIO_FATTURA serv_fatt 
 on (serv_fatt.id_fattura_ente = fattura.id_fattura_ente)
 
join ORG_SERVIZIO_EROG servizio 
 on (serv_fatt.id_servizio_erogato = servizio.id_servizio_erogato)
join ORG_TIPO_SERVIZIO tiposervizio
 on (servizio.id_tipo_servizio = tiposervizio.id_tipo_servizio)
 
 
where accordo.dt_dec_accordo = (select max(accordo_max.dt_dec_accordo)
								from ORG_ACCORDO_ENTE accordo_max
								where accordo_max.id_ente_convenz = ente.id_ente_siam
								);

-- changeset root:1753259446745-232
COMMENT ON COLUMN ORG_V_RIC_FATTURE.ID_FATTURA_ENTE IS 'PK.1';

-- changeset root:1753259446745-233
COMMENT ON COLUMN ORG_V_RIC_FATTURE.ID_SERVIZIO_FATTURA IS 'PK.2';

-- changeset root:1753259446745-234
CREATE OR REPLACE FORCE VIEW "ORG_V_RIC_FATTURE_PER_ACCORDO" ("ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_ACCORDO_ENTE", "ID_TIPO_ACCORDO", "CD_TIPO_ACCORDO", "ID_FATTURA_ENTE", "AA_FATTURA", "PG_FATTURA", "CD_FATTURA", "CD_REGISTRO_EMIS_FATTURA", "AA_EMISS_FATTURA", "CD_EMIS_FATTURA", "DT_EMIS_FATTURA", "IM_TOT_FATTURA", "IM_TOT_PAGATO", "ID_STATO_FATTURA_ENTE", "TI_STATO_FATTURA_ENTE", "DT_REG_STATO_FATTURA_ENTE", "ID_SERVIZIO_FATTURA", "ID_SERVIZIO_EROGATO", "ID_TIPO_SERVIZIO", "CD_TIPO_SERVIZIO") AS SELECT ente.id_ente_siam,
           ente.nm_ente_siam,
           accordo.id_accordo_ente,
           ti_accordo.id_tipo_accordo,
           ti_accordo.cd_tipo_accordo,
           fattura.id_fattura_ente,
           fattura.aa_fattura,
           fattura.pg_fattura,
           fattura.cd_fattura,
           fattura.cd_registro_emis_fattura,
           fattura.aa_emiss_fattura,
           fattura.cd_emis_fattura,
           fattura.dt_emis_fattura,
           fattura.im_tot_fattura,
           (SELECT SUM (pagamenti.im_pagam)
              FROM ORG_PAGAM_FATTURA_ENTE pagamenti
             WHERE pagamenti.id_fattura_ente = fattura.id_fattura_ente)
               im_tot_pagato,
           statofattura.id_stato_fattura_ente,
           statofattura.ti_stato_fattura_ente,
           statofattura.dt_reg_stato_fattura_ente,
           serv_fatt.id_servizio_fattura,
           servizio.id_servizio_erogato,
           tiposervizio.id_tipo_servizio,
           tiposervizio.cd_tipo_servizio
      FROM ORG_ENTE_SIAM  ente
           JOIN ORG_ACCORDO_ENTE accordo
               ON (accordo.id_ente_convenz = ente.id_ente_siam)
           JOIN ORG_TIPO_ACCORDO ti_accordo
               ON (ti_accordo.id_tipo_accordo = accordo.id_tipo_accordo)
           JOIN ORG_FATTURA_ENTE fattura
               ON (ente.id_ente_siam = fattura.id_ente_convenz)
           JOIN ORG_STATO_FATTURA_ENTE statofattura
               ON (fattura.id_stato_fattura_ente_cor =
                   statofattura.id_stato_fattura_ente)
           JOIN ORG_SERVIZIO_FATTURA serv_fatt
               ON (serv_fatt.id_fattura_ente = fattura.id_fattura_ente)
           JOIN ORG_SERVIZIO_EROG servizio
               ON (serv_fatt.id_servizio_erogato =
                   servizio.id_servizio_erogato)
           JOIN ORG_TIPO_SERVIZIO tiposervizio
               ON (servizio.id_tipo_servizio = tiposervizio.id_tipo_servizio)
     WHERE servizio.ID_ACCORDO_ENTE = accordo.ID_ACCORDO_ENTE;

-- changeset root:1753259446745-235
COMMENT ON COLUMN ORG_V_RIC_FATTURE_PER_ACCORDO.ID_FATTURA_ENTE IS 'PK.1';

-- changeset root:1753259446745-236
COMMENT ON COLUMN ORG_V_RIC_FATTURE_PER_ACCORDO.ID_SERVIZIO_FATTURA IS 'PK.2';

-- changeset root:1753259446745-237
CREATE OR REPLACE FORCE VIEW "ORG_V_CREA_FATTURA_BY_ANNO" ("ID_ENTE_CONVENZ", "AA_FATTURA", "AA_SERVIZIO_FATTURA", "IM_TOT_FATTURA", "IM_TOT_DA_PAGARE", "IM_TOT_IVA", "ID_ACCORDO_ENTE", "DT_DEC_ACCORDO") AS SELECT ente_convenz.id_ente_siam,
           aa_fatt.aa_fattura     aa_fattura,
           aa_serv.aa_fattura     aa_servizio_fattura,
           0                      im_tot_fattura,
           0                      im_tot_da_pagare,
           0                      im_tot_iva,
           acc.id_accordo_ente,
           acc.dt_dec_accordo
      FROM ORG_AA_FATTURA  aa_fatt                       -- anno della fattura
           JOIN ORG_AA_FATTURA aa_serv ON (aa_serv.aa_fattura > 0) -- anno dei servizi
           JOIN ORG_ENTE_SIAM ente_convenz
               ON (ente_convenz.nm_ente_siam LIKE '%')
           JOIN org_accordo_ente acc
               ON (    acc.id_ente_convenz = ente_convenz.id_ente_siam
                   AND EXTRACT (YEAR FROM acc.dt_dec_accordo) <=
                       aa_serv.aa_fattura -- accordi validi nell'anno dei servizi
                   AND EXTRACT (YEAR FROM acc.dt_scad_accordo) >=
                       aa_serv.aa_fattura)
     WHERE (   EXISTS
                   (SELECT * -- esistono servizi UNA_TANTUM dell'accordo da fatturare nell'anno dei servizi
                      FROM org_servizio_erog  serv
                           JOIN org_tipo_servizio ti_serv
                               ON (    ti_serv.id_tipo_servizio =
                                       serv.id_tipo_servizio
                                   AND ti_serv.tipo_fatturazione =
                                       'UNA_TANTUM')
                     WHERE     serv.id_accordo_ente = acc.id_accordo_ente
                           AND serv.fl_pagamento = '1'
                           AND EXTRACT (YEAR FROM serv.dt_erog) =
                               aa_serv.aa_fattura
                           AND NOT EXISTS
                                   (SELECT * -- servizio non già fatturato nell'anno dei servizi
                                      FROM org_servizio_fattura
                                           serv_fatt_prec
                                           JOIN ORG_FATTURA_ENTE fatt_prec
                                               ON (fatt_prec.id_fattura_ente =
                                                   serv_fatt_prec.id_fattura_ente)
                                           JOIN
                                           ORG_STATO_FATTURA_ENTE stato_cor
                                               ON (    stato_cor.id_stato_fattura_ente =
                                                       fatt_prec.id_stato_fattura_ente_cor
                                                   AND stato_cor.ti_stato_fattura_ente !=
                                                       'STORNATA')
                                     WHERE     serv_fatt_prec.id_servizio_erogato =
                                               serv.id_servizio_erogato
                                           AND serv_fatt_prec.aa_servizio_fattura =
                                               aa_serv.aa_fattura))
            OR EXISTS
                   (SELECT *
                      FROM org_servizio_erog  serv -- esistono servizi ANNUALE dell'accordo da fatturare nell'anno dei servizi
                           JOIN org_tipo_servizio ti_serv
                               ON (    ti_serv.id_tipo_servizio =
                                       serv.id_tipo_servizio
                                   AND ti_serv.tipo_fatturazione = 'ANNUALE')
                     WHERE     serv.id_accordo_ente = acc.id_accordo_ente
                           AND serv.fl_pagamento = '1'
                           AND EXTRACT (YEAR FROM serv.dt_erog) <=
                               aa_serv.aa_fattura
                           AND NOT EXISTS
                                   (SELECT * -- servizio non fatturato nell'anno dei servizi
                                      FROM org_servizio_fattura
                                           serv_fatt_prec
                                           JOIN ORG_FATTURA_ENTE fatt_prec
                                               ON (fatt_prec.id_fattura_ente =
                                                   serv_fatt_prec.id_fattura_ente)
                                           JOIN
                                           ORG_STATO_FATTURA_ENTE stato_cor
                                               ON (    stato_cor.id_stato_fattura_ente =
                                                       fatt_prec.id_stato_fattura_ente_cor
                                                   AND stato_cor.ti_stato_fattura_ente !=
                                                       'STORNATA')
                                     WHERE     serv_fatt_prec.id_servizio_erogato =
                                               serv.id_servizio_erogato
                                           AND serv_fatt_prec.aa_servizio_fattura =
                                               aa_serv.aa_fattura))
            OR EXISTS
                   (SELECT * -- esistono servizi UNA_TANTUM dell'accordo da fatturare in anni prec l'anno dei servizi
                      FROM org_servizio_erog  serv
                           JOIN org_tipo_servizio ti_serv
                               ON (    ti_serv.id_tipo_servizio =
                                       serv.id_tipo_servizio
                                   AND ti_serv.tipo_fatturazione =
                                       'UNA_TANTUM')
                     WHERE     serv.id_accordo_ente = acc.id_accordo_ente
                           AND serv.fl_pagamento = '1'
                           AND EXTRACT (YEAR FROM serv.dt_erog) <
                               aa_serv.aa_fattura
                           AND NOT EXISTS
                                   (SELECT * -- servizio non già fatturato in anni prec l'anno dei servizi
                                      FROM org_servizio_fattura
                                           serv_fatt_prec
                                           JOIN ORG_FATTURA_ENTE fatt_prec
                                               ON (fatt_prec.id_fattura_ente =
                                                   serv_fatt_prec.id_fattura_ente)
                                           JOIN
                                           ORG_STATO_FATTURA_ENTE stato_cor
                                               ON (    stato_cor.id_stato_fattura_ente =
                                                       fatt_prec.id_stato_fattura_ente_cor
                                                   AND stato_cor.ti_stato_fattura_ente !=
                                                       'STORNATA')
                                     WHERE     serv_fatt_prec.id_servizio_erogato =
                                               serv.id_servizio_erogato
                                           AND serv_fatt_prec.aa_servizio_fattura =
                                               EXTRACT (
                                                   YEAR FROM serv.dt_erog))));

-- changeset root:1753259446745-238
COMMENT ON COLUMN ORG_V_CREA_FATTURA_BY_ANNO.ID_ENTE_CONVENZ IS 'PK.1';

-- changeset root:1753259446745-239
COMMENT ON COLUMN ORG_V_CREA_FATTURA_BY_ANNO.AA_FATTURA IS 'PK.2';

-- changeset root:1753259446745-240
COMMENT ON COLUMN ORG_V_CREA_FATTURA_BY_ANNO.AA_SERVIZIO_FATTURA IS 'PK.3';

-- changeset root:1753259446745-241
CREATE OR REPLACE FORCE VIEW "ORG_V_CREA_FATTURA_BY_FATT" ("ID_FATTURA_ENTE_DA_RICALC", "ID_ENTE_CONVENZ", "AA_FATTURA", "PG_FATTURA", "CD_FATTURA", "IM_TOT_FATTURA", "IM_TOT_DA_PAGARE", "IM_TOT_IVA") AS select 
 fatt_da_ricalc.id_fattura_ente id_fattura_ente_da_ricalc,
 
 ente_convenz.id_ente_siam,
 aa_fatt.aa_fattura aa_fattura,
 
 (select nvl(max (pg_fattura), 0) + 1
  from org_fattura_ente fatt
  where fatt.id_ente_convenz = ente_convenz.id_ente_siam
  and fatt.aa_fattura = aa_fatt.aa_fattura
 ) pg_fattura,
 
 ente_convenz.cd_ente_convenz || '/' ||
 aa_fatt.aa_fattura || '/' ||
 (select nvl(max (pg_fattura), 0) + 1
  from org_fattura_ente fatt
  where fatt.id_ente_convenz = ente_convenz.id_ente_siam
  and fatt.aa_fattura = aa_fatt.aa_fattura
 ) cd_fattura,
 
 0 im_tot_fattura,
 0 im_tot_da_pagare,
 0 im_tot_iva

from ORG_FATTURA_ENTE fatt_da_ricalc
join ORG_AA_FATTURA aa_fatt													-- anno della fattura
 on (aa_fatt.aa_fattura > 0)
 
join ORG_ENTE_SIAM ente_convenz
 on (ente_convenz.id_ente_siam = fatt_da_ricalc.id_ente_convenz);

-- changeset root:1753259446745-242
COMMENT ON COLUMN ORG_V_CREA_FATTURA_BY_FATT.ID_FATTURA_ENTE_DA_RICALC IS 'PK.1';

-- changeset root:1753259446745-243
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_DATI_SUPEST_TO_DEL" ("ID_USER_IAM", "ID_USO_USER_APPLIC", "ID_APPLIC", "ID_ABIL_DATI", "ID_TIPO_DATO_IAM", "ID_DICH_ABIL_DATI", "ID_APPART_COLLEG_ENTI", "ID_SUPT_EST_ENTE_CONVENZ", "ID_VIGIL_ENTE_PRODUT", "FL_ABIL_AUTOMATICA", "DS_CAUSALE_ABIL") AS select 
 usr.id_user_iam,
 uso_apl.id_uso_user_applic,
 uso_apl.id_applic,
 abil_dati.id_abil_dati,
 abil_dati.id_tipo_dato_iam,
 abil_dati.id_dich_abil_dati,
 abil_dati.id_appart_colleg_enti,
 abil_dati.id_supt_est_ente_convenz,
 abil_dati.id_vigil_ente_produt,
 abil_dati.fl_abil_automatica,
 abil_dati.ds_causale_abil

from USR_USER usr
join USR_USO_USER_APPLIC uso_apl
	on (uso_apl.id_user_iam = usr.id_user_iam)
join USR_ABIL_DATI abil_dati
	on (abil_dati.id_uso_user_applic = abil_dati.id_uso_user_applic)

where abil_dati.id_dich_abil_dati is null
and abil_dati.ID_SUPT_EST_ENTE_CONVENZ is not null
and abil_dati.fl_abil_automatica = '1';

-- changeset root:1753259446745-244
COMMENT ON COLUMN USR_V_ABIL_DATI_SUPEST_TO_DEL.ID_ABIL_DATI IS 'PK.1';

-- changeset root:1753259446745-245
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_DATI_VIGIL_TO_DEL" ("ID_USER_IAM", "ID_USO_USER_APPLIC", "ID_APPLIC", "ID_ABIL_DATI", "ID_TIPO_DATO_IAM", "ID_DICH_ABIL_DATI", "ID_APPART_COLLEG_ENTI", "ID_SUPT_EST_ENTE_CONVENZ", "ID_VIGIL_ENTE_PRODUT", "FL_ABIL_AUTOMATICA", "DS_CAUSALE_ABIL") AS select 
 usr.id_user_iam,
 uso_apl.id_uso_user_applic,
 uso_apl.id_applic,
 abil_dati.id_abil_dati,
 abil_dati.id_tipo_dato_iam,
 abil_dati.id_dich_abil_dati,
 abil_dati.id_appart_colleg_enti,
 abil_dati.id_supt_est_ente_convenz,
 abil_dati.id_vigil_ente_produt,
 abil_dati.fl_abil_automatica,
 abil_dati.ds_causale_abil

from USR_USER usr
join USR_USO_USER_APPLIC uso_apl
	on (uso_apl.id_user_iam = usr.id_user_iam)
join USR_ABIL_DATI abil_dati
	on (abil_dati.id_uso_user_applic = abil_dati.id_uso_user_applic)

where abil_dati.id_dich_abil_dati is null
and abil_dati.id_vigil_ente_produt is not null
and abil_dati.fl_abil_automatica = '1';

-- changeset root:1753259446745-246
COMMENT ON COLUMN USR_V_ABIL_DATI_VIGIL_TO_DEL.ID_ABIL_DATI IS 'PK.1';

-- changeset root:1753259446745-247
CREATE OR REPLACE FORCE VIEW "APL_V_PARAM_APPLIC" ("NM_PARAM_APPLIC", "DS_PARAM_APPLIC", "DS_VALORE_PARAM_APPLIC", "TI_PARAM_APPLIC") AS select 
par.nm_param_applic,
par.ds_param_applic,
val.ds_valore_param_applic,
par.ti_param_applic
from IAM_PARAM_APPLIC par
join IAM_VALORE_PARAM_APPLIC val
	on (val.id_param_applic = par.id_param_applic)
where par.fl_appart_applic = '1'
and par.fl_appart_ambiente = '0'
and par.fl_apparte_ente = '0'

and val.ti_appart = 'APPLIC';

-- changeset root:1753259446745-248
CREATE OR REPLACE FORCE VIEW "IAM_V_GETVAL_PARAM_BY_APL" ("ID_PARAM_APPLIC", "NM_PARAM_APPLIC", "ID_VALORE_PARAM_APPLIC", "DS_VALORE_PARAM_APPLIC") AS select
 par.id_param_applic, par.nm_param_applic,
 val.id_valore_param_applic, val.ds_valore_param_applic
 
from IAM_PARAM_APPLIC par
join IAM_VALORE_PARAM_APPLIC val
	on (val.id_param_applic = par.id_param_applic)
where par.fl_appart_applic = '1'
and par.fl_appart_ambiente = '0'
and par.fl_apparte_ente = '0'

and val.ti_appart = 'APPLIC';

-- changeset root:1753259446745-249
COMMENT ON COLUMN IAM_V_GETVAL_PARAM_BY_APL.ID_VALORE_PARAM_APPLIC IS 'PK.1';

-- changeset root:1753259446745-250
CREATE OR REPLACE FORCE VIEW "IAM_V_GETVAL_PARAM_BY_ENTE" ("TI_APPART", "ID_PARAM_APPLIC", "NM_PARAM_APPLIC", "ID_VALORE_PARAM_APPLIC", "DS_VALORE_PARAM_APPLIC", "ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ") AS select
 'ENTE' ti_appart,
 par.id_param_applic, par.nm_param_applic,
 val.id_valore_param_applic, val.ds_valore_param_applic,
 ente.id_ente_siam, ente.nm_ente_siam
 
from IAM_PARAM_APPLIC par
join IAM_VALORE_PARAM_APPLIC val
	on (val.id_param_applic = par.id_param_applic)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = val.id_ente_convenz)

where par.fl_appart_applic in ('1', '0')
and par.fl_appart_ambiente in ('1', '0')
and par.fl_apparte_ente = '1'

and val.ti_appart = 'ENTE'


UNION

select
 'AMBIENTE' ti_appart,
 par.id_param_applic, par.nm_param_applic,
 val.id_valore_param_applic, val.ds_valore_param_applic,
 ente.id_ente_siam, ente.nm_ente_siam
 
from IAM_PARAM_APPLIC par
join IAM_VALORE_PARAM_APPLIC val
	on (val.id_param_applic = par.id_param_applic)
join ORG_ENTE_SIAM ente
	on (ente.id_ambiente_ente_convenz = val.id_ambiente_ente_convenz)

where par.fl_appart_applic in ('1', '0')
and par.fl_appart_ambiente = '1'
and par.fl_apparte_ente = '1'

and val.ti_appart = 'AMBIENTE'
and not exists (select *
				from IAM_VALORE_PARAM_APPLIC val_ente
				where val_ente.id_param_applic = par.id_param_applic
				and val_ente.id_ente_convenz = ente.id_ente_siam
				and val_ente.ti_appart = 'ENTE'
				)



UNION


select
 'APPLIC' ti_appart,
 par.id_param_applic, par.nm_param_applic,
 val.id_valore_param_applic, val.ds_valore_param_applic,
 ente.id_ente_siam, ente.nm_ente_siam
 
from IAM_PARAM_APPLIC par
join IAM_VALORE_PARAM_APPLIC val
	on (val.id_param_applic = par.id_param_applic)
join ORG_ENTE_SIAM ente
	on (ente.nm_ente_siam like '%')
	
where par.fl_appart_applic = '1'
and par.fl_appart_ambiente in ('1', '0')
and par.fl_apparte_ente = '1'

and val.ti_appart = 'APPLIC'

and not exists (select *
				from IAM_VALORE_PARAM_APPLIC val_amb
				where val_amb.id_param_applic = par.id_param_applic
				and val_amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz
				and val_amb.ti_appart = 'AMBIENTE'
				)
and not exists (select *
				from IAM_VALORE_PARAM_APPLIC val_ente
				where val_ente.id_param_applic = par.id_param_applic
				and val_ente.id_ente_convenz = ente.id_ente_siam
				and val_ente.ti_appart = 'ENTE'
				);

-- changeset root:1753259446745-251
COMMENT ON COLUMN IAM_V_GETVAL_PARAM_BY_ENTE.ID_VALORE_PARAM_APPLIC IS 'PK.1';

-- changeset root:1753259446745-252
CREATE OR REPLACE FORCE VIEW "USR_V_UNAORG_BY_AMMIN" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ORGANIZ_IAM", "DS_CAUSALE_DICH") AS select 																		-- strutture su cui l'utente corrente e' abilitato per qualunque dichiarazione
 user_cor.id_user_iam id_user_iam_cor,
 apl.id_applic, apl.nm_applic,
 abil_org.id_organiz_iam,
 'Appartenenza ad ente amministratore' ds_causale_dich
 
 
from USR_USER user_cor
join USR_USO_USER_APPLIC uso_apl
	on (uso_apl.id_user_iam = user_cor.id_user_iam)
join APL_APPLIC apl
	on (apl.id_applic = uso_apl.id_applic)
join USR_ABIL_ORGANIZ abil_org
	on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic);

-- changeset root:1753259446745-253
COMMENT ON COLUMN USR_V_UNAORG_BY_AMMIN.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-254
COMMENT ON COLUMN USR_V_UNAORG_BY_AMMIN.ID_ORGANIZ_IAM IS 'PK.2';

-- changeset root:1753259446745-255
CREATE OR REPLACE FORCE VIEW "USR_V_UNAORG_BY_CONSERV" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ORGANIZ_IAM", "ID_ENTE_CONSERV", "DS_CAUSALE_DICH") AS select  																		-- strutture Sacer su cui l'utente corrente e' abilitato per qualunque dichiarazione
																				-- con ente conservatore
 user_cor.id_user_iam id_user_iam_cor,
 apl.id_applic, apl.nm_applic,
 abil_org.id_organiz_iam,
 org_amb.id_ente_conserv,
 'Appartenenza ad ente conservatore' ds_causale_dich
  
from USR_USER user_cor
join USR_USO_USER_APPLIC uso_apl
	on (uso_apl.id_user_iam = user_cor.id_user_iam)
join APL_APPLIC apl
	on (apl.id_applic = uso_apl.id_applic
	and apl.nm_applic = 'SACER')
join USR_ABIL_ORGANIZ abil_org
	on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)

join USR_ORGANIZ_IAM org_strut
	on (org_strut.id_organiz_iam = abil_org.id_organiz_iam)
join USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam = org_strut.id_organiz_iam_padre)
join USR_ORGANIZ_IAM org_amb
	on (org_amb.id_organiz_iam = org_ente.id_organiz_iam_padre)

UNION

select  																		-- versatori Ping su cui l'utente corrente e' abilitato per qualunque dichiarazione
																				-- con ente conservatore
 user_cor.id_user_iam id_user_iam_cor,
 apl.id_applic, apl.nm_applic,
 abil_org.id_organiz_iam,
 org_amb.id_ente_conserv,
 'Appartenenza ad ente conservatore' ds_causale_dich
  
from USR_USER user_cor
join USR_USO_USER_APPLIC uso_apl
	on (uso_apl.id_user_iam = user_cor.id_user_iam)
join APL_APPLIC apl
	on (apl.id_applic = uso_apl.id_applic
	and apl.nm_applic = 'SACER_PREINGEST')
join USR_ABIL_ORGANIZ abil_org
	on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)

join USR_ORGANIZ_IAM org_vers
	on (org_vers.id_organiz_iam = abil_org.id_organiz_iam)
join USR_ORGANIZ_IAM org_amb
	on (org_amb.id_organiz_iam = org_vers.id_organiz_iam_padre)
	
UNION

select  																		-- strutture Sacer su cui l'utente corrente e' abilitato per qualunque dichiarazione
																				-- con ente gestore
 user_cor.id_user_iam id_user_iam_cor,
 apl.id_applic, apl.nm_applic,
 abil_org.id_organiz_iam,
 org_amb.id_ente_gestore,
 'Appartenenza ad ente conservatore' ds_causale_dich
  
from USR_USER user_cor
join USR_USO_USER_APPLIC uso_apl
	on (uso_apl.id_user_iam = user_cor.id_user_iam)
join APL_APPLIC apl
	on (apl.id_applic = uso_apl.id_applic
	and apl.nm_applic = 'SACER')
join USR_ABIL_ORGANIZ abil_org
	on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)

join USR_ORGANIZ_IAM org_strut
	on (org_strut.id_organiz_iam = abil_org.id_organiz_iam)
join USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam = org_strut.id_organiz_iam_padre)
join USR_ORGANIZ_IAM org_amb
	on (org_amb.id_organiz_iam = org_ente.id_organiz_iam_padre)

UNION

select  																		-- versatori Ping su cui l'utente corrente e' abilitato per qualunque dichiarazione
																				-- con ente gestore
 user_cor.id_user_iam id_user_iam_cor,
 apl.id_applic, apl.nm_applic,
 abil_org.id_organiz_iam,
 org_amb.id_ente_gestore,
 'Appartenenza ad ente conservatore' ds_causale_dich
  
from USR_USER user_cor
join USR_USO_USER_APPLIC uso_apl
	on (uso_apl.id_user_iam = user_cor.id_user_iam)
join APL_APPLIC apl
	on (apl.id_applic = uso_apl.id_applic
	and apl.nm_applic = 'SACER_PREINGEST')
join USR_ABIL_ORGANIZ abil_org
	on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)

join USR_ORGANIZ_IAM org_vers
	on (org_vers.id_organiz_iam = abil_org.id_organiz_iam)
join USR_ORGANIZ_IAM org_amb
	on (org_amb.id_organiz_iam = org_vers.id_organiz_iam_padre);

-- changeset root:1753259446745-256
COMMENT ON COLUMN USR_V_UNAORG_BY_CONSERV.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-257
COMMENT ON COLUMN USR_V_UNAORG_BY_CONSERV.ID_ORGANIZ_IAM IS 'PK.2';

-- changeset root:1753259446745-258
CREATE OR REPLACE FORCE VIEW "USR_V_UNAORG_BY_VIGIL_COR" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ENTE_ORGANO_VIGIL", "ID_ORGANIZ_IAM_STRUT", "ID_ENTE_PRODUT_CORRISP", "DS_CAUSALE_DICH") AS select   														-- strutture Sacer appartenenti ad ente produt corrispondente ad organo di vigilanza dell'utente inserito / modificato
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,

 ente_non_convenz.id_ente_siam id_ente_organo_vigil,
 strut_app_ente.id_organiz_iam id_organiz_iam_strut,
 ente_non_convenz.id_ente_produt_corrisp,
 'Ente produttore corrispondente ad organo di vigilanza' ds_causale_dich


from ORG_ENTE_SIAM ente_non_convenz	
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join APL_APPLIC apl_cor
	on (apl_cor.nm_applic = 'SACER')						
join ORG_ENTE_CONVENZ_ORG strut_app_ente
	on (strut_app_ente.id_ente_convenz = ente_non_convenz.id_ente_produt_corrisp
	and strut_app_ente.dt_ini_val <= trunc(sysdate)
	and strut_app_ente.dt_fine_val >= trunc(sysdate))
join USR_ORGANIZ_IAM org
  on (org.id_organiz_iam = strut_app_ente.id_organiz_iam
  and org.id_applic = apl_cor.id_applic)

where strut_app_ente.id_organiz_iam in (select abil_org.id_organiz_iam				-- strutture Sacer abilitate ad utente corrente
									 from USR_USO_USER_APPLIC uso_apl
								     join USR_ABIL_ORGANIZ abil_org
										on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)
									 where uso_apl.id_user_iam = user_cor.id_user_iam
									 and uso_apl.id_applic = apl_cor.id_applic
									 );

-- changeset root:1753259446745-259
COMMENT ON COLUMN USR_V_UNAORG_BY_VIGIL_COR.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-260
COMMENT ON COLUMN USR_V_UNAORG_BY_VIGIL_COR.ID_ORGANIZ_IAM_STRUT IS 'PK.2';

-- changeset root:1753259446745-261
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ORG_VIGIL_TO_DEL" ("ID_USER_IAM", "ID_USO_USER_APPLIC", "ID_APPLIC", "ID_ABIL_ORGANIZ", "ID_ORGANIZ_IAM", "ID_DICH_ABIL_ORGANIZ", "ID_APPART_COLLEG_ENTI", "ID_SUPT_EST_ENTE_CONVENZ", "ID_VIGIL_ENTE_PRODUT", "FL_ABIL_AUTOMATICA", "DS_CAUSALE_ABIL") AS select 
 usr.id_user_iam,
 uso_apl.id_uso_user_applic,
 uso_apl.id_applic,
 abil_org.id_abil_organiz,
 abil_org.id_organiz_iam,
 abil_org.id_dich_abil_organiz,
 abil_org.id_appart_colleg_enti,
 abil_org.id_supt_est_ente_convenz,
 abil_org.id_vigil_ente_produt,
 abil_org.fl_abil_automatica,
 abil_org.ds_causale_abil

from USR_USER usr
join USR_USO_USER_APPLIC uso_apl
	on (uso_apl.id_user_iam = usr.id_user_iam)
join USR_ABIL_ORGANIZ abil_org
	on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)

where abil_org.id_dich_abil_organiz is null
and abil_org.id_vigil_ente_produt is not null
and abil_org.fl_abil_automatica = '1';

-- changeset root:1753259446745-262
COMMENT ON COLUMN USR_V_ABIL_ORG_VIGIL_TO_DEL.ID_ABIL_ORGANIZ IS 'PK.1';

-- changeset root:1753259446745-263
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_ENTE_BY_ABIL_ORG" ("ID_USER_IAM", "ID_ENTE_CONVENZ") AS select distinct
 usr.id_user_iam,
 ente_org.id_ente_convenz

from USR_USER usr
join USR_USO_USER_APPLIC uso_apl
	on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
	on (apl.id_applic = uso_apl.id_applic
	and apl.nm_applic = 'SACER')
join USR_ABIL_ORGANIZ abil_org
	on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)
join ORG_ENTE_CONVENZ_ORG ente_org	
 on (ente_org.id_organiz_iam = abil_org.id_organiz_iam);

-- changeset root:1753259446745-264
COMMENT ON COLUMN USR_V_LIS_ENTE_BY_ABIL_ORG.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-265
COMMENT ON COLUMN USR_V_LIS_ENTE_BY_ABIL_ORG.ID_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-266
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ORG_SUPEST_TO_DEL" ("ID_USER_IAM", "ID_USO_USER_APPLIC", "ID_APPLIC", "ID_ABIL_ORGANIZ", "ID_ORGANIZ_IAM", "ID_DICH_ABIL_ORGANIZ", "ID_APPART_COLLEG_ENTI", "ID_SUPT_EST_ENTE_CONVENZ", "ID_VIGIL_ENTE_PRODUT", "FL_ABIL_AUTOMATICA", "DS_CAUSALE_ABIL") AS select 
 usr.id_user_iam,
 uso_apl.id_uso_user_applic,
 uso_apl.id_applic,
 abil_org.id_abil_organiz,
 abil_org.id_organiz_iam,
 abil_org.id_dich_abil_organiz,
 abil_org.id_appart_colleg_enti,
 abil_org.id_supt_est_ente_convenz,
 abil_org.id_vigil_ente_produt,
 abil_org.fl_abil_automatica,
 abil_org.ds_causale_abil

from USR_USER usr
join USR_USO_USER_APPLIC uso_apl
	on (uso_apl.id_user_iam = usr.id_user_iam)
join USR_ABIL_ORGANIZ abil_org
	on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)

where abil_org.id_dich_abil_organiz is null
and abil_org.ID_SUPT_EST_ENTE_CONVENZ is not null
and abil_org.fl_abil_automatica = '1';

-- changeset root:1753259446745-267
CREATE OR REPLACE FORCE VIEW "ORG_V_SERV_SIST_VERS_DA_EROG" ("ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_ACCORDO_ENTE", "DT_DEC_ACCORDO", "ID_SERVIZIO_EROGATO", "NM_SERVIZIO_EROGATO", "DT_EROG", "ID_TIPO_SERVIZIO", "CD_TIPO_SERVIZIO", "ID_SISTEMA_VERSANTE", "NM_SISTEMA_VERSANTE", "LIST_STRUT") AS select
 ente.id_ente_siam, ente.nm_ente_siam,
 accordo.id_accordo_ente, accordo.dt_dec_accordo,
 serv.id_servizio_erogato, serv.nm_servizio_erogato, serv.dt_erog,
 
 ti_serv.id_tipo_servizio, ti_serv.cd_tipo_servizio,
 
 sist.id_sistema_versante,sist.nm_sistema_versante,
 
 listagg (strut.id_organiz_applic, ', ') within group (order by strut.id_organiz_applic) list_strut
 
from ORG_ENTE_SIAM ente
join ORG_ENTE_CONVENZ_ORG strut_ente
 on (strut_ente.id_ente_convenz = ente.id_ente_siam
 and strut_ente.dt_ini_val <= trunc(sysdate)
 and strut_ente.dt_fine_val >= trunc(sysdate))
 
join USR_ORGANIZ_IAM strut
 on (strut.id_organiz_iam = strut_ente.id_organiz_iam)
join APL_APPLIC apl
 on (apl.id_applic = strut.id_applic
 and apl.nm_applic = 'SACER')
 
join ORG_ACCORDO_ENTE accordo
 on (accordo.id_ente_convenz = ente.id_ente_siam
 and accordo.dt_dec_accordo <= trunc(sysdate)
 and accordo.dt_scad_accordo >= trunc(sysdate))
join ORG_SERVIZIO_EROG serv
 on (serv.id_accordo_ente = accordo.id_accordo_ente)
join ORG_TIPO_SERVIZIO ti_serv
 on (ti_serv.id_tipo_servizio = serv.id_tipo_servizio
 and ti_serv.ti_classe_tipo_servizio = 'ATTIVAZIONE_SISTEMA_VERSANTE')
join APL_SISTEMA_VERSANTE sist
 on (sist.id_sistema_versante = serv.id_sistema_versante)
 
group by ente.id_ente_siam, ente.nm_ente_siam, 
		accordo.id_accordo_ente, accordo.dt_dec_accordo,
		serv.id_servizio_erogato, serv.nm_servizio_erogato, serv.dt_erog,
		ti_serv.id_tipo_servizio, ti_serv.cd_tipo_servizio,
		sist.id_sistema_versante, sist.nm_sistema_versante;

-- changeset root:1753259446745-268
COMMENT ON COLUMN ORG_V_SERV_SIST_VERS_DA_EROG.ID_SERVIZIO_EROGATO IS 'PK.1';

-- changeset root:1753259446745-269
CREATE OR REPLACE FORCE VIEW "ORG_V_SERV_TI_SERV_DA_EROG" ("ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_ACCORDO_ENTE", "DT_DEC_ACCORDO", "ID_SERVIZIO_EROGATO", "NM_SERVIZIO_EROGATO", "DT_EROG", "ID_TIPO_SERVIZIO", "CD_TIPO_SERVIZIO", "LIST_STRUT") AS select
 ente.id_ente_siam, ente.nm_ente_siam,
 accordo.id_accordo_ente, accordo.dt_dec_accordo,
 serv.id_servizio_erogato, serv.nm_servizio_erogato, serv.dt_erog,
 ti_serv.id_tipo_servizio, ti_serv.cd_tipo_servizio,
 
 listagg (strut.id_organiz_applic, ', ') within group (order by strut.id_organiz_applic) list_strut
 
from ORG_ENTE_SIAM ente
join ORG_ENTE_CONVENZ_ORG strut_ente
 on (strut_ente.id_ente_convenz = ente.id_ente_siam
 and strut_ente.dt_ini_val <= trunc(sysdate)
 and strut_ente.dt_fine_val >= trunc(sysdate))
 
join USR_ORGANIZ_IAM strut
 on (strut.id_organiz_iam = strut_ente.id_organiz_iam)
join APL_APPLIC apl
 on (apl.id_applic = strut.id_applic
 and apl.nm_applic = 'SACER')
 
join ORG_ACCORDO_ENTE accordo
 on (accordo.id_ente_convenz = ente.id_ente_siam
 and accordo.dt_dec_accordo <= trunc(sysdate)
 and accordo.dt_scad_accordo >= trunc(sysdate))
join ORG_SERVIZIO_EROG serv
 on (serv.id_accordo_ente = accordo.id_accordo_ente)
join ORG_TIPO_SERVIZIO ti_serv
 on (ti_serv.id_tipo_servizio = serv.id_tipo_servizio
 and ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE')

 
group by ente.id_ente_siam, ente.nm_ente_siam,
		accordo.id_accordo_ente, accordo.dt_dec_accordo,
		serv.id_servizio_erogato, serv.nm_servizio_erogato, serv.dt_erog,
		ti_serv.id_tipo_servizio, ti_serv.cd_tipo_servizio;

-- changeset root:1753259446745-270
COMMENT ON COLUMN ORG_V_SERV_TI_SERV_DA_EROG.ID_SERVIZIO_EROGATO IS 'PK.1';

-- changeset root:1753259446745-271
CREATE OR REPLACE FORCE VIEW "ORG_V_CHK_SERV_FATT_BY_STRUT" ("ID_STRUT", "ID_ENTE_CONVENZ", "DT_INI_VAL", "FL_ELIMINA_ENTE_STRUT") AS select
 org.id_organiz_applic id_strut,
 ente_org.id_ente_convenz,
 ente_org.dt_ini_val,
 case
	when exists (select *
				 from ORG_FATTURA_ENTE fatt
				 where fatt.id_ente_convenz = ente_org.id_ente_convenz
				 )
		then '0'
		else '1'
 end fl_elimina_ente_strut
 
from APL_APPLIC apl
join USR_ORGANIZ_IAM org
 on (org.id_applic = apl.id_applic)
join APL_TIPO_ORGANIZ ti_org
 on (ti_org.id_tipo_organiz = org.id_tipo_organiz
 and ti_org.nm_tipo_organiz = 'STRUTTURA')

join ORG_ENTE_CONVENZ_ORG ente_org
 on (ente_org.id_organiz_iam  = org.id_organiz_iam)
 
where apl.nm_applic = 'SACER';

-- changeset root:1753259446745-272
COMMENT ON COLUMN ORG_V_CHK_SERV_FATT_BY_STRUT.ID_STRUT IS 'PK.1';

-- changeset root:1753259446745-273
COMMENT ON COLUMN ORG_V_CHK_SERV_FATT_BY_STRUT.ID_ENTE_CONVENZ IS 'PK.2';

-- changeset root:1753259446745-274
COMMENT ON COLUMN ORG_V_CHK_SERV_FATT_BY_STRUT.DT_INI_VAL IS 'PK.3';

-- changeset root:1753259446745-275
CREATE OR REPLACE FORCE VIEW "USR_V_ENTI_SACER_BY_PRODUT" ("ID_ENTE_PRODUT", "ID_ORGANIZ_IAM_ENTE") AS select distinct															-- enti sacer di strut appartenenti ad ente produt dell'utente inserito / modificato
strut_app_ente.id_ente_convenz id_ente_produt,
org_strut.id_organiz_iam_padre id_organiz_iam_ente

from ORG_ENTE_CONVENZ_ORG strut_app_ente							
join USR_ORGANIZ_IAM org_strut
	on (org_strut.id_organiz_iam = strut_app_ente.id_organiz_iam)
where strut_app_ente.dt_ini_val <= trunc(sysdate)
and strut_app_ente.dt_fine_val >= trunc(sysdate);

-- changeset root:1753259446745-276
COMMENT ON COLUMN USR_V_ENTI_SACER_BY_PRODUT.ID_ORGANIZ_IAM_ENTE IS 'PK.1';

-- changeset root:1753259446745-277
CREATE OR REPLACE FORCE VIEW "USR_V_ENTI_SACER_BY_CORRISP" ("ID_ENTE_NON_CONVEN", "ID_ORGANIZ_IAM_ENTE", "ID_ENTE_PRODUT_CORRISP", "TI_ENTE_NON_CONVENZ") AS SELECT DISTINCT -- enti sacer di strut appartenenti ad ente produt corrispondente all'organo di vigilanza / fornitore esterno dell'utente inserito / modificato
                    ente_non_convenz.id_ente_siam      id_ente_non_conven,
                    org_strut.id_organiz_iam_padre     id_organiz_iam_ente,
                    ente_non_convenz.id_ente_produt_corrisp,
                    ente_non_convenz.TI_ENTE_NON_CONVENZ
      FROM ORG_ENTE_SIAM  ente_non_convenz
           JOIN ORG_ENTE_CONVENZ_ORG strut_app_ente
               ON (strut_app_ente.id_ente_convenz =
                   ente_non_convenz.id_ente_produt_corrisp)
           JOIN USR_ORGANIZ_IAM org_strut
               ON (org_strut.id_organiz_iam = strut_app_ente.id_organiz_iam)
     WHERE     strut_app_ente.dt_ini_val <= TRUNC (SYSDATE)
           AND strut_app_ente.dt_fine_val >= TRUNC (SYSDATE);

-- changeset root:1753259446745-278
COMMENT ON COLUMN USR_V_ENTI_SACER_BY_CORRISP.ID_ORGANIZ_IAM_ENTE IS 'PK.1';

-- changeset root:1753259446745-279
CREATE OR REPLACE FORCE VIEW "ORG_V_LIS_TI_SERV_BY_ENTE" ("ID_ENTE_CONVENZ", "CD_TIPO_ACCORDO", "CD_ALGO_TARIFFARIO", "NM_TARIFFARIO", "NM_TARIFFA", "CD_CLASSE_ENTE_CONVENZ", "ID_TIPO_SERVIZIO", "CD_TIPO_SERVIZIO", "TI_CLASSE_TIPO_SERVIZIO", "TI_DOC_TIPO_SERVIZIO") AS select distinct 
	ente.id_ente_siam, 
	ti_acc.cd_tipo_accordo,
	ti_acc.cd_algo_tariffario,
	tariffario.nm_tariffario, 
	tariffa.nm_tariffa,
	classe_ente.cd_classe_ente_convenz,
	ti_serv.id_tipo_servizio, 
	ti_serv.cd_tipo_servizio, 
	ti_serv.ti_classe_tipo_servizio,
	ti_serv.ti_doc_tipo_servizio
	
from org_ente_siam ente
join org_accordo_ente acc
 on (acc.id_ente_convenz = ente.id_ente_siam)
join org_classe_ente_convenz classe_ente
 on (classe_ente.id_classe_ente_convenz = acc.id_classe_ente_convenz)
 
join org_tipo_accordo ti_acc
 on (ti_acc.id_tipo_accordo = acc.id_tipo_accordo
 and ti_acc.cd_algo_tariffario = 'CLASSE_ENTE')
 
join org_tariffario tariffario
 on (tariffario.id_tariffario = acc.id_tariffario)
join org_tariffa tariffa
 on (tariffa.id_tariffario = tariffario.id_tariffario
 and tariffa.id_classe_ente_convenz = acc.id_classe_ente_convenz)
join org_tipo_servizio ti_serv
 on (ti_serv.id_tipo_servizio = tariffa.id_tipo_servizio)
 
where acc.dt_dec_accordo = (select max(accordo_max.dt_dec_accordo)
							from ORG_ACCORDO_ENTE accordo_max
							where accordo_max.id_ente_convenz = ente.id_ente_siam
							)
							
UNION

select distinct 
	ente.id_ente_siam, 
	ti_acc.cd_tipo_accordo,
	ti_acc.cd_algo_tariffario,
	tariffario.nm_tariffario, 
	tariffa.nm_tariffa,
	null cd_classe_ente_convenz,
	ti_serv.id_tipo_servizio, 
	ti_serv.cd_tipo_servizio, 
	ti_serv.ti_classe_tipo_servizio,
	ti_serv.ti_doc_tipo_servizio
	
from org_ente_siam ente
join org_accordo_ente acc
 on (acc.id_ente_convenz = ente.id_ente_siam)

join org_tipo_accordo ti_acc
 on (ti_acc.id_tipo_accordo = acc.id_tipo_accordo
 and ti_acc.cd_algo_tariffario = 'NO_CLASSE_ENTE')
 
join org_tariffario tariffario
 on (tariffario.id_tariffario = acc.id_tariffario)
join org_tariffa tariffa
 on (tariffa.id_tariffario = tariffario.id_tariffario)
join org_tipo_servizio ti_serv
 on (ti_serv.id_tipo_servizio = tariffa.id_tipo_servizio)
 
where acc.dt_dec_accordo = (select max(accordo_max.dt_dec_accordo)
							from ORG_ACCORDO_ENTE accordo_max
							where accordo_max.id_ente_convenz = ente.id_ente_siam
							);

-- changeset root:1753259446745-280
CREATE OR REPLACE FORCE VIEW "ORG_V_TI_SERV_BY_ENTE_CONVENZ" ("ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_TIPO_SERVIZIO", "CD_TIPO_SERVIZIO") AS select
 ente.id_ente_siam, ente.nm_ente_siam,
 ti_serv.id_tipo_servizio, ti_serv.cd_tipo_servizio
 
from ORG_ENTE_SIAM ente
join ORG_ACCORDO_ENTE accordo
 on (accordo.id_ente_convenz = ente.id_ente_siam
 and accordo.dt_dec_accordo <= trunc(sysdate)
 and accordo.dt_scad_accordo >= trunc(sysdate))
join ORG_SERVIZIO_EROG serv
 on (serv.id_accordo_ente = accordo.id_accordo_ente)
join ORG_TIPO_SERVIZIO ti_serv
 on (ti_serv.id_tipo_servizio = serv.id_tipo_servizio
 and ti_serv.ti_classe_tipo_servizio = 'CONSERVAZIONE');

-- changeset root:1753259446745-281
COMMENT ON COLUMN ORG_V_TI_SERV_BY_ENTE_CONVENZ.ID_ENTE_CONVENZ IS 'PK.1';

-- changeset root:1753259446745-282
COMMENT ON COLUMN ORG_V_TI_SERV_BY_ENTE_CONVENZ.ID_TIPO_SERVIZIO IS 'PK.2';

-- changeset root:1753259446745-283
CREATE OR REPLACE FORCE VIEW "USR_V_CHK_CREA_AMB_SACER" ("ID_USER_IAM", "ID_APPLIC", "NM_APPLIC", "FL_CREA_AMBIENTE") AS select
 usr.id_user_iam,
 apl.id_applic,
 apl.nm_applic,
 case
	when exists (select ti_ente_convenz
				from org_ente_siam ente
				where ente.id_ente_siam = usr.id_ente_siam
				and ti_ente_convenz = 'AMMINISTRATORE'				
				)
		then '1'
		else '0'
 end fl_crea_ambiente

from USR_USER usr
join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_apl.id_applic);

-- changeset root:1753259446745-284
COMMENT ON COLUMN USR_V_CHK_CREA_AMB_SACER.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-285
COMMENT ON COLUMN USR_V_CHK_CREA_AMB_SACER.ID_APPLIC IS 'PK.2';

-- changeset root:1753259446745-286
CREATE OR REPLACE FORCE VIEW "ORG_V_VIS_STATO_ACCORDO" ("ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "ID_ACCORDO_ENTE", "TI_STATO_ACCORDO") AS SELECT ente.id_ente_siam,
           ente.nm_ente_siam,
           accordo.id_accordo_ente,
           CASE
               --a) Accordo valido (data corrente compresa tra data decorrenza e data fine validità e < data scadenza)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE accordo_ente.id_ente_convenz =
                                ente.id_ente_siam
                            AND accordo.dt_fine_valid_accordo >=
                                TRUNC (SYSDATE)
                            AND accordo.dt_dec_accordo <= TRUNC (SYSDATE)
                            AND accordo.dt_scad_accordo >= TRUNC (SYSDATE)) THEN
                   'Accordo valido'
               --b) Accordo valido in corso di rinnovo (data corrente > data scadenza e < data fine validità)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE accordo_ente.id_ente_convenz =
                                ente.id_ente_siam
                            AND TRUNC (SYSDATE) <=
                                accordo.dt_fine_valid_accordo
                            --and accordo.dt_dec_accordo < trunc (sysdate)
                            AND TRUNC (SYSDATE) > accordo.dt_scad_accordo) THEN
                   'Accordo valido in corso rinnovo'
               --c) Accordo non valido per recesso (data fine validità < data scadenza e data corrente > data fine validità)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE accordo_ente.id_ente_convenz =
                                ente.id_ente_siam
                            AND accordo.dt_fine_valid_accordo <
                                accordo.dt_scad_accordo
                            AND TRUNC (SYSDATE) >
                                accordo.dt_fine_valid_accordo) THEN
                   'Accordo non valido per recesso'
               --d) Accordo non valido per scadenza (data fine validità >= data scadenza =< data corrente)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE accordo_ente.id_ente_convenz =
                                ente.id_ente_siam
                            AND accordo.dt_fine_valid_accordo >=
                                accordo.dt_scad_accordo
                            AND TRUNC (SYSDATE) >
                                accordo.dt_fine_valid_accordo) THEN
                   'Accordo non valido per scadenza'
               --e) Accordo in corso di stipula (data corrente < data decorrenza e dt_registrazione is null o > data corrente)
               WHEN EXISTS
                        (SELECT *
                           FROM ORG_ACCORDO_ENTE accordo_ente
                          WHERE accordo_ente.id_ente_convenz =
                                ente.id_ente_siam
                            AND TRUNC (SYSDATE) < accordo.dt_dec_accordo
                            AND accordo.dt_reg_accordo IS NULL
                             OR accordo.dt_reg_accordo > SYSDATE) THEN
                   'Accordo in corso di stipula'
               ELSE
                   --Accordo non valido (data corrente < data decorrenza o > data fine validità)
                   'Accordo non valido'
           END    ti_stato_accordo
      FROM ORG_ENTE_SIAM  ente
           LEFT JOIN ORG_ACCORDO_ENTE accordo
               ON (accordo.id_ente_convenz = ente.id_ente_siam)
     WHERE ente.ti_ente = 'CONVENZIONATO';

-- changeset root:1753259446745-287
COMMENT ON COLUMN ORG_V_VIS_STATO_ACCORDO.ID_ACCORDO_ENTE IS 'PK.1';

-- changeset root:1753259446745-288
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_AZIO_RICH_GEST_USER" ("ID_APPART_USER_RICH", "ID_RICH_GEST_USER", "TI_APPART_USER_RICH", "NM_NOME_USER", "NM_COGNOME_USER", "NM_USERID", "ID_USER_IAM", "TI_AZIONE_RICH", "FL_AZIONE_RICH_EVASA", "ID_ENTE_USER", "NM_ENTE_SIAM_USER") AS select 
 azio.id_appart_user_rich,
 azio.id_rich_gest_user,
 azio.ti_appart_user_rich,
 case
	when ti_appart_user_rich = 'UTENTE_NON_CODIFICATO'
		then azio.nm_nome_user
		else usr.nm_nome_user
 end nm_nome_user,
 case
	when ti_appart_user_rich = 'UTENTE_NON_CODIFICATO'
		then azio.nm_cognome_user
		else usr.nm_cognome_user
 end nm_cognome_user,
 case
	when ti_appart_user_rich = 'UTENTE_NON_CODIFICATO'
		then azio.nm_userid
		else usr.nm_userid
 end nm_userid,
 azio.id_user_iam,
 azio.ti_azione_rich,
 azio.fl_azione_rich_evasa,
 azio.id_ente_user,
 ente_utente.nm_ente_siam nm_ente_siam_user
 
from USR_APPART_USER_RICH azio
left join USR_USER usr
 on (usr.id_user_iam = azio.id_user_iam)
join ORG_ENTE_SIAM ente_utente
	on (ente_utente.id_ente_siam = azio.id_ente_user);

-- changeset root:1753259446745-289
COMMENT ON COLUMN USR_V_LIS_AZIO_RICH_GEST_USER.ID_APPART_USER_RICH IS 'PK.1';

-- changeset root:1753259446745-290
CREATE OR REPLACE FORCE VIEW "ORG_V_CALC_IM_SERV_FATT_ANN" ("ID_FATTURA_ENTE", "ID_ACCORDO_ENTE", "ID_SERVIZIO_EROGATO", "AA_SERVIZIO_FATTURA", "NM_SERVIZIO_FATTURA", "IM_SERVIZIO_FATTURA", "QT_SCAGLIONE_SERVIZIO_FATTURA", "QT_UNIT_SERVIZIO_FATTURA", "DT_EROG", "NT_SERVIZIO_FATTURA", "ID_CD_IVA", "MM_FATTURA", "IM_VALORE_FISSO_TARIFFA", "NI_QUANTITA_UNIT", "NI_ABITANTI") AS select 
tmp.id_fattura_ente,
tmp.id_accordo_ente,
tmp.id_servizio_erogato,
tmp.aa_servizio_fattura,
--tmp.tipo_tariffa,

tmp.nm_servizio_fattura,
			 
case
	when tmp.tipo_tariffa = 'VALORE_SCAGLIONI_STORAGE'									-- uso tutti gli scaglioni con estremo sx minore o uguale a quantità
		then round ( (select sum(scg.im_scaglione)
					  from org_scaglione_tariffa scg
					  where scg.id_tariffa = tmp.id_tariffa
					  and scg.ni_ini_scaglione <= tmp.qt_scaglione_servizio_fattura
					 ) * (tmp.mm_fattura / 12)											-- rapporto a mesi da fatturare
					, 2)

	when tmp.tipo_tariffa = 'VALORE_UNITARIO_SCAGLIONI_STORAGE'							-- uso solo lo scaglione in cui la quantità e' inclusa
		then round ( (select scg.im_scaglione
					  from org_scaglione_tariffa scg
					  where scg.id_tariffa = tmp.id_tariffa
					  and scg.ni_ini_scaglione <= tmp.qt_scaglione_servizio_fattura
					  and scg.ni_fine_scaglione >= tmp.qt_scaglione_servizio_fattura
					 )
					 * round (tmp.qt_unit_servizio_fattura / tmp.ni_quantita_unit) 		-- numero abitanti / 1000
					 * (tmp.mm_fattura / 12)											-- rapporto a mesi da fatturare
					, 2)

	when tmp.tipo_tariffa = 'VALORE_SCAGLIONI_UD_VERSATE'								-- uso tutti gli scaglioni con estremo sx minore o uguale a quantità
		then round ( (select sum(scg.im_scaglione)
					  from org_scaglione_tariffa scg
					  where scg.id_tariffa = tmp.id_tariffa
					  and scg.ni_ini_scaglione <= tmp.qt_scaglione_servizio_fattura
					 ) 
					 * (tmp.mm_fattura / 12)											-- rapporto a mesi da fatturare
					, 2)
	when tmp.tipo_tariffa = 'VALORE_FISSO'
		then round ( tmp.im_valore_fisso_tariffa
					* (tmp.mm_fattura / 12)												-- rapporto a mesi da fatturare
					, 2)
	else 0
end im_servizio_fattura,
tmp.qt_scaglione_servizio_fattura,
tmp.qt_unit_servizio_fattura,
tmp.dt_erog,
null nt_servizio_fattura,
tmp.id_cd_iva,
tmp.mm_fattura,
tmp.im_valore_fisso_tariffa,
tmp.ni_quantita_unit,
tmp.ni_abitanti

from ORG_V_CALC_SERV_FATT_ANNUALE tmp;

-- changeset root:1753259446745-291
COMMENT ON COLUMN ORG_V_CALC_IM_SERV_FATT_ANN.ID_FATTURA_ENTE IS 'PK.1';

-- changeset root:1753259446745-292
COMMENT ON COLUMN ORG_V_CALC_IM_SERV_FATT_ANN.ID_SERVIZIO_EROGATO IS 'PK.3';

-- changeset root:1753259446745-293
COMMENT ON COLUMN ORG_V_CALC_IM_SERV_FATT_ANN.AA_SERVIZIO_FATTURA IS 'PK.2';

-- changeset root:1753259446745-294
CREATE OR REPLACE FORCE VIEW "PRF_V_LIS_AUTOR_RUOLO" ("ID_RUOLO", "NM_RUOLO", "ID_APPLIC", "NM_APPLIC", "TI_DICH_AUTOR", "ID_AUTOR", "NM_PAGINA_WEB", "NM_AUTOR", "DS_AUTOR", "NI_LIVELLO_ENTRY_MENU", "NI_ORD_ENTRY_MENU", "DL_LINK_ENTRY_MENU") AS select
ruo.id_ruolo, ruo.nm_ruolo,
apl.id_applic, apl.nm_applic,
aut.ti_dich_autor, 
menu.id_entry_menu, 
null, menu.nm_entry_menu, menu.ds_entry_menu, menu.ni_livello_entry_menu, menu.ni_ord_entry_menu, menu.dl_link_entry_menu

from PRF_RUOLO ruo 
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join PRF_AUTOR aut 
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic)
join APL_ENTRY_MENU menu
 on (menu.id_entry_menu = aut.id_entry_menu)
where aut.ti_dich_autor = 'ENTRY_MENU'

UNION

select
ruo.id_ruolo, ruo.nm_ruolo,
apl.id_applic, apl.nm_applic,
aut.ti_dich_autor, 
pag.id_pagina_web, 
null, pag.nm_pagina_web, pag.ds_pagina_web, null, null, null

from PRF_RUOLO ruo 
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join PRF_AUTOR aut 
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic)
join APL_PAGINA_WEB pag
 on (pag.id_pagina_web = aut.id_pagina_web)
where aut.ti_dich_autor = 'PAGINA'

UNION

select
ruo.id_ruolo, ruo.nm_ruolo,
apl.id_applic, apl.nm_applic,
aut.ti_dich_autor, 
azio.id_azione_pagina, 
pag.nm_pagina_web, azio.nm_azione_pagina, pag.ds_pagina_web || ' --> ' || azio.ds_azione_pagina, null, null, null

from PRF_RUOLO ruo 
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join PRF_AUTOR aut 
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic)
join APL_AZIONE_PAGINA azio
 on (azio.id_azione_pagina = aut.id_azione_pagina)
join APL_PAGINA_WEB pag
 on (pag.id_pagina_web = azio.id_pagina_web)
 
where aut.ti_dich_autor = 'AZIONE'

UNION

select
ruo.id_ruolo, ruo.nm_ruolo,
apl.id_applic, apl.nm_applic,
aut.ti_dich_autor, 
serv.id_servizio_web, 
null, serv.nm_servizio_web, serv.ds_servizio_web, null, null, null

from PRF_RUOLO ruo 
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join PRF_AUTOR aut 
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic)
join APL_SERVIZIO_WEB serv
 on (serv.id_servizio_web = aut.id_servizio_web)
where aut.ti_dich_autor = 'SERVIZIO_WEB';

-- changeset root:1753259446745-295
COMMENT ON COLUMN PRF_V_LIS_AUTOR_RUOLO.ID_RUOLO IS 'PK.1';

-- changeset root:1753259446745-296
COMMENT ON COLUMN PRF_V_LIS_AUTOR_RUOLO.ID_APPLIC IS 'PK.2';

-- changeset root:1753259446745-297
COMMENT ON COLUMN PRF_V_LIS_AUTOR_RUOLO.TI_DICH_AUTOR IS 'PK.6';

-- changeset root:1753259446745-298
COMMENT ON COLUMN PRF_V_LIS_AUTOR_RUOLO.ID_AUTOR IS 'PK.7';

-- changeset root:1753259446745-299
CREATE OR REPLACE FORCE VIEW "USR_V_AUTOR_DEFAULT" ("ID_USER_IAM", "NM_USERID", "ID_USO_USER_APPLIC", "ID_USO_RUOLO_USER_DEFAULT", "ID_APPLIC", "NM_APPLIC", "ID_RUOLO", "NM_RUOLO", "TI_DICH_AUTOR", "ID_AUTOR", "NM_AUTOR", "DS_AUTOR") AS select distinct
 usr.id_user_iam, usr.nm_userid,
 uso_user_apl.id_uso_user_applic,
 ruo_def.id_uso_ruolo_user_default,
 apl.id_applic, apl.nm_applic, ruo.id_ruolo, ruo.nm_ruolo,
 aut.ti_dich_autor,
 menu.id_entry_menu, menu.nm_entry_menu, menu.ds_entry_menu
from USR_USER usr
join USR_USO_USER_APPLIC uso_user_apl
 on (uso_user_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_user_apl.id_applic)
join USR_USO_RUOLO_USER_DEFAULT ruo_def
 on (ruo_def.id_uso_user_applic = uso_user_apl.id_uso_user_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = ruo_def.id_ruolo)
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo
 and uso_ruo.id_applic = uso_user_apl.id_applic)
join PRF_AUTOR aut
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
 and aut.ti_dich_autor = 'ENTRY_MENU')
join APL_ENTRY_MENU menu
 on (menu.id_entry_menu = aut.id_entry_menu)

UNION
 
select distinct
 usr.id_user_iam, usr.nm_userid,
 uso_user_apl.id_uso_user_applic,
 ruo_def.id_uso_ruolo_user_default,
 apl.id_applic, apl.nm_applic, ruo.id_ruolo, ruo.nm_ruolo,
 aut.ti_dich_autor,
 pag.id_pagina_web, pag.nm_pagina_web, pag.ds_pagina_web
from USR_USER usr
join USR_USO_USER_APPLIC uso_user_apl
 on (uso_user_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_user_apl.id_applic)
join USR_USO_RUOLO_USER_DEFAULT ruo_def
 on (ruo_def.id_uso_user_applic = uso_user_apl.id_uso_user_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = ruo_def.id_ruolo)
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo
 and uso_ruo.id_applic = uso_user_apl.id_applic)
join PRF_AUTOR aut
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
 and aut.ti_dich_autor = 'PAGINA')
join APL_PAGINA_WEB pag
 on (pag.id_pagina_web = aut.id_pagina_web)

UNION
 
select distinct
 usr.id_user_iam, usr.nm_userid,
 uso_user_apl.id_uso_user_applic,
 ruo_def.id_uso_ruolo_user_default,
 apl.id_applic, apl.nm_applic, ruo.id_ruolo, ruo.nm_ruolo,
 aut.ti_dich_autor,
 azio.id_azione_pagina, pag.nm_pagina_web || ' --> ' || azio.nm_azione_pagina, pag.ds_pagina_web || ' --> ' || azio.ds_azione_pagina
from USR_USER usr
join USR_USO_USER_APPLIC uso_user_apl
 on (uso_user_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_user_apl.id_applic)
join USR_USO_RUOLO_USER_DEFAULT ruo_def
 on (ruo_def.id_uso_user_applic = uso_user_apl.id_uso_user_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = ruo_def.id_ruolo)
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo
 and uso_ruo.id_applic = uso_user_apl.id_applic)
join PRF_AUTOR aut
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
 and aut.ti_dich_autor = 'AZIONE')
join APL_AZIONE_PAGINA azio
 on (azio.id_azione_pagina = aut.id_azione_pagina)
join APL_PAGINA_WEB pag
 on (pag.id_pagina_web = azio.id_pagina_web)

UNION
   
select distinct
 usr.id_user_iam, usr.nm_userid,
 uso_user_apl.id_uso_user_applic,
 ruo_def.id_uso_ruolo_user_default,
 apl.id_applic, apl.nm_applic, ruo.id_ruolo, ruo.nm_ruolo,
 aut.ti_dich_autor,
 serv.id_servizio_web, serv.nm_servizio_web, serv.ds_servizio_web
from USR_USER usr
join USR_USO_USER_APPLIC uso_user_apl
 on (uso_user_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_user_apl.id_applic)
join USR_USO_RUOLO_USER_DEFAULT ruo_def
 on (ruo_def.id_uso_user_applic = uso_user_apl.id_uso_user_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = ruo_def.id_ruolo)
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo
 and uso_ruo.id_applic = uso_user_apl.id_applic)
join PRF_AUTOR aut
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
 and aut.ti_dich_autor = 'SERVIZIO_WEB')
join APL_SERVIZIO_WEB serv
 on (serv.id_servizio_web = aut.id_servizio_web);

-- changeset root:1753259446745-300
COMMENT ON COLUMN USR_V_AUTOR_DEFAULT.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-301
COMMENT ON COLUMN USR_V_AUTOR_DEFAULT.ID_APPLIC IS 'PK.2';

-- changeset root:1753259446745-302
COMMENT ON COLUMN USR_V_AUTOR_DEFAULT.ID_RUOLO IS 'PK.3';

-- changeset root:1753259446745-303
COMMENT ON COLUMN USR_V_AUTOR_DEFAULT.TI_DICH_AUTOR IS 'PK.4';

-- changeset root:1753259446745-304
COMMENT ON COLUMN USR_V_AUTOR_DEFAULT.ID_AUTOR IS 'PK.5';

-- changeset root:1753259446745-305
CREATE OR REPLACE FORCE VIEW "USR_V_TREE_ORGANIZ_IAM" ("ID_APPLIC", "NM_APPLIC", "ID_ORGANIZ_IAM", "ID_ORGANIZ_APPLIC", "ID_TIPO_ORGANIZ", "NM_ORGANIZ", "DS_ORGANIZ", "ID_ORGANIZ_IAM_PADRE", "DL_COMPOSITO_ORGANIZ", "DL_PATH_ID_ORGANIZ_IAM", "NM_TIPO_ORGANIZ", "FL_LAST_LIVELLO") AS select 
 org.id_applic,
 apl.nm_applic,
 org.id_organiz_iam,
 org.id_organiz_applic,
 org.id_tipo_organiz,
 org.nm_organiz,
 org.ds_organiz,
 org.id_organiz_iam_padre,
 ltrim(sys_connect_by_path (nm_organiz, ' / '), ' / ') || ' (' || substr(org.ds_organiz,1, 50) || ')',
 sys_connect_by_path (id_organiz_iam, '/') || '/',
 ti_org.nm_tipo_organiz,
 ti_org.fl_last_livello
from USR_ORGANIZ_IAM org
join APL_APPLIC apl
 on (apl.id_applic = org.id_applic)
join APL_TIPO_ORGANIZ ti_org
 on (ti_org.id_tipo_organiz = org.id_tipo_organiz)

start with org.id_organiz_iam_padre is null
connect by prior org.id_organiz_iam = org.id_organiz_iam_padre;

-- changeset root:1753259446745-306
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_APPLIC" ("ID_USER_IAM", "NM_USERID", "ID_APPLIC", "NM_APPLIC") AS select
 usr.id_user_iam,
 usr.nm_userid,
 apl.id_applic,
 apl.nm_applic
from USR_USER usr
join USR_USO_USER_APPLIC uso_usr
	on (uso_usr.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
	on (apl.id_applic = uso_usr.id_applic);

-- changeset root:1753259446745-307
COMMENT ON COLUMN USR_V_ABIL_APPLIC.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-308
COMMENT ON COLUMN USR_V_ABIL_APPLIC.ID_APPLIC IS 'PK.2';

-- changeset root:1753259446745-309
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_AMB_SACER_XENTE" ("ID_USER_IAM", "NM_APPLIC", "ID_ORGANIZ_APPLIC", "NM_ORGANIZ", "DS_ORGANIZ") AS select
 usr.id_user_iam,
 apl.nm_applic,
 org.id_organiz_applic,
 org.nm_organiz,
 org.ds_organiz
 
from USR_USER usr

join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_apl.id_applic) 
join USR_DICH_ABIL_ORGANIZ abil_org
 on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
 and abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG')

join USR_ORGANIZ_IAM org
 on (org.id_applic = apl.id_applic
 and org.nm_organiz like '%')
join APL_TIPO_ORGANIZ tipo_org
 on (tipo_org.id_tipo_organiz = org.id_tipo_organiz
 and tipo_org.nm_tipo_organiz = 'AMBIENTE')

UNION

select
 usr.id_user_iam,
 apl.nm_applic,
 org.id_organiz_applic,
 org.nm_organiz,
 org.ds_organiz
 
from USR_USER usr

join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_apl.id_applic) 
join USR_DICH_ABIL_ORGANIZ abil_org
 on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
 and abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG_CHILD')

join USR_ORGANIZ_IAM org
 on (org.id_organiz_iam = abil_org.id_organiz_iam)
join APL_TIPO_ORGANIZ tipo_org
 on (tipo_org.id_tipo_organiz = org.id_tipo_organiz
 and tipo_org.nm_tipo_organiz = 'AMBIENTE');

-- changeset root:1753259446745-310
COMMENT ON COLUMN USR_V_ABIL_AMB_SACER_XENTE.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-311
COMMENT ON COLUMN USR_V_ABIL_AMB_SACER_XENTE.ID_ORGANIZ_APPLIC IS 'PK.2';

-- changeset root:1753259446745-312
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ENTE_SACER_XSTRUT" ("ID_USER_IAM", "NM_APPLIC", "ID_ORGANIZ_APPLIC", "NM_ORGANIZ", "DS_ORGANIZ", "ID_ORGANIZ_APPLIC_PADRE") AS select
 usr.id_user_iam,
 apl.nm_applic,
 org.id_organiz_applic,
 org.nm_organiz,
 org.ds_organiz,
 org_padre.id_organiz_applic
 
from USR_USER usr

join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_apl.id_applic) 
join USR_DICH_ABIL_ORGANIZ abil_org
 on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
 and abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG')

join USR_ORGANIZ_IAM org
 on (org.id_applic = apl.id_applic
 and org.nm_organiz like '%')
join APL_TIPO_ORGANIZ tipo_org
 on (tipo_org.id_tipo_organiz = org.id_tipo_organiz
 and tipo_org.nm_tipo_organiz = 'ENTE')

join USR_ORGANIZ_IAM org_padre
 on (org_padre.id_organiz_iam = org.id_organiz_iam_padre)
 
 
UNION

select
 usr.id_user_iam,
 apl.nm_applic,
 org.id_organiz_applic,
 org.nm_organiz,
 org.ds_organiz,
 org_amb.id_organiz_applic
 
from USR_USER usr

join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_apl.id_applic) 
join USR_DICH_ABIL_ORGANIZ abil_org
 on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
 and abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG_CHILD')

join USR_ORGANIZ_IAM org_amb
 on (org_amb.id_organiz_iam = abil_org.id_organiz_iam)
join APL_TIPO_ORGANIZ tipo_org
 on (tipo_org.id_tipo_organiz = org_amb.id_tipo_organiz
 and tipo_org.nm_tipo_organiz = 'AMBIENTE')
 
join USR_ORGANIZ_IAM org
 on (org.id_organiz_iam_padre = org_amb.id_organiz_iam)
join APL_TIPO_ORGANIZ tipo_org
 on (tipo_org.id_tipo_organiz = org.id_tipo_organiz
 and tipo_org.nm_tipo_organiz = 'ENTE')
 
UNION

select
 usr.id_user_iam,
 apl.nm_applic,
 org.id_organiz_applic,
 org.nm_organiz,
 org.ds_organiz,
 org_padre.id_organiz_applic
 
from USR_USER usr

join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_apl.id_applic) 
join USR_DICH_ABIL_ORGANIZ abil_org
 on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
 and abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG_CHILD')

join USR_ORGANIZ_IAM org
 on (org.id_organiz_iam = abil_org.id_organiz_iam)
join APL_TIPO_ORGANIZ tipo_org
 on (tipo_org.id_tipo_organiz = org.id_tipo_organiz
 and tipo_org.nm_tipo_organiz = 'ENTE')

join USR_ORGANIZ_IAM org_padre
 on (org_padre.id_organiz_iam = org.id_organiz_iam_padre);

-- changeset root:1753259446745-313
COMMENT ON COLUMN USR_V_ABIL_ENTE_SACER_XSTRUT.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-314
COMMENT ON COLUMN USR_V_ABIL_ENTE_SACER_XSTRUT.ID_ORGANIZ_APPLIC IS 'PK.2';

-- changeset root:1753259446745-315
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_AMB_SACER_XSTRUT" ("ID_USER_IAM", "NM_APPLIC", "ID_ORGANIZ_APPLIC", "NM_ORGANIZ", "DS_ORGANIZ") AS select
 usr.id_user_iam,
 apl.nm_applic,
 org.id_organiz_applic,
 org.nm_organiz,
 org.ds_organiz
 
from USR_USER usr

join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_apl.id_applic) 
join USR_DICH_ABIL_ORGANIZ abil_org
 on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
 and abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG')

join USR_ORGANIZ_IAM org
 on (org.id_applic = apl.id_applic
 and org.nm_organiz like '%')
join APL_TIPO_ORGANIZ tipo_org
 on (tipo_org.id_tipo_organiz = org.id_tipo_organiz
 and tipo_org.nm_tipo_organiz = 'AMBIENTE')

UNION

select
 usr.id_user_iam,
 apl.nm_applic,
 org.id_organiz_applic,
 org.nm_organiz,
 org.ds_organiz
 
from USR_USER usr

join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_apl.id_applic) 
join USR_DICH_ABIL_ORGANIZ abil_org
 on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
 and abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG_CHILD')

join USR_ORGANIZ_IAM org
 on (org.id_organiz_iam = abil_org.id_organiz_iam)
join APL_TIPO_ORGANIZ tipo_org
 on (tipo_org.id_tipo_organiz = org.id_tipo_organiz
 and tipo_org.nm_tipo_organiz = 'AMBIENTE')

UNION

select
 usr.id_user_iam,
 apl.nm_applic,
 org.id_organiz_applic,
 org.nm_organiz,
 org.ds_organiz
 
from USR_USER usr

join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_apl.id_applic) 
join USR_DICH_ABIL_ORGANIZ abil_org
 on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
 and abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG_CHILD')

join USR_ORGANIZ_IAM org_ente
 on (org_ente.id_organiz_iam = abil_org.id_organiz_iam)
join APL_TIPO_ORGANIZ tipo_org
 on (tipo_org.id_tipo_organiz = org_ente.id_tipo_organiz
 and tipo_org.nm_tipo_organiz = 'ENTE')

join USR_ORGANIZ_IAM org
 on (org.id_organiz_iam = org_ente.id_organiz_iam_padre)
join APL_TIPO_ORGANIZ tipo_org
 on (tipo_org.id_tipo_organiz = org.id_tipo_organiz
 and tipo_org.nm_tipo_organiz = 'AMBIENTE');

-- changeset root:1753259446745-316
COMMENT ON COLUMN USR_V_ABIL_AMB_SACER_XSTRUT.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-317
COMMENT ON COLUMN USR_V_ABIL_AMB_SACER_XSTRUT.ID_ORGANIZ_APPLIC IS 'PK.2';

-- changeset root:1753259446745-318
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ORGANIZ" ("ID_USER_IAM", "NM_USERID", "FL_ATTIVO", "ID_USO_USER_APPLIC", "ID_APPLIC", "NM_APPLIC", "ID_DICH_ABIL_ORGANIZ", "ID_ORGANIZ_IAM", "ID_ORGANIZ_APPLIC", "ID_TIPO_ORGANIZ", "NM_TIPO_ORGANIZ", "NM_ORGANIZ", "DS_ORGANIZ", "ID_ORGANIZ_IAM_PADRE", "DL_COMPOSITO_ORGANIZ", "DL_PATH_ID_ORGANIZ_IAM") AS select
 usr.id_user_iam,
 usr.nm_userid,
 usr.fl_attivo,
 uso_apl.id_uso_user_applic,
 uso_apl.id_applic,
 apl.nm_applic,
 abil_org.id_dich_abil_organiz,
 org.id_organiz_iam,
 org.id_organiz_applic,
 org.id_tipo_organiz,
 org.nm_tipo_organiz,
 org.nm_organiz,
 org.ds_organiz,
 org.id_organiz_iam_padre,
 org.dl_composito_organiz,
 org.dl_path_id_organiz_iam

from USR_USER usr

join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_apl.id_applic) 
join USR_ABIL_ORGANIZ abil_org
 on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic)
 
join USR_V_TREE_ORGANIZ_IAM org
 on (org.id_organiz_iam = abil_org.id_organiz_iam);

-- changeset root:1753259446745-319
COMMENT ON COLUMN USR_V_ABIL_ORGANIZ.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-320
COMMENT ON COLUMN USR_V_ABIL_ORGANIZ.ID_ORGANIZ_IAM IS 'PK.2';

-- changeset root:1753259446745-321
CREATE OR REPLACE FORCE VIEW "LOG_V_LOG_AGENTE" ("ID_AGENTE", "NM_AGENTE", "TIPO_AGENTE_PREMIS", "TIPO_ORIGINE_AGENTE", "ID_USER_COMP_SW", "NM_COGNOME_USER_APPLIC", "NM_NOME_USER_COMP_SW") AS select
 age.id_agente, age.nm_agente, age.tipo_agente_premis, age.tipo_origine_agente,
 usr.id_user_iam, usr.nm_cognome_user, usr.nm_nome_user
from LOG_AGENTE age
join USR_USER usr
 on (usr.id_agente = age.id_agente)
where age.tipo_origine_agente = 'UTENTE'
 
UNION

select
age.id_agente, age.nm_agente, age.tipo_agente_premis, age.tipo_origine_agente,
comp_sw.id_comp_sw, apl.nm_applic, comp_sw.nm_comp_sw
from LOG_AGENTE age
join APL_COMP_SW comp_sw
 on (comp_sw.id_agente = age.id_agente)
join APL_APPLIC apl
 on (apl.id_applic = comp_sw.id_applic)
where age.tipo_origine_agente = 'COMPONENTE_SW';

-- changeset root:1753259446745-322
COMMENT ON COLUMN LOG_V_LOG_AGENTE.ID_AGENTE IS 'PK.1';

-- changeset root:1753259446745-323
CREATE OR REPLACE FORCE VIEW "APL_V_LOG_TI_EVN_CON_ORIGINE" ("ID_APPLIC", "NM_APPLIC", "ID_PAGINA_COMP_SW", "NM_PAGINA_COMP_SW", "ID_AZIONE_PAGINA_COMP_SW", "NM_AZIONE_PAGINA_COMP_SW", "ID_TIPO_EVENTO", "NM_TIPO_EVENTO", "TIPO_ORIGINE_EVENTO", "TIPO_CLASSE_EVENTO", "TIPO_CLASSE_PREMIS_EVENTO") AS select
 apl.id_applic, apl.nm_applic,
 pag.id_pagina_web, pag.nm_pagina_web,
 azio.id_azione_pagina, azio.nm_azione_pagina, 
 ti_evn.id_tipo_evento, ti_evn.nm_tipo_evento, ti_evn.tipo_origine_evento, ti_evn.tipo_classe_evento, ti_evn.tipo_classe_premis_evento

from APL_APPLIC apl
left join APL_PAGINA_WEB pag
 on (pag.id_applic = apl.id_applic)
left join APL_AZIONE_PAGINA azio
 on (azio.id_pagina_web = pag.id_pagina_web)
join APL_TIPO_EVENTO ti_evn
 on (ti_evn.id_tipo_evento = azio.id_tipo_evento
 and ti_evn.tipo_origine_evento in ('AZIONE_PAGINA', 'ENTRAMBI'))
 
UNION

select
 apl.id_applic, apl.nm_applic,
 comp_sw.id_comp_sw, comp_sw.nm_comp_sw,
 azio.id_azione_comp_sw, azio.nm_azione_comp_sw, 
 ti_evn.id_tipo_evento, ti_evn.nm_tipo_evento, ti_evn.tipo_origine_evento, ti_evn.tipo_classe_evento, ti_evn.tipo_classe_premis_evento

from APL_APPLIC apl
join APL_COMP_SW comp_sw
 on (comp_sw.id_applic = apl.id_applic)
join APL_AZIONE_COMP_SW azio
 on (azio.id_comp_sw = comp_sw.id_comp_sw)
join APL_TIPO_EVENTO ti_evn
 on (ti_evn.id_tipo_evento = azio.id_tipo_evento
 and ti_evn.tipo_origine_evento in ('AZIONE_COMP_SW', 'ENTRAMBI'));

-- changeset root:1753259446745-324
COMMENT ON COLUMN APL_V_LOG_TI_EVN_CON_ORIGINE.ID_APPLIC IS 'PK.1';

-- changeset root:1753259446745-325
COMMENT ON COLUMN APL_V_LOG_TI_EVN_CON_ORIGINE.ID_PAGINA_COMP_SW IS 'PK.2';

-- changeset root:1753259446745-326
COMMENT ON COLUMN APL_V_LOG_TI_EVN_CON_ORIGINE.ID_AZIONE_PAGINA_COMP_SW IS 'PK.3';

-- changeset root:1753259446745-327
COMMENT ON COLUMN APL_V_LOG_TI_EVN_CON_ORIGINE.ID_TIPO_EVENTO IS 'PK.1';

-- changeset root:1753259446745-328
CREATE OR REPLACE FORCE VIEW "APL_V_LOG_TI_EVN" ("ID_APPLIC", "NM_APPLIC", "ID_TIPO_EVENTO", "NM_TIPO_EVENTO", "TIPO_ORIGINE_EVENTO", "TIPO_CLASSE_EVENTO", "TIPO_CLASSE_PREMIS_EVENTO") AS select 
 apl.id_applic, apl.nm_applic,
 ti_evn.id_tipo_evento, ti_evn.nm_tipo_evento, ti_evn.tipo_origine_evento, ti_evn.tipo_classe_evento, ti_evn.tipo_classe_premis_evento

from APL_APPLIC apl
join APL_TIPO_EVENTO ti_evn
 on (ti_evn.id_applic = apl.id_applic);

-- changeset root:1753259446745-329
COMMENT ON COLUMN APL_V_LOG_TI_EVN.ID_TIPO_EVENTO IS 'PK.1';

-- changeset root:1753259446745-330
CREATE OR REPLACE FORCE VIEW "APL_V_LOG_TI_OGG" ("ID_APPLIC", "NM_APPLIC", "ID_TIPO_OGGETTO", "NM_TIPO_OGGETTO", "ID_TIPO_OGGETTO_PADRE") AS select
 apl.id_applic, apl.nm_applic,
 ti_ogg.id_tipo_oggetto, ti_ogg.nm_tipo_oggetto, ti_ogg.id_tipo_oggetto_padre
from APL_APPLIC apl
join APL_TIPO_OGGETTO ti_ogg
 on (ti_ogg.id_applic = apl.id_applic);

-- changeset root:1753259446745-331
COMMENT ON COLUMN APL_V_LOG_TI_OGG.ID_TIPO_OGGETTO IS 'PK.1';

-- changeset root:1753259446745-332
CREATE OR REPLACE FORCE VIEW "APL_V_LOG_TRIG_TI_EVN_OGG" ("ID_TIPO_EVENTO_OGGETTO", "ID_TIPO_EVENTO", "ID_TIPO_OGGETTO", "ID_TIPO_EVENTO_OGGETTO_TRIG", "ID_TIPO_EVENTO_TRIG", "NM_TIPO_EVENTO_TRIG", "TIPO_CLASSE_EVENTO_TRIG", "ID_TIPO_OGGETTO_TRIG", "NM_TIPO_OGGETTO_TRIG", "ID_QUERY_TIPO_OGGETTO_TRIG", "NM_QUERY_TIPO_OGGETTO_TRIG", "BL_QUERY_TIPO_OGGETTO_TRIG", "ID_QUERY_TIPO_OGGETTO_SEL", "NM_QUERY_TIPO_OGGETTO_SEL", "BL_QUERY_TIPO_OGGETTO_SEL", "NM_APPLIC_TRIG") AS select
 ti_evn_ogg.id_tipo_evento_oggetto, ti_evn_ogg.id_tipo_evento, ti_evn_ogg.id_tipo_oggetto,
 trig.id_tipo_evento_oggetto_trig,
 ti_evn_trig.id_tipo_evento id_tipo_evento_trig, ti_evn_trig.nm_tipo_evento nm_tipo_evento_trig, ti_evn_trig.tipo_classe_evento tipo_classe_evento_trig,
 
 ti_ogg_trig.id_tipo_oggetto id_tipo_oggetto_trig, ti_ogg_trig.nm_tipo_oggetto nm_tipo_oggetto_trig,
 qry_trig.id_query_tipo_oggetto id_query_tipo_oggetto_trig, qry_trig.nm_query_tipo_oggetto nm_query_tipo_oggetto_trig, qry_trig.bl_query_tipo_oggetto bl_query_tipo_oggetto_trig,
 qry_sel.id_query_tipo_oggetto id_query_tipo_oggetto_sel, qry_sel.nm_query_tipo_oggetto nm_query_tipo_oggetto_sel, qry_sel.bl_query_tipo_oggetto bl_query_tipo_oggetto_sel,
 
 apl_trig.nm_applic nm_applic_trig

from APL_TIPO_EVENTO_OGGETTO ti_evn_ogg
join APL_TIPO_EVENTO_OGGETTO_TRIG trig
 on (trig.id_tipo_evento_oggetto = ti_evn_ogg.id_tipo_evento_oggetto)
join APL_TIPO_EVENTO ti_evn_trig
 on (ti_evn_trig.id_tipo_evento = trig.id_tipo_evento_trig)
join APL_TIPO_OGGETTO ti_ogg_trig
 on (ti_ogg_trig.id_tipo_oggetto = trig.id_tipo_oggetto_trig)
left join APL_QUERY_TIPO_OGGETTO qry_trig
 on (qry_trig.id_query_tipo_oggetto = trig.id_query_tipo_oggetto_trig)
join APL_QUERY_TIPO_OGGETTO qry_sel
 on (qry_sel.id_query_tipo_oggetto = trig.id_query_tipo_oggetto_sel)

join APL_APPLIC apl_trig
 on (apl_trig.id_applic = ti_evn_trig.id_applic);

-- changeset root:1753259446745-333
COMMENT ON COLUMN APL_V_LOG_TRIG_TI_EVN_OGG.ID_TIPO_EVENTO_OGGETTO_TRIG IS 'PK.1';

-- changeset root:1753259446745-334
CREATE OR REPLACE FORCE VIEW "APL_V_LOG_INIT" ("ID_QUERY_TIPO_OGGETTO", "NM_QUERY_TIPO_OGGETTO", "BL_QUERY_TIPO_OGGETTO", "ID_TIPO_OGGETTO", "NM_TIPO_OGGETTO", "ID_TIPO_EVENTO", "NM_TIPO_EVENTO", "ID_AZIONE_COMP_SW", "NM_AZIONE_COMP_SW", "ID_COMP_SW", "NM_COMP_SW", "ID_AGENTE", "NM_AGENTE", "ID_APPLIC", "NM_APPLIC") AS SELECT  	ID_QUERY_TIPO_OGGETTO, 
			NM_QUERY_TIPO_OGGETTO, BL_QUERY_TIPO_OGGETTO,
			ID_TIPO_OGGETTO, NM_TIPO_OGGETTO,
			ID_TIPO_EVENTO, NM_TIPO_EVENTO,
			ID_AZIONE_COMP_SW, NM_AZIONE_COMP_SW,
			ID_COMP_SW, NM_COMP_SW,
			ID_AGENTE, NM_AGENTE,
			ID_APPLIC, NM_APPLIC
FROM    SACER_IAM.APL_TIPO_OGGETTO ogg
JOIN    SACER_IAM.APL_TIPO_EVENTO_OGGETTO eOgg USING (id_tipo_oggetto)
JOIN    SACER_IAM.APL_TIPO_EVENTO ev USING (id_tipo_evento)
JOIN    SACER_IAM.APL_AZIONE_COMP_SW  azSw USING (id_tipo_evento)
JOIN    SACER_IAM.APL_COMP_SW compSw USING (id_comp_sw)
JOIN    SACER_IAM.APL_QUERY_TIPO_OGGETTO qu USING (id_tipo_oggetto)
JOIN    LOG_AGENTE ag USING (id_agente)
JOIN    SACER_IAM.APL_APPLIC app USING (id_applic)

WHERE   qu.TIPO_USO_QUERY = 'INIZIALIZZAZIONE'
AND     compSw.NM_COMP_SW like 'INIZIALIZZAZIONE_LOG_%';

-- changeset root:1753259446745-335
CREATE OR REPLACE FORCE VIEW "APL_V_TREE_TIPO_OGG" ("ID_APPLIC", "NM_APPLIC", "ID_TIPO_OGGETTO", "NM_TIPO_OGGETTO", "ID_TIPO_OGGETTO_PADRE", "DL_COMPOSITO_TIPO_OGGETTO", "DL_PATH_ID_TIPO_OGGETTO") AS select 
 ti_ogg.id_applic,
 apl.nm_applic,
 ti_ogg.id_tipo_oggetto,
 ti_ogg.nm_tipo_oggetto,
 ti_ogg.id_tipo_oggetto_padre,
 ltrim(sys_connect_by_path (nm_tipo_oggetto, ' / '), ' / '),
 sys_connect_by_path (id_tipo_oggetto, '/') || '/'
 
from APL_TIPO_OGGETTO ti_ogg
join APL_APPLIC apl
 on (apl.id_applic = ti_ogg.id_applic)

start with ti_ogg.id_tipo_oggetto_padre is null
connect by prior ti_ogg.id_tipo_oggetto = ti_ogg.id_tipo_oggetto_padre;

-- changeset root:1753259446745-336
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ORGANIZ_TO_ADD" ("ID_USER_IAM", "FL_ATTIVO", "ID_USO_USER_APPLIC", "ID_APPLIC", "NM_APPLIC", "ID_DICH_ABIL_ORGANIZ", "ID_ORGANIZ_IAM", "ID_APPART_COLLEG_ENTI", "ID_SUPT_EST_ENTE_CONVENZ", "ID_VIGIL_ENTE_PRODUT", "DS_CAUSALE_ABIL") AS select
 id_user_iam,
 fl_attivo,
 id_uso_user_applic,
 id_applic,
 nm_applic,

 id_dich_abil_organiz,
 id_organiz_iam,
 id_appart_colleg_enti,
 id_supt_est_ente_convenz,
 id_vigil_ente_produt,
 ds_causale_dich
from	(
		select
		 usr.id_user_iam,
		 usr.fl_attivo,
		 uso_apl.id_uso_user_applic,
		 uso_apl.id_applic,
		 apl.nm_applic,
		 
		 abil_org.id_dich_abil_organiz,
		 org.id_organiz_iam,
		 abil_org.id_appart_colleg_enti,
		 abil_org.id_supt_est_ente_convenz,
		 abil_org.id_vigil_ente_produt,
		 ds_causale_dich

		from USR_USER usr

		join USR_USO_USER_APPLIC uso_apl
		 on (uso_apl.id_user_iam = usr.id_user_iam)
		join APL_APPLIC apl
		 on (apl.id_applic = uso_apl.id_applic) 

		join USR_DICH_ABIL_ORGANIZ abil_org
		 on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
		 and abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG')
		 
		join USR_V_TREE_ORGANIZ_IAM org
		 on (org.id_applic = apl.id_applic
		 and org.dl_path_id_organiz_iam like '%'
		 and org.fl_last_livello = '1')
		 
		UNION

		select
		 usr.id_user_iam,
		 usr.fl_attivo,
		 uso_apl.id_uso_user_applic,
		 uso_apl.id_applic,
		 apl.nm_applic,
		 
		 abil_org.id_dich_abil_organiz,
		 org.id_organiz_iam,
		 abil_org.id_appart_colleg_enti,
		 abil_org.id_supt_est_ente_convenz,
		 abil_org.id_vigil_ente_produt,
		 ds_causale_dich

		from USR_USER usr

		join USR_USO_USER_APPLIC uso_apl
		 on (uso_apl.id_user_iam = usr.id_user_iam)
		join APL_APPLIC apl
		 on (apl.id_applic = uso_apl.id_applic) 

		join USR_DICH_ABIL_ORGANIZ abil_org
		 on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
		 and abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG_CHILD')
		 
		join USR_V_TREE_ORGANIZ_IAM org
		 on (org.id_applic = apl.id_applic
		 and org.dl_path_id_organiz_iam like '%/' || abil_org.id_organiz_iam || '/%'
		 and org.fl_last_livello = '1')

		UNION

		select
		 usr.id_user_iam,
		 usr.fl_attivo,
		 uso_apl.id_uso_user_applic,
		 uso_apl.id_applic,
		 apl.nm_applic,

		 abil_org.id_dich_abil_organiz,
		 org.id_organiz_iam,
		 abil_org.id_appart_colleg_enti,
		 abil_org.id_supt_est_ente_convenz,
		 abil_org.id_vigil_ente_produt,
		 ds_causale_dich

		from USR_USER usr

		join USR_USO_USER_APPLIC uso_apl
		 on (uso_apl.id_user_iam = usr.id_user_iam)
		join APL_APPLIC apl
		 on (apl.id_applic = uso_apl.id_applic) 
		join USR_DICH_ABIL_ORGANIZ abil_org
		 on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
		 and abil_org.ti_scopo_dich_abil_organiz = 'UNA_ORG')
		 
		join USR_V_TREE_ORGANIZ_IAM org
		 on (org.id_organiz_iam = abil_org.id_organiz_iam)
		) tmp
where not exists (select *
				  from USR_ABIL_ORGANIZ abil
				  where abil.id_uso_user_applic = tmp.id_uso_user_applic
				  and abil.id_organiz_iam = tmp.id_organiz_iam
				  );

-- changeset root:1753259446745-337
COMMENT ON COLUMN USR_V_ABIL_ORGANIZ_TO_ADD.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-338
COMMENT ON COLUMN USR_V_ABIL_ORGANIZ_TO_ADD.ID_ORGANIZ_IAM IS 'PK.2';

-- changeset root:1753259446745-339
CREATE OR REPLACE FORCE VIEW "PRF_V_LIS_USER_DA_REPLIC" ("ID_RUOLO", "NM_RUOLO", "ID_APPLIC", "NM_APPLIC", "ID_USER_IAM", "NM_USERID") AS select
ruo.id_ruolo,
ruo.nm_ruolo,
apl.id_applic,
apl.nm_applic,
usr.id_user_iam,
usr.nm_userid

from PRF_RUOLO ruo 
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic
 and apl.ds_url_replica_user is not null)

join USR_USO_RUOLO_USER_DEFAULT uso_ruo_def
 on (uso_ruo_def.id_ruolo = ruo.id_ruolo)
join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_uso_user_applic = uso_ruo_def.id_uso_user_applic
 and uso_apl.id_applic = apl.id_applic)
join USR_USER usr
 on (usr.id_user_iam = uso_apl.id_user_iam)
 
where 
(exists (select *
			from PRF_ALLINEA_RUOLO allinea_ruo
			where allinea_ruo.id_ruolo = ruo.id_ruolo
			and allinea_ruo.nm_applic = apl.nm_applic
			and allinea_ruo.ti_dich_autor = 'SERVIZIO_WEB'
			and allinea_ruo.ti_scopo_dich_autor = 'ALL_ABILITAZIONI'
			and not exists (select *
							from PRF_DICH_AUTOR dich
							where dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
							and dich.ti_dich_autor = allinea_ruo.ti_dich_autor
							and dich.ti_scopo_dich_autor = allinea_ruo.ti_scopo_dich_autor
							)
			)
or exists (select *
			from PRF_ALLINEA_RUOLO allinea_ruo
			where allinea_ruo.id_ruolo = ruo.id_ruolo
			and allinea_ruo.nm_applic = apl.nm_applic
			and allinea_ruo.ti_dich_autor = 'SERVIZIO_WEB'
			and allinea_ruo.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
			and not exists (select *
							from PRF_DICH_AUTOR dich
							join APL_SERVIZIO_WEB serv
							 on (serv.id_servizio_web = dich.id_servizio_web)
							where dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
							and dich.ti_dich_autor = allinea_ruo.ti_dich_autor
							and dich.ti_scopo_dich_autor = allinea_ruo.ti_scopo_dich_autor

							and serv.nm_servizio_web = allinea_ruo.nm_servizio_web
							)
			)
or exists (select *
			from PRF_DICH_AUTOR dich
			where dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
			and dich.ti_dich_autor = 'SERVIZIO_WEB'
			and dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI'
			and not exists (select *
							from PRF_ALLINEA_RUOLO allinea_ruo
							where allinea_ruo.id_ruolo = ruo.id_ruolo
							and allinea_ruo.nm_applic = apl.nm_applic
							and allinea_ruo.ti_dich_autor = dich.ti_dich_autor
							and allinea_ruo.ti_scopo_dich_autor = dich.ti_scopo_dich_autor
							)
			)
or exists (select *
			from PRF_DICH_AUTOR dich
			join APL_SERVIZIO_WEB serv
			 on (serv.id_servizio_web = dich.id_servizio_web)
			where dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
			and dich.ti_dich_autor = 'SERVIZIO_WEB'
			and dich.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
			and not exists (select *
							from PRF_ALLINEA_RUOLO allinea_ruo
							
							where allinea_ruo.id_ruolo = ruo.id_ruolo
							and allinea_ruo.nm_applic = apl.nm_applic
							and allinea_ruo.ti_dich_autor = dich.ti_dich_autor
							and allinea_ruo.ti_scopo_dich_autor = dich.ti_scopo_dich_autor
							
							and allinea_ruo.nm_servizio_web = serv.nm_servizio_web
							)
			)
)			
			
and apl.nm_applic in (select distinct nm_applic
						from PRF_ALLINEA_RUOLO allinea_ruo
						where allinea_ruo.id_ruolo = ruo.id_ruolo
						);

-- changeset root:1753259446745-340
COMMENT ON COLUMN PRF_V_LIS_USER_DA_REPLIC.ID_APPLIC IS 'PK.2';

-- changeset root:1753259446745-341
COMMENT ON COLUMN PRF_V_LIS_USER_DA_REPLIC.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-342
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_USER_REPLIC" ("ID_LOG_USER_DA_REPLIC", "ID_APPLIC", "NM_APPLIC", "ID_USER_IAM", "NM_USERID", "TI_OPER_REPLIC", "TI_STATO_REPLIC", "DT_LOG_USER_DA_REPLIC", "CD_ERR", "DS_MSG_ERR", "DT_ERR", "DT_CHIUSURA_REPLICA") AS select 
 replic.id_log_user_da_replic,
 replic.id_applic,
 apl.nm_applic,
 replic.id_user_iam,
 replic.nm_userid,
 replic.ti_oper_replic,
 replic.ti_stato_replic,
 replic.dt_log_user_da_replic,
 replic.cd_err,
 replic.ds_msg_err,
 replic.dt_err,
 replic.dt_chiusura_replica
  
from LOG_USER_DA_REPLIC replic
join APL_APPLIC apl
 on (apl.id_applic = replic.id_applic);

-- changeset root:1753259446745-343
COMMENT ON COLUMN USR_V_LIS_USER_REPLIC.ID_LOG_USER_DA_REPLIC IS 'PK.1 relativa a tabella LOG_USER_DA_REPLIC';

-- changeset root:1753259446745-344
CREATE OR REPLACE FORCE VIEW "ORG_V_ENTE_CONV_BY_DELABILORG" ("ID_DICH_ABIL_ORGANIZ", "ID_ENTE_CONVENZ") AS select distinct
dich_org.id_dich_abil_organiz, org_ente.id_ente_convenz

from  USR_DICH_ABIL_ORGANIZ dich_org
join APL_APPLIC apl
 on (apl.nm_applic = 'SACER')
join APL_TIPO_ORGANIZ tipo_organiz
 on (tipo_organiz.id_applic = apl.id_applic
 and tipo_organiz.nm_tipo_organiz = 'STRUTTURA')
join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_uso_user_applic  = dich_org.id_uso_user_applic)
join USR_USER usr
 on (usr.id_user_iam = uso_apl.id_user_iam
 and usr.id_sistema_versante is not null)
 
join USR_ORGANIZ_IAM organiz
 on (organiz.id_applic = apl.id_applic
 and organiz.id_tipo_organiz = tipo_organiz.id_tipo_organiz)

join ORG_ENTE_CONVENZ_ORG org_ente
 on (org_ente.id_organiz_iam = organiz.id_organiz_iam)

where dich_org.ti_scopo_dich_abil_organiz = 'ALL_ORG'

UNION

select distinct
dich_org.id_dich_abil_organiz, org_ente.id_ente_convenz

from  USR_DICH_ABIL_ORGANIZ dich_org
join APL_APPLIC apl
 on (apl.nm_applic = 'SACER')
join APL_TIPO_ORGANIZ tipo_organiz
 on (tipo_organiz.id_applic = apl.id_applic
 and tipo_organiz.nm_tipo_organiz = 'STRUTTURA')
join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_uso_user_applic  = dich_org.id_uso_user_applic)
join USR_USER usr
 on (usr.id_user_iam = uso_apl.id_user_iam
 and usr.id_sistema_versante is not null)

join USR_V_TREE_ORGANIZ_IAM organiz
 on (organiz.id_applic = apl.id_applic
 and organiz.id_tipo_organiz = tipo_organiz.id_tipo_organiz
 and organiz.dl_path_id_organiz_iam like '%/' || dich_org.id_organiz_iam || '/%'
 and organiz.FL_LAST_LIVELLO = '1')

join ORG_ENTE_CONVENZ_ORG org_ente
 on (org_ente.id_organiz_iam = organiz.id_organiz_iam)

where dich_org.ti_scopo_dich_abil_organiz = 'ALL_ORG_CHILD'

UNION

select distinct
dich_org.id_dich_abil_organiz, org_ente.id_ente_convenz

from  USR_DICH_ABIL_ORGANIZ dich_org
join APL_APPLIC apl
 on (apl.nm_applic = 'SACER')
join APL_TIPO_ORGANIZ tipo_organiz
 on (tipo_organiz.id_applic = apl.id_applic
 and tipo_organiz.nm_tipo_organiz = 'STRUTTURA')
join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_uso_user_applic  = dich_org.id_uso_user_applic)
join USR_USER usr
 on (usr.id_user_iam = uso_apl.id_user_iam
 and usr.id_sistema_versante is not null)
 
join USR_ORGANIZ_IAM organiz
 on (organiz.id_applic = apl.id_applic
 and organiz.id_tipo_organiz = tipo_organiz.id_tipo_organiz
 and organiz.id_organiz_iam = dich_org.id_organiz_iam)

join ORG_ENTE_CONVENZ_ORG org_ente
 on (org_ente.id_organiz_iam = organiz.id_organiz_iam)

where dich_org.ti_scopo_dich_abil_organiz = 'UNA_ORG';

-- changeset root:1753259446745-345
COMMENT ON COLUMN ORG_V_ENTE_CONV_BY_DELABILORG.ID_DICH_ABIL_ORGANIZ IS 'PK1';

-- changeset root:1753259446745-346
COMMENT ON COLUMN ORG_V_ENTE_CONV_BY_DELABILORG.ID_ENTE_CONVENZ IS 'PK2';

-- changeset root:1753259446745-347
CREATE OR REPLACE FORCE VIEW "USR_V_ALL_AUTOR" ("ID_USER_IAM", "NM_USERID", "ID_USO_USER_APPLIC", "ID_APPLIC", "NM_APPLIC", "ID_ORGANIZ_IAM", "NM_TIPO_ORGANIZ_APPLIC", "ID_ORGANIZ_APPLIC", "NM_ORGANIZ_APPLIC", "TI_USO_RUO", "ID_USO_RUOLO", "ID_RUOLO", "NM_RUOLO", "TI_DICH_AUTOR", "ID_AUTOR", "NM_PAGINA_WEB", "NM_AUTOR", "DS_AUTOR", "FL_HELP_PRESENTE") AS select distinct
 usr.id_user_iam, usr.nm_userid,
 uso_user_apl.id_uso_user_applic,
 apl.id_applic, apl.nm_applic,
 null id_organiz_iam, null nm_tipo_organiz_applic, null id_organiz_applic, null nm_organiz_applic,

 'DEF', ruo_def.id_uso_ruolo_user_default id_uso_ruolo,
 ruo.id_ruolo, ruo.nm_ruolo,
  
 aut.ti_dich_autor, menu.id_entry_menu, null, menu.nm_entry_menu, menu.ds_entry_menu,
 case
	when exists (select *
				 from APL_HELP_ON_LINE help
				 where help.ti_help_on_line = 'HELP_RICERCA_DIPS'
				 and help.id_entry_menu = menu.id_entry_menu
				 and help.dt_ini_val <= sysdate
				 and help.dt_fine_val >= sysdate)
		then '1'
		else '0'
 end fl_help_presente
 
from USR_USER usr
join USR_USO_USER_APPLIC uso_user_apl
 on (uso_user_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_user_apl.id_applic)
 
join USR_USO_RUOLO_USER_DEFAULT ruo_def
 on (ruo_def.id_uso_user_applic = uso_user_apl.id_uso_user_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = ruo_def.id_ruolo)
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo
 and uso_ruo.id_applic = uso_user_apl.id_applic)
join PRF_AUTOR aut
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
 and aut.ti_dich_autor = 'ENTRY_MENU')
join APL_ENTRY_MENU menu
 on (menu.id_entry_menu = aut.id_entry_menu)

UNION
 
--			autorizzazioni di pagine da ruoli di default
select distinct
 usr.id_user_iam, usr.nm_userid,
 uso_user_apl.id_uso_user_applic,
 apl.id_applic, apl.nm_applic,
 null id_organiz_iam, null nm_tipo_organiz_applic, null id_organiz_applic, null nm_organiz_applic,

 'DEF', ruo_def.id_uso_ruolo_user_default id_uso_ruolo,
 ruo.id_ruolo, ruo.nm_ruolo,
  
 aut.ti_dich_autor, pag.id_pagina_web, null, pag.nm_pagina_web, pag.ds_pagina_web,
 case
	when exists (select *
				 from APL_HELP_ON_LINE help
				 where help.ti_help_on_line = 'HELP_PAGINA'
				 and help.id_pagina_web = pag.id_pagina_web
				 and help.dt_ini_val <= sysdate
				 and help.dt_fine_val >= sysdate)
		then '1'
		else '0'
 end fl_help_presente
 
from USR_USER usr
join USR_USO_USER_APPLIC uso_user_apl
 on (uso_user_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_user_apl.id_applic)
 
join USR_USO_RUOLO_USER_DEFAULT ruo_def
 on (ruo_def.id_uso_user_applic = uso_user_apl.id_uso_user_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = ruo_def.id_ruolo)
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo
 and uso_ruo.id_applic = uso_user_apl.id_applic)
join PRF_AUTOR aut
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
 and aut.ti_dich_autor = 'PAGINA')
join APL_PAGINA_WEB pag
 on (pag.id_pagina_web = aut.id_pagina_web)

UNION

--			autorizzazioni di azioni da ruoli di default
select distinct
 usr.id_user_iam, usr.nm_userid,
 uso_user_apl.id_uso_user_applic,
 apl.id_applic, apl.nm_applic,
 null id_organiz_iam, null nm_tipo_organiz_applic, null id_organiz_applic, null nm_organiz_applic,
 
 'DEF', ruo_def.id_uso_ruolo_user_default id_uso_ruolo,
 ruo.id_ruolo, ruo.nm_ruolo,
  
 aut.ti_dich_autor, azio.id_azione_pagina, pag.nm_pagina_web, azio.nm_azione_pagina, pag.ds_pagina_web || ' --> ' || azio.ds_azione_pagina,
 null fl_help_presente
 
from USR_USER usr
join USR_USO_USER_APPLIC uso_user_apl
 on (uso_user_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_user_apl.id_applic)
join USR_USO_RUOLO_USER_DEFAULT ruo_def
 on (ruo_def.id_uso_user_applic = uso_user_apl.id_uso_user_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = ruo_def.id_ruolo)
 
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo
 and uso_ruo.id_applic = uso_user_apl.id_applic)
join PRF_AUTOR aut
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
 and aut.ti_dich_autor = 'AZIONE')
join APL_AZIONE_PAGINA azio
 on (azio.id_azione_pagina = aut.id_azione_pagina)
join APL_PAGINA_WEB pag
 on (pag.id_pagina_web = azio.id_pagina_web)

UNION

--			autorizzazioni di servizi da ruoli di default
select distinct
 usr.id_user_iam, usr.nm_userid,
 uso_user_apl.id_uso_user_applic,
 apl.id_applic, apl.nm_applic,
 null id_organiz_iam, null nm_tipo_organiz_applic, null id_organiz_applic, null nm_organiz_applic,

 'DEF', ruo_def.id_uso_ruolo_user_default id_uso_ruolo,
 ruo.id_ruolo, ruo.nm_ruolo,

 aut.ti_dich_autor, serv.id_servizio_web, null, serv.nm_servizio_web, serv.ds_servizio_web,
 null fl_help_presente

from USR_USER usr
join USR_USO_USER_APPLIC uso_user_apl
 on (uso_user_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_user_apl.id_applic)

 join USR_USO_RUOLO_USER_DEFAULT ruo_def
 on (ruo_def.id_uso_user_applic = uso_user_apl.id_uso_user_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = ruo_def.id_ruolo)
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo
 and uso_ruo.id_applic = uso_user_apl.id_applic)
join PRF_AUTOR aut
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
 and aut.ti_dich_autor = 'SERVIZIO_WEB')
join APL_SERVIZIO_WEB serv
 on (serv.id_servizio_web = aut.id_servizio_web)

UNION 

--			autorizzazioni di menù da ruoli specificati per le dichiarazioni di abilitazione alle organizzazioni 
select distinct
 usr.id_user_iam, usr.nm_userid,
 uso_user_apl.id_uso_user_applic,
 apl.id_applic, apl.nm_applic,
 
-- abil_org.id_organiz_iam,  abil_org.nm_tipo_organiz nm_tipo_organiz_applic, abil_org.id_organiz_applic id_organiz_applic, abil_org.dl_composito_organiz nm_organiz_applic,
 tree_org.id_organiz_iam, tree_org.nm_tipo_organiz nm_tipo_organiz_applic, tree_org.id_organiz_applic id_organiz_applic, tree_org.dl_composito_organiz nm_organiz_applic,
 
 
 'DICH', ruo_dich.id_uso_ruolo_dich id_uso_ruolo,
 ruo.id_ruolo, ruo.nm_ruolo,
  
 aut.ti_dich_autor, menu.id_entry_menu, null, menu.nm_entry_menu, menu.ds_entry_menu,
 case
	when exists (select *
				 from APL_HELP_ON_LINE help
				 where help.ti_help_on_line = 'HELP_RICERCA_DIPS'
				 and help.id_entry_menu = menu.id_entry_menu
				 and help.dt_ini_val <= sysdate
				 and help.dt_fine_val >= sysdate)
		then '1'
		else '0'
 end fl_help_presente
 
from USR_USER usr
join USR_USO_USER_APPLIC uso_user_apl
 on (uso_user_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_user_apl.id_applic)

join USR_DICH_ABIL_ORGANIZ dich
 on (dich.id_uso_user_applic = uso_user_apl.id_uso_user_applic)
join USR_USO_RUOLO_DICH ruo_dich
 on (ruo_dich.id_dich_abil_organiz = dich.id_dich_abil_organiz)
join USR_V_TREE_ORGANIZ_IAM org_ruolo
 on (org_ruolo.id_organiz_iam = ruo_dich.id_organiz_iam_ruolo)

join USR_V_TREE_ORGANIZ_IAM tree_org
 on (tree_org.dl_path_id_organiz_iam like org_ruolo.dl_path_id_organiz_iam || '%')

join PRF_RUOLO ruo
 on (ruo.id_ruolo = ruo_dich.id_ruolo)
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo
 and uso_ruo.id_applic = uso_user_apl.id_applic)
join PRF_AUTOR aut
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
 and aut.ti_dich_autor = 'ENTRY_MENU')
join APL_ENTRY_MENU menu
 on (menu.id_entry_menu = aut.id_entry_menu)


UNION 

--			autorizzazioni di pagine da ruoli specificati per le dichiarazioni di abilitazione alle organizzazioni 
select distinct
 usr.id_user_iam, usr.nm_userid,
 uso_user_apl.id_uso_user_applic,
 apl.id_applic, apl.nm_applic,
 --abil_org.id_organiz_iam, abil_org.nm_tipo_organiz nm_tipo_organiz_applic, abil_org.id_organiz_applic id_organiz_applic, abil_org.dl_composito_organiz nm_organiz_applic,
 tree_org.id_organiz_iam, tree_org.nm_tipo_organiz nm_tipo_organiz_applic, tree_org.id_organiz_applic id_organiz_applic, tree_org.dl_composito_organiz nm_organiz_applic,

 'DICH', ruo_dich.id_uso_ruolo_dich id_uso_ruolo,
 ruo.id_ruolo, ruo.nm_ruolo,
  
 aut.ti_dich_autor, pag.id_pagina_web, null, pag.nm_pagina_web, pag.ds_pagina_web,
 case
	when exists (select *
				 from APL_HELP_ON_LINE help
				 where help.ti_help_on_line = 'HELP_PAGINA'
				 and help.id_pagina_web = pag.id_pagina_web
				 and help.dt_ini_val <= sysdate
				 and help.dt_fine_val >= sysdate)
		then '1'
		else '0'
 end fl_help_presente
  
from USR_USER usr
join USR_USO_USER_APPLIC uso_user_apl
 on (uso_user_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_user_apl.id_applic)
 
join USR_DICH_ABIL_ORGANIZ dich
 on (dich.id_uso_user_applic = uso_user_apl.id_uso_user_applic)
join USR_USO_RUOLO_DICH ruo_dich
 on (ruo_dich.id_dich_abil_organiz = dich.id_dich_abil_organiz)
join USR_V_TREE_ORGANIZ_IAM org_ruolo
 on (org_ruolo.id_organiz_iam = ruo_dich.id_organiz_iam_ruolo)

join USR_V_TREE_ORGANIZ_IAM tree_org
 on (tree_org.dl_path_id_organiz_iam like org_ruolo.dl_path_id_organiz_iam || '%')

join PRF_RUOLO ruo
 on (ruo.id_ruolo = ruo_dich.id_ruolo)
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo
 and uso_ruo.id_applic = uso_user_apl.id_applic)
join PRF_AUTOR aut
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
 and aut.ti_dich_autor = 'PAGINA')
join APL_PAGINA_WEB pag
 on (pag.id_pagina_web = aut.id_pagina_web)

UNION 

--			autorizzazioni di azioni da ruoli specificati per le dichiarazioni di abilitazione alle organizzazioni 
select distinct
 usr.id_user_iam, usr.nm_userid,
 uso_user_apl.id_uso_user_applic,
 apl.id_applic, apl.nm_applic,
 --abil_org.id_organiz_iam, abil_org.nm_tipo_organiz nm_tipo_organiz_applic, abil_org.id_organiz_applic id_organiz_applic, abil_org.dl_composito_organiz nm_organiz_applic,
 tree_org.id_organiz_iam, tree_org.nm_tipo_organiz nm_tipo_organiz_applic, tree_org.id_organiz_applic id_organiz_applic, tree_org.dl_composito_organiz nm_organiz_applic,

 'DICH', ruo_dich.id_uso_ruolo_dich id_uso_ruolo,
 ruo.id_ruolo, ruo.nm_ruolo,
  
 aut.ti_dich_autor, azio.id_azione_pagina, pag.nm_pagina_web, azio.nm_azione_pagina, pag.ds_pagina_web || ' --> ' || azio.ds_azione_pagina,
 null fl_help_presente
 
from USR_USER usr
join USR_USO_USER_APPLIC uso_user_apl
 on (uso_user_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_user_apl.id_applic)

join USR_DICH_ABIL_ORGANIZ dich
 on (dich.id_uso_user_applic = uso_user_apl.id_uso_user_applic)
join USR_USO_RUOLO_DICH ruo_dich
 on (ruo_dich.id_dich_abil_organiz = dich.id_dich_abil_organiz)
join USR_V_TREE_ORGANIZ_IAM org_ruolo
 on (org_ruolo.id_organiz_iam = ruo_dich.id_organiz_iam_ruolo)

join USR_V_TREE_ORGANIZ_IAM tree_org
 on (tree_org.dl_path_id_organiz_iam like org_ruolo.dl_path_id_organiz_iam || '%')

join PRF_RUOLO ruo
 on (ruo.id_ruolo = ruo_dich.id_ruolo)
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo
 and uso_ruo.id_applic = uso_user_apl.id_applic)
join PRF_AUTOR aut
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
 and aut.ti_dich_autor = 'AZIONE')
join APL_AZIONE_PAGINA azio
 on (azio.id_azione_pagina = aut.id_azione_pagina)
join APL_PAGINA_WEB pag
 on (pag.id_pagina_web = azio.id_pagina_web)

UNION 

--			autorizzazioni di servizi da ruoli specificati per le dichiarazioni di abilitazione alle organizzazioni 
select distinct
 usr.id_user_iam, usr.nm_userid,
 uso_user_apl.id_uso_user_applic,
 apl.id_applic, apl.nm_applic,
 --abil_org.id_organiz_iam,  abil_org.nm_tipo_organiz nm_tipo_organiz_applic, abil_org.id_organiz_applic id_organiz_applic, abil_org.dl_composito_organiz nm_organiz_applic,
 tree_org.id_organiz_iam, tree_org.nm_tipo_organiz nm_tipo_organiz_applic, tree_org.id_organiz_applic id_organiz_applic, tree_org.dl_composito_organiz nm_organiz_applic,

 'DICH', ruo_dich.id_uso_ruolo_dich id_uso_ruolo,
 ruo.id_ruolo, ruo.nm_ruolo,
  
 aut.ti_dich_autor, serv.id_servizio_web, null, serv.nm_servizio_web, serv.ds_servizio_web,
 null fl_help_presente
 
from USR_USER usr
join USR_USO_USER_APPLIC uso_user_apl
 on (uso_user_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_user_apl.id_applic)

join USR_DICH_ABIL_ORGANIZ dich
 on (dich.id_uso_user_applic = uso_user_apl.id_uso_user_applic)
join USR_USO_RUOLO_DICH ruo_dich
 on (ruo_dich.id_dich_abil_organiz = dich.id_dich_abil_organiz)
join USR_V_TREE_ORGANIZ_IAM org_ruolo
 on (org_ruolo.id_organiz_iam = ruo_dich.id_organiz_iam_ruolo)

join USR_V_TREE_ORGANIZ_IAM tree_org
 on (tree_org.dl_path_id_organiz_iam like org_ruolo.dl_path_id_organiz_iam || '%')

join PRF_RUOLO ruo
 on (ruo.id_ruolo = ruo_dich.id_ruolo)
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo
 and uso_ruo.id_applic = uso_user_apl.id_applic)
join PRF_AUTOR aut
 on (aut.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
 and aut.ti_dich_autor = 'SERVIZIO_WEB')
join APL_SERVIZIO_WEB serv
 on (serv.id_servizio_web = aut.id_servizio_web);

-- changeset root:1753259446745-348
COMMENT ON COLUMN USR_V_ALL_AUTOR.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-349
COMMENT ON COLUMN USR_V_ALL_AUTOR.ID_APPLIC IS 'PK.2';

-- changeset root:1753259446745-350
COMMENT ON COLUMN USR_V_ALL_AUTOR.TI_USO_RUO IS 'PK.3';

-- changeset root:1753259446745-351
COMMENT ON COLUMN USR_V_ALL_AUTOR.ID_USO_RUOLO IS 'PK.4';

-- changeset root:1753259446745-352
COMMENT ON COLUMN USR_V_ALL_AUTOR.ID_RUOLO IS 'PK.5';

-- changeset root:1753259446745-353
COMMENT ON COLUMN USR_V_ALL_AUTOR.TI_DICH_AUTOR IS 'PK.6';

-- changeset root:1753259446745-354
COMMENT ON COLUMN USR_V_ALL_AUTOR.ID_AUTOR IS 'PK.7';

-- changeset root:1753259446745-355
CREATE OR REPLACE FORCE VIEW "USR_V_VIS_DICH_ABIL" ("ID_DICH_ABIL_ORGANIZ", "NM_COGNOME_USER", "NM_NOME_USER", "NM_USERID", "NM_APPLIC", "TI_SCOPO_DICH_ABIL_ORGANIZ", "DL_COMPOSITO_ORGANIZ") AS select
 abil.id_dich_abil_organiz,
 usr.nm_cognome_user,
 usr.nm_nome_user,
 usr.nm_userid,
 apl.nm_applic,
 abil.ti_scopo_dich_abil_organiz,
 org.dl_composito_organiz

from USR_DICH_ABIL_ORGANIZ abil
join USR_USO_USER_APPLIC uso_usr
 on (uso_usr.id_uso_user_applic = abil.id_uso_user_applic)
join USR_USER usr
 on (usr.id_user_iam = uso_usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_usr.id_applic)
left join USR_V_TREE_ORGANIZ_IAM org
 on (org.id_organiz_iam = abil.id_organiz_iam);

-- changeset root:1753259446745-356
COMMENT ON COLUMN USR_V_VIS_DICH_ABIL.ID_DICH_ABIL_ORGANIZ IS 'PK.1';

-- changeset root:1753259446745-357
CREATE OR REPLACE FORCE VIEW "ORG_V_ENTE_CONVENZ_BY_ORGANIZ" ("ID_APPLIC", "NM_APPLIC", "ID_TIPO_ORGANIZ", "NM_TIPO_ORGANIZ", "ID_ORGANIZ_IAM", "ID_ORGANIZ_APPLIC", "NM_ORGANIZ", "ID_ENTE_CONVENZ_ORG", "DT_INI_VAL", "DT_FINE_VAL", "ID_ENTE_CONVENZ", "NM_ENTE_CONVENZ", "DL_COMPOSITO_ORGANIZ") AS select
 apl.id_applic, apl.nm_applic,
 tipo_organiz.id_tipo_organiz, tipo_organiz.nm_tipo_organiz,
 organiz.id_organiz_iam, organiz.id_organiz_applic, organiz.nm_organiz,
 org_ente.id_ente_convenz_org, org_ente.dt_ini_val, org_ente.dt_fine_val,
 ente.id_ente_siam, ente.nm_ente_siam, org.dl_composito_organiz
 
from APL_APPLIC apl
join APL_TIPO_ORGANIZ tipo_organiz
 on (tipo_organiz.id_applic = apl.id_applic)
join USR_ORGANIZ_IAM organiz
 on (organiz.id_applic = apl.id_applic
 and organiz.id_tipo_organiz = tipo_organiz.id_tipo_organiz)
 join USR_V_TREE_ORGANIZ_IAM org
 on (org.id_organiz_iam = organiz.id_organiz_iam)

join ORG_ENTE_CONVENZ_ORG org_ente
 on (org_ente.id_organiz_iam = organiz.id_organiz_iam)
join ORG_ENTE_SIAM ente
 on (ente.id_ente_siam = org_ente.id_ente_convenz);

-- changeset root:1753259446745-358
COMMENT ON COLUMN ORG_V_ENTE_CONVENZ_BY_ORGANIZ.ID_ENTE_CONVENZ_ORG IS 'PK.1';

-- changeset root:1753259446745-359
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_DATI_TO_ADD" ("ID_USER_IAM", "ID_USO_USER_APPLIC", "ID_APPLIC", "NM_APPLIC", "ID_DICH_ABIL_DATI", "ID_TIPO_DATO_IAM", "ID_CLASSE_TIPO_DATO", "ID_APPART_COLLEG_ENTI", "ID_SUPT_EST_ENTE_CONVENZ", "ID_VIGIL_ENTE_PRODUT", "DS_CAUSALE_ABIL") AS select
 id_user_iam,
 id_uso_user_applic,
 id_applic,
 nm_applic,
 
 id_dich_abil_dati,
 id_tipo_dato_iam,
 id_classe_tipo_dato,
 id_appart_colleg_enti,
 id_supt_est_ente_convenz,
 id_vigil_ente_produt,
 ds_causale_dich
from 	(
		select
		 usr.id_user_iam,
		 uso_apl.id_uso_user_applic,
		 uso_apl.id_applic,
		 apl.nm_applic,
		 
		 abil_dati.id_dich_abil_dati,
		 ti_dato.id_tipo_dato_iam,
		 ti_dato.id_classe_tipo_dato,
		 abil_dati.id_appart_colleg_enti,
		 abil_dati.id_supt_est_ente_convenz,
		 abil_dati.id_vigil_ente_produt,
		 ds_causale_dich
		 
		from USR_USER usr

		join USR_USO_USER_APPLIC uso_apl
		 on (uso_apl.id_user_iam = usr.id_user_iam)
		join APL_APPLIC apl
		 on (apl.id_applic = uso_apl.id_applic) 
		 
		join USR_DICH_ABIL_DATI abil_dati
		 on (abil_dati.id_uso_user_applic = uso_apl.id_uso_user_applic
		 and abil_dati.ti_scopo_dich_abil_dati = 'ALL_ORG')
		 
		join USR_V_TREE_ORGANIZ_IAM org
		 on (org.id_applic = apl.id_applic
		 and org.dl_path_id_organiz_iam like '%'
		 and org.fl_last_livello = '1')
		join USR_TIPO_DATO_IAM ti_dato
		 on (ti_dato.id_organiz_iam = org.id_organiz_iam
		 and ti_dato.id_classe_tipo_dato = abil_dati.id_classe_tipo_dato
		 and ti_dato.id_tipo_dato_iam like '%')

		UNION

		select
		 usr.id_user_iam,
		 uso_apl.id_uso_user_applic,
		 uso_apl.id_applic,
		 apl.nm_applic,
		 
		 abil_dati.id_dich_abil_dati,
		 ti_dato.id_tipo_dato_iam,
		 ti_dato.id_classe_tipo_dato,
		 abil_dati.id_appart_colleg_enti,
		 abil_dati.id_supt_est_ente_convenz,
		 abil_dati.id_vigil_ente_produt,
		 ds_causale_dich
		 
		from USR_USER usr

		join USR_USO_USER_APPLIC uso_apl
		 on (uso_apl.id_user_iam = usr.id_user_iam)
		join APL_APPLIC apl
		 on (apl.id_applic = uso_apl.id_applic) 
		 
		join USR_DICH_ABIL_DATI abil_dati
		 on (abil_dati.id_uso_user_applic = uso_apl.id_uso_user_applic
		 and abil_dati.ti_scopo_dich_abil_dati = 'ALL_ORG_CHILD')

		join USR_V_TREE_ORGANIZ_IAM org
		 on (org.id_applic = apl.id_applic
		 and org.dl_path_id_organiz_iam like '%/' || abil_dati.id_organiz_iam || '/%'
		 and org.fl_last_livello = '1')
		join USR_TIPO_DATO_IAM ti_dato
		 on (ti_dato.id_organiz_iam = org.id_organiz_iam
		 and ti_dato.id_classe_tipo_dato = abil_dati.id_classe_tipo_dato
		 and ti_dato.id_tipo_dato_iam like '%')

		UNION

		select
		 usr.id_user_iam,
		 uso_apl.id_uso_user_applic,
		 uso_apl.id_applic,
		 apl.nm_applic,
		 
		 abil_dati.id_dich_abil_dati,
		 ti_dato.id_tipo_dato_iam,
		 ti_dato.id_classe_tipo_dato,
		 abil_dati.id_appart_colleg_enti,
		 abil_dati.id_supt_est_ente_convenz,
		 abil_dati.id_vigil_ente_produt,
		 ds_causale_dich
		 
		from USR_USER usr

		join USR_USO_USER_APPLIC uso_apl
		 on (uso_apl.id_user_iam = usr.id_user_iam)
		join APL_APPLIC apl
		 on (apl.id_applic = uso_apl.id_applic) 
		 
		join USR_DICH_ABIL_DATI abil_dati
		 on (abil_dati.id_uso_user_applic = uso_apl.id_uso_user_applic
		 and abil_dati.ti_scopo_dich_abil_dati = 'UNA_ORG')

		join USR_V_TREE_ORGANIZ_IAM org
		 on (org.id_organiz_iam = abil_dati.id_organiz_iam)
		join USR_TIPO_DATO_IAM ti_dato
		 on (ti_dato.id_organiz_iam = org.id_organiz_iam
		 and ti_dato.id_classe_tipo_dato = abil_dati.id_classe_tipo_dato
		 and ti_dato.id_tipo_dato_iam like '%')

		UNION

		select
		 usr.id_user_iam,
		 uso_apl.id_uso_user_applic,
		 uso_apl.id_applic,
		 apl.nm_applic,
		 
		 abil_dati.id_dich_abil_dati,
		 ti_dato.id_tipo_dato_iam,
		 ti_dato.id_classe_tipo_dato,
		 abil_dati.id_appart_colleg_enti,
		 abil_dati.id_supt_est_ente_convenz,
		 abil_dati.id_vigil_ente_produt,
		 ds_causale_dich
		 
		from USR_USER usr

		join USR_USO_USER_APPLIC uso_apl
		 on (uso_apl.id_user_iam = usr.id_user_iam)
		join APL_APPLIC apl
		 on (apl.id_applic = uso_apl.id_applic) 
		 
		join USR_DICH_ABIL_DATI abil_dati
		 on (abil_dati.id_uso_user_applic = uso_apl.id_uso_user_applic
		 and abil_dati.ti_scopo_dich_abil_dati = 'UN_TIPO_DATO')
		join USR_TIPO_DATO_IAM ti_dato
		 on (ti_dato.id_tipo_dato_iam = abil_dati.id_tipo_dato_iam) 
		) tmp
 
where not exists (select *
				  from USR_ABIL_DATI abil
				  where abil.id_uso_user_applic = tmp.id_uso_user_applic
				  and abil.id_tipo_dato_iam = tmp.id_tipo_dato_iam
				  );

-- changeset root:1753259446745-360
COMMENT ON COLUMN USR_V_ABIL_DATI_TO_ADD.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-361
COMMENT ON COLUMN USR_V_ABIL_DATI_TO_ADD.ID_TIPO_DATO_IAM IS 'PK.2';

-- changeset root:1753259446745-362
CREATE OR REPLACE FORCE VIEW "USR_V_CREA_ABIL_DATI" ("NM_USERID", "ID_USO_USER_APPLIC", "NM_APPLIC", "ID_CLASSE_TIPO_DATO", "NM_CLASSE_TIPO_DATO", "TI_SCOPO_DICH_ABIL_DATI", "ID_ORGANIZ_IAM", "ID_APPART_COLLEG_ENTI", "ID_SUPT_EST_ENTE_CONVENZ", "ID_VIGIL_ENTE_PRODUT", "DS_CAUSALE_DICH") AS select
 usr.nm_userid, uso_apl.id_uso_user_applic, apl.nm_applic, cla_dato.id_classe_tipo_dato, cla_dato.nm_classe_tipo_dato,
 'ALL_ORG', 0,			-- si definisce id_organiz_iam = 0 per compatibilità con gli altri rami in UNION
 dich_org.id_appart_colleg_enti,
 dich_org.id_supt_est_ente_convenz,
 dich_org.id_vigil_ente_produt,
 dich_org.ds_causale_dich
from USR_USER usr
join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_apl.id_applic)
join APL_CLASSE_TIPO_DATO cla_dato
 on (cla_dato.id_applic = apl.id_applic)
join USR_DICH_ABIL_ORGANIZ dich_org
 on (dich_org.id_uso_user_applic = uso_apl.id_uso_user_applic
 and dich_org.ti_scopo_dich_abil_organiz = 'ALL_ORG')
where not exists (select *
				from USR_ABIL_DATI abil_dato
				join USR_TIPO_DATO_IAM ti_dato
				 on (ti_dato.id_tipo_dato_iam = abil_dato.id_tipo_dato_iam
				 and ti_dato.id_classe_tipo_dato = cla_dato.id_classe_tipo_dato)
				 
				where abil_dato.id_uso_user_applic = uso_apl.id_uso_user_applic
				)

UNION

select
 usr.nm_userid, uso_apl.id_uso_user_applic, apl.nm_applic, cla_dato.id_classe_tipo_dato, cla_dato.nm_classe_tipo_dato,
 'ALL_ORG_CHILD', dich_org.id_organiz_iam,
 dich_org.id_appart_colleg_enti,
 dich_org.id_supt_est_ente_convenz,
 dich_org.id_vigil_ente_produt,
 dich_org.ds_causale_dich
from USR_USER usr
join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_apl.id_applic)
join APL_CLASSE_TIPO_DATO cla_dato
 on (cla_dato.id_applic = apl.id_applic)
join USR_DICH_ABIL_ORGANIZ dich_org
 on (dich_org.id_uso_user_applic = uso_apl.id_uso_user_applic
 and dich_org.ti_scopo_dich_abil_organiz = 'ALL_ORG_CHILD')
where not exists (select *
				from USR_ABIL_DATI abil_dato
				join USR_TIPO_DATO_IAM ti_dato
					on (ti_dato.id_tipo_dato_iam = abil_dato.id_tipo_dato_iam
					and ti_dato.id_classe_tipo_dato = cla_dato.id_classe_tipo_dato)
				join USR_V_TREE_ORGANIZ_IAM org
					on (org.id_organiz_iam = ti_dato.id_organiz_iam
					and org.dl_path_id_organiz_iam like '%/' || dich_org.id_organiz_iam || '/%')
				
				where abil_dato.id_uso_user_applic = uso_apl.id_uso_user_applic
				)

UNION

select
 usr.nm_userid, uso_apl.id_uso_user_applic, apl.nm_applic, cla_dato.id_classe_tipo_dato, cla_dato.nm_classe_tipo_dato,
 'UNA_ORG', dich_org.id_organiz_iam,
 dich_org.id_appart_colleg_enti,
 dich_org.id_supt_est_ente_convenz,
 dich_org.id_vigil_ente_produt,
 dich_org.ds_causale_dich
from USR_USER usr
join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_apl.id_applic)
join APL_CLASSE_TIPO_DATO cla_dato
 on (cla_dato.id_applic = apl.id_applic)
join USR_DICH_ABIL_ORGANIZ dich_org
 on (dich_org.id_uso_user_applic = uso_apl.id_uso_user_applic
 and dich_org.ti_scopo_dich_abil_organiz in ('UNA_ORG'))
where not exists (select *
					from USR_ABIL_DATI abil_dato
					join USR_TIPO_DATO_IAM ti_dato
						on (ti_dato.id_tipo_dato_iam = abil_dato.id_tipo_dato_iam
						and ti_dato.id_classe_tipo_dato = cla_dato.id_classe_tipo_dato
						and ti_dato.id_organiz_iam = dich_org.id_organiz_iam)
					
					where abil_dato.id_uso_user_applic = uso_apl.id_uso_user_applic
					);

-- changeset root:1753259446745-363
COMMENT ON COLUMN USR_V_CREA_ABIL_DATI.ID_USO_USER_APPLIC IS 'PK.1';

-- changeset root:1753259446745-364
COMMENT ON COLUMN USR_V_CREA_ABIL_DATI.ID_CLASSE_TIPO_DATO IS 'PK.2';

-- changeset root:1753259446745-365
COMMENT ON COLUMN USR_V_CREA_ABIL_DATI.TI_SCOPO_DICH_ABIL_DATI IS 'PK.3';

-- changeset root:1753259446745-366
COMMENT ON COLUMN USR_V_CREA_ABIL_DATI.ID_ORGANIZ_IAM IS 'PK.4';

-- changeset root:1753259446745-367
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_DATI" ("ID_USER_IAM", "ID_USO_USER_APPLIC", "ID_APPLIC", "NM_APPLIC", "ID_DICH_ABIL_DATI", "ID_ORGANIZ_IAM", "ID_ORGANIZ_APPLIC", "ID_TIPO_ORGANIZ", "NM_ORGANIZ", "DS_ORGANIZ", "ID_ORGANIZ_IAM_PADRE", "DL_COMPOSITO_ORGANIZ", "ID_CLASSE_TIPO_DATO", "NM_CLASSE_TIPO_DATO", "ID_TIPO_DATO_IAM", "NM_TIPO_DATO", "DS_TIPO_DATO", "ID_TIPO_DATO_APPLIC") AS select
 usr.id_user_iam,
 uso_apl.id_uso_user_applic,
 uso_apl.id_applic,
 apl.nm_applic,
 abil_dati.id_dich_abil_dati,
 
 org.id_organiz_iam,
 org.id_organiz_applic,
 org.id_tipo_organiz,
 org.nm_organiz,
 org.ds_organiz,
 org.id_organiz_iam_padre,
 org.dl_composito_organiz,
 
 cla_dato.id_classe_tipo_dato,
 cla_dato.nm_classe_tipo_dato,
 ti_dato.id_tipo_dato_iam,
 ti_dato.nm_tipo_dato,
 ti_dato.ds_tipo_dato,
 ti_dato.id_tipo_dato_applic
 
from USR_USER usr

join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = usr.id_user_iam)
join APL_APPLIC apl
 on (apl.id_applic = uso_apl.id_applic) 
 
join USR_ABIL_DATI abil_dati
 on (abil_dati.id_uso_user_applic = uso_apl.id_uso_user_applic)
 
join USR_TIPO_DATO_IAM ti_dato
 on (ti_dato.id_tipo_dato_iam = abil_dati.id_tipo_dato_iam) 
join APL_CLASSE_TIPO_DATO cla_dato
 on (cla_dato.id_classe_tipo_dato = ti_dato.id_classe_tipo_dato)
join USR_V_TREE_ORGANIZ_IAM org
 on (org.id_organiz_iam = ti_dato.id_organiz_iam);

-- changeset root:1753259446745-368
COMMENT ON COLUMN USR_V_ABIL_DATI.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-369
COMMENT ON COLUMN USR_V_ABIL_DATI.ID_TIPO_DATO_IAM IS 'PK.2';

-- changeset root:1753259446745-370
CREATE OR REPLACE FORCE VIEW "APL_V_LIS_ORGANIZ_USO_SIS_VERS" ("ID_SISTEMA_VERSANTE", "NM_SISTEMA_VERSANTE", "NM_APPLIC", "ID_ORGANIZ_IAM", "DL_COMPOSITO_ORGANIZ", "ID_ORGANIZ_APPLIC") AS select distinct
 sis.id_sistema_versante,
 sis.nm_sistema_versante,
 abil_org.nm_applic,
 abil_org.id_organiz_iam,
 abil_org.dl_composito_organiz,
 abil_org.id_organiz_applic
 
from APL_SISTEMA_VERSANTE sis
join USR_USER usr
 on (usr.id_sistema_versante = sis.id_sistema_versante)
join USR_STATO_USER stato_cor
 on (stato_cor.id_stato_user = usr.id_stato_user_cor)
 
join USR_V_ABIL_ORGANIZ abil_org
 on (abil_org.id_user_iam = usr.id_user_iam)
join USR_ORGANIZ_IAM org
 on (org.id_organiz_iam = abil_org.id_organiz_iam)

where stato_cor.ti_stato_user in ('ATTIVO', 'DISATTIVO')
and usr.tipo_user in ('PERSONA_FISICA', 'AUTOMA')

and org.nm_organiz not like 'Template%';

-- changeset root:1753259446745-371
COMMENT ON COLUMN APL_V_LIS_ORGANIZ_USO_SIS_VERS.ID_SISTEMA_VERSANTE IS 'PK.1';

-- changeset root:1753259446745-372
COMMENT ON COLUMN APL_V_LIS_ORGANIZ_USO_SIS_VERS.ID_ORGANIZ_IAM IS 'PK.2';

-- changeset root:1753259446745-373
CREATE OR REPLACE FORCE VIEW "APL_V_RIC_SISTEMA_VERSANTE" ("ID_USER_IAM_COR", "ID_SISTEMA_VERSANTE", "NM_SISTEMA_VERSANTE", "CD_VERSIONE", "DS_SISTEMA_VERSANTE", "ID_ENTE_SIAM", "NM_PRODUTTORE", "DS_VIA_SEDE_LEGALE", "CD_CAP_SEDE_LEGALE", "DS_CITTA_SEDE_LEGALE", "DS_EMAIL", "FL_PEC", "FL_INTEGRAZIONE", "DS_NOTE", "ID_USER_IAM", "NM_USERID", "NM_APPLIC", "ID_ORGANIZ_IAM", "DL_COMPOSITO_ORGANIZ", "ID_ORGANIZ_APPLIC", "FL_ASSOCIA_PERSONA_FISICA", "ARCHIVISTA", "ID_USER_IAM_ARK", "DT_INI_VAL", "DT_FINE_VAL", "FL_CESSATO") AS SELECT abil_ente.id_user_iam       id_user_iam_cor,
           sis.id_sistema_versante,
           sis.nm_sistema_versante,
           sis.cd_versione,
           sis.ds_sistema_versante,
           ente_fornit.id_ente_siam,
           ente_fornit.nm_ente_siam    nm_produttore,
           ente_fornit.ds_via_sede_legale,
           ente_fornit.cd_cap_sede_legale,
           ente_fornit.ds_citta_sede_legale,
           sis.ds_email,
           sis.fl_pec,
           sis.fl_integrazione,
           sis.ds_note,
           CASE
               WHEN    stato_cor.ti_stato_user = 'CESSATO'
                    OR stato_cor.ti_stato_user IS NULL
               THEN
                   NULL
               ELSE
                   usr.id_user_iam
           END                         id_user_iam,
           CASE
               WHEN    stato_cor.ti_stato_user = 'CESSATO'
                    OR stato_cor.ti_stato_user IS NULL
               THEN
                   NULL
               ELSE
                   usr.nm_userid
           END                         nm_userid,
           CASE
               WHEN    stato_cor.ti_stato_user = 'CESSATO'
                    OR stato_cor.ti_stato_user IS NULL
               THEN
                   NULL
               ELSE
                   abil_org.nm_applic
           END                         nm_applic,
           CASE
               WHEN    stato_cor.ti_stato_user = 'CESSATO'
                    OR stato_cor.ti_stato_user IS NULL
               THEN
                   NULL
               ELSE
                   abil_org.id_organiz_iam
           END                         id_organiz_iam,
           CASE
               WHEN    stato_cor.ti_stato_user = 'CESSATO'
                    OR stato_cor.ti_stato_user IS NULL
               THEN
                   NULL
               ELSE
                   abil_org.dl_composito_organiz
           END                         dl_composito_organiz,
           CASE
               WHEN    stato_cor.ti_stato_user = 'CESSATO'
                    OR stato_cor.ti_stato_user IS NULL
               THEN
                   NULL
               ELSE
                   abil_org.id_organiz_applic
           END                         id_organiz_applic,
           sis.fl_associa_persona_fisica,
           CASE
               WHEN (SELECT NVL (COUNT (*), 0)
                       FROM apl_sistema_vers_ark_rif count_archivisti
                      WHERE sis.id_sistema_versante =
                            count_archivisti.id_sistema_versante) =
                    1
               THEN
                   (SELECT ute_ark.nm_userid
                      FROM USR_USER ute_ark
                     WHERE ute_ark.id_user_iam = archivisti.id_user_iam)
               WHEN (SELECT NVL (COUNT (*), 0)
                       FROM apl_sistema_vers_ark_rif count_archivisti
                      WHERE sis.id_sistema_versante =
                            count_archivisti.id_sistema_versante) =
                    0
               THEN
                   'Nessun archivista definito'
               ELSE
                   'Sistema con più di un archivista di riferimento'
           END                         archivista,
           utente_ark.id_user_iam      id_user_iam_ark,
           sis.dt_ini_val,
           sis.dt_fine_val,
           CASE
               --a) Non cessato (data corrente compresa tra data inizio  e data fine validità )
               WHEN (    sis.dt_fine_val >= TRUNC (SYSDATE)
                     AND sis.dt_ini_val <= TRUNC (SYSDATE))
               THEN
                   '0'
               ELSE
                   '1'
           END                         fl_cessato
      FROM APL_SISTEMA_VERSANTE  sis
           JOIN ORG_ENTE_SIAM ente_fornit
               ON (ente_fornit.id_ente_siam = sis.id_ente_siam)
           JOIN USR_ABIL_ENTE_SIAM abil_ente
               ON (abil_ente.id_ente_siam = ente_fornit.id_ente_siam)
           LEFT JOIN USR_USER usr
               ON (usr.id_sistema_versante = sis.id_sistema_versante)
           LEFT JOIN USR_STATO_USER stato_cor
               ON (stato_cor.id_stato_user = usr.id_stato_user_cor)
           LEFT JOIN USR_V_ABIL_ORGANIZ abil_org
               ON (abil_org.id_user_iam = usr.id_user_iam)
           LEFT JOIN apl_sistema_vers_ark_rif archivisti
               ON (archivisti.id_sistema_versante = sis.id_sistema_versante)
           LEFT JOIN usr_user utente_ark
               ON (utente_ark.id_user_iam = archivisti.id_user_iam)
     WHERE    stato_cor.ti_stato_user IS NULL
           OR stato_cor.ti_stato_user IN ('ATTIVO', 'DISATTIVO')
           OR stato_cor.ti_stato_user = 'CESSATO';

-- changeset root:1753259446745-374
COMMENT ON COLUMN APL_V_RIC_SISTEMA_VERSANTE.ID_SISTEMA_VERSANTE IS 'PK.1';

-- changeset root:1753259446745-375
COMMENT ON COLUMN APL_V_RIC_SISTEMA_VERSANTE.ID_USER_IAM IS 'PK.2';

-- changeset root:1753259446745-376
COMMENT ON COLUMN APL_V_RIC_SISTEMA_VERSANTE.ID_ORGANIZ_IAM IS 'PK.3';

-- changeset root:1753259446745-377
CREATE OR REPLACE FORCE VIEW "USR_V_CHECK_RUOLO_DEFAULT" ("ID_USER_CORRENTE", "ID_RUOLO_AGGIUNTO", "ID_APPLIC_SCELTA", "TI_DICH_AUTOR", "ID_AUTOR_AGGIUNTA", "NM_AUTOR_AGGIUNTA", "DS_AUTOR_AGGIUNTA") AS select
 usr_corrente.id_user_iam id_user_corrente,
 ruo_aggiunto.id_ruolo id_ruolo_aggiunto,
 uso_ruo_aggiunto.id_applic id_applic_scelta,
 
 aut_ruo_aggiunto.ti_dich_autor, menu_aggiunto.id_entry_menu, menu_aggiunto.nm_entry_menu, menu_aggiunto.ds_entry_menu

from PRF_RUOLO ruo_aggiunto
join PRF_USO_RUOLO_APPLIC uso_ruo_aggiunto
 on (uso_ruo_aggiunto.id_ruolo = ruo_aggiunto.id_ruolo)
join PRF_AUTOR aut_ruo_aggiunto
 on (aut_ruo_aggiunto.id_uso_ruolo_applic = uso_ruo_aggiunto.id_uso_ruolo_applic
 and aut_ruo_aggiunto.ti_dich_autor = 'ENTRY_MENU')
join APL_ENTRY_MENU menu_aggiunto
 on (menu_aggiunto.id_entry_menu = aut_ruo_aggiunto.id_entry_menu)

join USR_USER usr_corrente
 on (usr_corrente.nm_userid like '%')
where not exists (select *
				from USR_V_AUTOR_DEFAULT aut
				where aut.id_user_iam = usr_corrente.id_user_iam
				and aut.id_applic = uso_ruo_aggiunto.id_applic
				and aut.ti_dich_autor = aut_ruo_aggiunto.ti_dich_autor
				and aut.id_autor = aut_ruo_aggiunto.id_entry_menu)

UNION

select
 usr_corrente.id_user_iam id_user_corrente,
 ruo_aggiunto.id_ruolo id_ruolo_aggiunto,
 uso_ruo_aggiunto.id_applic id_applic_scelta,
 
 aut_ruo_aggiunto.ti_dich_autor, pag_aggiunto.id_pagina_web, pag_aggiunto.nm_pagina_web, pag_aggiunto.ds_pagina_web

from PRF_RUOLO ruo_aggiunto
join PRF_USO_RUOLO_APPLIC uso_ruo_aggiunto
 on (uso_ruo_aggiunto.id_ruolo = ruo_aggiunto.id_ruolo)
join PRF_AUTOR aut_ruo_aggiunto
 on (aut_ruo_aggiunto.id_uso_ruolo_applic = uso_ruo_aggiunto.id_uso_ruolo_applic
 and aut_ruo_aggiunto.ti_dich_autor = 'PAGINA')
join APL_PAGINA_WEB pag_aggiunto
 on (pag_aggiunto.id_pagina_web = aut_ruo_aggiunto.id_pagina_web)

join USR_USER usr_corrente
 on (usr_corrente.nm_userid like '%')
where not exists (select *
				from USR_V_AUTOR_DEFAULT aut
				where aut.id_user_iam = usr_corrente.id_user_iam
				and aut.id_applic = uso_ruo_aggiunto.id_applic
				and aut.ti_dich_autor = aut_ruo_aggiunto.ti_dich_autor
				and aut.id_autor = aut_ruo_aggiunto.id_pagina_web)

UNION

select
 usr_corrente.id_user_iam id_user_corrente,
 ruo_aggiunto.id_ruolo id_ruolo_aggiunto,
 uso_ruo_aggiunto.id_applic id_applic_scelta,
 
 aut_ruo_aggiunto.ti_dich_autor, azio_aggiunto.id_azione_pagina, pag_aggiunto.nm_pagina_web || ' --> ' || azio_aggiunto.nm_azione_pagina, pag_aggiunto.ds_pagina_web || ' --> ' || azio_aggiunto.ds_azione_pagina

from PRF_RUOLO ruo_aggiunto
join PRF_USO_RUOLO_APPLIC uso_ruo_aggiunto
 on (uso_ruo_aggiunto.id_ruolo = ruo_aggiunto.id_ruolo)
join PRF_AUTOR aut_ruo_aggiunto
 on (aut_ruo_aggiunto.id_uso_ruolo_applic = uso_ruo_aggiunto.id_uso_ruolo_applic
 and aut_ruo_aggiunto.ti_dich_autor = 'AZIONE')
join APL_AZIONE_PAGINA azio_aggiunto
 on (azio_aggiunto.id_azione_pagina = aut_ruo_aggiunto.id_azione_pagina)
join APL_PAGINA_WEB pag_aggiunto
 on (pag_aggiunto.id_pagina_web = azio_aggiunto.id_pagina_web)

join USR_USER usr_corrente
 on (usr_corrente.nm_userid like '%')
where not exists (select *
				from USR_V_AUTOR_DEFAULT aut
				where aut.id_user_iam = usr_corrente.id_user_iam
				and aut.id_applic = uso_ruo_aggiunto.id_applic
				and aut.ti_dich_autor = aut_ruo_aggiunto.ti_dich_autor
				and aut.id_autor = aut_ruo_aggiunto.id_azione_pagina)

UNION

select
 usr_corrente.id_user_iam id_user_corrente,
 ruo_aggiunto.id_ruolo id_ruolo_aggiunto,
 uso_ruo_aggiunto.id_applic id_applic_scelta,
 
 aut_ruo_aggiunto.ti_dich_autor, serv_aggiunto.id_servizio_web, serv_aggiunto.nm_servizio_web, serv_aggiunto.ds_servizio_web

from PRF_RUOLO ruo_aggiunto
join PRF_USO_RUOLO_APPLIC uso_ruo_aggiunto
 on (uso_ruo_aggiunto.id_ruolo = ruo_aggiunto.id_ruolo)
join PRF_AUTOR aut_ruo_aggiunto
 on (aut_ruo_aggiunto.id_uso_ruolo_applic = uso_ruo_aggiunto.id_uso_ruolo_applic
 and aut_ruo_aggiunto.ti_dich_autor = 'SERVIZIO_WEB')
join APL_SERVIZIO_WEB serv_aggiunto
 on (serv_aggiunto.id_servizio_web = aut_ruo_aggiunto.id_servizio_web)

join USR_USER usr_corrente
 on (usr_corrente.nm_userid like '%')
where not exists (select *
				from USR_V_AUTOR_DEFAULT aut
				where aut.id_user_iam = usr_corrente.id_user_iam
				and aut.id_applic = uso_ruo_aggiunto.id_applic
				and aut.ti_dich_autor = aut_ruo_aggiunto.ti_dich_autor
				and aut.id_autor = aut_ruo_aggiunto.id_servizio_web);

-- changeset root:1753259446745-378
COMMENT ON COLUMN USR_V_CHECK_RUOLO_DEFAULT.ID_USER_CORRENTE IS 'PK.1';

-- changeset root:1753259446745-379
COMMENT ON COLUMN USR_V_CHECK_RUOLO_DEFAULT.ID_RUOLO_AGGIUNTO IS 'PK.2';

-- changeset root:1753259446745-380
COMMENT ON COLUMN USR_V_CHECK_RUOLO_DEFAULT.TI_DICH_AUTOR IS 'PK.3';

-- changeset root:1753259446745-381
COMMENT ON COLUMN USR_V_CHECK_RUOLO_DEFAULT.ID_AUTOR_AGGIUNTA IS 'PK.4';

-- changeset root:1753259446745-382
CREATE OR REPLACE FORCE VIEW "APL_V_TREE_MENU_PAG_AZIO" ("ID_APPLIC", "ID_NODO_PADRE", "ID_NODO", "TIPO_NODO", "DS_NODO", "NI_ORD_NODI", "DS_ORD_NODI", "NI_LIVELLO") AS select 
tmp.id_applic, tmp.id_nodo_padre,  tmp.id_nodo, tipo_nodo, 
tmp.ds_nodo,
tmp.ni_ord_nodi, tmp.ds_ord_nodi, level

from (

select id_applic, 'M' || to_char(id_entry_menu) id_nodo, null id_nodo_padre, 'M' tipo_nodo, 
	   ds_entry_menu ds_nodo, 
	   ni_ord_entry_menu ni_ord_nodi, null ds_ord_nodi
from apl_entry_menu

where id_entry_menu_padre is null

UNION

select id_applic, 'M' || to_char(id_entry_menu) id_nodo, 'M' || to_char(id_entry_menu_padre) id_nodo_padre, 'M' tipo_nodo, 
	   ds_entry_menu ds_nodo, 
	   ni_ord_entry_menu ni_ord_nodi, null ds_ord_nodi
from apl_entry_menu

where id_entry_menu_padre is not null

UNION

select id_applic, 'P' || to_char(id_pagina_web) id_nodo, 'M' || to_char(id_entry_menu) id_nodo_padre, 'P' tipo_nodo, 
	   ds_pagina_web ds_nodo, 
	   0 ni_ord_nodi, ds_pagina_web ds_ord_nodi
from apl_pagina_web

UNION

select pag.id_applic, 'A' || to_char(azio.id_azione_pagina) id_nodo, 'P' || to_char(pag.id_pagina_web) id_nodo_padre, 'A' tipo_nodo, 
	   azio.ds_azione_pagina ds_nodo,
	   0 ni_ord_nodi, ds_azione_pagina ds_ord_nodi
from apl_pagina_web pag
join apl_azione_pagina azio
on (azio.id_pagina_web = pag.id_pagina_web)
) tmp

start with tmp.id_nodo_padre is null
connect by prior tmp.id_nodo = tmp.id_nodo_padre

order siblings by tmp.ni_ord_nodi, tmp.ds_ord_nodi;

-- changeset root:1753259446745-383
COMMENT ON COLUMN APL_V_TREE_MENU_PAG_AZIO.ID_NODO IS 'PK.1';

-- changeset root:1753259446745-384
CREATE OR REPLACE FORCE VIEW "USR_V_CHECK_RUOLO_DICH" ("ID_USER_CORRENTE", "ID_RUOLO_AGGIUNTO", "ID_APPLIC_DICH", "ID_ORGANIZ_IAM_RUOLO", "TI_DICH_AUTOR", "ID_AUTOR_AGGIUNTA", "NM_AUTOR_AGGIUNTA", "DS_AUTOR_AGGIUNTA") AS select
 usr_corrente.id_user_iam id_user_corrente,
 ruo_aggiunto.id_ruolo id_ruolo_aggiunto,
 uso_ruo_aggiunto.id_applic id_applic_dich,
 org_ruolo.id_organiz_iam id_organiz_iam_ruolo,
 
 aut_ruo_aggiunto.ti_dich_autor, menu_aggiunto.id_entry_menu, menu_aggiunto.nm_entry_menu, menu_aggiunto.ds_entry_menu

from PRF_RUOLO ruo_aggiunto
join PRF_USO_RUOLO_APPLIC uso_ruo_aggiunto
 on (uso_ruo_aggiunto.id_ruolo = ruo_aggiunto.id_ruolo)
join PRF_AUTOR aut_ruo_aggiunto
 on (aut_ruo_aggiunto.id_uso_ruolo_applic = uso_ruo_aggiunto.id_uso_ruolo_applic
 and aut_ruo_aggiunto.ti_dich_autor = 'ENTRY_MENU')
join APL_ENTRY_MENU menu_aggiunto
 on (menu_aggiunto.id_entry_menu = aut_ruo_aggiunto.id_entry_menu)

join USR_USER usr_corrente
 on (usr_corrente.nm_userid like '%')

join USR_V_TREE_ORGANIZ_IAM org_ruolo
 on (org_ruolo.id_applic = uso_ruo_aggiunto.id_applic)
join USR_V_TREE_ORGANIZ_IAM tree_org
 on (tree_org.dl_path_id_organiz_iam like org_ruolo.dl_path_id_organiz_iam || '%'
 and tree_org.nm_tipo_organiz in ('STRUTTURA', 'VERSATORE'))
 
where not exists (select *
				from USR_V_ALL_AUTOR aut
				where aut.id_user_iam = usr_corrente.id_user_iam
				and aut.id_applic = uso_ruo_aggiunto.id_applic
				and ((ti_uso_ruo = 'DEF' and aut.id_organiz_iam is null) or (ti_uso_ruo = 'DICH' and aut.id_organiz_iam = org_ruolo.id_organiz_iam))
				and aut.ti_dich_autor = aut_ruo_aggiunto.ti_dich_autor
				and aut.id_autor = aut_ruo_aggiunto.id_entry_menu)



UNION

select
 usr_corrente.id_user_iam id_user_corrente,
 ruo_aggiunto.id_ruolo id_ruolo_aggiunto,
 uso_ruo_aggiunto.id_applic id_applic_dich,
 org_ruolo.id_organiz_iam id_organiz_iam_ruolo,
 
 aut_ruo_aggiunto.ti_dich_autor, pag_aggiunto.id_pagina_web, pag_aggiunto.nm_pagina_web, pag_aggiunto.ds_pagina_web

from PRF_RUOLO ruo_aggiunto
join PRF_USO_RUOLO_APPLIC uso_ruo_aggiunto
 on (uso_ruo_aggiunto.id_ruolo = ruo_aggiunto.id_ruolo)
join PRF_AUTOR aut_ruo_aggiunto
 on (aut_ruo_aggiunto.id_uso_ruolo_applic = uso_ruo_aggiunto.id_uso_ruolo_applic
 and aut_ruo_aggiunto.ti_dich_autor = 'PAGINA')
join APL_PAGINA_WEB pag_aggiunto
 on (pag_aggiunto.id_pagina_web = aut_ruo_aggiunto.id_pagina_web)

join USR_USER usr_corrente
 on (usr_corrente.nm_userid like '%')

join USR_V_TREE_ORGANIZ_IAM org_ruolo
 on (org_ruolo.id_applic = uso_ruo_aggiunto.id_applic)
join USR_V_TREE_ORGANIZ_IAM tree_org
 on (tree_org.dl_path_id_organiz_iam like org_ruolo.dl_path_id_organiz_iam || '%'
 and tree_org.nm_tipo_organiz in ('STRUTTURA', 'VERSATORE'))

where not exists (select *
				from USR_V_ALL_AUTOR aut
				where aut.id_user_iam = usr_corrente.id_user_iam
				and aut.id_applic = uso_ruo_aggiunto.id_applic
				and ((ti_uso_ruo = 'DEF' and aut.id_organiz_iam is null) or (ti_uso_ruo = 'DICH' and aut.id_organiz_iam = org_ruolo.id_organiz_iam))
				and aut.ti_dich_autor = aut_ruo_aggiunto.ti_dich_autor
				and aut.id_autor = aut_ruo_aggiunto.id_pagina_web)

UNION

select
 usr_corrente.id_user_iam id_user_corrente,
 ruo_aggiunto.id_ruolo id_ruolo_aggiunto,
 uso_ruo_aggiunto.id_applic id_applic_dich,
 org_ruolo.id_organiz_iam id_organiz_iam_ruolo,
 
 aut_ruo_aggiunto.ti_dich_autor, azio_aggiunto.id_azione_pagina, pag_aggiunto.nm_pagina_web || ' --> ' || azio_aggiunto.nm_azione_pagina, pag_aggiunto.ds_pagina_web || ' --> ' || azio_aggiunto.ds_azione_pagina

from PRF_RUOLO ruo_aggiunto
join PRF_USO_RUOLO_APPLIC uso_ruo_aggiunto
 on (uso_ruo_aggiunto.id_ruolo = ruo_aggiunto.id_ruolo)
join PRF_AUTOR aut_ruo_aggiunto
 on (aut_ruo_aggiunto.id_uso_ruolo_applic = uso_ruo_aggiunto.id_uso_ruolo_applic
 and aut_ruo_aggiunto.ti_dich_autor = 'AZIONE')
join APL_AZIONE_PAGINA azio_aggiunto
 on (azio_aggiunto.id_azione_pagina = aut_ruo_aggiunto.id_azione_pagina)
join APL_PAGINA_WEB pag_aggiunto
 on (pag_aggiunto.id_pagina_web = azio_aggiunto.id_pagina_web)

join USR_USER usr_corrente
 on (usr_corrente.nm_userid like '%')

join USR_V_TREE_ORGANIZ_IAM org_ruolo
 on (org_ruolo.id_applic = uso_ruo_aggiunto.id_applic)
join USR_V_TREE_ORGANIZ_IAM tree_org
 on (tree_org.dl_path_id_organiz_iam like org_ruolo.dl_path_id_organiz_iam || '%'
 and tree_org.nm_tipo_organiz in ('STRUTTURA', 'VERSATORE'))

where not exists (select *
				from USR_V_ALL_AUTOR aut
				where aut.id_user_iam = usr_corrente.id_user_iam
				and aut.id_applic = uso_ruo_aggiunto.id_applic
				and ((ti_uso_ruo = 'DEF' and aut.id_organiz_iam is null) or (ti_uso_ruo = 'DICH' and aut.id_organiz_iam = org_ruolo.id_organiz_iam))
				and aut.ti_dich_autor = aut_ruo_aggiunto.ti_dich_autor
				and aut.id_autor = aut_ruo_aggiunto.id_azione_pagina)

UNION

select
 usr_corrente.id_user_iam id_user_corrente,
 ruo_aggiunto.id_ruolo id_ruolo_aggiunto,
 uso_ruo_aggiunto.id_applic id_applic_dich,
 org_ruolo.id_organiz_iam id_organiz_iam_ruolo,
 
 aut_ruo_aggiunto.ti_dich_autor, serv_aggiunto.id_servizio_web, serv_aggiunto.nm_servizio_web, serv_aggiunto.ds_servizio_web

from PRF_RUOLO ruo_aggiunto
join PRF_USO_RUOLO_APPLIC uso_ruo_aggiunto
 on (uso_ruo_aggiunto.id_ruolo = ruo_aggiunto.id_ruolo)
join PRF_AUTOR aut_ruo_aggiunto
 on (aut_ruo_aggiunto.id_uso_ruolo_applic = uso_ruo_aggiunto.id_uso_ruolo_applic
 and aut_ruo_aggiunto.ti_dich_autor = 'SERVIZIO_WEB')
join APL_SERVIZIO_WEB serv_aggiunto
 on (serv_aggiunto.id_servizio_web = aut_ruo_aggiunto.id_servizio_web)

join USR_USER usr_corrente
 on (usr_corrente.nm_userid like '%')

join USR_V_TREE_ORGANIZ_IAM org_ruolo
 on (org_ruolo.id_applic = uso_ruo_aggiunto.id_applic)
join USR_V_TREE_ORGANIZ_IAM tree_org
 on (tree_org.dl_path_id_organiz_iam like org_ruolo.dl_path_id_organiz_iam || '%'
 and tree_org.nm_tipo_organiz in ('STRUTTURA', 'VERSATORE'))

where not exists (select *
				from USR_V_ALL_AUTOR aut
				where aut.id_user_iam = usr_corrente.id_user_iam
				and aut.id_applic = uso_ruo_aggiunto.id_applic
				and ((ti_uso_ruo = 'DEF' and aut.id_organiz_iam is null) or (ti_uso_ruo = 'DICH' and aut.id_organiz_iam = org_ruolo.id_organiz_iam))
				and aut.ti_dich_autor = aut_ruo_aggiunto.ti_dich_autor
				and aut.id_autor = aut_ruo_aggiunto.id_servizio_web);

-- changeset root:1753259446745-385
COMMENT ON COLUMN USR_V_CHECK_RUOLO_DICH.ID_USER_CORRENTE IS 'PK.1';

-- changeset root:1753259446745-386
COMMENT ON COLUMN USR_V_CHECK_RUOLO_DICH.ID_RUOLO_AGGIUNTO IS 'PK.2';

-- changeset root:1753259446745-387
COMMENT ON COLUMN USR_V_CHECK_RUOLO_DICH.TI_DICH_AUTOR IS 'PK.3';

-- changeset root:1753259446745-388
COMMENT ON COLUMN USR_V_CHECK_RUOLO_DICH.ID_AUTOR_AGGIUNTA IS 'PK.4';

-- changeset root:1753259446745-389
CREATE OR REPLACE FORCE VIEW "USR_V_CHECK_DICH_ABIL_DATI" ("ID_DICH_ABIL_DATI_AGGIUNTA", "ID_TIPO_DATO_IAM", "DL_COMPOSITO_ORGANIZ", "NM_CLASSE_TIPO_DATO", "NM_TIPO_DATO", "ID_USER_IAM_CORRENTE") AS select
 abil_aggiunta.id_dich_abil_dati id_dich_abil_dati_aggiunta,
 abil_aggiunta.id_tipo_dato_iam id_tipo_dato_iam,
 org.dl_composito_organiz dl_composito_organiz, 
 cla_dato.nm_classe_tipo_dato nm_classe_tipo_dato,
 ti_dato.nm_tipo_dato nm_tipo_dato,
 
 usr_corrente.id_user_iam id_user_iam_corrente
 
from USR_ABIL_DATI abil_aggiunta
 
join USR_TIPO_DATO_IAM ti_dato
 on (ti_dato.id_tipo_dato_iam = abil_aggiunta.id_tipo_dato_iam) 
join APL_CLASSE_TIPO_DATO cla_dato
 on (cla_dato.id_classe_tipo_dato = ti_dato.id_classe_tipo_dato)
join USR_V_TREE_ORGANIZ_IAM org
 on (org.id_organiz_iam = ti_dato.id_organiz_iam)

join USR_USER usr_corrente
 on (usr_corrente.nm_userid like '%')
 
where abil_aggiunta.id_tipo_dato_iam not in (select abil_corrente.id_tipo_dato_iam
											from USR_USO_USER_APPLIC uso_apl_corrente
											join USR_ABIL_DATI abil_corrente
												on (abil_corrente.id_uso_user_applic = uso_apl_corrente.id_uso_user_applic)
											where uso_apl_corrente.id_user_iam = usr_corrente.id_user_iam
											);

-- changeset root:1753259446745-390
COMMENT ON COLUMN USR_V_CHECK_DICH_ABIL_DATI.ID_DICH_ABIL_DATI_AGGIUNTA IS 'PK.1';

-- changeset root:1753259446745-391
COMMENT ON COLUMN USR_V_CHECK_DICH_ABIL_DATI.ID_TIPO_DATO_IAM IS 'PK.2';

-- changeset root:1753259446745-392
COMMENT ON COLUMN USR_V_CHECK_DICH_ABIL_DATI.ID_USER_IAM_CORRENTE IS 'PK.3';

-- changeset root:1753259446745-393
CREATE OR REPLACE FORCE VIEW "ORG_V_CREA_SERV_EROG_BY_ACC" ("ID_ACCORDO_ENTE", "NM_SERVIZIO_EROGATO", "ID_TIPO_SERVIZIO", "ID_SISTEMA_VERSANTE", "FL_PAGAMENTO", "ID_TARIFFA", "ID_TARIFFA_ACCORDO", "ID_TARIFFA_AA_ACCORDO", "IM_VALORE_TARIFFA", "DT_EROG", "AA_ANNO_ACCORDO") AS SELECT accordo.id_accordo_ente,
           tipo_serv.cd_tipo_servizio    nm_servizio_erogato,
           tipo_serv.id_tipo_servizio,
           NULL                          id_sistema_versante,
           accordo.fl_pagamento,
           tariffa.id_tariffa,
           NULL                          id_tariffa_accordo,
           NULL                          id_tariffa_aa_accordo,
           CASE
               WHEN tariffa.tipo_tariffa = 'VALORE_FISSO'
               THEN
                   tariffa.im_valore_fisso_tariffa
               ELSE
                   (SELECT scag.im_scaglione
                      FROM ORG_SCAGLIONE_TARIFFA scag
                     WHERE     scag.id_tariffa = tariffa.id_tariffa
                           AND scag.ni_ini_scaglione =
                               (SELECT MIN (scag_min.ni_ini_scaglione)
                                  FROM ORG_SCAGLIONE_TARIFFA scag_min
                                 WHERE scag_min.id_tariffa =
                                       tariffa.id_tariffa))
           END                           im_valore_tariffa,
           NULL                          dt_erog, -- data erogazione calcolata da calcolo contenuto Sacer (per ALTRO viene definita manualmente)
           NULL                          AA_ANNO_ACCORDO
      FROM ORG_ACCORDO_ENTE  accordo
           JOIN ORG_TIPO_ACCORDO ti_acc
               ON (    ti_acc.id_tipo_accordo = accordo.id_tipo_accordo
                   AND ti_acc.cd_algo_tariffario = 'CLASSE_ENTE')
           JOIN ORG_TARIFFARIO tariffario
               ON (tariffario.id_tariffario = accordo.id_tariffario)
           JOIN ORG_TARIFFA tariffa
               ON (    tariffa.id_tariffario = tariffario.id_tariffario
                   AND tariffa.id_classe_ente_convenz =
                       accordo.id_classe_ente_convenz)
           JOIN ORG_TIPO_SERVIZIO tipo_serv
               ON (    tipo_serv.id_tipo_servizio = tariffa.id_tipo_servizio
                   AND tipo_serv.ti_classe_tipo_servizio IN
                           ('ALTRO', 'CONSERVAZIONE'))
    UNION
    -- tipo accordo CLASSE_ENTE - calcolo servizi di attivazione
    SELECT tmp.id_accordo_ente,
           tmp.cd_tipo_servizio || '_' || tmp.nm_sistema_versante
               nm_servizio_erogato,
           tmp.id_tipo_servizio,
           tmp.id_sistema_versante,
           tmp.fl_pagamento,
           tmp.id_tariffa,
           NULL
               id_tariffa_accordo,
           NULL
               id_tariffa_aa_accordo,
           tmp.im_valore_tariffa,
           NULL
               dt_erog,
           NULL
               AA_ANNO_ACCORDO -- data erogazione calcolata da alcolo contenuto Sacer
      FROM (SELECT DISTINCT accordo.id_accordo_ente,
                            tipo_serv.cd_tipo_servizio,
                            tipo_serv.id_tipo_servizio,
                            sis_vers.id_sistema_versante,
                            sis_vers.nm_sistema_versante,
                            accordo.fl_pagamento,
                            tariffa.id_tariffa,
                            CASE
                                WHEN tariffa.tipo_tariffa = 'VALORE_FISSO'
                                THEN
                                    tariffa.im_valore_fisso_tariffa
                                ELSE
                                    (SELECT scag.im_scaglione
                                       FROM ORG_SCAGLIONE_TARIFFA scag
                                      WHERE     scag.id_tariffa =
                                                tariffa.id_tariffa
                                            AND scag.ni_ini_scaglione =
                                                (SELECT MIN (
                                                            scag_min.ni_ini_scaglione)
                                                   FROM ORG_SCAGLIONE_TARIFFA
                                                        scag_min
                                                  WHERE scag_min.id_tariffa =
                                                        tariffa.id_tariffa))
                            END    im_valore_tariffa,
                            accordo.id_ente_convenz
              FROM ORG_ACCORDO_ENTE  accordo
                   JOIN ORG_TIPO_ACCORDO ti_acc
                       ON (    ti_acc.id_tipo_accordo =
                               accordo.id_tipo_accordo
                           AND ti_acc.cd_algo_tariffario = 'CLASSE_ENTE')
                   JOIN ORG_TARIFFARIO tariffario
                       ON (tariffario.id_tariffario = accordo.id_tariffario)
                   JOIN ORG_TARIFFA tariffa
                       ON (    tariffa.id_tariffario =
                               tariffario.id_tariffario
                           AND tariffa.id_classe_ente_convenz =
                               accordo.id_classe_ente_convenz)
                   JOIN ORG_TIPO_SERVIZIO tipo_serv
                       ON (    tipo_serv.id_tipo_servizio =
                               tariffa.id_tipo_servizio
                           AND tipo_serv.ti_classe_tipo_servizio =
                               'ATTIVAZIONE_SISTEMA_VERSANTE')
                   JOIN ORG_ENTE_CONVENZ_ORG org_ente
                       ON (    org_ente.id_ente_convenz =
                               accordo.id_ente_convenz
                           AND org_ente.dt_ini_val <= accordo.dt_scad_accordo
                           AND org_ente.dt_fine_val >= accordo.dt_dec_accordo)
                   JOIN APL_V_LIS_ORGANIZ_USO_SIS_VERS sis_vers
                       ON (    sis_vers.nm_applic = 'SACER'
                           AND sis_vers.id_organiz_iam =
                               org_ente.id_organiz_iam)
             WHERE    NOT EXISTS
                          (SELECT * -- includi servizio se i tipi ud relativi al tipo servizio non sono stati erogati con il sistema versante
                             FROM sacer.DEC_V_LIS_SIS_VERS_BY_TIPO_UD
                                  lis_sis_vers
                            WHERE     lis_sis_vers.id_tipo_servizio_attiv =
                                      tipo_serv.id_tipo_servizio
                                  AND lis_sis_vers.id_sistema_versante =
                                      sis_vers.id_sistema_versante)
                   OR EXISTS
                          (SELECT * -- includi servizio se i tipi ud relativi al tipo servizio sono stati erogati con il sistema versante nell'ambito dell'accordo
                             FROM sacer.DEC_V_LIS_SIS_VERS_BY_TIPO_UD
                                  lis_sis_vers
                            WHERE     lis_sis_vers.id_tipo_servizio_attiv =
                                      tipo_serv.id_tipo_servizio
                                  AND lis_sis_vers.id_sistema_versante =
                                      sis_vers.id_sistema_versante
                                  AND lis_sis_vers.dt_erog >=
                                      accordo.dt_dec_accordo
                                  AND lis_sis_vers.dt_erog <=
                                      accordo.dt_scad_accordo)) tmp
    UNION
    -- tipo accordo NO_CLASSE_ENTE - calcolo servizi di conservazione tariffa su accordo
    SELECT accordo.id_accordo_ente,
           tipo_serv.cd_tipo_servizio         nm_servizio_erogato,
           tipo_serv.id_tipo_servizio,
           NULL                               id_sistema_versante,
           accordo.fl_pagamento,
           NULL                               id_tariffa,
           tariffa_acc.id_tariffa_accordo,
           NULL                               id_tariffa_aa_accordo,
           tariffa_acc.im_tariffa_accordo     im_valore_tariffa,
           NULL                               dt_erog, -- data erogazione calcolata da calcolo contenuto Sacer
           NULL                               AA_ANNO_ACCORDO
      FROM ORG_ACCORDO_ENTE  accordo
           JOIN ORG_TIPO_ACCORDO ti_acc
               ON (    ti_acc.id_tipo_accordo = accordo.id_tipo_accordo
                   AND ti_acc.cd_algo_tariffario = 'NO_CLASSE_ENTE')
           JOIN ORG_TIPO_SERVIZIO tipo_serv
               ON (    tipo_serv.ti_classe_tipo_servizio IN ('CONSERVAZIONE')
                   AND tipo_serv.fl_tariffa_accordo = 1)
           JOIN ORG_TARIFFA_ACCORDO tariffa_acc
               ON (    accordo.id_accordo_ente = tariffa_acc.id_accordo_ente
                   AND tipo_serv.id_tipo_servizio =
                       tariffa_acc.id_tipo_servizio)
    UNION
    -- tipo accordo NO_CLASSE_ENTE - calcolo servizi di conservazione tariffa su annualità
    SELECT accordo.id_accordo_ente,
           tipo_serv.cd_tipo_servizio || ' ' || AA_ANNO_ACCORDO
               nm_servizio_erogato,
           tipo_serv.id_tipo_servizio,
           NULL
               id_sistema_versante,
           accordo.fl_pagamento,
           NULL
               id_tariffa,
           NULL
               id_tariffa_accordo,
           tariffa_annualita_acc.id_tariffa_aa_accordo,
           tariffa_annualita_acc.im_tariffa_aa_accordo
               im_valore_tariffa,
           CASE
               WHEN EXTRACT (YEAR FROM accordo.DT_DEC_ACCORDO) <
                    aa_anno_accordo
               THEN
                   TO_DATE ('01/01/' || aa_anno_accordo, 'dd/mm/yyyy')
               WHEN EXTRACT (YEAR FROM accordo.DT_DEC_ACCORDO) =
                    aa_anno_accordo
               THEN
                   accordo.DT_DEC_ACCORDO
               ELSE
                   NULL
           END
               AS dt_eorg, -- data erogazione calcolata da calcolo contenuto Sacer
           -- null AA_ANNO_ACCORDO
           (SELECT b.aa_anno_accordo
              FROM org_tariffa_aa_accordo  a
                   JOIN org_aa_accordo b ON a.id_aa_accordo = b.id_aa_accordo
             WHERE a.id_tariffa_aa_accordo =
                   tariffa_annualita_acc.id_tariffa_aa_accordo)
               AS AA_ANNO_ACCORDO
      FROM ORG_ACCORDO_ENTE  accordo
           JOIN ORG_TIPO_ACCORDO ti_acc
               ON (    ti_acc.id_tipo_accordo = accordo.id_tipo_accordo
                   AND ti_acc.cd_algo_tariffario = 'NO_CLASSE_ENTE')
           JOIN ORG_TIPO_SERVIZIO tipo_serv
               ON (    tipo_serv.ti_classe_tipo_servizio IN ('CONSERVAZIONE')
                   AND tipo_serv.fl_tariffa_annualita = 1)
           JOIN ORG_AA_ACCORDO annualita_acc
               ON (annualita_acc.id_accordo_ente = accordo.id_accordo_ente)
           JOIN ORG_TARIFFA_AA_ACCORDO tariffa_annualita_acc
               ON (    annualita_acc.id_aa_accordo =
                       tariffa_annualita_acc.id_aa_accordo
                   AND tariffa_annualita_acc.id_tipo_servizio =
                       tipo_serv.id_tipo_servizio)
    UNION
    -- tipo accordo NO_CLASSE_ENTE - calcolo servizi  altro  tariffa su accordo
    SELECT accordo.id_accordo_ente,
           tipo_serv.cd_tipo_servizio         nm_servizio_erogato,
           tipo_serv.id_tipo_servizio,
           NULL                               id_sistema_versante,
           accordo.fl_pagamento,
           NULL                               id_tariffa,
           tariffa_acc.id_tariffa_accordo,
           NULL                               id_tariffa_aa_accordo,
           tariffa_acc.im_tariffa_accordo     im_valore_tariffa,
           NULL                               dt_erog, -- data erogazione definita manualmente
           NULL                               AA_ANNO_ACCORDO -- data erogazione calcolata da calcolo contenuto Sacer
      FROM ORG_ACCORDO_ENTE  accordo
           JOIN ORG_TIPO_ACCORDO ti_acc
               ON (    ti_acc.id_tipo_accordo = accordo.id_tipo_accordo
                   AND ti_acc.cd_algo_tariffario = 'NO_CLASSE_ENTE')
           JOIN ORG_TIPO_SERVIZIO tipo_serv
               ON (    tipo_serv.ti_classe_tipo_servizio IN
                           ('ALTRO_ANNUALITA')
                   AND tipo_serv.fl_tariffa_accordo = 1)
           JOIN ORG_TARIFFA_ACCORDO tariffa_acc
               ON (    accordo.id_accordo_ente = tariffa_acc.id_accordo_ente
                   AND tipo_serv.id_tipo_servizio =
                       tariffa_acc.id_tipo_servizio)
    UNION
    -- tipo accordo NO_CLASSE_ENTE - calcolo servizi  altro  tariffa su annualità
    SELECT accordo.id_accordo_ente,
           tipo_serv.cd_tipo_servizio || ' ' || AA_ANNO_ACCORDO
               nm_servizio_erogato,
           tipo_serv.id_tipo_servizio,
           NULL
               id_sistema_versante,
           accordo.fl_pagamento,
           NULL
               id_tariffa,
           NULL
               id_tariffa_accordo,
           tariffa_annualita_acc.id_tariffa_aa_accordo,
           tariffa_annualita_acc.im_tariffa_aa_accordo
               im_valore_tariffa,
           -- NULL                                            dt_erog, -- data erogazione definita manualmente
           --null AA_ANNO_ACCORDO

           CASE
               WHEN EXTRACT (YEAR FROM accordo.DT_DEC_ACCORDO) <
                    aa_anno_accordo
               THEN
                   TO_DATE ('01/01/' || aa_anno_accordo, 'dd/mm/yyyy')
               WHEN EXTRACT (YEAR FROM accordo.DT_DEC_ACCORDO) =
                    aa_anno_accordo
               THEN
                   accordo.DT_DEC_ACCORDO
               ELSE
                   NULL
           END
               AS dt_eorg,
           (SELECT b.aa_anno_accordo
              FROM org_tariffa_aa_accordo  a
                   JOIN org_aa_accordo b ON a.id_aa_accordo = b.id_aa_accordo
             WHERE a.id_tariffa_aa_accordo =
                   tariffa_annualita_acc.id_tariffa_aa_accordo)
               AS AA_ANNO_ACCORDO
      FROM ORG_ACCORDO_ENTE  accordo
           JOIN ORG_TIPO_ACCORDO ti_acc
               ON (    ti_acc.id_tipo_accordo = accordo.id_tipo_accordo
                   AND ti_acc.cd_algo_tariffario = 'NO_CLASSE_ENTE')
           JOIN ORG_TIPO_SERVIZIO tipo_serv
               ON (    tipo_serv.ti_classe_tipo_servizio IN
                           ('ALTRO_ANNUALITA')
                   AND tipo_serv.fl_tariffa_annualita = 1)
           JOIN ORG_AA_ACCORDO annualita_acc
               ON (annualita_acc.id_accordo_ente = accordo.id_accordo_ente)
           JOIN ORG_TARIFFA_AA_ACCORDO tariffa_annualita_acc
               ON (    annualita_acc.id_aa_accordo =
                       tariffa_annualita_acc.id_aa_accordo
                   AND tariffa_annualita_acc.id_tipo_servizio =
                       tipo_serv.id_tipo_servizio)
    UNION
    -- tipo accordo NO_CLASSE_ENTE - calcolo servizi di attivazione tariffa su accordo
    SELECT accordo.id_accordo_ente,
           tipo_serv.cd_tipo_servizio         nm_servizio_erogato,
           tipo_serv.id_tipo_servizio,
           NULL                               id_sistema_versante,
           accordo.fl_pagamento,
           NULL                               id_tariffa,
           tariffa_acc.id_tariffa_accordo,
           NULL                               id_tariffa_aa_accordo,
           tariffa_acc.im_tariffa_accordo     im_valore_tariffa,
           NULL                               dt_erog, -- data erogazione calcolata da calcolo contenuto Sacer
           NULL                               AA_ANNO_ACCORDO
      FROM ORG_ACCORDO_ENTE  accordo
           JOIN ORG_TIPO_ACCORDO ti_acc
               ON (    ti_acc.id_tipo_accordo = accordo.id_tipo_accordo
                   AND ti_acc.cd_algo_tariffario = 'NO_CLASSE_ENTE')
           JOIN ORG_TIPO_SERVIZIO tipo_serv
               ON (    tipo_serv.ti_classe_tipo_servizio IN
                           ('ATTIVAZIONE_TIPO_UD')
                   AND tipo_serv.fl_tariffa_accordo = 1)
           JOIN ORG_TARIFFA_ACCORDO tariffa_acc
               ON (    accordo.id_accordo_ente = tariffa_acc.id_accordo_ente
                   AND tipo_serv.id_tipo_servizio =
                       tariffa_acc.id_tipo_servizio)
           LEFT JOIN org_servizio_erog erog
               ON (    erog.id_tipo_servizio = tipo_serv.id_tipo_servizio
                   AND erog.id_accordo_ente = accordo.id_accordo_ente)
    --     WHERE    erog.dt_erog IS NULL
    --           OR (    erog.dt_erog < accordo.dt_dec_accordo
    --               AND erog.dt_erog < accordo.dt_scad_accordo)
    UNION
    -- tipo accordo NO_CLASSE_ENTE - calcolo servizi di attivazione tariffa su annualità
    SELECT accordo.id_accordo_ente,
           tipo_serv.cd_tipo_servizio || ' ' || AA_ANNO_ACCORDO
               nm_servizio_erogato,
           tipo_serv.id_tipo_servizio,
           NULL
               id_sistema_versante,
           accordo.fl_pagamento,
           NULL
               id_tariffa,
           NULL
               id_tariffa_accordo,
           tariffa_annualita_acc.id_tariffa_aa_accordo,
           tariffa_annualita_acc.im_tariffa_aa_accordo
               im_valore_tariffa,
           --NULL                                            dt_erog, -- data erogazione calcolata da calcolo contenuto Sacer

           CASE
               WHEN EXTRACT (YEAR FROM accordo.DT_DEC_ACCORDO) <
                    aa_anno_accordo
               THEN
                   TO_DATE ('01/01/' || aa_anno_accordo, 'dd/mm/yyyy')
               WHEN EXTRACT (YEAR FROM accordo.DT_DEC_ACCORDO) =
                    aa_anno_accordo
               THEN
                   accordo.DT_DEC_ACCORDO
               ELSE
                   NULL
           END
               AS dt_eorg,
           --null AA_ANNO_ACCORDO
           (SELECT b.aa_anno_accordo
              FROM org_tariffa_aa_accordo  a
                   JOIN org_aa_accordo b ON a.id_aa_accordo = b.id_aa_accordo
             WHERE a.id_tariffa_aa_accordo =
                   tariffa_annualita_acc.id_tariffa_aa_accordo)
               AS AA_ANNO_ACCORDO
      FROM ORG_ACCORDO_ENTE  accordo
           JOIN ORG_TIPO_ACCORDO ti_acc
               ON (    ti_acc.id_tipo_accordo = accordo.id_tipo_accordo
                   AND ti_acc.cd_algo_tariffario = 'NO_CLASSE_ENTE')
           JOIN ORG_TIPO_SERVIZIO tipo_serv
               ON (    tipo_serv.ti_classe_tipo_servizio IN
                           ('ATTIVAZIONE_TIPO_UD')
                   AND tipo_serv.fl_tariffa_annualita = 1)
           JOIN ORG_AA_ACCORDO annualita_acc
               ON (annualita_acc.id_accordo_ente = accordo.id_accordo_ente)
           JOIN ORG_TARIFFA_AA_ACCORDO tariffa_annualita_acc
               ON (    annualita_acc.id_aa_accordo =
                       tariffa_annualita_acc.id_aa_accordo
                   AND tariffa_annualita_acc.id_tipo_servizio =
                       tipo_serv.id_tipo_servizio)
           LEFT JOIN org_servizio_erog erog
               ON (    erog.id_tipo_servizio = tipo_serv.id_tipo_servizio
                   AND erog.id_accordo_ente = accordo.id_accordo_ente);

-- changeset root:1753259446745-394
COMMENT ON COLUMN ORG_V_CREA_SERV_EROG_BY_ACC.ID_ACCORDO_ENTE IS 'PK.1';

-- changeset root:1753259446745-395
COMMENT ON COLUMN ORG_V_CREA_SERV_EROG_BY_ACC.NM_SERVIZIO_EROGATO IS 'PK.2';

-- changeset root:1753259446745-396
CREATE OR REPLACE FORCE VIEW "ORG_V_OCCUP_STORAGE_ACCORDO" ("AMBIENTE_ENTE", "NM_AMBIENTE_ENTE_CONVENZ", "NM_ENTE_SIAM", "ID_ACCORDO_ENTE", "DT_DEC_ACCORDO", "CD_TIPO_ACCORDO", "MESI_VALIDITA", "NUM_UD", "NUM_DOC", "NUM_COMP", "DIM_BYTES", "DIM_BYTES_MEDIA_ANNO", "DT_FINE_ACCORDO", "NI_FASCIA_ACCORDO_A", "FASCIA_ACCORDO", "NI_FASCIA_OCCUPAZIONE_A", "FASCIA_OCCUPAZIONE", "FL_SFORO", "DT_DEC_ACCORDO_INFO_ACC", "DT_SCAD_ACCORDO_ACC", "DT_DEC_ACCORDO_ACC", "DT_FINE_VALID_ACCORDO_ACC") AS SELECT
    media_annuale_ente_convenz."AMBIENTE_ENTE",media_annuale_ente_convenz."NM_AMBIENTE_ENTE_CONVENZ",media_annuale_ente_convenz."NM_ENTE_SIAM",media_annuale_ente_convenz."ID_ACCORDO_ENTE",media_annuale_ente_convenz."DT_DEC_ACCORDO",media_annuale_ente_convenz."CD_TIPO_ACCORDO",media_annuale_ente_convenz."MESI_VALIDITA",media_annuale_ente_convenz."NUM_UD",media_annuale_ente_convenz."NUM_DOC",media_annuale_ente_convenz."NUM_COMP",media_annuale_ente_convenz."DIM_BYTES",media_annuale_ente_convenz."DIM_BYTES_MEDIA_ANNO",
	add_months(media_annuale_ente_convenz.DT_DEC_ACCORDO, media_annuale_ente_convenz.MESI_VALIDITA-MOD(media_annuale_ente_convenz.MESI_VALIDITA,12))-1 as DT_FINE_ACCORDO,
    CASE
        WHEN fascia_storage_accordo_manuale.ti_fascia IS NOT NULL THEN
            fascia_storage_accordo_manuale.ni_fascia_a
        WHEN fascia_storage_accordo_standard.ti_fascia IS NOT NULL THEN
            fascia_storage_accordo_standard.ni_fascia_a
        ELSE
            null
    END AS ni_fascia_accordo_a,
    CASE
        WHEN fascia_storage_accordo_manuale.ti_fascia IS NOT NULL THEN
            fascia_storage_accordo_manuale.ti_fascia
            || ' - da '
            || trim(to_char(fascia_storage_accordo_manuale.ni_fascia_da, '999G999G999G999G999'))
            || ' a '
            || trim(to_char(fascia_storage_accordo_manuale.ni_fascia_a, '999G999G999G999G999'))
        WHEN fascia_storage_accordo_standard.ti_fascia IS NOT NULL THEN
            fascia_storage_accordo_standard.ti_fascia
            || ' - da '
            || trim(to_char(fascia_storage_accordo_standard.ni_fascia_da, '999G999G999G999G999'))
            || ' a '
            || trim(to_char(fascia_storage_accordo_standard.ni_fascia_a, '999G999G999G999G999'))
        ELSE
            'non definita'
    END AS fascia_accordo,
    (
        SELECT
            fascia_storage_accordo_occup.ni_fascia_a
        FROM
            sacer_iam.org_fascia_storage_accordo fascia_storage_accordo_occup
        WHERE
            media_annuale_ente_convenz.dim_bytes_media_anno BETWEEN fascia_storage_accordo_occup.ni_fascia_da AND fascia_storage_accordo_occup.ni_fascia_a
    )   AS ni_fascia_occupazione_a,
    (
        SELECT
            fascia_storage_accordo_occup.ti_fascia
            || ' - da '
            || trim(to_char(fascia_storage_accordo_occup.ni_fascia_da, '999G999G999G999G999'))
            || ' a '
            || trim(to_char(fascia_storage_accordo_occup.ni_fascia_a, '999G999G999G999G999'))
        FROM
            sacer_iam.org_fascia_storage_accordo fascia_storage_accordo_occup
        WHERE
            media_annuale_ente_convenz.dim_bytes_media_anno BETWEEN fascia_storage_accordo_occup.ni_fascia_da AND fascia_storage_accordo_occup.ni_fascia_a
    )   AS fascia_occupazione,
    CASE
        WHEN fascia_storage_accordo_manuale.ti_fascia IS NOT NULL
        THEN
            CASE
                WHEN
                media_annuale_ente_convenz.dim_bytes_media_anno - ( fascia_storage_accordo_manuale.ni_fascia_a * 20 / 100 ) > fascia_storage_accordo_manuale.ni_fascia_a -- sforo del 20%
                THEN
                    1
                ELSE
                    0        
                END
        WHEN fascia_storage_accordo_standard.ti_fascia IS NOT NULL
        THEN
            CASE
                WHEN
                media_annuale_ente_convenz.dim_bytes_media_anno - ( fascia_storage_accordo_standard.ni_fascia_a * 20 / 100 ) > fascia_storage_accordo_standard.ni_fascia_a -- sforo del 20%
                THEN
                    1
                ELSE
                    0  
                END
        ELSE
            0
    END fl_sforo,
    accordo_ente.dt_dec_accordo_info as dt_dec_accordo_info_acc,
    accordo_ente.dt_scad_accordo as dt_scad_accordo_acc,
    accordo_ente.dt_dec_accordo as dt_dec_accordo_acc,
    accordo_ente.dt_fine_valid_accordo as dt_fine_valid_accordo_acc
FROM
         sacer_iam.org_v_media_annuale_ente_convenz media_annuale_ente_convenz
    JOIN sacer_iam.org_accordo_ente           accordo_ente ON ( accordo_ente.id_accordo_ente = media_annuale_ente_convenz.id_accordo_ente)
    LEFT JOIN sacer_iam.org_fascia_storage_accordo fascia_storage_accordo_standard ON ( fascia_storage_accordo_standard.id_fascia_storage_accordo = accordo_ente.id_fascia_storage_standard_accordo)
    LEFT JOIN sacer_iam.org_fascia_storage_accordo fascia_storage_accordo_manuale ON ( fascia_storage_accordo_manuale.id_fascia_storage_accordo = accordo_ente.id_fascia_storage_manuale_accordo);

-- changeset root:1753259446745-397
COMMENT ON COLUMN ORG_V_OCCUP_STORAGE_ACCORDO.ID_ACCORDO_ENTE IS 'PK.1';

-- changeset root:1753259446745-398
CREATE OR REPLACE FORCE VIEW "APL_V_TREE_ENTRY_MENU" ("ID_ENTRY_MENU", "ID_APPLIC", "NM_ENTRY_MENU", "DS_ENTRY_MENU", "NI_LIVELLO_ENTRY_MENU", "NI_ORD_ENTRY_MENU", "ID_ENTRY_MENU_PADRE", "DL_LINK_ENTRY_MENU", "DL_COMPOSITO_ENTRY_MENU", "DL_PATH_ID_ENTRY_MENU", "DL_COMPOSITO_NM_ENTRY_MENU") AS select 
 id_entry_menu, 
 id_applic, 
 nm_entry_menu, 
 ds_entry_menu, 
 ni_livello_entry_menu, 
 ni_ord_entry_menu, 
 id_entry_menu_padre, 
 dl_link_entry_menu,
 ltrim(sys_connect_by_path (ds_entry_menu, ' - '), ' - '),
 sys_connect_by_path (id_entry_menu, '/'),
 
 sys_connect_by_path (nm_entry_menu, '~~') dl_composito_nm_entry_menu
from APL_ENTRY_MENU entry

start with entry.id_entry_menu_padre is null
connect by prior entry.id_entry_menu = entry.id_entry_menu_padre;

-- changeset root:1753259446745-399
COMMENT ON COLUMN APL_V_TREE_ENTRY_MENU.ID_ENTRY_MENU IS 'PK.1 relativa a tabella APL_ENTRY_MENU';

-- changeset root:1753259446745-400
CREATE OR REPLACE FORCE VIEW "PRF_V_CALC_AUTOR_RUOLO" ("NM_RUOLO", "ID_RUOLO", "NM_APPLIC", "ID_APPLIC", "ID_USO_RUOLO_APPLIC", "TI_DICH_AUTOR", "ID_AUTOR", "DS_AUTOR") AS select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
menu.id_entry_menu id_autor, menu.dl_composito_entry_menu ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)
 
join APL_V_TREE_ENTRY_MENU menu
on (menu.id_applic = uso_ruo.id_applic
and menu.nm_entry_menu like '%')
where dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI'
and dich.ti_dich_autor = 'ENTRY_MENU'

UNION

--		caso ALL_ABILITAZIONI_CHILD per ENTRY_MENU
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
menu.id_entry_menu id_autor, menu.dl_composito_entry_menu ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_V_TREE_ENTRY_MENU menu
on (menu.id_entry_menu_padre = dich.id_entry_menu_padre)

where dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI_CHILD'
and dich.ti_dich_autor = 'ENTRY_MENU'

UNION

--		caso ALL_ABILITAZIONI_CHILD per ENTRY_MENU per la entry specificata nella dichiarazione
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
menu.id_entry_menu id_autor, menu.dl_composito_entry_menu ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_V_TREE_ENTRY_MENU menu
on (menu.id_entry_menu = dich.id_entry_menu_padre)

where dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI_CHILD'
and dich.ti_dich_autor = 'ENTRY_MENU'

UNION

--		caso ALL_ABILITAZIONI_CHILD per ENTRY_MENU (per il padre di I livello della entry specificata nella dichiarazione)
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
menu.id_entry_menu id_autor, menu.dl_composito_entry_menu ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_ENTRY_MENU menu_dich
on (menu_dich.id_entry_menu = dich.id_entry_menu_padre)
join APL_V_TREE_ENTRY_MENU menu
on (menu.id_entry_menu = menu_dich.id_entry_menu_padre)

where dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI_CHILD'
and dich.ti_dich_autor = 'ENTRY_MENU'

UNION

--		caso ALL_ABILITAZIONI_CHILD per ENTRY_MENU (per il padre di II livello della entry specificata nella dichiarazione)
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
menu.id_entry_menu id_autor, menu.dl_composito_entry_menu ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_ENTRY_MENU menu_dich
on (menu_dich.id_entry_menu = dich.id_entry_menu_padre)

join APL_ENTRY_MENU menu_1
on (menu_1.id_entry_menu = dich.id_entry_menu_padre)
join APL_V_TREE_ENTRY_MENU menu
on (menu.id_entry_menu = menu_1.id_entry_menu_padre)

where dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI_CHILD'
and dich.ti_dich_autor = 'ENTRY_MENU'

UNION

--		caso UNA_ABILITAZIONE per ENTRY_MENU
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
menu.id_entry_menu id_autor, menu.dl_composito_entry_menu ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_V_TREE_ENTRY_MENU menu
on (menu.id_entry_menu = dich.id_entry_menu_foglia)
where dich.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
and dich.ti_dich_autor = 'ENTRY_MENU'

UNION

--		caso UNA_ABILITAZIONE per ENTRY_MENU (per il padre di I livello della entry specificata nella dichiarazione)
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
menu.id_entry_menu id_autor, menu.dl_composito_entry_menu ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_ENTRY_MENU menu_dich
on (menu_dich.id_entry_menu = dich.id_entry_menu_foglia)
join APL_V_TREE_ENTRY_MENU menu
on (menu.id_entry_menu = menu_dich.id_entry_menu_padre)

where dich.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
and dich.ti_dich_autor = 'ENTRY_MENU'

UNION

--		caso UNA_ABILITAZIONE per ENTRY_MENU (per il padre di II livello della entry specificata nella dichiarazione)
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
menu.id_entry_menu id_autor, menu.dl_composito_entry_menu ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_ENTRY_MENU menu_dich
on (menu_dich.id_entry_menu = dich.id_entry_menu_foglia)

join APL_ENTRY_MENU menu_1
on (menu_1.id_entry_menu = menu_dich.id_entry_menu_padre)
join APL_V_TREE_ENTRY_MENU menu
on (menu.id_entry_menu = menu_1.id_entry_menu_padre)

where dich.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
and dich.ti_dich_autor = 'ENTRY_MENU'


UNION

--		caso ALL_ABILITAZIONI per PAGINA
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
pag.id_pagina_web id_autor, pag.ds_pagina_web ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_PAGINA_WEB pag
on (pag.id_applic = uso_ruo.id_applic
and pag.nm_pagina_web like '%')
where dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI'
and dich.ti_dich_autor = 'PAGINA'

UNION

--		caso UNA_ABILITAZIONE per PAGINA
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
pag.id_pagina_web id_autor, pag.ds_pagina_web ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_PAGINA_WEB pag
on (pag.id_pagina_web = dich.id_pagina_web)
where dich.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
and dich.ti_dich_autor = 'PAGINA'

UNION

--		caso ALL_ABILITAZIONI per AZIONE
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
azio.id_azione_pagina id_autor, pag.ds_pagina_web || ' --> ' || azio.ds_azione_pagina ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_AZIONE_PAGINA azio
on (azio.nm_azione_pagina like '%')
join APL_PAGINA_WEB pag
on (pag.id_pagina_web = azio.id_pagina_web
and pag.id_applic = uso_ruo.id_applic)
where dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI'
and dich.ti_dich_autor = 'AZIONE'

UNION

--		caso ALL_ABILITAZIONI per AZIONE su PAGINA
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
'PAGINA',
pag.id_pagina_web id_autor, pag.ds_pagina_web ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_AZIONE_PAGINA azio
on (azio.nm_azione_pagina like '%')
join APL_PAGINA_WEB pag
on (pag.id_pagina_web = azio.id_pagina_web
and pag.id_applic = uso_ruo.id_applic)
where dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI'
and dich.ti_dich_autor = 'AZIONE'

UNION

--		caso ALL_ABILITAZIONI_CHILD per AZIONE
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
azio.id_azione_pagina id_autor, pag.ds_pagina_web || ' --> ' || azio.ds_azione_pagina ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_AZIONE_PAGINA azio
on (azio.id_pagina_web = dich.id_pagina_web)
join APL_PAGINA_WEB pag
on (pag.id_pagina_web = azio.id_pagina_web)

where dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI_CHILD'
and dich.ti_dich_autor = 'AZIONE'

UNION

--		caso ALL_ABILITAZIONI_CHILD per AZIONE su PAGINA
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
'PAGINA',
pag.id_pagina_web id_autor, pag.ds_pagina_web ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_PAGINA_WEB pag
on (pag.id_pagina_web = dich.id_pagina_web)

where dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI_CHILD'
and dich.ti_dich_autor = 'AZIONE'

UNION

--		caso UNA_ABILITAZIONE per AZIONE
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
azio.id_azione_pagina id_autor, pag.ds_pagina_web || ' --> ' || azio.ds_azione_pagina ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_AZIONE_PAGINA azio
on (azio.id_azione_pagina = dich.id_azione_pagina)
join APL_PAGINA_WEB pag
on (pag.id_pagina_web = azio.id_pagina_web)

where dich.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
and dich.ti_dich_autor = 'AZIONE'

UNION

--		caso UNA_ABILITAZIONE per AZIONE su PAGINA
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
'PAGINA',
pag.id_pagina_web id_autor, pag.ds_pagina_web ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_AZIONE_PAGINA azio
on (azio.id_azione_pagina = dich.id_azione_pagina)
join APL_PAGINA_WEB pag
on (pag.id_pagina_web = azio.id_pagina_web)

where dich.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
and dich.ti_dich_autor = 'AZIONE'

UNION

--		caso ALL_ABILITAZIONI per SERVIZIO_WEB
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
serv.id_servizio_web id_autor, serv.ds_servizio_web ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_SERVIZIO_WEB serv
on (serv.id_applic = uso_ruo.id_applic
and serv.nm_servizio_web like '%')
where dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI'
and dich.ti_dich_autor = 'SERVIZIO_WEB'

UNION

--		caso UNA_ABILITAZIONE per SERVIZIO_WEB
select
ruo.nm_ruolo, ruo.id_ruolo,
apl.nm_applic, apl.id_applic,

dich.id_uso_ruolo_applic,
dich.ti_dich_autor,
serv.id_servizio_web id_autor, serv.ds_servizio_web ds_autor

from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo
on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)

join APL_SERVIZIO_WEB serv
on (serv.id_servizio_web = dich.id_servizio_web)
where dich.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
and dich.ti_dich_autor = 'SERVIZIO_WEB';

-- changeset root:1753259446745-401
COMMENT ON COLUMN PRF_V_CALC_AUTOR_RUOLO.ID_RUOLO IS 'PK.1';

-- changeset root:1753259446745-402
COMMENT ON COLUMN PRF_V_CALC_AUTOR_RUOLO.ID_APPLIC IS 'PK.2';

-- changeset root:1753259446745-403
COMMENT ON COLUMN PRF_V_CALC_AUTOR_RUOLO.TI_DICH_AUTOR IS 'PK.3';

-- changeset root:1753259446745-404
COMMENT ON COLUMN PRF_V_CALC_AUTOR_RUOLO.ID_AUTOR IS 'PK.4';

-- changeset root:1753259446745-405
CREATE OR REPLACE FORCE VIEW "PRF_V_LIS_DICH_AUTOR" ("ID_RUOLO", "ID_USO_RUOLO_APPLIC", "ID_APPLIC", "NM_APPLIC", "ID_DICH_AUTOR", "TI_DICH_AUTOR", "TI_SCOPO_DICH_AUTOR", "NI_LIVELLO_ENTRY_MENU", "NI_ORD_ENTRY_MENU", "ID_ENTRY_MENU", "DS_ENTRY_MENU", "ID_PAGINA_WEB_AZIO", "DS_PAGINA_WEB_AZIO", "ID_AZIONE_PAGINA", "DS_AZIONE_PAGINA", "ID_PAGINA_WEB", "DS_PAGINA_WEB", "ID_SERVIZIO_WEB", "DS_SERVIZIO_WEB", "DS_PATH_ENTRY_MENU_PADRE", "DS_PATH_ENTRY_MENU_FOGLIA", "NM_PAGINA_WEB", "NM_AZIONE_PAGINA", "NM_SERVIZIO_WEB") AS select 
 uso_ruo.id_ruolo,
 uso_ruo.id_uso_ruolo_applic,
 uso_ruo.id_applic,
 apl.nm_applic,
 
 dich.id_dich_autor,
 dich.ti_dich_autor,
 dich.ti_scopo_dich_autor,
 case
	when dich.ti_dich_autor = 'ENTRY_MENU'  then
		case 
			when dich.id_entry_menu_padre is not null 
				then entrata_padre.ni_livello_entry_menu
				else
					case
						when dich.id_entry_menu_foglia is not null
							then entrata_foglia.ni_livello_entry_menu
							else null
					end
		end
 end ni_livello_entry_menu,
 case
	when dich.ti_dich_autor = 'ENTRY_MENU'  then
		case 
			when dich.id_entry_menu_padre is not null 
				then entrata_padre.ni_ord_entry_menu
				else
					case
						when dich.id_entry_menu_foglia is not null
							then entrata_foglia.ni_ord_entry_menu
							else null
					end
		end
 end ni_ord_entry_menu,
 
 case
	when dich.ti_dich_autor = 'ENTRY_MENU'  then
		case 
			when dich.id_entry_menu_padre is not null 
				then dich.id_entry_menu_padre
				else
					case
						when dich.id_entry_menu_foglia is not null
							then dich.id_entry_menu_foglia
							else null
					end
		end
 end id_entry_menu,
 case
	when dich.ti_dich_autor = 'ENTRY_MENU'  then
		case 
			when dich.id_entry_menu_padre is not null 
				then entrata_padre.dl_composito_entry_menu
				else
					case
						when dich.id_entry_menu_foglia is not null
							then entrata_foglia.dl_composito_entry_menu
							else null
					end
		end
 end ds_entry_menu,
 
 case
	when dich.ti_dich_autor = 'AZIONE'
		then 
			case
				when dich.id_azione_pagina is not null
					then pag_azio.id_pagina_web
					else
						case
							when dich.id_pagina_web is not null
								then pag.id_pagina_web
								else null
						end
			end
		else null
 end id_pagina_web_azio,
 case
	when dich.ti_dich_autor = 'AZIONE'
		then 
			case
				when dich.id_azione_pagina is not null
					then pag_azio.ds_pagina_web
					else
						case
							when dich.id_pagina_web is not null
								then pag.ds_pagina_web
								else null
						end
			end
		else null
 end ds_pagina_web_azio,
 case
	when dich.ti_dich_autor = 'AZIONE'
		then azio.id_azione_pagina
		else null
 end id_azione_pagina,
 case
	when dich.ti_dich_autor = 'AZIONE'
		then azio.ds_azione_pagina
		else null
 end ds_azione_pagina,
 
 
 case
	when dich.ti_dich_autor = 'PAGINA'
		then pag.id_pagina_web
		else null
 end id_pagina_web,
 case
	when dich.ti_dich_autor = 'PAGINA'
		then pag.ds_pagina_web
		else null
 end ds_pagina_web,
 
 case
	when dich.ti_dich_autor = 'SERVIZIO_WEB'
		then serv.id_servizio_web
		else null
 end id_servizio_web,
 case
	when dich.ti_dich_autor = 'SERVIZIO_WEB'
		then serv.ds_servizio_web
		else null
 end ds_servizio_web,
 
 case
	when dich.ti_dich_autor = 'ENTRY_MENU'  then
		case 
			when dich.id_entry_menu_padre is not null 
				then entrata_padre.dl_composito_nm_entry_menu
				else null
		end
 end ds_path_entry_menu_padre,
 
 case
	when dich.ti_dich_autor = 'ENTRY_MENU'  then
		case 
			when dich.id_entry_menu_padre is null 
				then entrata_foglia.dl_composito_nm_entry_menu
				else null
		end
 end ds_path_entry_menu_foglia, 
 
 case
	when dich.ti_dich_autor = 'PAGINA'
		then pag.nm_pagina_web
	when dich.ti_dich_autor = 'AZIONE'
		then pag_azio.nm_pagina_web	
		else null
 end nm_pagina_web,
 
 case
	when dich.ti_dich_autor = 'AZIONE'
		then azio.nm_azione_pagina
		else null
 end nm_azione_pagina,
 
 case
	when dich.ti_dich_autor = 'SERVIZIO_WEB'
		then serv.nm_servizio_web
		else null
 end nm_servizio_web 
 
from PRF_USO_RUOLO_APPLIC uso_ruo
join APL_APPLIC apl
 on (apl.id_applic  = uso_ruo.id_applic)

join PRF_DICH_AUTOR dich
 on (dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic)
 
left join APL_V_TREE_ENTRY_MENU entrata_padre
 on (entrata_padre.id_entry_menu = dich.id_entry_menu_padre)
left join APL_V_TREE_ENTRY_MENU entrata_foglia
 on (entrata_foglia.id_entry_menu = dich.id_entry_menu_foglia)
 
left join APL_AZIONE_PAGINA azio
 on (azio.id_azione_pagina = dich.id_azione_pagina)
left join APL_PAGINA_WEB pag_azio
 on (pag_azio.id_pagina_web = azio.id_pagina_web)
 
left join APL_PAGINA_WEB pag
 on (pag.id_pagina_web = dich.id_pagina_web)
left join APL_SERVIZIO_WEB serv

 on (serv.id_servizio_web = dich.id_servizio_web);

-- changeset root:1753259446745-406
COMMENT ON COLUMN PRF_V_LIS_DICH_AUTOR.ID_DICH_AUTOR IS 'PK.1 relativa a tabella PRF_DICH_AUTOR';

-- changeset root:1753259446745-407
CREATE OR REPLACE FORCE VIEW "PRF_V_LIS_DICH_AUTOR_DA_ALLIN" ("ID_RUOLO", "NM_APPLIC", "CD_VERSIONE_COMP", "ID_DICH_AUTOR", "TI_DICH_AUTOR", "TI_SCOPO_DICH_AUTOR", "DS_PATH_ENTRY_MENU_PADRE", "DS_PATH_ENTRY_MENU_FOGLIA", "NM_PAGINA_WEB", "NM_AZIONE_PAGINA", "NM_SERVIZIO_WEB") AS select 
 uso_ruo.id_ruolo,
 apl.nm_applic,
 apl.cd_versione_comp,
 
 dich.id_dich_autor,
 dich.ti_dich_autor,
 dich.ti_scopo_dich_autor,

 case
	when dich.ti_dich_autor = 'ENTRY_MENU'  then
		case 
			when dich.id_entry_menu_padre is not null 
				then entrata_padre.dl_composito_nm_entry_menu
				else null
		end
 end ds_path_entry_menu_padre,

 case
	when dich.ti_dich_autor = 'ENTRY_MENU'  then
		case 
			when dich.id_entry_menu_foglia is not null 
				then entrata_foglia.dl_composito_nm_entry_menu
				else null
		end
 end ds_path_entry_menu_foglia,

 case
	when dich.ti_dich_autor = 'PAGINA'
		then pag.nm_pagina_web
		else 
			case
				when dich.ti_dich_autor = 'AZIONE' and dich.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
					then pag_azio.nm_pagina_web
				when dich.ti_dich_autor = 'AZIONE' and dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI_CHILD'
					then pag.nm_pagina_web
					else null
			end
 end nm_pagina_web,

 case
	when dich.ti_dich_autor = 'AZIONE'
		then azio.nm_azione_pagina
		else null
 end nm_azione_pagina,
 
 case
	when dich.ti_dich_autor = 'SERVIZIO_WEB'
		then serv.nm_servizio_web
		else null
 end nm_servizio_web
 
from PRF_USO_RUOLO_APPLIC uso_ruo
join APL_APPLIC apl
 on (apl.id_applic  = uso_ruo.id_applic)

join PRF_DICH_AUTOR dich
 on (dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic)
left join APL_V_TREE_ENTRY_MENU entrata_padre
 on (entrata_padre.id_entry_menu = dich.id_entry_menu_padre)
left join APL_V_TREE_ENTRY_MENU entrata_foglia
 on (entrata_foglia.id_entry_menu = dich.id_entry_menu_foglia)
 
left join APL_AZIONE_PAGINA azio
 on (azio.id_azione_pagina = dich.id_azione_pagina)
left join APL_PAGINA_WEB pag_azio
 on (pag_azio.id_pagina_web = azio.id_pagina_web)
 
left join APL_PAGINA_WEB pag
 on (pag.id_pagina_web = dich.id_pagina_web)
 
left join APL_SERVIZIO_WEB serv
 on (serv.id_servizio_web = dich.id_servizio_web);

-- changeset root:1753259446745-408
COMMENT ON COLUMN PRF_V_LIS_DICH_AUTOR_DA_ALLIN.ID_DICH_AUTOR IS 'PK.1';

-- changeset root:1753259446745-409
CREATE OR REPLACE FORCE VIEW "APL_V_VIS_HELP_ON_LINE" ("ID_HELP_ON_LINE", "ID_APPLIC", "NM_APPLIC", "TI_HELP_ON_LINE", "DT_INI_VAL", "DT_FINE_VAL", "ID_PAGINA_WEB", "NM_PAGINA_WEB", "DS_PAGINA_WEB", "ID_ENTRY_MENU", "NM_ENTRY_MENU", "DL_COMPOSITO_ENTRY_MENU", "DS_FILE_HELP_ON_LINE", "BL_HELP_ON_LINE", "BL_SORGENTE_HELP_ON_LINE") AS select
 help.id_help_on_line,
 help.id_applic, applic.nm_applic,
 help.ti_help_on_line,
 help.dt_ini_val, help.dt_fine_val,
 help.id_pagina_web, pag.nm_pagina_web, pag.ds_pagina_web,
 help.id_entry_menu, menu.nm_entry_menu, menu.dl_composito_entry_menu,
 help.ds_file_help_on_line,
 help.bl_help_on_line,
 help.bl_sorgente_help_on_line
 
from APL_HELP_ON_LINE help
join APL_APPLIC applic
 on (applic.id_applic = help.id_applic)
join APL_PAGINA_WEB pag
 on (pag.id_pagina_web = help.id_pagina_web)
left join APL_V_TREE_ENTRY_MENU menu
 on (menu.id_entry_menu = help.id_entry_menu);

-- changeset root:1753259446745-410
COMMENT ON COLUMN APL_V_VIS_HELP_ON_LINE.ID_HELP_ON_LINE IS 'PK.1';

-- changeset root:1753259446745-411
CREATE OR REPLACE FORCE VIEW "PRF_V_DICH_DA_ALLIN_OK" ("ID_RUOLO", "NM_APPLIC", "FL_DICH_OK") AS select 
allinea_ruo.id_ruolo,
allinea_ruo.nm_applic,
case
	when allinea_ruo.ti_dich_autor = 'ENTRY_MENU'
	and allinea_ruo.ti_scopo_dich_autor = 'ALL_ABILITAZIONI'
		then '1'

	when allinea_ruo.ti_dich_autor = 'ENTRY_MENU'
	and allinea_ruo.ti_scopo_dich_autor = 'ALL_ABILITAZIONI_CHILD'
	and  exists (select *
				from APL_V_TREE_ENTRY_MENU tree_menu
				join APL_APPLIC apl
				 on (apl.id_applic = tree_menu.id_applic)
				where apl.nm_applic = allinea_ruo.nm_applic
				and tree_menu.dl_composito_nm_entry_menu = allinea_ruo.ds_path_entry_menu_padre
				)
		then '1'
	
	when allinea_ruo.ti_dich_autor = 'ENTRY_MENU'
	and allinea_ruo.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
	and exists (select *
				from APL_V_TREE_ENTRY_MENU tree_menu
				join APL_APPLIC apl
				 on (apl.id_applic = tree_menu.id_applic)
				where apl.nm_applic = allinea_ruo.nm_applic
				and tree_menu.dl_composito_nm_entry_menu = allinea_ruo.ds_path_entry_menu_foglia
				)
		then '1'
		
	when allinea_ruo.ti_dich_autor = 'PAGINA'
	and allinea_ruo.ti_scopo_dich_autor = 'ALL_ABILITAZIONI'
		then '1'
		
	when allinea_ruo.ti_dich_autor = 'PAGINA'
	and allinea_ruo.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
	and exists (select *
				from APL_PAGINA_WEB pag
				join APL_APPLIC apl
				 on (apl.id_applic = pag.id_applic)
				where apl.nm_applic = allinea_ruo.nm_applic
				and pag.nm_pagina_web = allinea_ruo.nm_pagina_web
				)
		then '1'
		
	when allinea_ruo.ti_dich_autor = 'AZIONE'
	and allinea_ruo.ti_scopo_dich_autor = 'ALL_ABILITAZIONI'
		then '1'
		
	when allinea_ruo.ti_dich_autor = 'AZIONE'
	and allinea_ruo.ti_scopo_dich_autor = 'ALL_ABILITAZIONI_CHILD'
	and exists (select *
				from APL_PAGINA_WEB pag
				join APL_APPLIC apl
				 on (apl.id_applic = pag.id_applic)
				where apl.nm_applic = allinea_ruo.nm_applic
				and pag.nm_pagina_web = allinea_ruo.nm_pagina_web
				)
		then '1'
		
	when allinea_ruo.ti_dich_autor = 'AZIONE'
	and allinea_ruo.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
	and exists (select *
				from APL_AZIONE_PAGINA azio
				join APL_PAGINA_WEB pag
				 on (pag.id_pagina_web = azio.id_pagina_web)
				join APL_APPLIC apl
				 on (apl.id_applic = pag.id_applic)
				where apl.nm_applic = allinea_ruo.nm_applic
				and pag.nm_pagina_web = allinea_ruo.nm_pagina_web
				and azio.nm_azione_pagina = allinea_ruo.nm_azione_pagina
				)
		then '1'
		
	when allinea_ruo.ti_dich_autor = 'SERVIZIO_WEB'
	and allinea_ruo.ti_scopo_dich_autor = 'ALL_ABILITAZIONI'
		then '1'
	
	when allinea_ruo.ti_dich_autor = 'SERVIZIO_WEB'
	and allinea_ruo.nm_servizio_web is not null
	and exists (select *
				from APL_SERVIZIO_WEB serv
				join APL_APPLIC apl
				 on (apl.id_applic = serv.id_applic)
				where apl.nm_applic = allinea_ruo.nm_applic
				and serv.nm_servizio_web = allinea_ruo.nm_servizio_web
				)
		then '1'
		else '0'
end fl_dich_ok
from PRF_ALLINEA_RUOLO allinea_ruo;

-- changeset root:1753259446745-412
CREATE OR REPLACE FORCE VIEW "PRF_V_LIS_DICH_ALLINEA_TOADD" ("ID_ALLINEA_RUOLO", "ID_RUOLO", "ID_USO_RUOLO_APPLIC", "TI_DICH_AUTOR", "TI_SCOPO_DICH_AUTOR", "ID_ENTRY_MENU_PADRE", "ID_ENTRY_MENU_FOGLIA", "ID_PAGINA_WEB", "ID_AZIONE_PAGINA", "ID_SERVIZIO_WEB") AS select 
tmp.id_allinea_ruolo,
tmp.id_ruolo,
tmp.id_uso_ruolo_applic,
tmp.ti_dich_autor,
tmp.ti_scopo_dich_autor,
tmp.id_entry_menu_padre, 
tmp.id_entry_menu_foglia, 
tmp.id_pagina_web, 
tmp.id_azione_pagina, 
tmp.id_servizio_web
from (
		select
		allinea_ruo.id_allinea_ruolo,
		allinea_ruo.id_ruolo,
		uso_ruo.id_uso_ruolo_applic,
		allinea_ruo.ti_dich_autor,
		allinea_ruo.ti_scopo_dich_autor,
		null id_entry_menu_padre, 
		null id_entry_menu_foglia, 
		null id_pagina_web, 
		null id_azione_pagina, 
		null id_servizio_web

		from PRF_ALLINEA_RUOLO allinea_ruo
		join APL_APPLIC apl
		 on (apl.nm_applic = allinea_ruo.nm_applic)
		join PRF_USO_RUOLO_APPLIC uso_ruo 
		 on (uso_ruo.id_ruolo = allinea_ruo.id_ruolo
		 and uso_ruo.id_applic = apl.id_applic)
		where allinea_ruo.ti_scopo_dich_autor = 'ALL_ABILITAZIONI'
		and allinea_ruo.ti_dich_autor in ('ENTRY_MENU', 'PAGINA', 'AZIONE', 'SERVIZIO_WEB')
		and not exists (select *
						from PRF_DICH_AUTOR dich
						where dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
						and dich.ti_scopo_dich_autor = allinea_ruo.ti_scopo_dich_autor
						and dich.ti_dich_autor = allinea_ruo.ti_dich_autor
						)

		UNION

		select
		allinea_ruo.id_allinea_ruolo,
		allinea_ruo.id_ruolo,
		uso_ruo.id_uso_ruolo_applic,
		allinea_ruo.ti_dich_autor,
		allinea_ruo.ti_scopo_dich_autor,
		tree_menu.id_entry_menu id_entry_menu_padre, 
		null id_entry_menu_foglia, 
		null id_pagina_web, 
		null id_azione_pagina, 
		null id_servizio_web

		from PRF_ALLINEA_RUOLO allinea_ruo
		join APL_APPLIC apl
		 on (apl.nm_applic = allinea_ruo.nm_applic)
		join PRF_USO_RUOLO_APPLIC uso_ruo 
		 on (uso_ruo.id_ruolo = allinea_ruo.id_ruolo
		 and uso_ruo.id_applic = apl.id_applic)
		join APL_V_TREE_ENTRY_MENU tree_menu 
		 on (tree_menu.id_applic = apl.id_applic
		 and tree_menu.dl_composito_nm_entry_menu = allinea_ruo.ds_path_entry_menu_padre)
		where allinea_ruo.ti_scopo_dich_autor = 'ALL_ABILITAZIONI_CHILD'
		and allinea_ruo.ti_dich_autor = 'ENTRY_MENU'
		and not exists (select *
						from PRF_DICH_AUTOR dich
						where dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
						and dich.ti_scopo_dich_autor = allinea_ruo.ti_scopo_dich_autor
						and dich.ti_dich_autor = allinea_ruo.ti_dich_autor
						and dich.id_entry_menu_padre = tree_menu.id_entry_menu
						)

		UNION

		select
		allinea_ruo.id_allinea_ruolo,
		allinea_ruo.id_ruolo,
		uso_ruo.id_uso_ruolo_applic,
		allinea_ruo.ti_dich_autor,
		allinea_ruo.ti_scopo_dich_autor,
		null id_entry_menu_padre, 
		tree_menu.id_entry_menu id_entry_menu_foglia, 
		null id_pagina_web, 
		null id_azione_pagina, 
		null id_servizio_web

		from PRF_ALLINEA_RUOLO allinea_ruo
		join APL_APPLIC apl
		 on (apl.nm_applic = allinea_ruo.nm_applic)
		join PRF_USO_RUOLO_APPLIC uso_ruo 
		 on (uso_ruo.id_ruolo = allinea_ruo.id_ruolo
		 and uso_ruo.id_applic = apl.id_applic)
		join APL_V_TREE_ENTRY_MENU tree_menu 
		 on (tree_menu.id_applic = apl.id_applic
		 and tree_menu.dl_composito_nm_entry_menu = allinea_ruo.ds_path_entry_menu_foglia)
		where allinea_ruo.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
		and allinea_ruo.ti_dich_autor = 'ENTRY_MENU'
		and not exists (select *
						from PRF_DICH_AUTOR dich
						where dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
						and dich.ti_scopo_dich_autor = allinea_ruo.ti_scopo_dich_autor
						and dich.ti_dich_autor = allinea_ruo.ti_dich_autor
						and dich.id_entry_menu_foglia = tree_menu.id_entry_menu
						)

		UNION

		select
		allinea_ruo.id_allinea_ruolo,
		allinea_ruo.id_ruolo,
		uso_ruo.id_uso_ruolo_applic,
		allinea_ruo.ti_dich_autor,
		allinea_ruo.ti_scopo_dich_autor,
		null id_entry_menu_padre, 
		null id_entry_menu_foglia, 
		pag.id_pagina_web, 
		null id_azione_pagina, 
		null id_servizio_web

		from PRF_ALLINEA_RUOLO allinea_ruo
		join APL_APPLIC apl
		 on (apl.nm_applic = allinea_ruo.nm_applic)
		join PRF_USO_RUOLO_APPLIC uso_ruo 
		 on (uso_ruo.id_ruolo = allinea_ruo.id_ruolo
		 and uso_ruo.id_applic = apl.id_applic)
		join APL_PAGINA_WEB pag
		 on (pag.id_applic = apl.id_applic
		 and pag.nm_pagina_web = allinea_ruo.nm_pagina_web)
		where allinea_ruo.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
		and allinea_ruo.ti_dich_autor = 'PAGINA'
		and not exists (select *
						from PRF_DICH_AUTOR dich
						where dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
						and dich.ti_scopo_dich_autor = allinea_ruo.ti_scopo_dich_autor
						and dich.ti_dich_autor = allinea_ruo.ti_dich_autor
						and dich.id_pagina_web = pag.id_pagina_web
						)

		UNION
		select
		allinea_ruo.id_allinea_ruolo,
		allinea_ruo.id_ruolo,
		uso_ruo.id_uso_ruolo_applic,
		allinea_ruo.ti_dich_autor,
		allinea_ruo.ti_scopo_dich_autor,
		null id_entry_menu_padre, 
		null id_entry_menu_foglia, 
		pag.id_pagina_web, 
		null id_azione_pagina, 
		null id_servizio_web

		from PRF_ALLINEA_RUOLO allinea_ruo
		join APL_APPLIC apl
		 on (apl.nm_applic = allinea_ruo.nm_applic)
		join PRF_USO_RUOLO_APPLIC uso_ruo 
		 on (uso_ruo.id_ruolo = allinea_ruo.id_ruolo
		 and uso_ruo.id_applic = apl.id_applic)
		join APL_PAGINA_WEB pag
		 on (pag.id_applic = apl.id_applic
		 and pag.nm_pagina_web = allinea_ruo.nm_pagina_web)
		where allinea_ruo.ti_scopo_dich_autor = 'ALL_ABILITAZIONI_CHILD'
		and allinea_ruo.ti_dich_autor = 'AZIONE'
		and not exists (select *
						from PRF_DICH_AUTOR dich
						where dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
						and dich.ti_scopo_dich_autor = allinea_ruo.ti_scopo_dich_autor
						and dich.ti_dich_autor = allinea_ruo.ti_dich_autor
						and dich.id_pagina_web = pag.id_pagina_web
						)
								
		UNION
		select
		allinea_ruo.id_allinea_ruolo,
		allinea_ruo.id_ruolo,
		uso_ruo.id_uso_ruolo_applic,
		allinea_ruo.ti_dich_autor,
		allinea_ruo.ti_scopo_dich_autor,
		null id_entry_menu_padre, 
		null id_entry_menu_foglia, 
		pag.id_pagina_web, 
		azio.id_azione_pagina, 
		null id_servizio_web

		from PRF_ALLINEA_RUOLO allinea_ruo
		join APL_APPLIC apl
		 on (apl.nm_applic = allinea_ruo.nm_applic)
		join PRF_USO_RUOLO_APPLIC uso_ruo 
		 on (uso_ruo.id_ruolo = allinea_ruo.id_ruolo
		 and uso_ruo.id_applic = apl.id_applic)
		join APL_PAGINA_WEB pag
		 on (pag.id_applic = apl.id_applic
		 and pag.nm_pagina_web = allinea_ruo.nm_pagina_web)
		join APL_AZIONE_PAGINA azio
		 on (azio.id_pagina_web = pag.id_pagina_web
		 and azio.nm_azione_pagina = allinea_ruo.nm_azione_pagina)
		where allinea_ruo.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
		and allinea_ruo.ti_dich_autor = 'AZIONE'
		and not exists (select *
						from PRF_DICH_AUTOR dich
						where dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
						and dich.ti_scopo_dich_autor = allinea_ruo.ti_scopo_dich_autor
						and dich.ti_dich_autor = allinea_ruo.ti_dich_autor
						and dich.id_azione_pagina = azio.id_azione_pagina
						)

		UNION
		select
		allinea_ruo.id_allinea_ruolo,
		allinea_ruo.id_ruolo,
		uso_ruo.id_uso_ruolo_applic,
		allinea_ruo.ti_dich_autor,
		allinea_ruo.ti_scopo_dich_autor,
		null id_entry_menu_padre, 
		null id_entry_menu_foglia, 
		null id_pagina_web, 
		null id_azione_pagina, 
		serv.id_servizio_web

		from PRF_ALLINEA_RUOLO allinea_ruo
		join APL_APPLIC apl
		 on (apl.nm_applic = allinea_ruo.nm_applic)
		join PRF_USO_RUOLO_APPLIC uso_ruo 
		 on (uso_ruo.id_ruolo = allinea_ruo.id_ruolo
		 and uso_ruo.id_applic = apl.id_applic)
		join APL_SERVIZIO_WEB serv 
		 on (serv.id_applic = apl.id_applic
		 and serv.nm_servizio_web = allinea_ruo.nm_servizio_web)
		where allinea_ruo.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
		and allinea_ruo.ti_dich_autor = 'SERVIZIO_WEB'
		and not exists (select *
						from PRF_DICH_AUTOR dich
						where dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic
						and dich.ti_scopo_dich_autor = allinea_ruo.ti_scopo_dich_autor
						and dich.ti_dich_autor = allinea_ruo.ti_dich_autor
						and dich.id_servizio_web = serv.id_servizio_web
						)
	) tmp;

-- changeset root:1753259446745-413
COMMENT ON COLUMN PRF_V_LIS_DICH_ALLINEA_TOADD.ID_ALLINEA_RUOLO IS 'PK.1';

-- changeset root:1753259446745-414
CREATE OR REPLACE FORCE VIEW "PRF_V_LIS_DICH_ALLINEA_TODEL" ("ID_RUOLO", "ID_DICH_AUTOR") AS select 
ruo.id_ruolo,
dich.id_dich_autor
from PRF_RUOLO ruo
join PRF_USO_RUOLO_APPLIC uso_ruo 
 on (uso_ruo.id_ruolo = ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)
join PRF_DICH_AUTOR dich
 on (dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic)

where dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI'
and dich.ti_dich_autor in ('ENTRY_MENU', 'PAGINA', 'AZIONE', 'SERVIZIO_WEB')

and apl.nm_applic in (select distinct nm_applic
					  from PRF_ALLINEA_RUOLO apl_allinea_ruo
					  where apl_allinea_ruo.id_ruolo = ruo.id_ruolo 
					 )

and not exists (select *
			  from PRF_ALLINEA_RUOLO allinea_ruo
			  where allinea_ruo.id_ruolo = ruo.id_ruolo 
			  and allinea_ruo.nm_applic = apl.nm_applic
			  and allinea_ruo.ti_scopo_dich_autor = dich.ti_scopo_dich_autor
			  and allinea_ruo.ti_dich_autor = dich.ti_dich_autor
			  )

UNION

select 
ruo.id_ruolo,
dich.id_dich_autor
from PRF_RUOLO ruo
join PRF_USO_RUOLO_APPLIC uso_ruo 
 on (uso_ruo.id_ruolo = ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)
join PRF_DICH_AUTOR dich
 on (dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic)

join APL_V_TREE_ENTRY_MENU tree_menu
 on (tree_menu.id_entry_menu = dich.id_entry_menu_padre)
 
where dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI_CHILD'
and dich.ti_dich_autor = 'ENTRY_MENU'

and apl.nm_applic in (select distinct nm_applic
					  from PRF_ALLINEA_RUOLO apl_allinea_ruo
					  where apl_allinea_ruo.id_ruolo = ruo.id_ruolo 
					 )

and not exists (select *
			  from PRF_ALLINEA_RUOLO allinea_ruo
			  where allinea_ruo.id_ruolo = ruo.id_ruolo 
			  and allinea_ruo.nm_applic = apl.nm_applic
			  and allinea_ruo.ti_scopo_dich_autor = dich.ti_scopo_dich_autor
			  and allinea_ruo.ti_dich_autor = dich.ti_dich_autor
			  and allinea_ruo.ds_path_entry_menu_padre = tree_menu.dl_composito_nm_entry_menu
			  )

UNION

select 
ruo.id_ruolo,
dich.id_dich_autor
from PRF_RUOLO ruo
join PRF_USO_RUOLO_APPLIC uso_ruo 
 on (uso_ruo.id_ruolo = ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)
join PRF_DICH_AUTOR dich
 on (dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic)

join APL_V_TREE_ENTRY_MENU tree_menu
 on (tree_menu.id_entry_menu = dich.id_entry_menu_foglia)
 
where dich.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
and dich.ti_dich_autor = 'ENTRY_MENU'

and apl.nm_applic in (select distinct nm_applic
					  from PRF_ALLINEA_RUOLO apl_allinea_ruo
					  where apl_allinea_ruo.id_ruolo = ruo.id_ruolo 
					 )

and not exists (select *
			  from PRF_ALLINEA_RUOLO allinea_ruo
			  where allinea_ruo.id_ruolo = ruo.id_ruolo 
			  and allinea_ruo.nm_applic = apl.nm_applic
			  and allinea_ruo.ti_scopo_dich_autor = dich.ti_scopo_dich_autor
			  and allinea_ruo.ti_dich_autor = dich.ti_dich_autor
			  and allinea_ruo.ds_path_entry_menu_foglia = tree_menu.dl_composito_nm_entry_menu
			  )

UNION

select 
ruo.id_ruolo,
dich.id_dich_autor
from PRF_RUOLO ruo
join PRF_USO_RUOLO_APPLIC uso_ruo 
 on (uso_ruo.id_ruolo = ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)
join PRF_DICH_AUTOR dich
 on (dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic)

join APL_PAGINA_WEB pag 
 on (pag.id_pagina_web = dich.id_pagina_web)
 
where dich.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
and dich.ti_dich_autor = 'PAGINA'

and apl.nm_applic in (select distinct nm_applic
					  from PRF_ALLINEA_RUOLO apl_allinea_ruo
					  where apl_allinea_ruo.id_ruolo = ruo.id_ruolo 
					 )

and not exists (select *
			  from PRF_ALLINEA_RUOLO allinea_ruo
			  where allinea_ruo.id_ruolo = ruo.id_ruolo 
			  and allinea_ruo.nm_applic = apl.nm_applic
			  and allinea_ruo.ti_scopo_dich_autor = dich.ti_scopo_dich_autor
			  and allinea_ruo.ti_dich_autor = dich.ti_dich_autor
			  and allinea_ruo.nm_pagina_web = pag.nm_pagina_web
			  )

UNION

select 
ruo.id_ruolo,
dich.id_dich_autor
from PRF_RUOLO ruo
join PRF_USO_RUOLO_APPLIC uso_ruo 
 on (uso_ruo.id_ruolo = ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)
join PRF_DICH_AUTOR dich
 on (dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic)

join APL_PAGINA_WEB pag 
 on (pag.id_pagina_web = dich.id_pagina_web)
 
where dich.ti_scopo_dich_autor = 'ALL_ABILITAZIONI_CHILD'
and dich.ti_dich_autor = 'AZIONE'

and apl.nm_applic in (select distinct nm_applic
					  from PRF_ALLINEA_RUOLO apl_allinea_ruo
					  where apl_allinea_ruo.id_ruolo = ruo.id_ruolo 
					 )

and not exists (select *
			  from PRF_ALLINEA_RUOLO allinea_ruo
			  where allinea_ruo.id_ruolo = ruo.id_ruolo 
			  and allinea_ruo.nm_applic = apl.nm_applic
			  and allinea_ruo.ti_scopo_dich_autor = dich.ti_scopo_dich_autor
			  and allinea_ruo.ti_dich_autor = dich.ti_dich_autor
			  and allinea_ruo.nm_pagina_web = pag.nm_pagina_web
			  )

UNION

select 
ruo.id_ruolo,
dich.id_dich_autor
from PRF_RUOLO ruo
join PRF_USO_RUOLO_APPLIC uso_ruo 
 on (uso_ruo.id_ruolo = ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)
join PRF_DICH_AUTOR dich
 on (dich.id_uso_ruolo_applic = uso_ruo.id_uso_ruolo_applic)

join APL_AZIONE_PAGINA azio 
 on (azio.id_azione_pagina = dich.id_azione_pagina)
join APL_PAGINA_WEB pag 
 on (pag.id_pagina_web = azio.id_pagina_web)
 
where dich.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
and dich.ti_dich_autor = 'AZIONE'

and apl.nm_applic in (select distinct nm_applic
					  from PRF_ALLINEA_RUOLO apl_allinea_ruo
					  where apl_allinea_ruo.id_ruolo = ruo.id_ruolo 
					 )

and not exists (select *
			  from PRF_ALLINEA_RUOLO allinea_ruo 
			  where allinea_ruo.id_ruolo = ruo.id_ruolo 
			  and allinea_ruo.nm_applic = apl.nm_applic
			  and allinea_ruo.ti_scopo_dich_autor = dich.ti_scopo_dich_autor
			  and allinea_ruo.ti_dich_autor = dich.ti_dich_autor
			  and allinea_ruo.nm_pagina_web = pag.nm_pagina_web
			  and allinea_ruo.nm_azione_pagina = azio.nm_azione_pagina
			  )

UNION

select 
ruo.id_ruolo,
dich.id_dich_autor
from PRF_DICH_AUTOR dich
join PRF_USO_RUOLO_APPLIC uso_ruo 
 on (uso_ruo.id_uso_ruolo_applic = dich.id_uso_ruolo_applic)
join PRF_RUOLO ruo 
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join APL_APPLIC apl 
 on (apl.id_applic = uso_ruo.id_applic)
join APL_SERVIZIO_WEB serv 
 on (serv.id_servizio_web = dich.id_servizio_web)
where dich.ti_scopo_dich_autor = 'UNA_ABILITAZIONE'
and dich.ti_dich_autor = 'SERVIZIO_WEB'

and apl.nm_applic in (select distinct nm_applic
					  from PRF_ALLINEA_RUOLO apl_allinea_ruo
					  where apl_allinea_ruo.id_ruolo = ruo.id_ruolo 
					 )

and not exists (select *
			  from PRF_ALLINEA_RUOLO allinea_ruo 
			  where allinea_ruo.id_ruolo = ruo.id_ruolo 
			  and allinea_ruo.nm_applic = apl.nm_applic
			  and allinea_ruo.ti_scopo_dich_autor = dich.ti_scopo_dich_autor
			  and allinea_ruo.ti_dich_autor = dich.ti_dich_autor
			  and allinea_ruo.nm_servizio_web = serv.nm_servizio_web
			  );

-- changeset root:1753259446745-415
COMMENT ON COLUMN PRF_V_LIS_DICH_ALLINEA_TODEL.ID_DICH_AUTOR IS 'PK.1';

-- changeset root:1753259446745-416
CREATE OR REPLACE FORCE VIEW "USR_V_ENTI_BY_USER" ("ID_USER_IAM_COR", "ID_APPLIC", "ID_ORGANIZ_IAM_ENTE") AS select 
uso_apl.id_user_iam id_user_iam_cor,
uso_apl.id_applic,
org_ente.id_organiz_iam id_organiz_iam_ente

from USR_USO_USER_APPLIC uso_apl
join USR_DICH_ABIL_ORGANIZ dich_abil_org
	on (dich_abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
	and dich_abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG')
join APL_TIPO_ORGANIZ tipo_org
	on (tipo_org.id_applic = uso_apl.id_applic
	and tipo_org.nm_tipo_organiz = 'ENTE')
join USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam > 0
	and org_ente.id_tipo_organiz = tipo_org.id_tipo_organiz)
	
UNION

select 
uso_apl.id_user_iam id_user_iam_cor,
uso_apl.id_applic,
org_ente.id_organiz_iam id_organiz_iam_ente

from USR_USO_USER_APPLIC uso_apl
join USR_DICH_ABIL_ORGANIZ dich_abil_org
	on (dich_abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
	and dich_abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG_CHILD')
join USR_ORGANIZ_IAM org_amb
	on (org_amb.id_organiz_iam = dich_abil_org.id_organiz_iam)
join APL_TIPO_ORGANIZ tipo_org
	on (tipo_org.id_tipo_organiz = org_amb.id_tipo_organiz
	and tipo_org.nm_tipo_organiz = 'AMBIENTE')
join USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam_padre = org_amb.id_organiz_iam)
	
UNION

select
uso_apl.id_user_iam id_user_iam_cor,
uso_apl.id_applic,
org_ente.id_organiz_iam id_organiz_iam_ente

from USR_USO_USER_APPLIC uso_apl
join USR_DICH_ABIL_ORGANIZ dich_abil_org
	on (dich_abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
	and dich_abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG_CHILD')
join USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam = dich_abil_org.id_organiz_iam)
join APL_TIPO_ORGANIZ tipo_org
	on (tipo_org.id_tipo_organiz = org_ente.id_tipo_organiz
	and tipo_org.nm_tipo_organiz = 'ENTE');

-- changeset root:1753259446745-417
COMMENT ON COLUMN USR_V_ENTI_BY_USER.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-418
COMMENT ON COLUMN USR_V_ENTI_BY_USER.ID_ORGANIZ_IAM_ENTE IS 'PK.2';

-- changeset root:1753259446745-419
CREATE OR REPLACE FORCE VIEW "USR_V_AMB_BY_USER" ("ID_USER_IAM_COR", "ID_APPLIC", "ID_ORGANIZ_IAM_AMB") AS select 
uso_apl.id_user_iam id_user_iam_cor,
uso_apl.id_applic,
org_amb.id_organiz_iam id_organiz_iam_amb

from USR_USO_USER_APPLIC uso_apl
join USR_DICH_ABIL_ORGANIZ dich_abil_org
	on (dich_abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
	and dich_abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG')
join APL_TIPO_ORGANIZ tipo_org
	on (tipo_org.id_applic = uso_apl.id_applic
	and tipo_org.nm_tipo_organiz = 'AMBIENTE')
join USR_ORGANIZ_IAM org_amb
	on (org_amb.id_organiz_iam > 0
	and org_amb.id_tipo_organiz = tipo_org.id_tipo_organiz)
	
UNION

select 
uso_apl.id_user_iam id_user_iam_cor,
uso_apl.id_applic,
org_amb.id_organiz_iam id_organiz_iam_amb

from USR_USO_USER_APPLIC uso_apl
join USR_DICH_ABIL_ORGANIZ dich_abil_org
	on (dich_abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
	and dich_abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG_CHILD')
join USR_ORGANIZ_IAM org_amb
	on (org_amb.id_organiz_iam = dich_abil_org.id_organiz_iam)
join APL_TIPO_ORGANIZ tipo_org
	on (tipo_org.id_tipo_organiz = org_amb.id_tipo_organiz
	and tipo_org.nm_tipo_organiz = 'AMBIENTE');

-- changeset root:1753259446745-420
COMMENT ON COLUMN USR_V_AMB_BY_USER.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-421
COMMENT ON COLUMN USR_V_AMB_BY_USER.ID_ORGANIZ_IAM_AMB IS 'PK.2';

-- changeset root:1753259446745-422
CREATE OR REPLACE FORCE VIEW "USR_V_ALLORGCHILD_BY_CONSERV" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ORGANIZ_IAM_AMB_ENTE", "ID_ENTE_CONSERV", "DS_CAUSALE_DICH") AS select  																		-- ambienti sacer o ping con ente conservatore
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,
 org_amb.id_organiz_iam,
 org_amb.id_ente_conserv,
 'Appartenenza ad ente conservatore' ds_causale_dich
 
from USR_ORGANIZ_IAM org_amb
join APL_TIPO_ORGANIZ tipo_org
	on (tipo_org.id_tipo_organiz = org_amb.id_tipo_organiz
	and tipo_org.nm_tipo_organiz = 'AMBIENTE')
join APL_APPLIC apl_cor
	on (apl_cor.id_applic = org_amb.id_applic)
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
where org_amb.id_organiz_iam in (select amb_by_user.id_organiz_iam_amb				-- ambiente sacer abilitato ad utente corrente
								 from USR_V_AMB_BY_USER amb_by_user
								 where amb_by_user.id_user_iam_cor = user_cor.id_user_iam
								 and amb_by_user.id_applic = apl_cor.id_applic
								 )

UNION

select  																		-- enti sacer appartenenti ad ambienti con ente conservatore
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,
 org_ente.id_organiz_iam,
 org_amb.id_ente_conserv,
 'Appartenenza ad ente conservatore' ds_causale_dich
 
from USR_ORGANIZ_IAM org_amb
join APL_TIPO_ORGANIZ tipo_org
	on (tipo_org.id_tipo_organiz = org_amb.id_tipo_organiz
	and tipo_org.nm_tipo_organiz = 'AMBIENTE')
join APL_APPLIC apl_cor
	on (apl_cor.id_applic = org_amb.id_applic
	and apl_cor.nm_applic = 'SACER')
join USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam_padre = org_amb.id_organiz_iam)
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
where org_ente.id_organiz_iam in (select ente_by_user.id_organiz_iam_ente				-- ente sacer abilitato ad utente corrente
								 from USR_V_ENTI_BY_USER ente_by_user
								 where ente_by_user.id_user_iam_cor = user_cor.id_user_iam
								 and ente_by_user.id_applic = apl_cor.id_applic
								 )
								 
UNION

select  																		-- ambienti sacer o ping con ente gestore
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,
 org_amb.id_organiz_iam,
 org_amb.id_ente_gestore,
 'Appartenenza ad ente conservatore' ds_causale_dich
 
from USR_ORGANIZ_IAM org_amb
join APL_TIPO_ORGANIZ tipo_org
	on (tipo_org.id_tipo_organiz = org_amb.id_tipo_organiz
	and tipo_org.nm_tipo_organiz = 'AMBIENTE')
join APL_APPLIC apl_cor
	on (apl_cor.id_applic = org_amb.id_applic)
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
where org_amb.id_organiz_iam in (select amb_by_user.id_organiz_iam_amb				-- ambiente sacer abilitato ad utente corrente
								 from USR_V_AMB_BY_USER amb_by_user
								 where amb_by_user.id_user_iam_cor = user_cor.id_user_iam
								 and amb_by_user.id_applic = apl_cor.id_applic
								 )

UNION

select  																		-- enti sacer appartenenti ad ambienti con ente gestore
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,
 org_ente.id_organiz_iam,
 org_amb.id_ente_gestore,
 'Appartenenza ad ente conservatore' ds_causale_dich
 
from USR_ORGANIZ_IAM org_amb
join APL_TIPO_ORGANIZ tipo_org
	on (tipo_org.id_tipo_organiz = org_amb.id_tipo_organiz
	and tipo_org.nm_tipo_organiz = 'AMBIENTE')
join APL_APPLIC apl_cor
	on (apl_cor.id_applic = org_amb.id_applic
	and apl_cor.nm_applic = 'SACER')
join USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam_padre = org_amb.id_organiz_iam)
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
where org_ente.id_organiz_iam in (select ente_by_user.id_organiz_iam_ente				-- ente sacer abilitato ad utente corrente
								 from USR_V_ENTI_BY_USER ente_by_user
								 where ente_by_user.id_user_iam_cor = user_cor.id_user_iam
								 and ente_by_user.id_applic = apl_cor.id_applic
								 );

-- changeset root:1753259446745-423
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_CONSERV.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-424
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_CONSERV.ID_ORGANIZ_IAM_AMB_ENTE IS 'PK.2';

-- changeset root:1753259446745-425
CREATE OR REPLACE FORCE VIEW "USR_V_ALLORGCHILD_BY_GESTORE" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ORGANIZ_IAM_AMB_ENTE", "ID_ENTE_GESTORE", "DS_CAUSALE_DICH") AS select  																		-- ambienti sacer o ping
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,
 org_amb.id_organiz_iam,
 org_amb.id_ente_gestore,
 'Appartenenza ad ente gestore' ds_causale_dich
 
from USR_ORGANIZ_IAM org_amb
join APL_TIPO_ORGANIZ tipo_org
	on (tipo_org.id_tipo_organiz = org_amb.id_tipo_organiz
	and tipo_org.nm_tipo_organiz = 'AMBIENTE')
join APL_APPLIC apl_cor
	on (apl_cor.id_applic = org_amb.id_applic)
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
where org_amb.id_organiz_iam in (select amb_by_user.id_organiz_iam_amb				-- ambiente sacer abilitato ad utente corrente
								 from USR_V_AMB_BY_USER amb_by_user
								 where amb_by_user.id_user_iam_cor = user_cor.id_user_iam
								 and amb_by_user.id_applic = apl_cor.id_applic
								 )

UNION

select  																		-- enti sacer
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,
 org_ente.id_organiz_iam,
 org_amb.id_ente_gestore,
 'Appartenenza ad ente gestore' ds_causale_dich
 
from USR_ORGANIZ_IAM org_amb
join APL_TIPO_ORGANIZ tipo_org
	on (tipo_org.id_tipo_organiz = org_amb.id_tipo_organiz
	and tipo_org.nm_tipo_organiz = 'AMBIENTE')
join APL_APPLIC apl_cor
	on (apl_cor.id_applic = org_amb.id_applic
	and apl_cor.nm_applic = 'SACER')
join USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam_padre = org_amb.id_organiz_iam)
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
where org_ente.id_organiz_iam in (select ente_by_user.id_organiz_iam_ente				-- ente sacer abilitato ad utente corrente
								 from USR_V_ENTI_BY_USER ente_by_user
								 where ente_by_user.id_user_iam_cor = user_cor.id_user_iam
								 and ente_by_user.id_applic = apl_cor.id_applic
								 );

-- changeset root:1753259446745-426
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_GESTORE.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-427
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_GESTORE.ID_ORGANIZ_IAM_AMB_ENTE IS 'PK.2';

-- changeset root:1753259446745-428
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_ABIL_ORGANIZ" ("ID_USER_IAM_GESTITO", "ID_ENTE_UTENTE", "ID_APPLIC", "NM_APPLIC", "TI_SCOPO_ABIL", "ID_ORGANIZ_IAM", "DL_COMPOSITO_ORGANIZ", "DS_CAUSALE_ABIL", "NM_ENTE_CAUSALE", "FL_ABIL_AUTOMATICA", "ID_APPART_COLLEG_ENTI", "ID_SUPT_EST_ENTE_CONVENZ", "ID_VIGIL_ENTE_PRODUT") AS select 
 tmp.id_user_iam_gestito,
 tmp.id_ente_utente,
 tmp.id_applic, tree_org.nm_applic,
 tmp.ti_scopo_abil,
 tmp.id_organiz_iam, tree_org.dl_composito_organiz,
 tmp.ds_causale_abil,
 case
	when tmp.ds_causale_abil in ('Appartenenza ad ente amministratore', 
							   'Appartenenza ad ente conservatore', 
							   'Appartenenza ad ente gestore', 
							   'Appartenenza ad ente produttore')
		then (select ente_utente.nm_ente_siam
			  from ORG_ENTE_SIAM ente_utente
			  where ente_utente.id_ente_siam = tmp.id_ente_utente
			  )
	when tmp.ds_causale_abil in ('Ente produttore collegato ad ente a cui appartiene utente')
		then (select ente_colleg.nm_ente_siam
			  from ORG_APPART_COLLEG_ENTI app_colleg
			  join ORG_ENTE_SIAM ente_colleg
				on (ente_colleg.id_ente_siam = app_colleg.id_ente_convenz)
			  where app_colleg.id_appart_colleg_enti = tmp.id_appart_colleg_enti
			  )
	when tmp.ds_causale_abil in ('Ente produttore corrispondente ad organo di vigilanza',
										   'Ente produttore corrispondente a fornitore')
		then (select ente_corrisp.nm_ente_siam
			  from ORG_ENTE_SIAM ente_utente
			  join ORG_ENTE_SIAM ente_corrisp
				on (ente_corrisp.id_ente_siam = ente_utente.id_ente_produt_corrisp)
			  where ente_utente.id_ente_siam = tmp.id_ente_utente
			  )
	when tmp.ds_causale_abil in ('Ente produttore vigilato da organo di vigilanza')
		then (select ente_vigil.nm_ente_siam
			  from ORG_VIGIL_ENTE_PRODUT vigil
			  join ORG_ENTE_SIAM ente_vigil
				on (ente_vigil.id_ente_siam = vigil.id_ente_produt)
			  where vigil.id_vigil_ente_produt = tmp.id_vigil_ente_produt
			  )
	when tmp.ds_causale_abil in ('Ente produttore supportato da fornitore esterno' , 'Fornitore esterno che supporta ente a cui appartiene utente')
		then (select ente_supt.nm_ente_siam
			  from ORG_SUPT_ESTERNO_ENTE_CONVENZ supt
			  join ORG_ENTE_SIAM ente_supt
				on (ente_supt.id_ente_siam = supt.id_ente_produt)
			  where supt.id_supt_est_ente_convenz = tmp.id_supt_est_ente_convenz
			  )
	when tmp.ds_causale_abil is null
		then null
		else 'Causale non prevista'
 end nm_ente_causale,
 tmp.fl_abil_automatica,
 tmp.id_appart_colleg_enti,
 tmp.id_supt_est_ente_convenz,
 tmp.id_vigil_ente_produt
 
 from (
		select 
		 usr.id_user_iam id_user_iam_gestito,
		 usr.id_ente_siam id_ente_utente,
		 uso_apl.id_applic,
		 'UN_AMBIENTE' ti_scopo_abil,
		 org_amb.id_organiz_iam,
		 dich_abil_org.ds_causale_dich ds_causale_abil,
		 '0' fl_abil_automatica,
		 dich_abil_org.id_appart_colleg_enti,
		 dich_abil_org.id_supt_est_ente_convenz,
		 dich_abil_org.id_vigil_ente_produt

		from USR_USER usr
		join USR_USO_USER_APPLIC uso_apl
			on (uso_apl.id_user_iam = usr.id_user_iam)
		join USR_DICH_ABIL_ORGANIZ dich_abil_org
			on (dich_abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
			and dich_abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG')
		join APL_TIPO_ORGANIZ tipo_org
			on (tipo_org.id_applic = uso_apl.id_applic
			and tipo_org.nm_tipo_organiz = 'AMBIENTE')
		join USR_ORGANIZ_IAM org_amb
			on (org_amb.id_organiz_iam > 0
			and org_amb.id_tipo_organiz = tipo_org.id_tipo_organiz)
			
		UNION

		select 
		 usr.id_user_iam id_user_iam_gestito,
		 usr.id_ente_siam id_ente_utente,
		 uso_apl.id_applic,
		 'UN_AMBIENTE' ti_scopo_abil,
		 org_amb.id_organiz_iam,
		 dich_abil_org.ds_causale_dich ds_causale_abil,
		 '0' fl_abil_automatica,
		 dich_abil_org.id_appart_colleg_enti,
		 dich_abil_org.id_supt_est_ente_convenz,
		 dich_abil_org.id_vigil_ente_produt

		from USR_USER usr
		join USR_USO_USER_APPLIC uso_apl
			on (uso_apl.id_user_iam = usr.id_user_iam)
		join USR_DICH_ABIL_ORGANIZ dich_abil_org
			on (dich_abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
			and dich_abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG_CHILD')
		join USR_ORGANIZ_IAM org_amb
			on (org_amb.id_organiz_iam = dich_abil_org.id_organiz_iam)
		join APL_TIPO_ORGANIZ tipo_org
			on (tipo_org.id_tipo_organiz = org_amb.id_tipo_organiz
			and tipo_org.nm_tipo_organiz = 'AMBIENTE')
			
		UNION

		select 
		 usr.id_user_iam id_user_iam_gestito,
		 usr.id_ente_siam id_ente_utente,
		 uso_apl.id_applic,
		 'UN_ENTE' ti_scopo_abil,
		 org_ente.id_organiz_iam,
		 dich_abil_org.ds_causale_dich ds_causale_abil,
		 '0' fl_abil_automatica,
		 dich_abil_org.id_appart_colleg_enti,
		 dich_abil_org.id_supt_est_ente_convenz,
		 dich_abil_org.id_vigil_ente_produt

		from USR_USER usr
		join USR_USO_USER_APPLIC uso_apl
			on (uso_apl.id_user_iam = usr.id_user_iam)
		join USR_DICH_ABIL_ORGANIZ dich_abil_org
			on (dich_abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
			and dich_abil_org.ti_scopo_dich_abil_organiz = 'ALL_ORG_CHILD')
		join USR_ORGANIZ_IAM org_ente
			on (org_ente.id_organiz_iam = dich_abil_org.id_organiz_iam)
		join APL_TIPO_ORGANIZ tipo_org
			on (tipo_org.id_tipo_organiz = org_ente.id_tipo_organiz
			and tipo_org.nm_tipo_organiz = 'ENTE')
			
		UNION

		select 
		 usr.id_user_iam id_user_iam_gestito,
		 usr.id_ente_siam id_ente_utente,
		 uso_apl.id_applic,
		 'UNA_ORG' ti_scopo_abil,
		 dich_abil_org.id_organiz_iam,
		 dich_abil_org.ds_causale_dich ds_causale_abil,
		 '0' fl_abil_automatica,
		 dich_abil_org.id_appart_colleg_enti,
		 dich_abil_org.id_supt_est_ente_convenz,
		 dich_abil_org.id_vigil_ente_produt

		from USR_USER usr
		join USR_USO_USER_APPLIC uso_apl
			on (uso_apl.id_user_iam = usr.id_user_iam)
		join USR_DICH_ABIL_ORGANIZ dich_abil_org
			on (dich_abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
			and dich_abil_org.ti_scopo_dich_abil_organiz = 'UNA_ORG')

		UNION

		select 
		 usr.id_user_iam id_user_iam_gestito,
		 usr.id_ente_siam id_ente_utente,
		 uso_apl.id_applic,
		 'UNA_ORG' ti_scopo_abil,
		 abil_org.id_organiz_iam,
		 abil_org.ds_causale_abil,
		 abil_org.fl_abil_automatica,
		 abil_org.id_appart_colleg_enti,
		 abil_org.id_supt_est_ente_convenz,
		 abil_org.id_vigil_ente_produt

		from USR_USER usr
		join USR_USO_USER_APPLIC uso_apl
			on (uso_apl.id_user_iam = usr.id_user_iam)
		join USR_ABIL_ORGANIZ abil_org
			on (abil_org.id_uso_user_applic = uso_apl.id_uso_user_applic
			and abil_org.id_dich_abil_organiz is null)
	) tmp

join USR_V_TREE_ORGANIZ_IAM tree_org
	on (tree_org.id_organiz_iam = tmp.id_organiz_iam);

-- changeset root:1753259446745-429
COMMENT ON COLUMN USR_V_LIS_ABIL_ORGANIZ.ID_USER_IAM_GESTITO IS 'PK.1';

-- changeset root:1753259446745-430
COMMENT ON COLUMN USR_V_LIS_ABIL_ORGANIZ.ID_ORGANIZ_IAM IS 'PK.2';

-- changeset root:1753259446745-431
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_INI_SCHED_JOB" ("ID_LOG_JOB", "NM_JOB", "DT_REG_LOG_JOB_INI", "DT_REG_LOG_JOB_FINE_SUC", "DT_REG_LOG_JOB_INI_SUC") AS select 
 inizio_job.id_log_job,
 inizio_job.nm_job,
 inizio_job.dt_reg_log_job dt_reg_log_job_ini,
 
 (select min(fine_job_min.dt_reg_log_job)
	from LOG_JOB fine_job_min
	where fine_job_min.nm_job = inizio_job.nm_job
	and fine_job_min.ti_reg_log_job in ('FINE_SCHEDULAZIONE', 'ERRORE')
  and fine_job_min.dt_reg_log_job >= inizio_job.dt_reg_log_job) dt_reg_log_job_fine_suc,
  
 (select min(inizio_suc.dt_reg_log_job) 
  from LOG_JOB inizio_suc
	where inizio_suc.nm_job = inizio_job.nm_job
    and inizio_suc.ti_reg_log_job = 'INIZIO_SCHEDULAZIONE'
	and inizio_suc.dt_reg_log_job > inizio_job.dt_reg_log_job) dt_reg_log_job_ini_suc
  
from LOG_JOB inizio_job
where inizio_job.ti_reg_log_job = 'INIZIO_SCHEDULAZIONE';

-- changeset root:1753259446745-432
CREATE OR REPLACE FORCE VIEW "USR_V_VIS_LAST_SCHED" ("ID_LOG_JOB", "NM_JOB", "DT_REG_LOG_JOB_INI", "FL_JOB_ATTIVO", "FL_ERR") AS select 
 inizio_job.id_log_job,
 inizio_job.nm_job,
 inizio_job.dt_reg_log_job dt_reg_log_job_ini,
 case
	when exists (select *
				from LOG_JOB fine_job
				where fine_job.nm_job = inizio_job.nm_job
				and fine_job.ti_reg_log_job in ('FINE_SCHEDULAZIONE', 'ERRORE')
				and fine_job.dt_reg_log_job >= inizio_job.dt_reg_log_job)
		then '0'
		else '1'
 end fl_job_attivo,
 
 case
	when exists (select *
				from LOG_USER_DA_REPLIC
				where ti_stato_replic in ('REPLICA_IN_ERRORE', 'REPLICA_IN_TIMEOUT'))
		then '1'
		else '0'
 end fl_err
  
from LOG_JOB inizio_job
where inizio_job.ti_reg_log_job = 'INIZIO_SCHEDULAZIONE'
and inizio_job.dt_reg_log_job = (select max(inizio_job_max.dt_reg_log_job)
								from LOG_JOB inizio_job_max
								where inizio_job_max.nm_job = inizio_job.nm_job
								and inizio_job_max.ti_reg_log_job = 'INIZIO_SCHEDULAZIONE');

-- changeset root:1753259446745-433
COMMENT ON COLUMN USR_V_VIS_LAST_SCHED.ID_LOG_JOB IS 'PK.1 relativa a tabella LOG_JOB';

-- changeset root:1753259446745-434
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_SCHED" ("ID_LOG_JOB", "NM_JOB", "DT_REG_LOG_JOB_INI", "DT_REG_LOG_JOB_FINE", "DURATA_GG", "DURATA_ORE", "DURATA_MIN", "DURATA_SEC", "DL_MSG_ERR", "TI_BLOCCO") AS select
 tmp.id_log_job,
 tmp.nm_job,
 tmp.dt_reg_log_job_ini,
 
 case
	when (tmp.dt_reg_log_job_ini_suc is not null and tmp.dt_reg_log_job_fine_suc is not null and tmp.dt_reg_log_job_ini_suc > tmp.dt_reg_log_job_fine_suc) 
	or (tmp.dt_reg_log_job_ini_suc is null)
		then tmp.dt_reg_log_job_fine_suc
		else null
 end dt_reg_log_job_fine,

 case
	when (tmp.dt_reg_log_job_ini_suc is not null and tmp.dt_reg_log_job_fine_suc is not null and tmp.dt_reg_log_job_ini_suc > tmp.dt_reg_log_job_fine_suc) 
	or (tmp.dt_reg_log_job_ini_suc is null and tmp.dt_reg_log_job_fine_suc is not null)
		then trunc((((86400*(tmp.dt_reg_log_job_fine_suc - tmp.dt_reg_log_job_ini))/60)/60)/24)
		else null
 end durata_gg,

 case
	when (tmp.dt_reg_log_job_ini_suc is not null and tmp.dt_reg_log_job_fine_suc is not null and tmp.dt_reg_log_job_ini_suc > tmp.dt_reg_log_job_fine_suc) 
	or (tmp.dt_reg_log_job_ini_suc is null and tmp.dt_reg_log_job_fine_suc is not null)
		then trunc(((86400*(tmp.dt_reg_log_job_fine_suc - tmp.dt_reg_log_job_ini))/60)/60)-24*(trunc((((86400*(tmp.dt_reg_log_job_fine_suc - tmp.dt_reg_log_job_ini))/60)/60)/24))
		else null
 end durata_ore,

 case
	when (tmp.dt_reg_log_job_ini_suc is not null and tmp.dt_reg_log_job_fine_suc is not null and tmp.dt_reg_log_job_ini_suc > tmp.dt_reg_log_job_fine_suc) 
	or (tmp.dt_reg_log_job_ini_suc is null and tmp.dt_reg_log_job_fine_suc is not null)
		then trunc((86400*(tmp.dt_reg_log_job_fine_suc - tmp.dt_reg_log_job_ini))/60)-60*(trunc(((86400*(tmp.dt_reg_log_job_fine_suc - tmp.dt_reg_log_job_ini))/60)/60))
		else null
 end durata_min,

 case
	when (tmp.dt_reg_log_job_ini_suc is not null and tmp.dt_reg_log_job_fine_suc is not null and tmp.dt_reg_log_job_ini_suc > tmp.dt_reg_log_job_fine_suc) 
	or (tmp.dt_reg_log_job_ini_suc is null and tmp.dt_reg_log_job_fine_suc is not null)
		then trunc(86400*(tmp.dt_reg_log_job_fine_suc - tmp.dt_reg_log_job_ini))-60*(trunc((86400*(tmp.dt_reg_log_job_fine_suc - tmp.dt_reg_log_job_ini))/60))
		else null
 end durata_sec,

 case
	when (tmp.dt_reg_log_job_ini_suc is not null and tmp.dt_reg_log_job_fine_suc is not null and tmp.dt_reg_log_job_ini_suc > tmp.dt_reg_log_job_fine_suc) 
	or (tmp.dt_reg_log_job_ini_suc is null and tmp.dt_reg_log_job_fine_suc is not null)
		then (select min(fine_job.dl_msg_err)
			from LOG_JOB fine_job 
			where fine_job.nm_job = tmp.nm_job
			and fine_job.ti_reg_log_job in ('FINE_SCHEDULAZIONE', 'ERRORE')
			and fine_job.dt_reg_log_job = tmp.dt_reg_log_job_fine_suc)
	when (tmp.dt_reg_log_job_ini_suc is not null and tmp.dt_reg_log_job_fine_suc is not null and tmp.dt_reg_log_job_ini_suc < tmp.dt_reg_log_job_fine_suc)
		then 'Job terminato per caduta dell''application server'
		else null
 end dl_msg_err,
 
 case
	when tmp.nm_job like 'REPLICA_UTENTI_%'
		then
			case
				when tmp.dt_reg_log_job_ini_suc is null 
				and tmp.dt_reg_log_job_fine_suc is null
				and trunc(((sysdate - tmp.dt_reg_log_job_ini) * 86400)) > 7200
						then 'SENZA_FINE_SCHEDULAZIONE'
				when tmp.dt_reg_log_job_fine_suc is not null
				and exists (select *
							from LOG_JOB fine_job 
							where fine_job.nm_job = tmp.nm_job
							and fine_job.ti_reg_log_job ='ERRORE'
							and fine_job.dt_reg_log_job = tmp.dt_reg_log_job_fine_suc)
				and exists (select *
							from LOG_USER_DA_REPLIC log_usr
							where log_usr.id_log_job = tmp.id_log_job
							and log_usr.ti_stato_replic = 'REPLICA_IN_CORSO')
						then 'ERRORE'
						else null
			end
		else null
 end ti_blocco
 
from USR_V_LIS_INI_SCHED_JOB tmp;

-- changeset root:1753259446745-435
COMMENT ON COLUMN USR_V_LIS_SCHED.ID_LOG_JOB IS 'PK.1 relativa a tabella LOG_JOB';

-- changeset root:1753259446745-436
CREATE OR REPLACE FORCE VIEW "MON_V_LIS_INI_SCHED_JOB" ("ID_LOG_JOB", "NM_JOB", "DT_REG_LOG_JOB_INI", "DT_REG_LOG_JOB_FINE_SUC", "DT_REG_LOG_JOB_INI_SUC") AS SELECT inizio_job.id_log_job,
           inizio_job.nm_job,
           inizio_job.dt_reg_log_job
               dt_reg_log_job_ini,
           (SELECT MIN (fine_job_min.dt_reg_log_job)
              FROM LOG_JOB fine_job_min
             WHERE fine_job_min.nm_job = inizio_job.nm_job
               AND fine_job_min.ti_reg_log_job IN
                       ('FINE_SCHEDULAZIONE', 'ERRORE')
               AND fine_job_min.dt_reg_log_job >= inizio_job.dt_reg_log_job)
               dt_reg_log_job_fine_suc,
           (SELECT MIN (inizio_suc.dt_reg_log_job)
             FROM LOG_JOB inizio_suc
            WHERE inizio_suc.nm_job = inizio_job.nm_job
              AND inizio_suc.ti_reg_log_job = 'INIZIO_SCHEDULAZIONE'
              AND inizio_suc.dt_reg_log_job > inizio_job.dt_reg_log_job)
               dt_reg_log_job_ini_suc
      FROM LOG_JOB inizio_job
     WHERE inizio_job.ti_reg_log_job = 'INIZIO_SCHEDULAZIONE';

-- changeset root:1753259446745-437
CREATE OR REPLACE FORCE VIEW "MON_V_LIS_SCHED_JOB" ("ID_LOG_JOB", "NM_JOB", "DT_REG_LOG_JOB_INI", "DT_REG_LOG_JOB_FINE", "DURATA_GG", "DURATA_ORE", "DURATA_MIN", "DURATA_SEC", "DL_MSG_ERR") AS SELECT tmp.id_log_job,
           tmp.nm_job,
           tmp.dt_reg_log_job_ini,
           CASE
               WHEN (tmp.dt_reg_log_job_ini_suc IS NOT NULL
                 AND tmp.dt_reg_log_job_fine_suc IS NOT NULL
                 AND tmp.dt_reg_log_job_ini_suc > tmp.dt_reg_log_job_fine_suc)
                 OR (tmp.dt_reg_log_job_ini_suc IS NULL) THEN
                   tmp.dt_reg_log_job_fine_suc
               ELSE
                   NULL
           END    dt_reg_log_job_fine,
           CASE
               WHEN (tmp.dt_reg_log_job_ini_suc IS NOT NULL
                 AND tmp.dt_reg_log_job_fine_suc IS NOT NULL
                 AND tmp.dt_reg_log_job_ini_suc > tmp.dt_reg_log_job_fine_suc)
                 OR (tmp.dt_reg_log_job_ini_suc IS NULL
                 AND tmp.dt_reg_log_job_fine_suc IS NOT NULL) THEN
                   TRUNC (
                         (  (  (  86400
                                * (  tmp.dt_reg_log_job_fine_suc
                                   - tmp.dt_reg_log_job_ini))
                             / 60)
                          / 60)
                       / 24)
               ELSE
                   NULL
           END    durata_gg,
           CASE
               WHEN (tmp.dt_reg_log_job_ini_suc IS NOT NULL
                 AND tmp.dt_reg_log_job_fine_suc IS NOT NULL
                 AND tmp.dt_reg_log_job_ini_suc > tmp.dt_reg_log_job_fine_suc)
                 OR (tmp.dt_reg_log_job_ini_suc IS NULL
                 AND tmp.dt_reg_log_job_fine_suc IS NOT NULL) THEN
                     TRUNC (
                           (  (  86400
                               * (  tmp.dt_reg_log_job_fine_suc
                                  - tmp.dt_reg_log_job_ini))
                            / 60)
                         / 60)
                   -   24
                     * (TRUNC (
                              (  (  (  86400
                                     * (  tmp.dt_reg_log_job_fine_suc
                                        - tmp.dt_reg_log_job_ini))
                                  / 60)
                               / 60)
                            / 24))
               ELSE
                   NULL
           END    durata_ore,
           CASE
               WHEN (tmp.dt_reg_log_job_ini_suc IS NOT NULL
                 AND tmp.dt_reg_log_job_fine_suc IS NOT NULL
                 AND tmp.dt_reg_log_job_ini_suc > tmp.dt_reg_log_job_fine_suc)
                 OR (tmp.dt_reg_log_job_ini_suc IS NULL
                 AND tmp.dt_reg_log_job_fine_suc IS NOT NULL) THEN
                     TRUNC (
                           (  86400
                            * (  tmp.dt_reg_log_job_fine_suc
                               - tmp.dt_reg_log_job_ini))
                         / 60)
                   -   60
                     * (TRUNC (
                              (  (  86400
                                  * (  tmp.dt_reg_log_job_fine_suc
                                     - tmp.dt_reg_log_job_ini))
                               / 60)
                            / 60))
               ELSE
                   NULL
           END    durata_min,
           CASE
               WHEN (tmp.dt_reg_log_job_ini_suc IS NOT NULL
                 AND tmp.dt_reg_log_job_fine_suc IS NOT NULL
                 AND tmp.dt_reg_log_job_ini_suc > tmp.dt_reg_log_job_fine_suc)
                 OR (tmp.dt_reg_log_job_ini_suc IS NULL
                 AND tmp.dt_reg_log_job_fine_suc IS NOT NULL) THEN
                     TRUNC (
                           86400
                         * (  tmp.dt_reg_log_job_fine_suc
                            - tmp.dt_reg_log_job_ini))
                   -   60
                     * (TRUNC (
                              (  86400
                               * (  tmp.dt_reg_log_job_fine_suc
                                  - tmp.dt_reg_log_job_ini))
                            / 60))
               ELSE
                   NULL
           END    durata_sec,
           CASE
               WHEN (tmp.dt_reg_log_job_ini_suc IS NOT NULL
                 AND tmp.dt_reg_log_job_fine_suc IS NOT NULL
                 AND tmp.dt_reg_log_job_ini_suc > tmp.dt_reg_log_job_fine_suc)
                 OR (tmp.dt_reg_log_job_ini_suc IS NULL
                 AND tmp.dt_reg_log_job_fine_suc IS NOT NULL) THEN
                   (SELECT MIN (fine_job.dl_msg_err)
                     FROM LOG_JOB fine_job
                    WHERE fine_job.nm_job = tmp.nm_job
                      AND fine_job.ti_reg_log_job IN
                              ('FINE_SCHEDULAZIONE', 'ERRORE')
                      AND fine_job.dt_reg_log_job =
                          tmp.dt_reg_log_job_fine_suc)
               WHEN (tmp.dt_reg_log_job_ini_suc IS NOT NULL
                 AND tmp.dt_reg_log_job_fine_suc IS NOT NULL
                 AND tmp.dt_reg_log_job_ini_suc < tmp.dt_reg_log_job_fine_suc) THEN
                   'Job terminato per caduta dell''application server'
               ELSE
                   NULL
           END    dl_msg_err
      FROM MON_V_LIS_INI_SCHED_JOB tmp;

-- changeset root:1753259446745-438
COMMENT ON COLUMN MON_V_LIS_SCHED_JOB.ID_LOG_JOB IS 'PK.1 relativa a tabella LOG_JOB';

-- changeset root:1753259446745-439
CREATE OR REPLACE FORCE VIEW "LOG_V_VIS_LAST_SCHED" ("ID_LOG_JOB", "NM_JOB", "DT_REG_LOG_JOB_INI", "FL_JOB_ATTIVO", "LAST_EXEC_OK") AS SELECT MAX (tab1.id_log_job),
             tab1.nm_job,
             tab1.dt_reg_log_job_ini,
             tab1.fl_job_attivo,
             tab1.LAST_EXEC_OK
        FROM (SELECT inizio_job.id_log_job,
                     inizio_job.nm_job,
                     inizio_job.dt_reg_log_job    dt_reg_log_job_ini,
                     CASE
                         WHEN EXISTS
                                  (SELECT *
                                     FROM LOG_JOB fine_job
                                    WHERE fine_job.nm_job = inizio_job.nm_job
                                      AND fine_job.ti_reg_log_job IN
                                              ('FINE_SCHEDULAZIONE', 'ERRORE')
                                      AND fine_job.dt_reg_log_job >=
                                          inizio_job.dt_reg_log_job) THEN
                             '0'
                         ELSE
                             '1'
                     END                          fl_job_attivo,
                     CASE
                         WHEN EXISTS
                                  (SELECT *
                                     FROM LOG_JOB fine_job
                                    WHERE fine_job.nm_job = inizio_job.nm_job
                                      AND fine_job.ti_reg_log_job IN
                                              ('FINE_SCHEDULAZIONE')
                                      AND fine_job.dt_reg_log_job >=
                                          inizio_job.dt_reg_log_job) THEN
                             '1'
                         ELSE
                             '0'
                     END                          last_exec_ok
                FROM LOG_JOB inizio_job
               WHERE inizio_job.ti_reg_log_job = 'INIZIO_SCHEDULAZIONE'
                 AND inizio_job.dt_reg_log_job =
                     (SELECT MAX (inizio_job_max.dt_reg_log_job)
                       FROM LOG_JOB inizio_job_max
                      WHERE inizio_job_max.nm_job = inizio_job.nm_job
                        AND inizio_job_max.ti_reg_log_job =
                            'INIZIO_SCHEDULAZIONE')) tab1
    GROUP BY tab1.nm_job,
             tab1.dt_reg_log_job_ini,
             tab1.fl_job_attivo,
             tab1.LAST_EXEC_OK;

-- changeset root:1753259446745-440
CREATE OR REPLACE FORCE VIEW "APL_V_LOG_JOB" ("ID_LOG_JOB", "NM_JOB", "TI_REG_LOG_JOB", "DT_REG_LOG_JOB", "DL_MSG_ERR", "CD_IND_SERVER") AS SELECT ID_LOG_JOB, NM_JOB, TI_REG_LOG_JOB,DT_REG_LOG_JOB, DL_MSG_ERR, cd_ind_server
FROM LOG_JOB;

-- changeset root:1753259446745-441
CREATE OR REPLACE FORCE VIEW "APL_V_LOG_CHIAVE_TI_OGG" ("ID_QUERY_TIPO_OGGETTO", "ID_TIPO_OGGETTO", "NM_QUERY_TIPO_OGGETTO", "BL_QUERY_TIPO_OGGETTO", "ID_TIPO_OGGETTO_CHIAVE", "NM_TIPO_OGGETTO_CHIAVE") AS select
 qry_chiave.id_query_tipo_oggetto, qry_chiave.id_tipo_oggetto, qry_chiave.nm_query_tipo_oggetto, qry_chiave.bl_query_tipo_oggetto, 
 ti_ogg_chiave.id_tipo_oggetto, ti_ogg_chiave.nm_tipo_oggetto
from APL_QUERY_TIPO_OGGETTO qry_chiave
join APL_TIPO_OGGETTO ti_ogg_chiave
 on (ti_ogg_chiave.id_tipo_oggetto = qry_chiave.id_tipo_oggetto_accesso)

where qry_chiave.tipo_uso_query = 'CHIAVE_ACCESSO';

-- changeset root:1753259446745-442
COMMENT ON COLUMN APL_V_LOG_CHIAVE_TI_OGG.ID_QUERY_TIPO_OGGETTO IS 'PK.1';

-- changeset root:1753259446745-443
CREATE OR REPLACE FORCE VIEW "PRF_V_CHK_ALLINEA_RUOLO" ("ID_RUOLO", "NM_APPLIC", "FL_ALLINEAMENTO_PARZIALE") AS select
ruo.id_ruolo,
apl.nm_applic,
case
	when exists (select *
				 from PRF_V_DICH_DA_ALLIN_OK dich_ok
				 where dich_ok.id_ruolo = ruo.id_ruolo
         and dich_ok.nm_applic = apl.nm_applic
				 and dich_ok.fl_dich_ok = '0'
				 )
		then '1'
		else '0'
end fl_allineamento_parziale

from PRF_RUOLO ruo
join PRF_USO_RUOLO_APPLIC uso_ruo
 on (uso_ruo.id_ruolo = ruo.id_ruolo)
join APL_APPLIC apl
 on (apl.id_applic = uso_ruo.id_applic)
where exists (select *
			  from PRF_V_DICH_DA_ALLIN_OK dich_ok
			  where dich_ok.id_ruolo = ruo.id_ruolo
			  and dich_ok.nm_applic = apl.nm_applic
			  );

-- changeset root:1753259446745-444
COMMENT ON COLUMN PRF_V_CHK_ALLINEA_RUOLO.ID_RUOLO IS 'PK.1';

-- changeset root:1753259446745-445
COMMENT ON COLUMN PRF_V_CHK_ALLINEA_RUOLO.NM_APPLIC IS 'PK.1';

-- changeset root:1753259446745-446
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_USO_RUOLO_DICH" ("ID_USO_RUOLO_DICH", "ID_DICH_ABIL_ORGANIZ", "TI_SCOPO_RUOLO", "ID_ORGANIZ_IAM_RUOLO", "DL_COMPOSITO_ORGANIZ", "ID_RUOLO", "NM_RUOLO", "DS_RUOLO") AS select 
 uso_ruo_dich.id_uso_ruolo_dich,
 uso_ruo_dich.id_dich_abil_organiz,
 uso_ruo_dich.ti_scopo_ruolo,
 uso_ruo_dich.id_organiz_iam_ruolo,
 org.dl_composito_organiz,
 uso_ruo_dich.id_ruolo,
 ruo.nm_ruolo,
 ruo.ds_ruolo

from USR_USO_RUOLO_DICH uso_ruo_dich
join PRF_RUOLO ruo
	on (ruo.id_ruolo = uso_ruo_dich.id_ruolo)
join USR_V_TREE_ORGANIZ_IAM org
	on (org.id_organiz_iam = uso_ruo_dich.id_organiz_iam_ruolo);

-- changeset root:1753259446745-447
COMMENT ON COLUMN USR_V_LIS_USO_RUOLO_DICH.ID_USO_RUOLO_DICH IS 'PK.1';

-- changeset root:1753259446745-448
CREATE OR REPLACE FORCE VIEW "PRF_LIS_RUOLO_DEF_DICH_BY_USER" ("TI_USO_RUOLO", "ID_USO_USER_APPLIC", "ID_RUOLO", "NM_RUOLO", "ID_ORGANIZ_IAM", "ID_ORGANIZ_APPLIC", "DL_COMPOSITO_ORGANIZ") AS select 
 'DEFAULT' ti_uso_ruolo, ruo_def.id_uso_user_applic, ruo.id_ruolo, ruo.nm_ruolo, 
 0 id_organiz_iam, 0 id_organiz_applic, ' ' id_organiz_applic

from USR_USO_RUOLO_USER_DEFAULT ruo_def
join PRF_RUOLO ruo
 on (ruo.id_ruolo = ruo_def.id_ruolo)

UNION


select
 'ALL_ORG_CHILD' ti_uso_ruolo, dich.id_uso_user_applic, ruo.id_ruolo, ruo.nm_ruolo 
-- , tree_org_ente.id_organiz_iam, tree_org_ente.id_organiz_applic, tree_org_ente.dl_composito_organiz
 , tree_org_strut.id_organiz_iam, tree_org_strut.id_organiz_applic, tree_org_strut.dl_composito_organiz
 
from USR_DICH_ABIL_ORGANIZ dich
join USR_USO_RUOLO_DICH uso_ruo
 on (uso_ruo.id_dich_abil_organiz = dich.id_dich_abil_organiz
 and uso_ruo.ti_scopo_ruolo = 'ALL_ORG_CHILD')
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join USR_V_TREE_ORGANIZ_IAM tree_org_ente
 on (tree_org_ente.id_organiz_iam_padre = uso_ruo.id_organiz_iam_ruolo
 and tree_org_ente.nm_tipo_organiz = 'ENTE')
 
join USR_V_TREE_ORGANIZ_IAM tree_org_strut
 on (tree_org_strut.id_organiz_iam_padre = tree_org_ente.id_organiz_iam
 and tree_org_strut.nm_tipo_organiz = 'STRUTTURA')

UNION

select
 'UNA_ORG' ti_uso_ruolo, dich.id_uso_user_applic, ruo.id_ruolo, ruo.nm_ruolo, 
 tree_org.id_organiz_iam, tree_org.id_organiz_applic, tree_org.dl_composito_organiz
 
from USR_DICH_ABIL_ORGANIZ dich
join USR_USO_RUOLO_DICH uso_ruo
 on (uso_ruo.id_dich_abil_organiz = dich.id_dich_abil_organiz
 and uso_ruo.ti_scopo_ruolo = 'UNA_ORG')
join PRF_RUOLO ruo
 on (ruo.id_ruolo = uso_ruo.id_ruolo)
join USR_V_TREE_ORGANIZ_IAM tree_org
 on (tree_org.id_organiz_iam = uso_ruo.id_organiz_iam_ruolo);

-- changeset root:1753259446745-449
COMMENT ON COLUMN PRF_LIS_RUOLO_DEF_DICH_BY_USER.ID_USO_USER_APPLIC IS 'PK.1';

-- changeset root:1753259446745-450
COMMENT ON COLUMN PRF_LIS_RUOLO_DEF_DICH_BY_USER.ID_RUOLO IS 'PK.2';

-- changeset root:1753259446745-451
COMMENT ON COLUMN PRF_LIS_RUOLO_DEF_DICH_BY_USER.ID_ORGANIZ_IAM IS 'PK.3';

-- changeset root:1753259446745-452
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_USER_RIF_BY_STRUT" ("ID_STRUT", "TI_USER_ARK_RIF", "ID_USER_IAM", "NM_COGNOME_USER", "NM_NOME_USER", "NM_USERID", "TIPO_USER", "DS_EMAIL", "LISTA_RUO", "DL_NOTE") AS SELECT org.id_organiz_applic                             id_strut,
           'PERSONA_FISICA'                                  ti_user_ark_rif,
           usr.id_user_iam,
           usr.nm_cognome_user,
           usr.nm_nome_user,
           usr.nm_userid,
           usr.tipo_user,
           usr.ds_email,
           (SELECT LISTAGG (lis_ruolo.nm_ruolo, '; ')
                       WITHIN GROUP (ORDER BY lis_ruolo.nm_ruolo)
              FROM PRF_LIS_RUOLO_DEF_DICH_BY_USER lis_ruolo
             WHERE     lis_ruolo.id_uso_user_applic =
                       uso_apl.id_uso_user_applic
                   AND (   lis_ruolo.id_organiz_iam = org.id_organiz_iam
                        OR lis_ruolo.id_organiz_iam = 0))    lista_ruo,
           NULL
      FROM APL_APPLIC  apl
           JOIN APL_TIPO_ORGANIZ ti_org
               ON (    ti_org.id_applic = apl.id_applic
                   AND ti_org.nm_tipo_organiz = 'STRUTTURA')
           JOIN USR_ORGANIZ_IAM org
               ON (    org.id_applic = apl.id_applic
                   AND org.id_tipo_organiz = ti_org.id_tipo_organiz)
           JOIN USR_ABIL_ORGANIZ abil_org
               ON (abil_org.id_organiz_iam = org.id_organiz_iam)
           JOIN USR_USO_USER_APPLIC uso_apl
               ON (uso_apl.id_uso_user_applic = abil_org.id_uso_user_applic)
           JOIN USR_USER usr
               ON (    usr.id_user_iam = uso_apl.id_user_iam
                   AND usr.tipo_user = 'PERSONA_FISICA')
           --join ORG_ENTE_SIAM ente_usr
           --on (ente_usr.id_ente_siam = usr.id_ente_siam
           --and ente_usr.ti_ente_convenz not in ('AMMINISTRATORE', 'CONSERVATORE'))

           JOIN sacer_iam.usr_uso_ruolo_user_default uuu
               ON (USO_APL.ID_USO_USER_APPLIC = UUU.ID_USO_USER_APPLIC)
           JOIN sacer_iam.prf_ruolo r
               ON (    uuu.id_ruolo = r.id_ruolo
                   AND r.id_ruolo IN
                           (SELECT rc.id_ruolo
                              FROM sacer_iam.prf_ruolo_categoria rc
                             WHERE     r.id_ruolo = rc.id_ruolo
                                   AND rc.ti_categ_ruolo NOT IN
                                           ('amministrazione')))
           JOIN USR_STATO_USER stato_cor
               ON (    stato_cor.id_stato_user = usr.id_stato_user_cor
                   AND stato_cor.ti_stato_user != 'CESSATO')
     WHERE apl.nm_applic = 'SACER'
    UNION
    SELECT org.id_organiz_applic           id_strut,
           'ARK_RIF'                       ti_user_ark_rif,
           usr.id_user_iam,
           usr.nm_cognome_user,
           usr.nm_nome_user,
           usr.nm_userid,
           usr.tipo_user,
           usr.ds_email,
           'Archivista di riferimento'     lista_ruo,
           NULL
      FROM APL_APPLIC  apl
           JOIN APL_TIPO_ORGANIZ ti_org
               ON (    ti_org.id_applic = apl.id_applic
                   AND ti_org.nm_tipo_organiz = 'STRUTTURA')
           JOIN USR_ORGANIZ_IAM org
               ON (    org.id_applic = apl.id_applic
                   AND org.id_tipo_organiz = ti_org.id_tipo_organiz)
           JOIN ORG_ENTE_CONVENZ_ORG ente_convenz_org
               ON (    ente_convenz_org.id_organiz_iam = org.id_organiz_iam
                   AND ente_convenz_org.dt_ini_val <= TRUNC (SYSDATE)
                   AND ente_convenz_org.dt_fine_val >= TRUNC (SYSDATE))
           JOIN ORG_ENTE_ARK_RIF ark
               ON (ark.id_ente_convenz = ente_convenz_org.id_ente_convenz)
           JOIN USR_USER usr ON (usr.id_user_iam = ark.id_user_iam)
           JOIN USR_USO_USER_APPLIC uso_apl
               ON (    uso_apl.id_user_iam = usr.id_user_iam
                   AND uso_apl.id_applic = apl.id_applic)
           JOIN USR_STATO_USER stato_cor
               ON (    stato_cor.id_stato_user = usr.id_stato_user_cor
                   AND stato_cor.ti_stato_user != 'CESSATO')
     WHERE apl.nm_applic = 'SACER'
    UNION
    SELECT org.id_organiz_applic     id_strut,
           'REF_ENTE'                ti_user_ark_rif,
           usr.id_user_iam,
           usr.nm_cognome_user,
           usr.nm_nome_user,
           usr.nm_userid,
           usr.tipo_user,
           usr.ds_email,
           'Referente ente'          lista_ruo,
           usr_rif.dl_note
      FROM APL_APPLIC  apl
           JOIN APL_TIPO_ORGANIZ ti_org
               ON (    ti_org.id_applic = apl.id_applic
                   AND ti_org.nm_tipo_organiz = 'STRUTTURA')
           JOIN USR_ORGANIZ_IAM org
               ON (    org.id_applic = apl.id_applic
                   AND org.id_tipo_organiz = ti_org.id_tipo_organiz)
           JOIN ORG_ENTE_CONVENZ_ORG ente_convenz_org
               ON (    ente_convenz_org.id_organiz_iam = org.id_organiz_iam
                   AND ente_convenz_org.dt_ini_val <= TRUNC (SYSDATE)
                   AND ente_convenz_org.dt_fine_val >= TRUNC (SYSDATE))
           JOIN ORG_ENTE_USER_RIF usr_rif
               ON (usr_rif.id_ente_convenz = ente_convenz_org.id_ente_convenz)
           JOIN USR_USER usr ON (usr.id_user_iam = usr_rif.id_user_iam)
           JOIN USR_STATO_USER stato_cor
               ON (stato_cor.id_stato_user = usr.id_stato_user_cor)
     WHERE apl.nm_applic = 'SACER'
    UNION
    SELECT org.id_organiz_applic                             id_strut,
           'AUTOMA'                                          ti_user_ark_rif,
           usr.id_user_iam,
           usr.nm_cognome_user,
           usr.nm_nome_user,
           usr.nm_userid,
           usr.tipo_user,
           usr.ds_email,
           (SELECT LISTAGG (lis_ruolo.nm_ruolo, '; ')
                       WITHIN GROUP (ORDER BY lis_ruolo.nm_ruolo)
              FROM PRF_LIS_RUOLO_DEF_DICH_BY_USER lis_ruolo
             WHERE     lis_ruolo.id_uso_user_applic =
                       uso_apl.id_uso_user_applic
                   AND (   lis_ruolo.id_organiz_iam = org.id_organiz_iam
                        OR lis_ruolo.id_organiz_iam = 0))    lista_ruo,
           NULL
      FROM APL_APPLIC  apl
           JOIN APL_TIPO_ORGANIZ ti_org
               ON (    ti_org.id_applic = apl.id_applic
                   AND ti_org.nm_tipo_organiz = 'STRUTTURA')
           JOIN USR_ORGANIZ_IAM org
               ON (    org.id_applic = apl.id_applic
                   AND org.id_tipo_organiz = ti_org.id_tipo_organiz)
           JOIN USR_ABIL_ORGANIZ abil_org
               ON (abil_org.id_organiz_iam = org.id_organiz_iam)
           JOIN USR_USO_USER_APPLIC uso_apl
               ON (uso_apl.id_uso_user_applic = abil_org.id_uso_user_applic)
           JOIN USR_USER usr
               ON (    usr.id_user_iam = uso_apl.id_user_iam
                   AND usr.tipo_user = 'AUTOMA'
                   AND usr.tipo_auth = 'AUTH_CERT')
           --join ORG_ENTE_SIAM ente_usr
           --on (ente_usr.id_ente_siam = usr.id_ente_siam
           --and ente_usr.ti_ente_convenz not in ('AMMINISTRATORE', 'CONSERVATORE'))
           JOIN sacer_iam.usr_uso_ruolo_user_default uuu
               ON (USO_APL.ID_USO_USER_APPLIC = UUU.ID_USO_USER_APPLIC)
           JOIN sacer_iam.prf_ruolo r
               ON (    uuu.id_ruolo = r.id_ruolo
                   AND r.id_ruolo IN
                           (SELECT rc.id_ruolo
                              FROM sacer_iam.prf_ruolo_categoria rc
                             WHERE     r.id_ruolo = rc.id_ruolo
                                   AND rc.ti_categ_ruolo NOT IN
                                           ('amministrazione')
                                   AND r.nm_ruolo = 'Recuperatore'))
           JOIN USR_STATO_USER stato_cor
               ON (    stato_cor.id_stato_user = usr.id_stato_user_cor
                   AND stato_cor.ti_stato_user != 'CESSATO')
     WHERE apl.nm_applic = 'SACER';

-- changeset root:1753259446745-453
COMMENT ON COLUMN USR_V_LIS_USER_RIF_BY_STRUT.ID_STRUT IS 'PK.1';

-- changeset root:1753259446745-454
COMMENT ON COLUMN USR_V_LIS_USER_RIF_BY_STRUT.ID_USER_IAM IS 'PK.2';

-- changeset root:1753259446745-455
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_STATO_USER" ("ID_STATO_USER", "ID_USER_IAM", "TS_STATO", "TI_STATO_USER", "ID_UNITA_DOC_RICH", "ID_RICH", "KEY_RICH_GEST_USER", "LISTA_TIPI_AZIONE") AS select
 stato.id_stato_user,
 stato.id_user_iam,
 stato.ts_stato,
 stato.ti_stato_user,
 
 case
	when rich.cd_registro_rich_gest_user is not null
		then org.dl_composito_organiz || '/' || rich.cd_registro_rich_gest_user || '-' || to_char(rich.aa_rich_gest_user) || '-' || rich.cd_key_rich_gest_user
		else null
 end id_unita_doc_rich,
 
 case
	when rich.cd_registro_rich_gest_user is null and rich.cd_rich_gest_user is not null
		then ente.nm_ente_siam || '/' || rich.cd_rich_gest_user
		else null
 end id_rich,

 case
	when rich.cd_registro_rich_gest_user is not null
		then org.dl_composito_organiz || '/' || rich.cd_registro_rich_gest_user || '-' || to_char(rich.aa_rich_gest_user) || '-' || rich.cd_key_rich_gest_user
		else 
			case
				when rich.cd_rich_gest_user is not null
					then ente.nm_ente_siam || '/' || rich.cd_rich_gest_user
					else null
			end
 end key_rich_gest_user,

 listagg (app_rich.ti_azione_rich, '; ') within group (order by app_rich.ti_azione_rich) lista_tipi_azione

from USR_STATO_USER stato
left join USR_RICH_GEST_USER rich
 on (rich.id_rich_gest_user = stato.id_rich_gest_user)
left join ORG_ENTE_SIAM ente
 on (ente.id_ente_siam = rich.id_ente_rich)
left join USR_V_TREE_ORGANIZ_IAM org
 on (org.id_organiz_iam = rich.id_organiz_iam)
 
left join USR_APPART_USER_RICH app_rich
 on (app_rich.id_rich_gest_user = rich.id_rich_gest_user
 and app_rich.id_user_iam = stato.id_user_iam)
  
group by stato.id_stato_user, stato.id_user_iam, stato.ts_stato, stato.ti_stato_user,

 case
	when rich.cd_registro_rich_gest_user is not null
		then org.dl_composito_organiz || '/' || rich.cd_registro_rich_gest_user || '-' || to_char(rich.aa_rich_gest_user) || '-' || rich.cd_key_rich_gest_user
		else null
 end,
 
 case
	when rich.cd_registro_rich_gest_user is null and rich.cd_rich_gest_user is not null
		then ente.nm_ente_siam || '/' || rich.cd_rich_gest_user
		else null
 end,

 case
	when rich.cd_registro_rich_gest_user is not null
		then org.dl_composito_organiz || '/' || rich.cd_registro_rich_gest_user || '-' || to_char(rich.aa_rich_gest_user) || '-' || rich.cd_key_rich_gest_user
		else 
			case
				when rich.cd_rich_gest_user is not null
					then ente.nm_ente_siam || '/' || rich.cd_rich_gest_user
					else null
			end
 end;

-- changeset root:1753259446745-456
COMMENT ON COLUMN USR_V_LIS_STATO_USER.ID_STATO_USER IS 'PK.1';

-- changeset root:1753259446745-457
CREATE OR REPLACE FORCE VIEW "USR_V_VIS_LAST_RICH_GEST_USER" ("ID_RICH_GEST_USER", "DT_RICH_GEST_USER", "ID_USER_IAM", "KEY_RICH_GEST_USER", "FL_AZIONI_EVASE", "DS_LISTA_AZIONI") AS select distinct
 tmp.id_rich_gest_user,
 tmp.dt_rich_gest_user,
 tmp.id_user_iam,
 tmp.key_rich_gest_user,
 case
	when exists (select *
				 from USR_APPART_USER_RICH azio
				 where azio.id_rich_gest_user = tmp.id_rich_gest_user
				 and azio.id_user_iam = tmp.id_user_iam
				 and azio.fl_azione_rich_evasa = '0'
				 )
		then '0'
		else '1'
 end fl_azioni_evase,
 
 listagg (tmp.ti_azione_rich, '; ') within group (order by tmp.ti_azione_rich) ds_lista_azioni

from ( 
		select 
		 last_rich.id_rich_gest_user,
		 last_rich.dt_rich_gest_user,
		 last_app_rich.id_user_iam,
		 case
			when last_rich.cd_registro_rich_gest_user is not null
				then (select dl_composito_organiz
					  from USR_V_TREE_ORGANIZ_IAM org
					  where org.id_organiz_iam = last_rich.id_organiz_iam
					 ) || ' - ' || 
					 last_rich.cd_registro_rich_gest_user || ' - ' || 
					 last_rich.aa_rich_gest_user || ' - ' ||
					 last_rich.cd_key_rich_gest_user
				else	(select nm_ente_siam
						 from ORG_ENTE_SIAM ente
						 where ente.id_ente_siam = last_rich.id_ente_rich
						) || ' - ' ||
						last_rich.cd_rich_gest_user
		 end key_rich_gest_user,
		 last_app_rich.ti_azione_rich

		from USR_APPART_USER_RICH last_app_rich
		join USR_RICH_GEST_USER last_rich
		 on (last_rich.id_rich_gest_user = last_app_rich.id_rich_gest_user)
		where last_rich.dt_rich_gest_user = (select max(dt_rich_gest_user)
											from USR_APPART_USER_RICH app_rich_max
											join USR_RICH_GEST_USER rich_max
											 on (rich_max.id_rich_gest_user = app_rich_max.id_rich_gest_user)
											where app_rich_max.id_user_iam = last_app_rich.id_user_iam
											)
		) tmp

group by tmp.id_rich_gest_user, tmp.dt_rich_gest_user, tmp.id_user_iam, tmp.key_rich_gest_user,
	 case
		when exists (select *
					 from USR_APPART_USER_RICH azio
					 where azio.id_rich_gest_user = tmp.id_rich_gest_user
					 and azio.id_user_iam = tmp.id_user_iam
					 and azio.fl_azione_rich_evasa = '0'
					 )
			then '0'
			else '1'
	 end;

-- changeset root:1753259446745-458
COMMENT ON COLUMN USR_V_VIS_LAST_RICH_GEST_USER.ID_RICH_GEST_USER IS 'PK.6';

-- changeset root:1753259446745-459
CREATE OR REPLACE FORCE VIEW "USR_V_ALLORGCHILD_BY_VIGIL" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ENTE_ORGANO_VIGIL", "ID_ORGANIZ_IAM_ENTE", "ID_ENTE_PRODUT_CORRISP", "ID_VIGIL_ENTE_PRODUT", "ID_ENTE_PRODUT_VIGIL", "DS_CAUSALE_DICH", "ID_RICH_GEST_USER") AS select 
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,
 
 ente_corrisp.id_ente_non_conven,
 ente_corrisp.id_organiz_iam_ente,
 ente_corrisp.id_ente_produt_corrisp,
 null id_vigil_ente_produt,
 null id_ente_produt_vigil,
 'Ente produttore corrispondente ad organo di vigilanza' ds_causale_dich,
 
 rich.id_rich_gest_user

from USR_V_ENTI_SACER_BY_CORRISP ente_corrisp					-- enti delle strut appartenenti ad ente produt corrispondente ad organo dell'utente inserito o modificato

join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join APL_APPLIC apl_cor
	on (apl_cor.id_applic > 0)
join USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam = ente_corrisp.id_organiz_iam_ente
	and org_ente.id_applic = apl_cor.id_applic)

join USR_RICH_GEST_USER rich
	on (rich.id_rich_gest_user > 0)

where ente_corrisp.id_organiz_iam_ente in (select ente_by_user.id_organiz_iam_ente				-- ente sacer abilitato ad utente corrente
											 from USR_V_ENTI_BY_USER ente_by_user
											 where ente_by_user.id_user_iam_cor = user_cor.id_user_iam
											 and ente_by_user.id_applic = apl_cor.id_applic
											 )
and not exists (select *																	-- tutte le strut degli enti sacer appartengono all'ente produt corrispondente
				from USR_ORGANIZ_IAM org_strut
				join ORG_ENTE_CONVENZ_ORG strut_app_ente
					on (strut_app_ente.id_organiz_iam = org_strut.id_organiz_iam
					and strut_app_ente.dt_ini_val <= trunc(sysdate)
					and strut_app_ente.dt_fine_val >= trunc(sysdate)
					)
				where org_strut.id_organiz_iam_padre = ente_corrisp.id_organiz_iam_ente
				
				and strut_app_ente.id_ente_convenz != ente_corrisp.id_ente_produt_corrisp
				)

UNION

select 
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,
 
 ente_by_vigil.id_ente_organo_vigil,
 ente_by_vigil.id_organiz_iam_ente,
 null id_ente_produt_corrisp,
 ente_by_vigil.id_vigil_ente_produt,
 ente_by_vigil.id_ente_produt_vigil,
 'Ente produttore vigilato da organo di vigilanza' ds_causale_dich,
 
 rich.id_rich_gest_user

from USR_V_ENTI_SACER_BY_VIGIL ente_by_vigil					-- enti delle strut appartenenti ad ente produt vigilato da organo dell'utente inserito / modificato
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join APL_APPLIC apl_cor
	on (apl_cor.id_applic > 0)
join USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam = ente_by_vigil.id_organiz_iam_ente
	and org_ente.id_applic = apl_cor.id_applic)

join USR_RICH_GEST_USER rich
	on (rich.id_rich_gest_user > 0)

where ente_by_vigil.id_organiz_iam_ente in (select ente_by_user.id_organiz_iam_ente				-- ente sacer abilitato ad utente corrente
											 from USR_V_ENTI_BY_USER ente_by_user
											 where ente_by_user.id_user_iam_cor = user_cor.id_user_iam
											 and ente_by_user.id_applic = apl_cor.id_applic
											 )
and not exists (select *																	-- tutte le strut degli enti sacer appartengono agli enti produt dell'utente o colleg
				from USR_ORGANIZ_IAM org_strut
				join ORG_ENTE_CONVENZ_ORG strut_app_ente
					on (strut_app_ente.id_organiz_iam = org_strut.id_organiz_iam
					and strut_app_ente.dt_ini_val <= trunc(sysdate)
					and strut_app_ente.dt_fine_val >= trunc(sysdate)
					)
				where org_strut.id_organiz_iam_padre = ente_by_vigil.id_organiz_iam_ente

				and strut_app_ente.id_ente_convenz != ente_by_vigil.id_ente_produt_vigil
				)

and ente_by_vigil.id_ente_produt_vigil in (select ente_servito.id_ente_convenz_servito			-- ente produt delle strutture servito da ente della richiesta
										   from USR_V_LIS_ENTI_CONVENZ_SERVITI ente_servito
										   where ente_servito.id_ente_convenz_servente = rich.id_ente_rich
										   );

-- changeset root:1753259446745-460
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_VIGIL.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-461
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_VIGIL.ID_ORGANIZ_IAM_ENTE IS 'PK.2';

-- changeset root:1753259446745-462
CREATE OR REPLACE FORCE VIEW "USR_V_RIC_RICHIESTE" ("ID_USER_IAM_COR", "NM_USERID_COR", "ID_ENTE_SIAM", "NM_ENTE_SIAM", "ID_AMBIENTE_ENTE_CONVENZ", "NM_AMBIENTE_ENTE_CONVENZ", "ID_RICH_GEST_USER", "ID_ORGANIZ_IAM", "DL_COMPOSITO_ORGANIZ", "CD_REGISTRO_RICH_GEST_USER", "AA_RICH_GEST_USER", "CD_KEY_RICH_GEST_USER", "CD_RICH_GEST_USER", "TI_USER_RICH", "NM_USER_RICH", "NM_NOME_USER_RICH", "NM_COGNOME_USER_RICH", "NM_USERID_RICH", "DT_RICH_GEST_USER", "TI_STATO_RICH_GEST_USER", "ID_USER_IAM_APP_RICH", "NM_NOME_USER_APP_RICH", "NM_COGNOME_USER_APP_RICH", "NM_USERID_APP_RICH") AS select 
 utente_cor.id_user_iam id_user_iam_cor, utente_cor.nm_userid nm_userid_cor,
 ente.id_ente_siam, ente.nm_ente_siam,
 amb.id_ambiente_ente_convenz, amb.nm_ambiente_ente_convenz,
 
 rich.id_rich_gest_user, 
 rich.id_organiz_iam, org.dl_composito_organiz, 
 rich.cd_registro_rich_gest_user, rich.aa_rich_gest_user, rich.cd_key_rich_gest_user, rich.cd_rich_gest_user,
 
 rich.ti_user_rich, rich.nm_user_rich, utente_rich.nm_nome_user nm_nome_user_rich, utente_rich.nm_cognome_user nm_cognome_user_rich, utente_rich.nm_userid nm_userid_rich, rich.dt_rich_gest_user, 
 rich.ti_stato_rich_gest_user, 

 app_rich.id_user_iam id_user_iam_app_rich, 
 
 case
	when app_rich.id_user_iam is null
		then app_rich.nm_nome_user
		else usr_azio.nm_nome_user
 end nm_nome_user_app_rich,
 case
	when app_rich.id_user_iam is null
		then app_rich.nm_cognome_user
		else usr_azio.nm_cognome_user
 end nm_cognome_user_app_rich,
 case
	when app_rich.id_user_iam is null
		then app_rich.nm_userid
		else usr_azio.nm_userid
 end nm_userid_app_rich
 
from USR_USER utente_cor
join USR_ABIL_ENTE_SIAM abil_ente 
	on (abil_ente.id_user_iam = utente_cor.id_user_iam)
join ORG_ENTE_SIAM ente
	on (ente.id_ente_siam = abil_ente.id_ente_siam)
left join ORG_AMBIENTE_ENTE_CONVENZ amb
		on (amb.id_ambiente_ente_convenz = ente.id_ambiente_ente_convenz)
		
join USR_RICH_GEST_USER rich
 on (rich.id_ente_rich = abil_ente.id_ente_siam)
 
left join usr_user utente_rich 
	on (utente_rich.id_user_iam = rich.id_user_iam_rich)
left join USR_APPART_USER_RICH app_rich 
	on (app_rich.id_rich_gest_user = rich.id_rich_gest_user)
left join USR_USER usr_azio
 on (usr_azio.id_user_iam = app_rich.id_user_iam)
	
left join USR_V_TREE_ORGANIZ_IAM org
 on (org.id_organiz_iam = rich.id_organiz_iam)
	
where utente_cor.nm_userid like '%';

-- changeset root:1753259446745-463
COMMENT ON COLUMN USR_V_RIC_RICHIESTE.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-464
COMMENT ON COLUMN USR_V_RIC_RICHIESTE.ID_RICH_GEST_USER IS 'PK.2';

-- changeset root:1753259446745-465
CREATE OR REPLACE FORCE VIEW "USR_V_VIS_RICH_GEST_USER" ("ID_RICH_GEST_USER", "KEY_RICH_GEST_USER", "NM_ENTE_CONVENZ", "TI_RICH_GEST_USER", "DT_RICH_GEST_USER", "NT_RICH_GEST_USER", "TI_USER_RICH", "COGNOME_NOME_UTENTE", "MAIL_UTENTE", "TI_STATO_RICH_GEST_USER", "NM_FILE_RICH_GEST_USER") AS select 
 ric.id_rich_gest_user,
 case
	when ric.cd_registro_rich_gest_user is not null
		then org.dl_composito_organiz || '/' || ric.cd_registro_rich_gest_user || '-' || to_char(ric.aa_rich_gest_user) || '-' || ric.cd_key_rich_gest_user
		else ente.nm_ente_siam || '/' || ric.cd_rich_gest_user
 end key_rich_gest_user,
 ente.nm_ente_siam,
 ric.ti_rich_gest_user,
 ric.dt_rich_gest_user,
 ric.nt_rich_gest_user,
 ric.ti_user_rich,
 case
	when ric.id_user_iam_rich is null
		then ric.nm_user_rich
		else ute.nm_cognome_user || ' ' || ute.nm_nome_user
 end cognome_nome_utente,
 case
	when ric.id_user_iam_rich is null
		then ric.ds_email_rich
		else ute.ds_email
 end mail_utente,
 ric.ti_stato_rich_gest_user,
 ric.nm_file_rich_gest_user

from USR_RICH_GEST_USER ric
left join USR_V_TREE_ORGANIZ_IAM org
 on (org.id_organiz_iam = ric.id_organiz_iam)
join ORG_ENTE_SIAM ente
  ON (ente.id_ente_siam = ric.id_ente_rich)
left join USR_USER ute
  ON (ute.id_user_iam = ric.id_user_iam_rich);

-- changeset root:1753259446745-466
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_USER" ("ID_USER_IAM", "NM_COGNOME_USER", "NM_NOME_USER", "NM_USERID", "CD_FISC", "TIPO_USER", "ID_APPLIC", "ID_RUOLO_DEFAULT", "ID_ORGANIZ_IAM", "ID_RUOLO_DICH", "NM_RUOLO_DEFAULT", "NM_RUOLO_DICH", "FL_ERR_REPLIC", "ID_USER_IAM_CORR", "ID_SISTEMA_VERSANTE", "NM_SISTEMA_VERSANTE", "ID_ENTE_SIAM_APPART", "NM_ENTE_SIAM_APPART", "ID_ENTE_CONVENZ_ABIL", "TI_STATO_USER", "FL_RESP_ENTE_CONVENZ", "FL_ATTIVO", "ID_ORGANIZ_IAM_RICH", "CD_REGISTRO_RICH_GEST_USER", "AA_RICH_GEST_USER", "CD_KEY_RICH_GEST_USER", "ID_ENTE_RICH", "CD_RICH_GEST_USER", "DT_RICH_GEST_USER", "ID_LAST_RICH_GEST_USER", "DT_LAST_RICH_GEST_USER", "CD_LAST_RICH_GEST_USER", "FL_AZIONI_EVASE", "DS_LISTA_AZIONI", "DS_EMAIL", "ID_AMB_ENTE_CONVENZ_APPART", "DS_EMAIL_SECONDARIA") AS select
 tmp.id_user_iam,
 tmp.nm_cognome_user, tmp.nm_nome_user, tmp.nm_userid, tmp.cd_fisc, tmp.tipo_user,
 uso_apl.id_applic,
 ruo_def.id_ruolo id_ruolo_default,
 abil_org.id_organiz_iam,
 ruo_dich.id_ruolo id_ruolo_dich,
/*
 case
	when tmp.count_applic = 0
		then 'Utente non usa applicazioni'
	when tmp.count_applic = 1
		then (select apl_una.nm_applic
			  from USR_USO_USER_APPLIC uso_apl_una
			  join APL_APPLIC apl_una
			   on (apl_una.id_applic = uso_apl_una.id_applic)

			  where uso_apl_una.id_user_iam = tmp.id_user_iam
			  )
		else 'Utente usa più di una applicazione'
 end nm_applic,
*/
 case
	when tmp.count_ruolo_def = 0
		then 'Utente senza ruolo di default'
	when tmp.count_ruolo_def = 1
		then (select distinct ruo_uno.nm_ruolo
			  from USR_USO_USER_APPLIC uso_apl_una
			  join USR_USO_RUOLO_USER_DEFAULT ruo_def_uno
			   on (ruo_def_uno.id_uso_user_applic = uso_apl_una.id_uso_user_applic)
			  join PRF_RUOLO ruo_uno
			   on (ruo_uno.id_ruolo = ruo_def_uno.id_ruolo)

			  where uso_apl_una.id_user_iam = tmp.id_user_iam
			 )
		else 'Utente autorizzato con più di un ruolo di default'
 end nm_ruolo_default,
/*
 case
	when tmp.count_abil_organiz = 0
		then 'Utente non e'' abilitato ad operare sulle organizzazioni'
	when tmp.count_abil_organiz = 1
		then (select org.dl_composito_organiz
			  from USR_USO_USER_APPLIC uso_apl_una
			  join USR_ABIL_ORGANIZ abil_org_una
			   on (abil_org_una.id_uso_user_applic = uso_apl_una.id_uso_user_applic)
			  join USR_V_TREE_ORGANIZ_IAM org
			   on (org.id_organiz_iam = abil_org_una.id_organiz_iam)

			  where uso_apl_una.id_user_iam = tmp.id_user_iam
			 )
		else 'Utente abilitato per più di una organizzazione'
 end dl_composito_organiz,
*/ 

 case
	when tmp.count_ruo_organiz = 0
		then 'Utente senza ruolo dipendente da abilitazioni alle organizzazioni'
	when tmp.count_ruo_organiz = 1
		then (select distinct ruo_uno.nm_ruolo
			  from USR_USO_USER_APPLIC uso_apl_una
			  join USR_DICH_ABIL_ORGANIZ dich_abil_org_una
			   on (dich_abil_org_una.id_uso_user_applic  = uso_apl_una.id_uso_user_applic)
			  join USR_USO_RUOLO_DICH ruo_dich_uno
			   on (ruo_dich_uno.id_dich_abil_organiz = dich_abil_org_una.id_dich_abil_organiz)
			  join PRF_RUOLO ruo_uno
			   on (ruo_uno.id_ruolo = ruo_dich_uno.id_ruolo)

			  where uso_apl_una.id_user_iam = tmp.id_user_iam
			 )
		else 'Utente autorizzato con più di un ruolo dipendente da abilitazioni alle organizzazioni'
 end nm_ruolo_dich,


 case
	when (select nvl(count(*), 0)
			from LOG_USER_DA_REPLIC log_user
			where log_user.id_user_iam = tmp.id_user_iam
			and log_user.ti_stato_replic in ('REPLICA_IN_ERRORE', 'REPLICA_IN_TIMEOUT', 'REPLICA_NON_POSSIBILE')) = 0
		then '0'
		else '1'
 end fl_err_replic,

 tmp.id_user_iam_corr,

 tmp.id_sistema_versante,
 sis.nm_sistema_versante,

 tmp.id_ente_siam id_ente_siam_appart,
 case
	when amb_ente_convenz_appart.nm_ambiente_ente_convenz is not null
		then amb_ente_convenz_appart.nm_ambiente_ente_convenz || ' / ' || ente_convenz_appart.nm_ente_siam
		else ente_convenz_appart.nm_ente_siam
 end nm_ente_siam_appart,

 abil_ente.id_ente_siam id_ente_convenz_abil,
/* 
 case
	when tmp.count_abil_ente = 0
		then 'Utente non e'' abilitato ad operare sugli enti convenzionati'
	when tmp.count_abil_ente = 1
		then (select ambiente_ente_convenz.nm_ambiente_ente_convenz || ' / ' || ente_convenz.nm_ente_siam
			  from USR_ABIL_ENTE_SIAM abil_ente_uno
			  join ORG_ENTE_SIAM ente_convenz
			   on (ente_convenz.id_ente_siam = abil_ente_uno.id_ente_siam)
			  join ORG_AMBIENTE_ENTE_CONVENZ ambiente_ente_convenz
				on (ambiente_ente_convenz.id_ambiente_ente_convenz = ente_convenz.id_ambiente_ente_convenz)

			  where abil_ente_uno.id_user_iam = tmp.id_user_iam
			 )
		else 'Utente abilitato per più di un ente convenzionato'
 end nm_ente_convenz_abil,
*/ 
 stato_cor.ti_stato_user,
 tmp.fl_resp_ente_convenz, 
 tmp.fl_attivo,

 rich.id_organiz_iam id_organiz_iam_rich, rich.cd_registro_rich_gest_user, rich.aa_rich_gest_user, rich.cd_key_rich_gest_user,
 rich.id_ente_rich id_ente_rich, rich.cd_rich_gest_user, rich.dt_rich_gest_user,

 last_rich.id_rich_gest_user,
 last_rich.dt_rich_gest_user,
 last_rich.key_rich_gest_user,

 last_rich.fl_azioni_evase,

 last_rich.ds_lista_azioni,
 tmp.ds_email,
 amb_ente_convenz_appart.id_ambiente_ente_convenz,
 tmp.ds_email_secondaria

from (
		select 
		 usr_ric.id_user_iam,
		 usr_ric.nm_cognome_user, usr_ric.nm_nome_user, usr_ric.nm_userid, usr_ric.cd_fisc, usr_ric.tipo_user,
		 usr_ric.id_sistema_versante,

		 usr_ric.id_ente_siam,

		 usr_corr.id_user_iam id_user_iam_corr,
/*
		(select nvl(count(*), 0)
		 from USR_USO_USER_APPLIC uso_apl_ric
		 where uso_apl_ric.id_user_iam = usr_ric.id_user_iam
		) count_applic,
*/		  
		(select nvl (count (distinct ruo_def_ric.id_ruolo), 0)
		 from USR_USO_USER_APPLIC uso_apl_ric
		 join USR_USO_RUOLO_USER_DEFAULT ruo_def_ric
		  on (ruo_def_ric.id_uso_user_applic = uso_apl_ric.id_uso_user_applic)

		 where uso_apl_ric.id_user_iam = usr_ric.id_user_iam
		) count_ruolo_def,
/*		  
		(select nvl(count(*), 0)
		 from USR_USO_USER_APPLIC uso_apl_ric
		 join USR_ABIL_ORGANIZ abil_org_count
		  on (abil_org_count.id_uso_user_applic  = uso_apl_ric.id_uso_user_applic)

		 where uso_apl_ric.id_user_iam = usr_ric.id_user_iam
		) count_abil_organiz,
*/		   
		(select nvl(count(distinct ruo_dich_ric.id_ruolo), 0)
		 from USR_USO_USER_APPLIC uso_apl_ric 
		 join USR_DICH_ABIL_ORGANIZ dich_abil_org_ric
		  on (dich_abil_org_ric.id_uso_user_applic  = uso_apl_ric.id_uso_user_applic)
		 join USR_USO_RUOLO_DICH ruo_dich_ric
		  on (ruo_dich_ric.id_dich_abil_organiz = dich_abil_org_ric.id_dich_abil_organiz)

		 where uso_apl_ric.id_user_iam = usr_ric.id_user_iam
		) count_ruo_organiz,
/*		
		(select nvl(count(*), 0)
		 from USR_ABIL_ENTE_SIAM abil_ente_count
		 where abil_ente_count.id_user_iam  = usr_ric.id_user_iam
		) count_abil_ente,
*/		
		usr_ric.id_stato_user_cor,
		usr_ric.fl_resp_ente_convenz, 
		usr_ric.fl_attivo,
		usr_ric.ds_email,
        usr_ric.ds_email_secondaria

		from USR_USER usr_ric
		join USR_USER usr_corr
		 on (usr_corr.nm_userid like '%')

		where not exists (select *
						from USR_USO_USER_APPLIC uso_apl_ric
						where uso_apl_ric.id_user_iam = usr_ric.id_user_iam
						and not exists (select *
										from USR_USO_USER_APPLIC uso_apl_corr
										where uso_apl_corr.id_user_iam = usr_corr.id_user_iam
										and uso_apl_corr.id_applic = uso_apl_ric.id_applic
										)
						)

		and not exists (select *
						from USR_USO_USER_APPLIC uso_apl_ric
						join USR_ABIL_ORGANIZ abil_org_ric
						 on (abil_org_ric.id_uso_user_applic  = uso_apl_ric.id_uso_user_applic)
						where uso_apl_ric.id_user_iam = usr_ric.id_user_iam
						and not exists (select *
										from USR_USO_USER_APPLIC uso_apl_cor
										join USR_ABIL_ORGANIZ abil_org_corr
										 on (abil_org_corr.id_uso_user_applic = uso_apl_cor.id_uso_user_applic)
										where uso_apl_cor.id_user_iam = usr_corr.id_user_iam
										and uso_apl_cor.id_applic = uso_apl_ric.id_applic
										and abil_org_corr.id_organiz_iam = abil_org_ric.id_organiz_iam
										)
						)
		and not exists (select *
						from USR_ABIL_ENTE_SIAM abil_ente_ric
						where abil_ente_ric.id_user_iam = usr_ric.id_user_iam
						and not exists (select *
										from USR_ABIL_ENTE_SIAM abil_ente_corr
										where abil_ente_corr.id_user_iam = usr_corr.id_user_iam
										and abil_ente_corr.id_ente_siam = abil_ente_ric.id_ente_siam
										)
						)
		and exists (select *
					from USR_ABIL_ENTE_SIAM abil_ente_corr
					where abil_ente_corr.id_user_iam = usr_corr.id_user_iam
					and abil_ente_corr.id_ente_siam = usr_ric.id_ente_siam)
	) tmp

left join USR_USO_USER_APPLIC uso_apl
 on (uso_apl.id_user_iam = tmp.id_user_iam)

left join USR_USO_RUOLO_USER_DEFAULT ruo_def
 on (ruo_def.id_uso_user_applic = uso_apl.id_uso_user_applic)

left join USR_ABIL_ORGANIZ abil_org
 on (abil_org.id_uso_user_applic  = uso_apl.id_uso_user_applic)

left join USR_USO_RUOLO_DICH ruo_dich
 on (ruo_dich.id_dich_abil_organiz = abil_org.id_dich_abil_organiz)

left join APL_SISTEMA_VERSANTE sis
 on (sis.id_sistema_versante = tmp.id_sistema_versante)

join ORG_ENTE_SIAM ente_convenz_appart
 on (ente_convenz_appart.id_ente_siam = tmp.id_ente_siam)
left join ORG_AMBIENTE_ENTE_CONVENZ amb_ente_convenz_appart
 on (amb_ente_convenz_appart.id_ambiente_ente_convenz = ente_convenz_appart.id_ambiente_ente_convenz)

left join USR_ABIL_ENTE_SIAM abil_ente
 on (abil_ente.id_user_iam = tmp.id_user_iam)

join USR_STATO_USER stato_cor
 on (stato_cor.id_stato_user = tmp.id_stato_user_cor)

left join USR_APPART_USER_RICH app_rich
 on (app_rich.id_user_iam = tmp.id_user_iam)
left join USR_RICH_GEST_USER rich
 on (rich.id_rich_gest_user = app_rich.id_rich_gest_user)

left join USR_V_VIS_LAST_RICH_GEST_USER last_rich
 on (last_rich.id_user_iam = tmp.id_user_iam);

-- changeset root:1753259446745-467
COMMENT ON COLUMN USR_V_LIS_USER.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-468
COMMENT ON COLUMN USR_V_LIS_USER.ID_APPLIC IS 'PK.2';

-- changeset root:1753259446745-469
COMMENT ON COLUMN USR_V_LIS_USER.ID_RUOLO_DEFAULT IS 'PK.3';

-- changeset root:1753259446745-470
COMMENT ON COLUMN USR_V_LIS_USER.ID_ORGANIZ_IAM IS 'PK.4';

-- changeset root:1753259446745-471
COMMENT ON COLUMN USR_V_LIS_USER.ID_RUOLO_DICH IS 'PK.5';

-- changeset root:1753259446745-472
COMMENT ON COLUMN USR_V_LIS_USER.ID_ENTE_CONVENZ_ABIL IS 'PK.6';

-- changeset root:1753259446745-473
CREATE OR REPLACE FORCE VIEW "USR_V_ALLORGCHILD_BY_FORNIT" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ENTE_FORNIT_ESTERNO", "ID_ORGANIZ_IAM_ENTE", "ID_ENTE_PRODUT_CORRISP", "ID_SUPT_EST_ENTE_CONVENZ", "ID_ENTE_PRODUT_SUPT", "DS_CAUSALE_DICH", "ID_RICH_GEST_USER") AS SELECT user_cor.id_user_iam    id_user_iam_cor,
           apl_cor.id_applic,
           apl_cor.nm_applic,
           ente_corrisp.id_ente_non_conven,
           ente_corrisp.id_organiz_iam_ente,
           ente_corrisp.id_ente_produt_corrisp,
           NULL                    id_supt_est_ente_convenz,
           NULL                    id_ente_produt_supt,
           -- 'Ente produttore corrispondente a fornitore'     ds_causale_dich,
           CASE ente_corrisp.TI_ENTE_NON_CONVENZ
               WHEN 'FORNITORE_ESTERNO'
               THEN
                   'Ente produttore corrispondente a fornitore'
               WHEN 'SOGGETTO_ATTUATORE'
               THEN
                   'Ente produttore corrispondente a soggetto attuatore'
               ELSE
                   ' '
           END                     ds_causale_dich,
           rich.id_rich_gest_user
      FROM USR_V_ENTI_SACER_BY_CORRISP  ente_corrisp -- enti delle strut appartenenti ad ente produt corrispondente a fornit esterno dell'utente inserito o modificato
           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
           JOIN APL_APPLIC apl_cor ON (apl_cor.id_applic > 0)
           JOIN USR_ORGANIZ_IAM org_ente
               ON (    org_ente.id_organiz_iam =
                       ente_corrisp.id_organiz_iam_ente
                   AND org_ente.id_applic = apl_cor.id_applic)
           JOIN USR_RICH_GEST_USER rich ON (rich.id_rich_gest_user > 0)
     WHERE     ente_corrisp.id_organiz_iam_ente IN
                   (SELECT ente_by_user.id_organiz_iam_ente -- ente sacer abilitato ad utente corrente
                      FROM USR_V_ENTI_BY_USER ente_by_user
                     WHERE     ente_by_user.id_user_iam_cor =
                               user_cor.id_user_iam
                           AND ente_by_user.id_applic = apl_cor.id_applic)
           AND NOT EXISTS
                   (SELECT * -- tutte le strut degli enti sacer appartengono all'ente produt corrispondente
                      FROM USR_ORGANIZ_IAM  org_strut
                           JOIN ORG_ENTE_CONVENZ_ORG strut_app_ente
                               ON (    strut_app_ente.id_organiz_iam =
                                       org_strut.id_organiz_iam
                                   AND strut_app_ente.dt_ini_val <=
                                       TRUNC (SYSDATE)
                                   AND strut_app_ente.dt_fine_val >=
                                       TRUNC (SYSDATE))
                     WHERE     org_strut.id_organiz_iam_padre =
                               ente_corrisp.id_organiz_iam_ente
                           AND strut_app_ente.id_ente_convenz !=
                               ente_corrisp.id_ente_produt_corrisp)
    UNION
    SELECT user_cor.id_user_iam    id_user_iam_cor,
           apl_cor.id_applic,
           apl_cor.nm_applic,
           ente_by_fornit.id_ente_fornit_est,
           ente_by_fornit.id_organiz_iam_ente,
           NULL                    id_ente_produt_corrisp,
           ente_by_fornit.id_supt_est_ente_convenz,
           ente_by_fornit.id_ente_produt_supt,
           --  'Ente produttore supportato da fornitore esterno'         ds_causale_dich,
           CASE ente_by_fornit.TI_ENTE_NON_CONVENZ
               WHEN 'FORNITORE_ESTERNO'
               THEN
                   'Ente produttore supportato da fornitore esterno'
               WHEN 'SOGGETTO_ATTUATORE'
               THEN
                   'Ente produttore supportato da soggetto attuatore'
               ELSE
                   ' '
           END                     ds_causale_dich,
           rich.id_rich_gest_user
      FROM USR_V_ENTI_SACER_BY_FORNIT  ente_by_fornit -- enti delle strut appartenenti ad ente produt supportato da fornitore esterno dell'utente inserito / modificato
           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
           JOIN APL_APPLIC apl_cor ON (apl_cor.id_applic > 0)
           JOIN USR_ORGANIZ_IAM org_ente
               ON (    org_ente.id_organiz_iam =
                       ente_by_fornit.id_organiz_iam_ente
                   AND org_ente.id_applic = apl_cor.id_applic)
           JOIN USR_RICH_GEST_USER rich ON (rich.id_rich_gest_user > 0)
     WHERE     ente_by_fornit.id_organiz_iam_ente IN
                   (SELECT ente_by_user.id_organiz_iam_ente -- ente sacer abilitato ad utente corrente
                      FROM USR_V_ENTI_BY_USER ente_by_user
                     WHERE     ente_by_user.id_user_iam_cor =
                               user_cor.id_user_iam
                           AND ente_by_user.id_applic = apl_cor.id_applic)
           AND NOT EXISTS
                   (SELECT * -- tutte le strut degli enti sacer appartengono agli enti produt dell'utente o colleg
                      FROM USR_ORGANIZ_IAM  org_strut
                           JOIN ORG_ENTE_CONVENZ_ORG strut_app_ente
                               ON (    strut_app_ente.id_organiz_iam =
                                       org_strut.id_organiz_iam
                                   AND strut_app_ente.dt_ini_val <=
                                       TRUNC (SYSDATE)
                                   AND strut_app_ente.dt_fine_val >=
                                       TRUNC (SYSDATE))
                     WHERE     org_strut.id_organiz_iam_padre =
                               ente_by_fornit.id_organiz_iam_ente
                           AND strut_app_ente.id_ente_convenz !=
                               ente_by_fornit.id_ente_produt_supt)
           AND ente_by_fornit.id_ente_produt_supt IN
                   (SELECT ente_servito.id_ente_convenz_servito -- ente produt delle strutture servito da ente della richiesta
                      FROM USR_V_LIS_ENTI_CONVENZ_SERVITI ente_servito
                     WHERE ente_servito.id_ente_convenz_servente =
                           rich.id_ente_rich);

-- changeset root:1753259446745-474
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_FORNIT.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-475
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_FORNIT.ID_ORGANIZ_IAM_ENTE IS 'PK.2';

-- changeset root:1753259446745-476
CREATE OR REPLACE FORCE VIEW "USR_V_LIS_USER_ENTE_CONVENZ" ("ID_ENTE_CONVENZ", "ID_USER_IAM", "NM_COGNOME_USER", "NM_NOME_USER", "NM_USERID", "TIPO_USER", "ID_SISTEMA_VERSANTE", "TI_STATO_USER", "TI_ENTE_CONVENZ_USER", "NM_APPLIC", "NM_RUOLO_DEFAULT", "DL_COMPOSITO_ORGANIZ", "ID_RICH_GEST_USER", "DT_RICH_GEST_USER", "KEY_RICH_GEST_USER", "FL_AZIONI_EVASE", "DS_LISTA_AZIONI") AS select 
 tmp.id_ente_convenz, 
 tmp.id_user_iam,
 tmp.nm_cognome_user, tmp.nm_nome_user, tmp.nm_userid,
 tmp.tipo_user, tmp.id_sistema_versante, tmp.ti_stato_user,
 tmp.ti_ente_convenz_user,

 case
	when (select nvl(count(*), 0)
			from USR_USO_USER_APPLIC uso_apl_1
			where uso_apl_1.id_user_iam = tmp.id_user_iam) = 1
		then (select apl_1.nm_applic
			from USR_USO_USER_APPLIC uso_apl_1
			join APL_APPLIC apl_1
				on (apl_1.id_applic = uso_apl_1.id_applic)
			where uso_apl_1.id_user_iam = tmp.id_user_iam
			)
		else 'Utente usa più di una applicazione'
 end nm_applic,

 case
	when (select nvl (count (distinct ruo_def_1.id_ruolo), 0)
			from USR_USO_USER_APPLIC uso_apl_1
			join USR_USO_RUOLO_USER_DEFAULT ruo_def_1
												
				on (ruo_def_1.id_uso_user_applic = uso_apl_1.id_uso_user_applic)
			where uso_apl_1.id_user_iam = tmp.id_user_iam
		 ) = 0
		then 'Utente senza ruolo di default'
	when (select nvl (count (distinct ruo_def_1.id_ruolo), 0)
			from USR_USO_USER_APPLIC uso_apl_1
			join USR_USO_RUOLO_USER_DEFAULT ruo_def_1
												
				on (ruo_def_1.id_uso_user_applic = uso_apl_1.id_uso_user_applic)
			where uso_apl_1.id_user_iam = tmp.id_user_iam
		  ) = 1
		then (select distinct ruo_1.nm_ruolo
			from USR_USO_USER_APPLIC uso_apl_1
			join USR_USO_RUOLO_USER_DEFAULT ruo_def_1
												
				on (ruo_def_1.id_uso_user_applic = uso_apl_1.id_uso_user_applic)
			join PRF_RUOLO ruo_1
				on (ruo_1.id_ruolo = ruo_def_1.id_ruolo)
			where uso_apl_1.id_user_iam = tmp.id_user_iam
			)
		else 'Utente autorizzato con più di un ruolo di default'
 end nm_ruolo_default,

 case
  when (select nvl(count(*), 0)
			from USR_USO_USER_APPLIC uso_apl_1
			join USR_DICH_ABIL_ORGANIZ dich_abil_org
												
				on (dich_abil_org.id_uso_user_applic  = uso_apl_1.id_uso_user_applic
				and dich_abil_org.ti_scopo_dich_abil_organiz = 'UNA_ORG')
			where uso_apl_1.id_user_iam = tmp.id_user_iam
		 ) = 1
		then (select org.dl_composito_organiz
			from USR_USO_USER_APPLIC uso_apl_1
			join USR_DICH_ABIL_ORGANIZ dich_abil_org
				on (dich_abil_org.id_uso_user_applic  = uso_apl_1.id_uso_user_applic
				and dich_abil_org.ti_scopo_dich_abil_organiz = 'UNA_ORG')
			join USR_V_TREE_ORGANIZ_IAM org
			 on (org.id_organiz_iam = dich_abil_org.id_organiz_iam)
			where uso_apl_1.id_user_iam = tmp.id_user_iam
			)

		else 'Utente abilitato per più di una organizzazione'
 end dl_composito_organiz,
 
 last_rich.id_rich_gest_user,
 last_rich.dt_rich_gest_user,
 last_rich.key_rich_gest_user,
 last_rich.fl_azioni_evase,
 last_rich.ds_lista_azioni

from (
	select distinct
	 ente.id_ente_siam id_ente_convenz, ente.ti_ente_convenz,
	 usr.id_user_iam,
	 usr.nm_cognome_user, usr.nm_nome_user, usr.nm_userid,
	 usr.tipo_user, usr.id_sistema_versante, stato_cor.ti_stato_user,
	 ente_usr.ti_ente_convenz ti_ente_convenz_user
	 
	from ORG_ENTE_SIAM ente
	join ORG_ENTE_CONVENZ_ORG org_ente_convenz
		on (org_ente_convenz.id_ente_convenz = ente.id_ente_siam
		and org_ente_convenz.dt_ini_val <= trunc(sysdate)
		and org_ente_convenz.dt_fine_val >= trunc(sysdate))
											
	join USR_ABIL_ORGANIZ abil_org
		on (abil_org.id_organiz_iam = org_ente_convenz.id_organiz_iam)

	join USR_USO_USER_APPLIC uso_apl
		on (uso_apl.id_uso_user_applic = abil_org.id_uso_user_applic)
	join USR_USER usr
		on (usr.id_user_iam = uso_apl.id_user_iam
		and usr.tipo_user in ('PERSONA_FISICA', 'AUTOMA'))
	join ORG_ENTE_SIAM ente_usr
		on (ente_usr.id_ente_siam = usr.id_ente_siam)
	join USR_STATO_USER stato_cor
		 on (stato_cor.id_stato_user = usr.id_stato_user_cor
		 and stato_cor.ti_stato_user in ('ATTIVO', 'DISATTIVO'))
	 
	where ente.ti_ente = 'CONVENZIONATO'
	) tmp
	
left join USR_V_VIS_LAST_RICH_GEST_USER last_rich
	on (last_rich.id_user_iam = tmp.id_user_iam)

where case
		when ti_ente_convenz = 'AMMINISTRATORE'
			then 'OK'
		when ti_ente_convenz = 'CONSERVATORE'
		and ti_ente_convenz_user != 'AMMINISTRATORE'
			then 'OK'
		when ti_ente_convenz = 'GESTORE'
		and ti_ente_convenz_user not in ('AMMINISTRATORE', 'CONSERVATORE')
			then 'OK'
		when ti_ente_convenz = 'PRODUTTORE'
		and ti_ente_convenz_user not in ('AMMINISTRATORE', 'CONSERVATORE', 'GESTORE')
			then 'OK'
			else 'KO'
	  end = 'OK';

-- changeset root:1753259446745-477
COMMENT ON COLUMN USR_V_LIS_USER_ENTE_CONVENZ.ID_ENTE_CONVENZ IS 'PK.1';

-- changeset root:1753259446745-478
COMMENT ON COLUMN USR_V_LIS_USER_ENTE_CONVENZ.ID_USER_IAM IS 'PK.2';

-- changeset root:1753259446745-479
CREATE OR REPLACE FORCE VIEW "APL_V_LOG_FOTO_TI_EVN_OGG" ("ID_TIPO_EVENTO_OGGETTO", "ID_TIPO_EVENTO", "ID_TIPO_OGGETTO", "ID_QUERY_TIPO_OGGETTO", "NM_QUERY_TIPO_OGGETTO", "TIPO_USO_QUERY", "BL_QUERY_TIPO_OGGETTO") AS select
 ti_evn_ogg.id_tipo_evento_oggetto, ti_evn_ogg.id_tipo_evento, ti_evn_ogg.id_tipo_oggetto, 
 qry_foto.id_query_tipo_oggetto, qry_foto.nm_query_tipo_oggetto, qry_foto.tipo_uso_query, qry_foto.bl_query_tipo_oggetto

from APL_TIPO_EVENTO_OGGETTO ti_evn_ogg
left join APL_QUERY_TIPO_OGGETTO qry_foto
 on (qry_foto.id_query_tipo_oggetto = ti_evn_ogg.id_query_tipo_oggetto_foto);

-- changeset root:1753259446745-480
COMMENT ON COLUMN APL_V_LOG_FOTO_TI_EVN_OGG.ID_TIPO_EVENTO_OGGETTO IS 'PK.1';

-- changeset root:1753259446745-481
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_STRUT_SACER_XPING" ("ID_USER_IAM", "NM_USERID", "NM_AMBIENTE", "ID_AMBIENTE", "NM_ENTE", "ID_ENTE", "NM_STRUT", "ID_STRUT", "ID_ORGANIZ_IAM_STRUT", "DL_COMPOSITO_ORGANIZ", "ID_ORGANIZ_IAM_AMBIENTE", "ID_ORGANIZ_IAM_ENTE") AS select
 abil.id_user_iam,
 abil.nm_userid,
 amb_sacer.nm_organiz nm_ambiente, amb_sacer.id_organiz_applic id_ambiente,
 ente_sacer.nm_organiz nm_ente, ente_sacer.id_organiz_applic id_ente,
 abil.nm_organiz nm_strut, abil.id_organiz_applic id_strut,
 
 abil.id_organiz_iam id_organiz_iam_strut, abil.dl_composito_organiz,
 
 amb_sacer.id_organiz_iam id_organiz_iam_ambiente,
 ente_sacer.id_organiz_iam id_organiz_iam_ente

from usr_v_abil_organiz abil
join usr_organiz_iam ente_sacer
 on (abil.id_organiz_iam_padre = ente_sacer.id_organiz_iam)
join usr_organiz_iam amb_sacer
 on (ente_sacer.id_organiz_iam_padre = amb_sacer.id_organiz_iam)
where abil.nm_applic = 'SACER'
and abil.nm_organiz not like 'Templa%';

-- changeset root:1753259446745-482
COMMENT ON COLUMN USR_V_ABIL_STRUT_SACER_XPING.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-483
COMMENT ON COLUMN USR_V_ABIL_STRUT_SACER_XPING.ID_STRUT IS 'PK.2';

-- changeset root:1753259446745-484
CREATE OR REPLACE FORCE VIEW "USR_V_ALLORGCHILD_BY_PRODUT" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ENTE_PRODUT", "ID_ORGANIZ_IAM_ENTE", "ID_APPART_COLLEG_ENTI", "ID_ENTE_PRODUT_COLLEG", "DS_CAUSALE_DICH") AS select 
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,
 
 ente_by_produt.id_ente_produt,
 ente_by_produt.id_organiz_iam_ente,
 null id_appart_colleg_enti,
 null id_ente_produt_colleg,
 'Appartenenza ad ente produttore' ds_causale_dich

from USR_V_ENTI_SACER_BY_PRODUT ente_by_produt					-- enti delle strut appartenenti ad ente produt dell'utente inserito / modificato
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join APL_APPLIC apl_cor
	on (apl_cor.id_applic > 0
	and apl_cor.nm_applic = 'SACER')
join USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam = ente_by_produt.id_organiz_iam_ente
	and org_ente.id_applic = apl_cor.id_applic)

where ente_by_produt.id_organiz_iam_ente in (select ente_by_user.id_organiz_iam_ente			-- ente sacer abilitato ad utente corrente
										 from USR_V_ENTI_BY_USER ente_by_user
										 where ente_by_user.id_user_iam_cor = user_cor.id_user_iam
										 and ente_by_user.id_applic = apl_cor.id_applic
										 )
and not exists (select *																		-- tutte le strut degli enti sacer appartengono al'ente produt dell'utente
				from USR_ORGANIZ_IAM org_strut
				join ORG_ENTE_CONVENZ_ORG strut_app_ente
					on (strut_app_ente.id_organiz_iam = org_strut.id_organiz_iam
					and strut_app_ente.dt_ini_val <= trunc(sysdate)
					and strut_app_ente.dt_fine_val >= trunc(sysdate))
				where org_strut.id_organiz_iam_padre = ente_by_produt.id_organiz_iam_ente

				and strut_app_ente.id_ente_convenz != ente_by_produt.id_ente_produt
				)

UNION

select 
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,

 ente_by_colleg.id_ente_produt,
 ente_by_colleg.id_organiz_iam_ente,
 ente_by_colleg.id_appart_colleg_enti,
 ente_by_colleg.id_ente_produt_colleg,
 'Ente produttore collegato ad ente a cui appartiene utente' ds_causale_dich

from USR_V_ENTI_SACER_BY_COLLEG ente_by_colleg					-- enti delle strut appartenenti ad ente produt colleg ad ente produt dell'utente inserito / modificato
join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join APL_APPLIC apl_cor
	on (apl_cor.id_applic > 0
	and apl_cor.nm_applic = 'SACER')
join USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam = ente_by_colleg.id_organiz_iam_ente
	and org_ente.id_applic = apl_cor.id_applic)

where ente_by_colleg.id_organiz_iam_ente in (select ente_by_user.id_organiz_iam_ente			-- ente sacer abilitato ad utente corrente
											 from USR_V_ENTI_BY_USER ente_by_user
											 where ente_by_user.id_user_iam_cor = user_cor.id_user_iam
											 and ente_by_user.id_applic = apl_cor.id_applic
											 )
and not exists (select *																		-- tutte le strut degli enti sacer appartengono all'ente produt collegato
				from USR_ORGANIZ_IAM org_strut
				join ORG_ENTE_CONVENZ_ORG strut_app_ente
					on (strut_app_ente.id_organiz_iam = org_strut.id_organiz_iam
					and strut_app_ente.dt_ini_val <= trunc(sysdate)
					and strut_app_ente.dt_fine_val >= trunc(sysdate))
				where org_strut.id_organiz_iam_padre = ente_by_colleg.id_organiz_iam_ente

				and strut_app_ente.id_ente_convenz != ente_by_colleg.id_ente_produt_colleg
				);

-- changeset root:1753259446745-485
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_PRODUT.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-486
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_PRODUT.ID_ORGANIZ_IAM_ENTE IS 'PK.2';

-- changeset root:1753259446745-487
CREATE OR REPLACE FORCE VIEW "USR_V_ALLORGCHILD_BY_VIGIL_COR" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ENTE_ORGANO_VIGIL", "ID_ORGANIZ_IAM_ENTE", "ID_ENTE_PRODUT_CORRISP", "DS_CAUSALE_DICH") AS select 
 user_cor.id_user_iam id_user_iam_cor,
 apl_cor.id_applic, apl_cor.nm_applic,
 
 ente_corrisp.id_ente_non_conven,
 ente_corrisp.id_organiz_iam_ente,
 ente_corrisp.id_ente_produt_corrisp,
 'Ente produttore corrispondente ad organo di vigilanza' ds_causale_dich

from USR_V_ENTI_SACER_BY_CORRISP ente_corrisp					-- enti delle strut appartenenti ad ente produt corrispondnete ad organo dell'utente inserito o modificato

join USR_USER user_cor
	on (user_cor.id_user_iam > 0)
join APL_APPLIC apl_cor
	on (apl_cor.id_applic > 0)
join USR_ORGANIZ_IAM org_ente
	on (org_ente.id_organiz_iam = ente_corrisp.id_organiz_iam_ente
	and org_ente.id_applic = apl_cor.id_applic)

where ente_corrisp.id_organiz_iam_ente in (select ente_by_user.id_organiz_iam_ente				-- ente sacer abilitato ad utente corrente
											 from USR_V_ENTI_BY_USER ente_by_user
											 where ente_by_user.id_user_iam_cor = user_cor.id_user_iam
											 and ente_by_user.id_applic = apl_cor.id_applic
											 )
and not exists (select *																	-- tutte le strut degli enti sacer appartengono all'ente produt corrispondente
				from USR_ORGANIZ_IAM org_strut
				join ORG_ENTE_CONVENZ_ORG strut_app_ente
					on (strut_app_ente.id_organiz_iam = org_strut.id_organiz_iam
					and strut_app_ente.dt_ini_val <= trunc(sysdate)
					and strut_app_ente.dt_fine_val >= trunc(sysdate)
					)
				where org_strut.id_organiz_iam_padre = ente_corrisp.id_organiz_iam_ente
				
				and strut_app_ente.id_ente_convenz != ente_corrisp.id_ente_produt_corrisp
				);

-- changeset root:1753259446745-488
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_VIGIL_COR.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-489
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_VIGIL_COR.ID_ORGANIZ_IAM_ENTE IS 'PK.2';

-- changeset root:1753259446745-490
CREATE OR REPLACE FORCE VIEW "USR_V_ALLORGCHILD_BY_FORNIT_COR" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ENTE_FORNIT_EST", "ID_ORGANIZ_IAM_ENTE", "ID_ENTE_PRODUT_CORRISP", "DS_CAUSALE_DICH") AS SELECT user_cor.id_user_iam    id_user_iam_cor,
           apl_cor.id_applic,
           apl_cor.nm_applic,
           ente_corrisp.id_ente_non_conven,
           ente_corrisp.id_organiz_iam_ente,
           ente_corrisp.id_ente_produt_corrisp,
           -- 'Ente produttore corrispondente a fornitore'     ds_causale_dich
           CASE ente_corrisp.TI_ENTE_NON_CONVENZ
               WHEN 'FORNITORE_ESTERNO'
               THEN
                   'Ente produttore corrispondente a fornitore'
               WHEN 'SOGGETTO_ATTUATORE'
               THEN
                   'Ente produttore corrispondente a soggetto attuatore'
               ELSE
                   ' '
           END                     ds_causale_dich
      FROM USR_V_ENTI_SACER_BY_CORRISP  ente_corrisp -- enti delle strut appartenenti ad ente produt corrispondnete a fornitore dell'utente inserito o modificato
           JOIN USR_USER user_cor ON (user_cor.id_user_iam > 0)
           JOIN APL_APPLIC apl_cor ON (apl_cor.id_applic > 0)
           JOIN USR_ORGANIZ_IAM org_ente
               ON (    org_ente.id_organiz_iam =
                       ente_corrisp.id_organiz_iam_ente
                   AND org_ente.id_applic = apl_cor.id_applic)
     WHERE     ente_corrisp.id_organiz_iam_ente IN
                   (SELECT ente_by_user.id_organiz_iam_ente -- ente sacer abilitato ad utente corrente
                      FROM USR_V_ENTI_BY_USER ente_by_user
                     WHERE     ente_by_user.id_user_iam_cor =
                               user_cor.id_user_iam
                           AND ente_by_user.id_applic = apl_cor.id_applic)
           AND NOT EXISTS
                   (SELECT * -- tutte le strut degli enti sacer appartengono all'ente produt corrispondente
                      FROM USR_ORGANIZ_IAM  org_strut
                           JOIN ORG_ENTE_CONVENZ_ORG strut_app_ente
                               ON (    strut_app_ente.id_organiz_iam =
                                       org_strut.id_organiz_iam
                                   AND strut_app_ente.dt_ini_val <=
                                       TRUNC (SYSDATE)
                                   AND strut_app_ente.dt_fine_val >=
                                       TRUNC (SYSDATE))
                     WHERE     org_strut.id_organiz_iam_padre =
                               ente_corrisp.id_organiz_iam_ente
                           AND strut_app_ente.id_ente_convenz !=
                               ente_corrisp.id_ente_produt_corrisp);

-- changeset root:1753259446745-491
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_FORNIT_COR.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-492
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_FORNIT_COR.ID_ORGANIZ_IAM_ENTE IS 'PK.2';

-- changeset root:1753259446745-493
CREATE OR REPLACE FORCE VIEW "USR_V_CHECK_DICH_ABIL_ORGANIZ" ("ID_DICH_ABIL_ORGANIZ_AGGIUNTA", "ID_ORGANIZ_IAM", "DL_COMPOSITO_ORGANIZ", "ID_USER_IAM_CORRENTE") AS select
 abil_aggiunta.id_dich_abil_organiz id_dich_abil_organiz_aggiunta,
 abil_aggiunta.id_organiz_iam id_organiz_iam,
 org.dl_composito_organiz dl_composito_organiz, 
 
 usr_corrente.id_user_iam id_user_iam_corrente
 
from USR_ABIL_ORGANIZ abil_aggiunta

join USR_V_TREE_ORGANIZ_IAM org
 on (org.id_organiz_iam = abil_aggiunta.id_organiz_iam)

join USR_USER usr_corrente
 on (usr_corrente.nm_userid like '%')
 
where abil_aggiunta.id_organiz_iam not in (select id_organiz_iam
										   from USR_USO_USER_APPLIC uso_apl_corrente
										   join USR_ABIL_ORGANIZ abil_corrente
												on (abil_corrente.id_uso_user_applic = uso_apl_corrente.id_uso_user_applic)
										   where uso_apl_corrente.id_user_iam = usr_corrente.id_user_iam
										   );

-- changeset root:1753259446745-494
COMMENT ON COLUMN USR_V_CHECK_DICH_ABIL_ORGANIZ.ID_DICH_ABIL_ORGANIZ_AGGIUNTA IS 'PK.1';

-- changeset root:1753259446745-495
COMMENT ON COLUMN USR_V_CHECK_DICH_ABIL_ORGANIZ.ID_ORGANIZ_IAM IS 'PK.2';

-- changeset root:1753259446745-496
COMMENT ON COLUMN USR_V_CHECK_DICH_ABIL_ORGANIZ.ID_USER_IAM_CORRENTE IS 'PK.3';

-- changeset root:1753259446745-497
CREATE OR REPLACE FORCE VIEW "ORG_V_CREA_SERV_FATT_ANNUALE" ("ID_FATTURA_ENTE", "ID_ACCORDO_ENTE", "ID_SERVIZIO_EROGATO", "AA_SERVIZIO_FATTURA", "NM_SERVIZIO_FATTURA", "IM_SERVIZIO_FATTURA", "QT_SCAGLIONE_SERVIZIO_FATTURA", "QT_UNIT_SERVIZIO_FATTURA", "DT_EROG", "NT_SERVIZIO_FATTURA", "ID_CD_IVA", "IM_IVA") AS select 
tmp.id_fattura_ente,
tmp.id_accordo_ente,

tmp.id_servizio_erogato,
tmp.aa_servizio_fattura,
tmp.nm_servizio_fattura,

tmp.im_servizio_fattura,
tmp.qt_scaglione_servizio_fattura,
tmp.qt_unit_servizio_fattura,
tmp.dt_erog,

null nt_servizio_fattura,

tmp.id_cd_iva,
case
	when iva.cd_iva = 'NOIVA'
		then 0
		else round ((tmp.im_servizio_fattura * 22 / 100), 2)
end im_iva
from ORG_V_CALC_IM_SERV_FATT_ANN tmp
join ORG_CD_IVA iva
 on (iva.id_cd_iva = tmp.id_cd_iva);

-- changeset root:1753259446745-498
COMMENT ON COLUMN ORG_V_CREA_SERV_FATT_ANNUALE.ID_FATTURA_ENTE IS 'PK.1';

-- changeset root:1753259446745-499
COMMENT ON COLUMN ORG_V_CREA_SERV_FATT_ANNUALE.ID_SERVIZIO_EROGATO IS 'PK.3';

-- changeset root:1753259446745-500
COMMENT ON COLUMN ORG_V_CREA_SERV_FATT_ANNUALE.AA_SERVIZIO_FATTURA IS 'PK.2';

-- changeset root:1753259446745-501
CREATE OR REPLACE FORCE VIEW "USR_V_ABIL_ORGANIZ_NOLAST_LIV" ("ID_USER_IAM", "ID_USO_USER_APPLIC", "ID_APPLIC", "NM_APPLIC", "ID_DICH_ABIL_ORGANIZ", "ID_ORGANIZ_IAM", "ID_ORGANIZ_APPLIC", "ID_TIPO_ORGANIZ", "NM_TIPO_ORGANIZ", "NM_ORGANIZ", "DS_ORGANIZ", "ID_ORGANIZ_IAM_PADRE", "DL_COMPOSITO_ORGANIZ", "DL_PATH_ID_ORGANIZ_IAM") AS select distinct
 abil.id_user_iam,
 abil.id_uso_user_applic,
 abil.id_applic,
 abil.nm_applic,
 abil.id_dich_abil_organiz,
 org_padre.id_organiz_iam,
 org_padre.id_organiz_applic,
 org_padre.id_tipo_organiz,
 org_padre.nm_tipo_organiz,
 org_padre.nm_organiz,
 org_padre.ds_organiz,
 org_padre.id_organiz_iam_padre,
 org_padre.dl_composito_organiz,
 org_padre.dl_path_id_organiz_iam
from USR_V_ABIL_ORGANIZ abil
 
join USR_V_TREE_ORGANIZ_IAM org_padre
 on (org_padre.id_organiz_iam = abil.id_organiz_iam_padre)
 
UNION

select distinct
 abil.id_user_iam,
 abil.id_uso_user_applic,
 abil.id_applic,
 abil.nm_applic,
 abil.id_dich_abil_organiz,
 org_nonno.id_organiz_iam,
 org_nonno.id_organiz_applic,
 org_nonno.id_tipo_organiz,
 org_nonno.nm_tipo_organiz,
 org_nonno.nm_organiz,
 org_nonno.ds_organiz,
 org_nonno.id_organiz_iam_padre,
 org_nonno.dl_composito_organiz,
 org_nonno.dl_path_id_organiz_iam
from USR_V_ABIL_ORGANIZ abil
 
join USR_V_TREE_ORGANIZ_IAM org_padre
 on (org_padre.id_organiz_iam = abil.id_organiz_iam_padre)
 
join USR_V_TREE_ORGANIZ_IAM org_nonno
 on (org_nonno.id_organiz_iam = org_padre.id_organiz_iam_padre);

-- changeset root:1753259446745-502
COMMENT ON COLUMN USR_V_ABIL_ORGANIZ_NOLAST_LIV.ID_USER_IAM IS 'PK.1';

-- changeset root:1753259446745-503
COMMENT ON COLUMN USR_V_ABIL_ORGANIZ_NOLAST_LIV.ID_ORGANIZ_IAM IS 'PK.2';

-- changeset root:1753259446745-504
CREATE OR REPLACE FORCE VIEW "USR_V_ALLORGCHILD_BY_AMMIN" ("ID_USER_IAM_COR", "ID_APPLIC", "NM_APPLIC", "ID_ORGANIZ_IAM_AMB_ENTE", "DS_CAUSALE_DICH") AS select 																		-- ambienti su cui l'utente corrente e' abilitato
 id_user_iam_cor,
 apl.id_applic, apl.nm_applic,
 amb_by_user.id_organiz_iam_amb,
 'Appartenenza ad ente amministratore' ds_causale_dich
 
from USR_V_AMB_BY_USER amb_by_user
join APL_APPLIC apl
	on (apl.id_applic = amb_by_user.id_applic)

UNION

select 																		-- enti su cui l'utente corrente e' abilitato
 id_user_iam_cor,
 apl.id_applic, apl.nm_applic,
 ente_by_user.id_organiz_iam_ente,
 'Appartenenza ad ente amministratore' ds_causale_dich
 
from USR_V_ENTI_BY_USER ente_by_user
join APL_APPLIC apl
	on (apl.id_applic = ente_by_user.id_applic
	and apl.nm_applic = 'SACER');

-- changeset root:1753259446745-505
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_AMMIN.ID_USER_IAM_COR IS 'PK.1';

-- changeset root:1753259446745-506
COMMENT ON COLUMN USR_V_ALLORGCHILD_BY_AMMIN.ID_ORGANIZ_IAM_AMB_ENTE IS 'PK.2';

-- changeset root:1753259446745-507
CREATE SEQUENCE SAPL_APPLIC START WITH 202 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-508
CREATE SEQUENCE SAPL_AZIONE_COMP_SW START WITH 283 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-509
CREATE SEQUENCE SAPL_AZIONE_PAGINA START WITH 5358 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-510
CREATE SEQUENCE SAPL_CLASSE_TIPO_DATO START WITH 221 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-511
CREATE SEQUENCE SAPL_COMP_SW START WITH 243 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-512
CREATE SEQUENCE SAPL_ENTRY_MENU START WITH 1565 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-513
CREATE SEQUENCE SAPL_HELP_ON_LINE START WITH 141 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-514
CREATE SEQUENCE SAPL_NEWS START WITH 41 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-515
CREATE SEQUENCE SAPL_NEWS_APPLIC START WITH 41 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-516
CREATE SEQUENCE SAPL_NOTA_RILASCIO START WITH 61 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-517
CREATE SEQUENCE SAPL_PAGINA_WEB START WITH 2124 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-518
CREATE SEQUENCE SAPL_PARAM_APPLIC START WITH 1 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-519
CREATE SEQUENCE SAPL_PARAM_APPLIC_REPORT START WITH 21 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-520
CREATE SEQUENCE SAPL_QUERY_TIPO_OGGETTO START WITH 406 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-521
CREATE SEQUENCE SAPL_SAML_METADATI START WITH 1 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-522
CREATE SEQUENCE SAPL_SERVIZIO_WEB START WITH 461 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-523
CREATE SEQUENCE SAPL_SISTEMA_VERSANTE START WITH 562 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-524
CREATE SEQUENCE SAPL_SISTEMA_VERSANTE_USER_REF START WITH 61 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-525
CREATE SEQUENCE SAPL_SISTEMA_VERS_ARK_RIF START WITH 141 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-526
CREATE SEQUENCE SAPL_TIPO_EVENTO START WITH 681 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-527
CREATE SEQUENCE SAPL_TIPO_EVENTO_OGGETTO START WITH 885 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-528
CREATE SEQUENCE SAPL_TIPO_EVENTO_OGGETTO_TRIG START WITH 241 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-529
CREATE SEQUENCE SAPL_TIPO_OGGETTO START WITH 281 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-530
CREATE SEQUENCE SAPL_TIPO_ORGANIZ START WITH 161 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-531
CREATE SEQUENCE SDEC_COL_QUERY_MODELLO_COMUNIC START WITH 21 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-532
CREATE SEQUENCE SDEC_JOB START WITH 81 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-533
CREATE SEQUENCE SDEC_MODELLO_COMUNIC START WITH 41 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-534
CREATE SEQUENCE SDEC_QUERY_MODELLO_COMUNIC START WITH 21 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-535
CREATE SEQUENCE SDEC_USO_MODELLO_COMUNIC START WITH 44 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-536
CREATE SEQUENCE SIAM_PARAM_APPLIC START WITH 541 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-537
CREATE SEQUENCE SIAM_VALORE_PARAM_APPLIC START WITH 641 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-538
CREATE SEQUENCE SLOG_AGENTE START WITH 3282 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-539
CREATE SEQUENCE SNTF_NOTIFICA START WITH 1 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-540
CREATE SEQUENCE SORG_AA_ACCORDO START WITH 541 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-541
CREATE SEQUENCE SORG_AA_FATTURA START WITH 21 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-542
CREATE SEQUENCE SORG_ACCORDO_ENTE START WITH 1701 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-543
CREATE SEQUENCE SORG_ACCORDO_VIGIL START WITH 21 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-544
CREATE SEQUENCE SORG_AMBIENTE_ENTE_CONVENZ START WITH 261 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-545
CREATE SEQUENCE SORG_AMBITO_TERRIT START WITH 41 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-546
CREATE SEQUENCE SORG_APPART_COLLEG_ENTI START WITH 501 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-547
CREATE SEQUENCE SORG_CD_IVA START WITH 41 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-548
CREATE SEQUENCE SORG_CLASSE_ENTE_CONVENZ START WITH 21 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-549
CREATE SEQUENCE SORG_COLLEG_ENTI_CONVENZ START WITH 341 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-550
CREATE SEQUENCE SORG_DISCIP_STRUT START WITH 763 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-551
CREATE SEQUENCE SORG_ENTE_ARK_RIF START WITH 561 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-552
CREATE SEQUENCE SORG_ENTE_CONVENZ_ORG START WITH 11827 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-553
CREATE SEQUENCE SORG_ENTE_SIAM START WITH 1481 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-554
CREATE SEQUENCE SORG_ENTE_USER_RIF START WITH 381 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-555
CREATE SEQUENCE SORG_FATTURA_ENTE START WITH 561 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-556
CREATE SEQUENCE SORG_GESTIONE_ACCORDO START WITH 281 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-557
CREATE SEQUENCE SORG_MODIF_FATTURA_ENTE START WITH 361 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-558
CREATE SEQUENCE SORG_MODULO_INFO_ACCORDO START WITH 341 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-559
CREATE SEQUENCE SORG_PAGAM_FATTURA_ENTE START WITH 141 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-560
CREATE SEQUENCE SORG_SCAGLIONE_TARIFFA START WITH 141 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-561
CREATE SEQUENCE SORG_SERVIZIO_EROG START WITH 1401 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-562
CREATE SEQUENCE SORG_SERVIZIO_FATTURA START WITH 921 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-563
CREATE SEQUENCE SORG_SOLLECITO_FATTURA_ENTE START WITH 41 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-564
CREATE SEQUENCE SORG_STATO_FATTURA_ENTE START WITH 881 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-565
CREATE SEQUENCE SORG_STO_ENTE_AMBIENTE_CONVENZ START WITH 61 INCREMENT BY 1 MINVALUE 0 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-566
CREATE SEQUENCE SORG_STO_ENTE_CONVENZ START WITH 481 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-567
CREATE SEQUENCE SORG_SUPT_ESTERNO_ENTE_CONVENZ START WITH 441 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-568
CREATE SEQUENCE SORG_TARIFFA START WITH 341 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-569
CREATE SEQUENCE SORG_TARIFFARIO START WITH 321 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-570
CREATE SEQUENCE SORG_TARIFFA_AA_ACCORDO START WITH 101 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-571
CREATE SEQUENCE SORG_TARIFFA_ACCORDO START WITH 301 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-572
CREATE SEQUENCE SORG_TIPI_GESTIONE_ACCORDO START WITH 41 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-573
CREATE SEQUENCE SORG_TIPO_ACCORDO START WITH 161 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-574
CREATE SEQUENCE SORG_TIPO_SERVIZIO START WITH 221 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-575
CREATE SEQUENCE SORG_VIGIL_ENTE_PRODUT START WITH 121 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-576
CREATE SEQUENCE SPRF_ALLINEA_RUOLO START WITH 7801 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-577
CREATE SEQUENCE SPRF_AUTOR START WITH 2351896 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-578
CREATE SEQUENCE SPRF_DICH_AUTOR START WITH 22881 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-579
CREATE SEQUENCE SPRF_RUOLO START WITH 1243 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-580
CREATE SEQUENCE SPRF_RUOLO_CATEGORIA START WITH 481 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-581
CREATE SEQUENCE SPRF_USO_RUOLO_APPLIC START WITH 1666 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-582
CREATE SEQUENCE SUSR_ABIL_DATI START WITH 1157928 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-583
CREATE SEQUENCE SUSR_ABIL_ENTE_SIAM START WITH 5102 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-584
CREATE SEQUENCE SUSR_ABIL_ORGANIZ START WITH 190750 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-585
CREATE SEQUENCE SUSR_APPART_USER_RICH START WITH 4128 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-586
CREATE SEQUENCE SUSR_DICH_ABIL_DATI START WITH 6789 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-587
CREATE SEQUENCE SUSR_DICH_ABIL_ENTE_CONVENZ START WITH 961 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-588
CREATE SEQUENCE SUSR_DICH_ABIL_ORGANIZ START WITH 4393 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-589
CREATE SEQUENCE SUSR_IND_IP_USER START WITH 141 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-590
CREATE SEQUENCE SUSR_ORGANIZ_IAM START WITH 12168 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-591
CREATE SEQUENCE SUSR_RICH_GEST_USER START WITH 3382 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-592
CREATE SEQUENCE SUSR_RICH_GEST_USER_CD START WITH 1787 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-593
CREATE SEQUENCE SUSR_STATO_USER START WITH 4445 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-594
CREATE SEQUENCE SUSR_TIPO_DATO_IAM START WITH 96399 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-595
CREATE SEQUENCE SUSR_USER START WITH 4804 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-596
CREATE SEQUENCE SUSR_USO_RUOLO_APPLIC START WITH 1 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-597
CREATE SEQUENCE SUSR_USO_RUOLO_DICH START WITH 181 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-598
CREATE SEQUENCE SUSR_USO_RUOLO_USER_DEFAULT START WITH 5480 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-599
CREATE SEQUENCE SUSR_USO_USER_APPLIC START WITH 5196 INCREMENT BY 1 MINVALUE 1 MAXVALUE 9999999999999999999999999999 CACHE 20 NOORDER;

-- changeset root:1753259446745-600
CREATE TABLE APL_NEWS (ID_NEWS NUMBER NOT NULL, DT_INI_PUBBLIC date NOT NULL, DT_FIN_PUBBLIC date NOT NULL, DS_OGGETTO VARCHAR2(254 BYTE) NOT NULL, FL_PUBBLIC_LOGIN CHAR(1 BYTE) DEFAULT '1' NOT NULL, FL_PUBBLIC_HOMEPAGE CHAR(1 BYTE) DEFAULT '1' NOT NULL, DL_TESTO VARCHAR2(4000 BYTE), CONSTRAINT PK_NEWS PRIMARY KEY (ID_NEWS));

-- changeset root:1753259446745-601
CREATE TABLE APL_NEWS_APPLIC (ID_NEWS_APPLIC NUMBER NOT NULL, ID_NEWS NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, CONSTRAINT PK_NEWS_APL PRIMARY KEY (ID_NEWS_APPLIC));

-- changeset root:1753259446745-602
CREATE TABLE APL_NOTA_RILASCIO (ID_NOTA_RILASCIO NUMBER NOT NULL, ID_APPLIC NUMBER NOT NULL, CD_VERSIONE VARCHAR2(100 BYTE) NOT NULL, DT_VERSIONE date NOT NULL, DT_INI_VAL date NOT NULL, DT_FINE_VAL date, DS_EVIDENZA VARCHAR2(4000 BYTE), BL_NOTA CLOB NOT NULL, CONSTRAINT PK_APL_NOTA_RILASCIO PRIMARY KEY (ID_NOTA_RILASCIO));

-- changeset root:1753259446745-603
CREATE TABLE APL_PARAM_APPLIC_REPORT (ID_PARAM_APPLIC_REPORT NUMBER NOT NULL, NM_APPLIC VARCHAR2(100 BYTE) NOT NULL, NM_REPORT VARCHAR2(100 BYTE) NOT NULL, BL_FILE_1 CLOB, BL_FILE_2 CLOB, BL_FILE_3 CLOB, CONSTRAINT PK_PAR_APL_RPT PRIMARY KEY (ID_PARAM_APPLIC_REPORT));

-- changeset root:1753259446745-604
CREATE TABLE APL_SAML_METADATI (ID_SAML_METADATI NUMBER NOT NULL, BL_SAML_METADATI CLOB NOT NULL, CONSTRAINT PK_SAML_META PRIMARY KEY (ID_SAML_METADATI));

-- changeset root:1753259446745-605
CREATE TABLE DEC_COL_QUERY_MODELLO_COMUNIC (ID_COL_QUERY_MODELLO_COMUNIC NUMBER NOT NULL, ID_QUERY_MODELLO_COMUNIC NUMBER NOT NULL, PG_POSIZ_COL NUMBER NOT NULL, NM_COL VARCHAR2(100 BYTE) NOT NULL, CONSTRAINT PK_COL_QRY_MODL_COM PRIMARY KEY (ID_COL_QUERY_MODELLO_COMUNIC));

-- changeset root:1753259446745-606 splitStatements:true
CREATE TABLE DEC_JOB (ID_JOB NUMBER NOT NULL, NM_JOB VARCHAR2(100 BYTE) NOT NULL, TI_SCHED_JOB VARCHAR2(20 BYTE) NOT NULL, TI_SCOPO_JOB VARCHAR2(20 BYTE) NOT NULL, NM_NODO_ASSEGNATO VARCHAR2(100 BYTE), TI_STATO_TIMER VARCHAR2(20 BYTE), CD_SCHED_HOUR VARCHAR2(100 BYTE), CD_SCHED_MINUTE VARCHAR2(100 BYTE), CD_SCHED_DAYOFMONTH VARCHAR2(100 BYTE), CD_SCHED_MONTH VARCHAR2(100 BYTE), CD_SCHED_DAYOFWEEK VARCHAR2(100 BYTE), DT_PROSSIMA_ATTIVAZIONE date, FL_DATA_ACCURATA VARCHAR2(1 BYTE), DS_JOB VARCHAR2(200 BYTE), NM_AMBITO VARCHAR2(200 BYTE), NI_ORD_EXEC NUMBER, CONSTRAINT PK_JOB PRIMARY KEY (ID_JOB));
COMMENT ON TABLE DEC_JOB IS 'Tabella per configurare l''esecuzione dei timer. Utilizzata dai job su jboss e dalle sonde Zabbix';
COMMENT ON COLUMN DEC_JOB.NM_NODO_ASSEGNATO IS 'Nome del nodo del cluster su cui verrà eseguito il job';
COMMENT ON COLUMN DEC_JOB.TI_STATO_TIMER IS 'Stato del job: ATTIVO, INATTIVO o ESECUZIONE_SINGOLA';
COMMENT ON COLUMN DEC_JOB.CD_SCHED_HOUR IS 'Campo ''ora'' nella schedulazione del job';
COMMENT ON COLUMN DEC_JOB.CD_SCHED_MINUTE IS 'Campo ''minuto'' nella schedulazione del job';
COMMENT ON COLUMN DEC_JOB.CD_SCHED_DAYOFMONTH IS 'Campo ''giorno del mese'' nella schedulazione del job';
COMMENT ON COLUMN DEC_JOB.CD_SCHED_MONTH IS 'Campo ''mese'' nella schedulazione del job';
COMMENT ON COLUMN DEC_JOB.CD_SCHED_DAYOFWEEK IS 'Campo ''giorno della settimana'' nella schedulazione del job';
COMMENT ON COLUMN DEC_JOB.DT_PROSSIMA_ATTIVAZIONE IS 'Quando il job verrà eseguito la prossima volta (se è attivo).';

-- changeset root:1753259446745-607 splitStatements:true
CREATE TABLE DEC_JOB_FOTO (ID_JOB_FOTO NUMBER NOT NULL, NM_JOB_FOTO VARCHAR2(100 BYTE) NOT NULL, TI_SCHED_JOB_FOTO VARCHAR2(20 BYTE) NOT NULL, TI_SCOPO_JOB_FOTO VARCHAR2(40 BYTE) NOT NULL, NM_NODO_ASSEGNATO_FOTO VARCHAR2(100 BYTE), TI_STATO_TIMER_FOTO VARCHAR2(20 BYTE), CD_SCHED_HOUR_FOTO VARCHAR2(100 BYTE), CD_SCHED_MINUTE_FOTO VARCHAR2(100 BYTE), CD_SCHED_DAYOFMONTH_FOTO VARCHAR2(100 BYTE), CD_SCHED_MONTH_FOTO VARCHAR2(100 BYTE), CD_SCHED_DAYOFWEEK_FOTO VARCHAR2(100 BYTE), DT_PROSSIMA_ATTIVAZIONE_FOTO date, FL_DATA_ACCURATA_FOTO VARCHAR2(1 BYTE), DS_JOB_FOTO VARCHAR2(200 BYTE), NM_AMBITO_FOTO VARCHAR2(200 BYTE), NI_ORD_EXEC_FOTO NUMBER, DT_JOB_FOTO date, CONSTRAINT PK_JOB_FOTO PRIMARY KEY (ID_JOB_FOTO));
COMMENT ON TABLE DEC_JOB_FOTO IS 'Tabella per configurare l''esecuzione dei timer. Utilizzata dai job su jboss e dalle sonde Zabbix';
COMMENT ON COLUMN DEC_JOB_FOTO.NM_NODO_ASSEGNATO_FOTO IS 'Nome del nodo del cluster su cui verrà eseguito il job';
COMMENT ON COLUMN DEC_JOB_FOTO.TI_STATO_TIMER_FOTO IS 'Stato del job: ATTIVO, INATTIVO o ESECUZIONE_SINGOLA';
COMMENT ON COLUMN DEC_JOB_FOTO.CD_SCHED_HOUR_FOTO IS 'Campo ''ora'' nella schedulazione del job';
COMMENT ON COLUMN DEC_JOB_FOTO.CD_SCHED_MINUTE_FOTO IS 'Campo ''minuto'' nella schedulazione del job';
COMMENT ON COLUMN DEC_JOB_FOTO.CD_SCHED_DAYOFMONTH_FOTO IS 'Campo ''giorno del mese'' nella schedulazione del job';
COMMENT ON COLUMN DEC_JOB_FOTO.CD_SCHED_MONTH_FOTO IS 'Campo ''mese'' nella schedulazione del job';
COMMENT ON COLUMN DEC_JOB_FOTO.CD_SCHED_DAYOFWEEK_FOTO IS 'Campo ''giorno della settimana'' nella schedulazione del job';
COMMENT ON COLUMN DEC_JOB_FOTO.DT_PROSSIMA_ATTIVAZIONE_FOTO IS 'Quando il job verrà eseguito la prossima volta (se è attivo).';

-- changeset root:1753259446745-608
CREATE TABLE DEC_MODELLO_COMUNIC (ID_MODELLO_COMUNIC NUMBER NOT NULL, CD_MODELLO_COMUNIC VARCHAR2(100 BYTE) NOT NULL, DS_MODELLO_COMUNIC VARCHAR2(254 BYTE) NOT NULL, TI_COMUNIC VARCHAR2(20 BYTE) NOT NULL, TI_OGGETTO_QUERY VARCHAR2(30 BYTE) NOT NULL, DT_ISTITUZ date NOT NULL, DT_SOPPRES date NOT NULL, TI_STATO_TRIG_COMUNIC VARCHAR2(30 BYTE), NM_MITTENTE VARCHAR2(100 BYTE), DS_OGGETTO_COMUNIC VARCHAR2(254 BYTE), BL_TESTO_COMUNIC CLOB NOT NULL, CONSTRAINT PK_MODL_COM PRIMARY KEY (ID_MODELLO_COMUNIC));

-- changeset root:1753259446745-609
CREATE TABLE DEC_QUERY_MODELLO_COMUNIC (ID_QUERY_MODELLO_COMUNIC NUMBER NOT NULL, ID_MODELLO_COMUNIC NUMBER NOT NULL, TI_USO_QUERY VARCHAR2(30 BYTE) NOT NULL, BL_QUERY CLOB NOT NULL, NM_QUERY VARCHAR2(100 BYTE) NOT NULL, TI_RESULT_SET VARCHAR2(20 BYTE) NOT NULL, CONSTRAINT PK_QRY_MODL_COM PRIMARY KEY (ID_QUERY_MODELLO_COMUNIC));

-- changeset root:1753259446745-610
CREATE TABLE DEC_USO_MODELLO_COMUNIC (ID_USO_MODELLO_COMUNIC NUMBER NOT NULL, ID_MODELLO_COMUNIC NUMBER NOT NULL, PG_USO NUMBER NOT NULL, TIPO_USO VARCHAR2(30 BYTE) NOT NULL, ID_AMBIENTE_ENTE_CONVENZ NUMBER, ID_ENTE_CONVENZ NUMBER, CONSTRAINT PK_USO_MODL_COM PRIMARY KEY (ID_USO_MODELLO_COMUNIC));

-- changeset root:1753259446745-611
CREATE TABLE NTF_NOTIFICA (ID_NOTIFICA NUMBER NOT NULL, ID_MODELLO_COMUNIC NUMBER NOT NULL, DS_EMAIL_DESTINATARIO VARCHAR2(254 BYTE) NOT NULL, TS_NOTIF TIMESTAMP(6) NOT NULL, NM_MITTENTE VARCHAR2(100 BYTE) NOT NULL, DS_OGGETTO VARCHAR2(254 BYTE) NOT NULL, DS_TESTO_NOTIFICA VARCHAR2(4000 BYTE), DS_DESTINATARIO VARCHAR2(100 BYTE) NOT NULL, TI_STATO_NOTIF VARCHAR2(30 BYTE) NOT NULL, CONSTRAINT PK_NOTIF PRIMARY KEY (ID_NOTIFICA));

-- changeset root:1753259446745-612
CREATE TABLE ORG_CLUSTER_ACCORDO (ID_CLUSTER_ACCORDO NUMBER GENERATED BY DEFAULT AS IDENTITY NOT NULL, CD_CLUSTER VARCHAR2(20 BYTE) NOT NULL, ID_FASCIA_STORAGE_ACCORDO NUMBER NOT NULL, CONSTRAINT PK_CLUSTER_ACCORDO PRIMARY KEY (ID_CLUSTER_ACCORDO));

-- changeset root:1753259446745-613
CREATE TABLE ORG_DISCIP_STRUT (ID_DISCIP_STRUT NUMBER NOT NULL, ID_ACCORDO_ENTE NUMBER, ID_ORGANIZ_IAM NUMBER NOT NULL, DT_DISCIP_STRUT date NOT NULL, BL_DISCIP_STRUT BLOB, DS_NOTE_DISCIP_STRUT VARCHAR2(4000 BYTE), DS_DISCIP_STRUT VARCHAR2(1024 BYTE), FL_INSERITO_MANUALMENTE CHAR(1 BYTE) DEFAULT 0 NOT NULL, CD_REGISTRO_DISCIP_STRUT VARCHAR2(100 BYTE), AA_DISCIP_STRUT NUMBER(4, 0), CD_KEY_DISCIP_STRUT VARCHAR2(100 BYTE), ENTE_DISCIP_STRUT VARCHAR2(100 BYTE), STRUTTURA_DISCIP_STRUT VARCHAR2(100 BYTE), ID_ENTE_CONVENZ NUMBER, CONSTRAINT PK_DISCIP_STRUT PRIMARY KEY (ID_DISCIP_STRUT));

-- changeset root:1753259446745-614
CREATE TABLE ORG_MODIF_FATTURA_ENTE (ID_MODIF_FATTURA_ENTE NUMBER NOT NULL, ID_FATTURA_ENTE NUMBER NOT NULL, DT_MODIF_FATTURA_ENTE date NOT NULL, NT_MODIF_FATTURA_ENTE VARCHAR2(1024 BYTE) NOT NULL, CONSTRAINT PK_MOD_FATT_ENTE PRIMARY KEY (ID_MODIF_FATTURA_ENTE));

-- changeset root:1753259446745-615
CREATE TABLE ORG_SOLLECITO_FATTURA_ENTE (ID_SOLLECITO_FATTURA_ENTE NUMBER NOT NULL, ID_FATTURA_ENTE NUMBER NOT NULL, CD_REGISTRO_SOLLECITO VARCHAR2(100 BYTE) NOT NULL, AA_VAR_SOLLECITO NUMBER(4, 0) NOT NULL, CD_KEY_VAR_SOLLECITO VARCHAR2(100 BYTE) NOT NULL, DT_SOLLECITO date NOT NULL, DL_SOLLECITO VARCHAR2(4000 BYTE), CONSTRAINT PK_SOLL_FATT_ENTE PRIMARY KEY (ID_SOLLECITO_FATTURA_ENTE));

-- changeset root:1753259446745-616
CREATE TABLE ORG_STO_ENTE_AMBIENTE_CONVENZ (ID_STO_ENTE_AMBIENTE_CONVENZ NUMBER NOT NULL, ID_ENTE_CONVENZ NUMBER NOT NULL, DT_INI_VAL date NOT NULL, ID_AMBIENTE_ENTE_CONVENZ NUMBER NOT NULL, DT_FIN_VAL date NOT NULL, CONSTRAINT PK_STO_ENTE_AMB_CONV PRIMARY KEY (ID_STO_ENTE_AMBIENTE_CONVENZ));

-- changeset root:1753259446745-617
CREATE TABLE ORG_STO_ENTE_CONVENZ (ID_STO_ENTE_CONVENZ NUMBER NOT NULL, ID_ENTE_CONVENZ NUMBER NOT NULL, DT_INI_VAL date NOT NULL, DT_FINE_VAL date NOT NULL, NM_ENTE_CONVENZ VARCHAR2(254 BYTE) NOT NULL, CD_FISC VARCHAR2(16 BYTE), CD_ENTE_CONVENZ VARCHAR2(100 BYTE) NOT NULL, DS_VIA_SEDE_LEGALE VARCHAR2(254 BYTE), DS_CITTA_SEDE_LEGALE VARCHAR2(254 BYTE), ID_AMBITO_TERRIT NUMBER NOT NULL, ID_CATEG_ENTE NUMBER NOT NULL, DL_NOTE VARCHAR2(254 BYTE), ID_PROV_SEDE_LEGALE NUMBER, CD_NAZIONE_SEDE_LEGALE VARCHAR2(254 BYTE) DEFAULT 'IT' NOT NULL, TI_CD_ENTE_CONVENZ VARCHAR2(20 BYTE) DEFAULT 'IPA Ente' NOT NULL, CD_CAP_SEDE_LEGALE VARCHAR2(5 BYTE), CONSTRAINT PK_STO_ENTE_CONVENZ PRIMARY KEY (ID_STO_ENTE_CONVENZ));

-- changeset root:1753259446745-618
CREATE TABLE PLAN_TABLE (STATEMENT_ID VARCHAR2(30 BYTE), PLAN_ID NUMBER, TIMESTAMP date, REMARKS VARCHAR2(4000 BYTE), OPERATION VARCHAR2(30 BYTE), OPTIONS VARCHAR2(255 BYTE), OBJECT_NODE VARCHAR2(128 BYTE), OBJECT_OWNER VARCHAR2(128 BYTE), OBJECT_NAME VARCHAR2(128 BYTE), OBJECT_ALIAS VARCHAR2(65 BYTE), OBJECT_INSTANCE NUMBER(*, 0), OBJECT_TYPE VARCHAR2(30 BYTE), OPTIMIZER VARCHAR2(255 BYTE), SEARCH_COLUMNS NUMBER, ID NUMBER(*, 0), PARENT_ID NUMBER(*, 0), DEPTH NUMBER(*, 0), POSITION NUMBER(*, 0), COST NUMBER(*, 0), CARDINALITY NUMBER(*, 0), BYTES NUMBER(*, 0), OTHER_TAG VARCHAR2(255 BYTE), PARTITION_START VARCHAR2(255 BYTE), PARTITION_STOP VARCHAR2(255 BYTE), PARTITION_ID NUMBER(*, 0), OTHER LONG, DISTRIBUTION VARCHAR2(30 BYTE), CPU_COST NUMBER(*, 0), IO_COST NUMBER(*, 0), TEMP_SPACE NUMBER(*, 0), ACCESS_PREDICATES VARCHAR2(4000 BYTE), FILTER_PREDICATES VARCHAR2(4000 BYTE), PROJECTION VARCHAR2(4000 BYTE), TIME NUMBER(*, 0), QBLOCK_NAME VARCHAR2(128 BYTE), OTHER_XML CLOB);

-- changeset root:1753259446745-619
CREATE TABLE USR_IND_IP_USER (ID_IND_IP_USER NUMBER NOT NULL, ID_USER_IAM NUMBER NOT NULL, CD_IND_IP_USER VARCHAR2(100 BYTE) NOT NULL, CONSTRAINT PK_IND_IP PRIMARY KEY (ID_IND_IP_USER));

-- changeset root:1753259446745-620
CREATE TABLE USR_USER_EXT (ID_USER_IAM NUMBER NOT NULL, DL_CERT_CLIENT CLOB, CONSTRAINT USR_USER_EXT_PK PRIMARY KEY (ID_USER_IAM));

-- changeset root:1753259446745-621
CREATE UNIQUE INDEX UN_AA_FATT ON ORG_AA_FATTURA(AA_FATTURA);

-- changeset root:1753259446745-622
ALTER TABLE ORG_AA_FATTURA ADD CONSTRAINT UN_AA_FATT UNIQUE (AA_FATTURA) USING INDEX UN_AA_FATT;

-- changeset root:1753259446745-623
CREATE UNIQUE INDEX UN_ABIL_DATI ON USR_ABIL_DATI(ID_USO_USER_APPLIC, ID_TIPO_DATO_IAM, ID_SUPT_EST_ENTE_CONVENZ, ID_VIGIL_ENTE_PRODUT);

-- changeset root:1753259446745-624
ALTER TABLE USR_ABIL_DATI ADD CONSTRAINT UN_ABIL_DATI UNIQUE (ID_USO_USER_APPLIC, ID_TIPO_DATO_IAM, ID_SUPT_EST_ENTE_CONVENZ, ID_VIGIL_ENTE_PRODUT) USING INDEX UN_ABIL_DATI;

-- changeset root:1753259446745-625
CREATE UNIQUE INDEX UN_ABIL_ENTE ON USR_ABIL_ENTE_SIAM(ID_USER_IAM, ID_ENTE_SIAM, ID_APPART_COLLEG_ENTI);

-- changeset root:1753259446745-626
ALTER TABLE USR_ABIL_ENTE_SIAM ADD CONSTRAINT UN_ABIL_ENTE UNIQUE (ID_USER_IAM, ID_ENTE_SIAM, ID_APPART_COLLEG_ENTI) USING INDEX UN_ABIL_ENTE;

-- changeset root:1753259446745-627
CREATE UNIQUE INDEX UN_ABIL_ORG ON USR_ABIL_ORGANIZ(ID_USO_USER_APPLIC, ID_ORGANIZ_IAM);

-- changeset root:1753259446745-628
ALTER TABLE USR_ABIL_ORGANIZ ADD CONSTRAINT UN_ABIL_ORG UNIQUE (ID_USO_USER_APPLIC, ID_ORGANIZ_IAM) USING INDEX UN_ABIL_ORG;

-- changeset root:1753259446745-629
CREATE UNIQUE INDEX UN_ACCOR_ENTE ON ORG_ACCORDO_ENTE(ID_ENTE_CONVENZ, DT_DEC_ACCORDO);

-- changeset root:1753259446745-630
ALTER TABLE ORG_ACCORDO_ENTE ADD CONSTRAINT UN_ACCOR_ENTE UNIQUE (ID_ENTE_CONVENZ, DT_DEC_ACCORDO) USING INDEX UN_ACCOR_ENTE;

-- changeset root:1753259446745-631
CREATE UNIQUE INDEX UN_ACC_VIG ON ORG_ACCORDO_VIGIL(ID_ENTE_ORGANO_VIGIL, ID_ENTE_CONSERV, DT_INI_VAL);

-- changeset root:1753259446745-632
ALTER TABLE ORG_ACCORDO_VIGIL ADD CONSTRAINT UN_ACC_VIG UNIQUE (ID_ENTE_ORGANO_VIGIL, ID_ENTE_CONSERV, DT_INI_VAL) USING INDEX UN_ACC_VIG;

-- changeset root:1753259446745-633
CREATE UNIQUE INDEX UN_AGENT ON LOG_AGENTE(NM_AGENTE);

-- changeset root:1753259446745-634
ALTER TABLE LOG_AGENTE ADD CONSTRAINT UN_AGENT UNIQUE (NM_AGENTE) USING INDEX UN_AGENT;

-- changeset root:1753259446745-635
CREATE UNIQUE INDEX UN_AMB_ENTE_CONVENZ ON ORG_AMBIENTE_ENTE_CONVENZ(NM_AMBIENTE_ENTE_CONVENZ);

-- changeset root:1753259446745-636
ALTER TABLE ORG_AMBIENTE_ENTE_CONVENZ ADD CONSTRAINT UN_AMB_ENTE_CONVENZ UNIQUE (NM_AMBIENTE_ENTE_CONVENZ) USING INDEX UN_AMB_ENTE_CONVENZ;

-- changeset root:1753259446745-637
CREATE UNIQUE INDEX UN_AMB_TRT ON ORG_AMBITO_TERRIT(CD_AMBITO_TERRIT);

-- changeset root:1753259446745-638
ALTER TABLE ORG_AMBITO_TERRIT ADD CONSTRAINT UN_AMB_TRT UNIQUE (CD_AMBITO_TERRIT) USING INDEX UN_AMB_TRT;

-- changeset root:1753259446745-639
CREATE UNIQUE INDEX UN_APL ON APL_APPLIC(NM_APPLIC);

-- changeset root:1753259446745-640
ALTER TABLE APL_APPLIC ADD CONSTRAINT UN_APL UNIQUE (NM_APPLIC) USING INDEX UN_APL;

-- changeset root:1753259446745-641
CREATE UNIQUE INDEX UN_APP_COLLEG_ENTI ON ORG_APPART_COLLEG_ENTI(ID_COLLEG_ENTI_CONVENZ, ID_ENTE_CONVENZ, DT_INI_VAL);

-- changeset root:1753259446745-642
ALTER TABLE ORG_APPART_COLLEG_ENTI ADD CONSTRAINT UN_APP_COLLEG_ENTI UNIQUE (ID_COLLEG_ENTI_CONVENZ, ID_ENTE_CONVENZ, DT_INI_VAL) USING INDEX UN_APP_COLLEG_ENTI;

-- changeset root:1753259446745-643
CREATE UNIQUE INDEX UN_AZN_COMP_SW ON APL_AZIONE_COMP_SW(ID_COMP_SW, NM_AZIONE_COMP_SW);

-- changeset root:1753259446745-644
ALTER TABLE APL_AZIONE_COMP_SW ADD CONSTRAINT UN_AZN_COMP_SW UNIQUE (ID_COMP_SW, NM_AZIONE_COMP_SW) USING INDEX UN_AZN_COMP_SW;

-- changeset root:1753259446745-645
CREATE UNIQUE INDEX UN_AZN_PAG ON APL_AZIONE_PAGINA(ID_PAGINA_WEB, NM_AZIONE_PAGINA);

-- changeset root:1753259446745-646
ALTER TABLE APL_AZIONE_PAGINA ADD CONSTRAINT UN_AZN_PAG UNIQUE (ID_PAGINA_WEB, NM_AZIONE_PAGINA) USING INDEX UN_AZN_PAG;

-- changeset root:1753259446745-647
CREATE UNIQUE INDEX UN_CD_IVA ON ORG_CD_IVA(CD_IVA);

-- changeset root:1753259446745-648
ALTER TABLE ORG_CD_IVA ADD CONSTRAINT UN_CD_IVA UNIQUE (CD_IVA) USING INDEX UN_CD_IVA;

-- changeset root:1753259446745-649
CREATE UNIQUE INDEX UN_CLA_ENTE_CONVENZ ON ORG_CLASSE_ENTE_CONVENZ(CD_CLASSE_ENTE_CONVENZ);

-- changeset root:1753259446745-650
ALTER TABLE ORG_CLASSE_ENTE_CONVENZ ADD CONSTRAINT UN_CLA_ENTE_CONVENZ UNIQUE (CD_CLASSE_ENTE_CONVENZ) USING INDEX UN_CLA_ENTE_CONVENZ;

-- changeset root:1753259446745-651
CREATE UNIQUE INDEX UN_CLA_TI_DATO ON APL_CLASSE_TIPO_DATO(ID_APPLIC, NM_CLASSE_TIPO_DATO);

-- changeset root:1753259446745-652
ALTER TABLE APL_CLASSE_TIPO_DATO ADD CONSTRAINT UN_CLA_TI_DATO UNIQUE (ID_APPLIC, NM_CLASSE_TIPO_DATO) USING INDEX UN_CLA_TI_DATO;

-- changeset root:1753259446745-653
CREATE UNIQUE INDEX UN_CLUSTER_ACCORDO ON ORG_CLUSTER_ACCORDO(CD_CLUSTER);

-- changeset root:1753259446745-654
ALTER TABLE ORG_CLUSTER_ACCORDO ADD CONSTRAINT UN_CLUSTER_ACCORDO UNIQUE (CD_CLUSTER) USING INDEX UN_CLUSTER_ACCORDO;

-- changeset root:1753259446745-655
CREATE UNIQUE INDEX UN_COLLEG_ENTI_CONV ON ORG_COLLEG_ENTI_CONVENZ(NM_COLLEG);

-- changeset root:1753259446745-656
ALTER TABLE ORG_COLLEG_ENTI_CONVENZ ADD CONSTRAINT UN_COLLEG_ENTI_CONV UNIQUE (NM_COLLEG) USING INDEX UN_COLLEG_ENTI_CONV;

-- changeset root:1753259446745-657
CREATE UNIQUE INDEX UN_COL_QRY_MODL_COM_NM ON DEC_COL_QUERY_MODELLO_COMUNIC(ID_QUERY_MODELLO_COMUNIC, NM_COL);

-- changeset root:1753259446745-658
ALTER TABLE DEC_COL_QUERY_MODELLO_COMUNIC ADD CONSTRAINT UN_COL_QRY_MODL_COM_NM UNIQUE (ID_QUERY_MODELLO_COMUNIC, NM_COL) USING INDEX UN_COL_QRY_MODL_COM_NM;

-- changeset root:1753259446745-659
CREATE UNIQUE INDEX UN_COL_QRY_MODL_COM_PG ON DEC_COL_QUERY_MODELLO_COMUNIC(ID_QUERY_MODELLO_COMUNIC, PG_POSIZ_COL);

-- changeset root:1753259446745-660
ALTER TABLE DEC_COL_QUERY_MODELLO_COMUNIC ADD CONSTRAINT UN_COL_QRY_MODL_COM_PG UNIQUE (ID_QUERY_MODELLO_COMUNIC, PG_POSIZ_COL) USING INDEX UN_COL_QRY_MODL_COM_PG;

-- changeset root:1753259446745-661
CREATE UNIQUE INDEX UN_COMP_SW ON APL_COMP_SW(ID_APPLIC, NM_COMP_SW);

-- changeset root:1753259446745-662
ALTER TABLE APL_COMP_SW ADD CONSTRAINT UN_COMP_SW UNIQUE (ID_APPLIC, NM_COMP_SW) USING INDEX UN_COMP_SW;

-- changeset root:1753259446745-663
CREATE UNIQUE INDEX UN_COMP_SW_AGENT ON APL_COMP_SW(ID_AGENTE);

-- changeset root:1753259446745-664
ALTER TABLE APL_COMP_SW ADD CONSTRAINT UN_COMP_SW_AGENT UNIQUE (ID_AGENTE) USING INDEX UN_COMP_SW_AGENT;

-- changeset root:1753259446745-665
CREATE UNIQUE INDEX UN_DISCIP_STRUT ON ORG_DISCIP_STRUT(ID_ACCORDO_ENTE, ID_ORGANIZ_IAM, DT_DISCIP_STRUT);

-- changeset root:1753259446745-666
ALTER TABLE ORG_DISCIP_STRUT ADD CONSTRAINT UN_DISCIP_STRUT UNIQUE (ID_ACCORDO_ENTE, ID_ORGANIZ_IAM, DT_DISCIP_STRUT) USING INDEX UN_DISCIP_STRUT;

-- changeset root:1753259446745-667
CREATE UNIQUE INDEX UN_ENTE_ARK_RIF ON ORG_ENTE_ARK_RIF(ID_ENTE_CONVENZ, ID_USER_IAM);

-- changeset root:1753259446745-668
ALTER TABLE ORG_ENTE_ARK_RIF ADD CONSTRAINT UN_ENTE_ARK_RIF UNIQUE (ID_ENTE_CONVENZ, ID_USER_IAM) USING INDEX UN_ENTE_ARK_RIF;

-- changeset root:1753259446745-669
CREATE UNIQUE INDEX UN_ENTE_SIAM ON ORG_ENTE_SIAM(NM_ENTE_SIAM);

-- changeset root:1753259446745-670
ALTER TABLE ORG_ENTE_SIAM ADD CONSTRAINT UN_ENTE_SIAM UNIQUE (NM_ENTE_SIAM) USING INDEX UN_ENTE_SIAM;

-- changeset root:1753259446745-671
CREATE UNIQUE INDEX UN_ENTE_USR_RIF ON ORG_ENTE_USER_RIF(ID_ENTE_CONVENZ, ID_USER_IAM, QUALIFICA_USER);

-- changeset root:1753259446745-672
ALTER TABLE ORG_ENTE_USER_RIF ADD CONSTRAINT UN_ENTE_USR_RIF UNIQUE (ID_ENTE_CONVENZ, ID_USER_IAM, QUALIFICA_USER) USING INDEX UN_ENTE_USR_RIF;

-- changeset root:1753259446745-673
CREATE UNIQUE INDEX UN_ENT_MENU ON APL_ENTRY_MENU(ID_APPLIC, NM_ENTRY_MENU);

-- changeset root:1753259446745-674
ALTER TABLE APL_ENTRY_MENU ADD CONSTRAINT UN_ENT_MENU UNIQUE (ID_APPLIC, NM_ENTRY_MENU) USING INDEX UN_ENT_MENU;

-- changeset root:1753259446745-675
CREATE UNIQUE INDEX UN_FAS_STOR_ACCORDO ON ORG_FASCIA_STORAGE_ACCORDO(TI_FASCIA);

-- changeset root:1753259446745-676
ALTER TABLE ORG_FASCIA_STORAGE_ACCORDO ADD CONSTRAINT UN_FAS_STOR_ACCORDO UNIQUE (TI_FASCIA) USING INDEX UN_FAS_STOR_ACCORDO;

-- changeset root:1753259446745-677
CREATE UNIQUE INDEX UN_FATT_ENTE ON ORG_FATTURA_ENTE(ID_ENTE_CONVENZ, AA_FATTURA, PG_FATTURA);

-- changeset root:1753259446745-678
ALTER TABLE ORG_FATTURA_ENTE ADD CONSTRAINT UN_FATT_ENTE UNIQUE (ID_ENTE_CONVENZ, AA_FATTURA, PG_FATTURA) USING INDEX UN_FATT_ENTE;

-- changeset root:1753259446745-679
CREATE UNIQUE INDEX UN_IND_IP ON USR_IND_IP_USER(ID_USER_IAM, CD_IND_IP_USER);

-- changeset root:1753259446745-680
ALTER TABLE USR_IND_IP_USER ADD CONSTRAINT UN_IND_IP UNIQUE (ID_USER_IAM, CD_IND_IP_USER) USING INDEX UN_IND_IP;

-- changeset root:1753259446745-681
CREATE UNIQUE INDEX UN_JOB ON DEC_JOB(NM_JOB);

-- changeset root:1753259446745-682
ALTER TABLE DEC_JOB ADD CONSTRAINT UN_JOB UNIQUE (NM_JOB) USING INDEX UN_JOB;

-- changeset root:1753259446745-683
CREATE UNIQUE INDEX UN_JOB_FOTO ON DEC_JOB_FOTO(NM_JOB_FOTO);

-- changeset root:1753259446745-684
ALTER TABLE DEC_JOB_FOTO ADD CONSTRAINT UN_JOB_FOTO UNIQUE (NM_JOB_FOTO) USING INDEX UN_JOB_FOTO;

-- changeset root:1753259446745-685
CREATE UNIQUE INDEX UN_MODL_COM ON DEC_MODELLO_COMUNIC(CD_MODELLO_COMUNIC);

-- changeset root:1753259446745-686
ALTER TABLE DEC_MODELLO_COMUNIC ADD CONSTRAINT UN_MODL_COM UNIQUE (CD_MODELLO_COMUNIC) USING INDEX UN_MODL_COM;

-- changeset root:1753259446745-687
CREATE UNIQUE INDEX UN_MOD_FATT_ENTE ON ORG_MODIF_FATTURA_ENTE(ID_FATTURA_ENTE, DT_MODIF_FATTURA_ENTE);

-- changeset root:1753259446745-688
ALTER TABLE ORG_MODIF_FATTURA_ENTE ADD CONSTRAINT UN_MOD_FATT_ENTE UNIQUE (ID_FATTURA_ENTE, DT_MODIF_FATTURA_ENTE) USING INDEX UN_MOD_FATT_ENTE;

-- changeset root:1753259446745-689
CREATE UNIQUE INDEX UN_NEWS_APL ON APL_NEWS_APPLIC(ID_NEWS, ID_APPLIC);

-- changeset root:1753259446745-690
ALTER TABLE APL_NEWS_APPLIC ADD CONSTRAINT UN_NEWS_APL UNIQUE (ID_NEWS, ID_APPLIC) USING INDEX UN_NEWS_APL;

-- changeset root:1753259446745-691
CREATE UNIQUE INDEX UN_NOTIF ON NTF_NOTIFICA(DS_EMAIL_DESTINATARIO, TS_NOTIF);

-- changeset root:1753259446745-692
ALTER TABLE NTF_NOTIFICA ADD CONSTRAINT UN_NOTIF UNIQUE (DS_EMAIL_DESTINATARIO, TS_NOTIF) USING INDEX UN_NOTIF;

-- changeset root:1753259446745-693
CREATE UNIQUE INDEX UN_OLD_PSW ON USR_OLD_PSW(ID_USER_IAM, PG_OLD_PSW);

-- changeset root:1753259446745-694
ALTER TABLE USR_OLD_PSW ADD CONSTRAINT UN_OLD_PSW UNIQUE (ID_USER_IAM, PG_OLD_PSW) USING INDEX UN_OLD_PSW;

-- changeset root:1753259446745-695
CREATE UNIQUE INDEX UN_ORG_AA_ACCORDO ON ORG_AA_ACCORDO(AA_ANNO_ACCORDO, ID_ACCORDO_ENTE);

-- changeset root:1753259446745-696
ALTER TABLE ORG_AA_ACCORDO ADD CONSTRAINT UN_ORG_AA_ACCORDO UNIQUE (AA_ANNO_ACCORDO, ID_ACCORDO_ENTE) USING INDEX UN_ORG_AA_ACCORDO;

-- changeset root:1753259446745-697
CREATE UNIQUE INDEX UN_ORG_IAM ON USR_ORGANIZ_IAM(ID_APPLIC, ID_TIPO_ORGANIZ, ID_ORGANIZ_APPLIC);

-- changeset root:1753259446745-698
ALTER TABLE USR_ORGANIZ_IAM ADD CONSTRAINT UN_ORG_IAM UNIQUE (ID_APPLIC, ID_TIPO_ORGANIZ, ID_ORGANIZ_APPLIC) USING INDEX UN_ORG_IAM;

-- changeset root:1753259446745-699
CREATE UNIQUE INDEX UN_ORG_TARIF_AA_ACC ON ORG_TARIFFA_AA_ACCORDO(ID_AA_ACCORDO, ID_TIPO_SERVIZIO);

-- changeset root:1753259446745-700
ALTER TABLE ORG_TARIFFA_AA_ACCORDO ADD CONSTRAINT UN_ORG_TARIF_AA_ACC UNIQUE (ID_AA_ACCORDO, ID_TIPO_SERVIZIO) USING INDEX UN_ORG_TARIF_AA_ACC;

-- changeset root:1753259446745-701
CREATE UNIQUE INDEX UN_ORG_TIPI_GEST_ACCORDO ON ORG_TIPI_GESTIONE_ACCORDO(CD_TIPO_GESTIONE_ACCORDO);

-- changeset root:1753259446745-702
ALTER TABLE ORG_TIPI_GESTIONE_ACCORDO ADD CONSTRAINT UN_ORG_TIPI_GEST_ACCORDO UNIQUE (CD_TIPO_GESTIONE_ACCORDO) USING INDEX UN_ORG_TIPI_GEST_ACCORDO;

-- changeset root:1753259446745-703
CREATE UNIQUE INDEX UN_PAG ON APL_PAGINA_WEB(ID_APPLIC, NM_PAGINA_WEB);

-- changeset root:1753259446745-704
ALTER TABLE APL_PAGINA_WEB ADD CONSTRAINT UN_PAG UNIQUE (ID_APPLIC, NM_PAGINA_WEB) USING INDEX UN_PAG;

-- changeset root:1753259446745-705
CREATE UNIQUE INDEX UN_PAG_FATT_ENTE ON ORG_PAGAM_FATTURA_ENTE(ID_FATTURA_ENTE, PG_PAGAM);

-- changeset root:1753259446745-706
ALTER TABLE ORG_PAGAM_FATTURA_ENTE ADD CONSTRAINT UN_PAG_FATT_ENTE UNIQUE (ID_FATTURA_ENTE, PG_PAGAM) USING INDEX UN_PAG_FATT_ENTE;

-- changeset root:1753259446745-707
CREATE UNIQUE INDEX UN_PAR_APL ON IAM_PARAM_APPLIC(NM_PARAM_APPLIC);

-- changeset root:1753259446745-708
ALTER TABLE IAM_PARAM_APPLIC ADD CONSTRAINT UN_PAR_APL UNIQUE (NM_PARAM_APPLIC) USING INDEX UN_PAR_APL;

-- changeset root:1753259446745-709
CREATE UNIQUE INDEX UN_PAR_APL_RPT ON APL_PARAM_APPLIC_REPORT(NM_APPLIC, NM_REPORT);

-- changeset root:1753259446745-710
ALTER TABLE APL_PARAM_APPLIC_REPORT ADD CONSTRAINT UN_PAR_APL_RPT UNIQUE (NM_APPLIC, NM_REPORT) USING INDEX UN_PAR_APL_RPT;

-- changeset root:1753259446745-711
CREATE UNIQUE INDEX UN_QRY_MODL_COM ON DEC_QUERY_MODELLO_COMUNIC(ID_MODELLO_COMUNIC, NM_QUERY);

-- changeset root:1753259446745-712
ALTER TABLE DEC_QUERY_MODELLO_COMUNIC ADD CONSTRAINT UN_QRY_MODL_COM UNIQUE (ID_MODELLO_COMUNIC, NM_QUERY) USING INDEX UN_QRY_MODL_COM;

-- changeset root:1753259446745-713
CREATE UNIQUE INDEX UN_QRY_TI_OGG ON APL_QUERY_TIPO_OGGETTO(ID_TIPO_OGGETTO, NM_QUERY_TIPO_OGGETTO);

-- changeset root:1753259446745-714
ALTER TABLE APL_QUERY_TIPO_OGGETTO ADD CONSTRAINT UN_QRY_TI_OGG UNIQUE (ID_TIPO_OGGETTO, NM_QUERY_TIPO_OGGETTO) USING INDEX UN_QRY_TI_OGG;

-- changeset root:1753259446745-715
CREATE UNIQUE INDEX UN_RUO ON PRF_RUOLO(NM_RUOLO);

-- changeset root:1753259446745-716
ALTER TABLE PRF_RUOLO ADD CONSTRAINT UN_RUO UNIQUE (NM_RUOLO) USING INDEX UN_RUO;

-- changeset root:1753259446745-717
CREATE UNIQUE INDEX UN_SCG_TARIFFA ON ORG_SCAGLIONE_TARIFFA(ID_TARIFFA, NI_INI_SCAGLIONE);

-- changeset root:1753259446745-718
ALTER TABLE ORG_SCAGLIONE_TARIFFA ADD CONSTRAINT UN_SCG_TARIFFA UNIQUE (ID_TARIFFA, NI_INI_SCAGLIONE) USING INDEX UN_SCG_TARIFFA;

-- changeset root:1753259446745-719
CREATE UNIQUE INDEX UN_SERV_EROG ON ORG_SERVIZIO_EROG(ID_ACCORDO_ENTE, NM_SERVIZIO_EROGATO);

-- changeset root:1753259446745-720
ALTER TABLE ORG_SERVIZIO_EROG ADD CONSTRAINT UN_SERV_EROG UNIQUE (ID_ACCORDO_ENTE, NM_SERVIZIO_EROGATO) USING INDEX UN_SERV_EROG;

-- changeset root:1753259446745-721
CREATE UNIQUE INDEX UN_SERV_FATT ON ORG_SERVIZIO_FATTURA(ID_FATTURA_ENTE, ID_SERVIZIO_EROGATO, AA_SERVIZIO_FATTURA);

-- changeset root:1753259446745-722
ALTER TABLE ORG_SERVIZIO_FATTURA ADD CONSTRAINT UN_SERV_FATT UNIQUE (ID_FATTURA_ENTE, ID_SERVIZIO_EROGATO, AA_SERVIZIO_FATTURA) USING INDEX UN_SERV_FATT;

-- changeset root:1753259446745-723
CREATE UNIQUE INDEX UN_SIST_VERS_ARK_RIF ON APL_SISTEMA_VERS_ARK_RIF(ID_SISTEMA_VERSANTE, ID_USER_IAM);

-- changeset root:1753259446745-724
ALTER TABLE APL_SISTEMA_VERS_ARK_RIF ADD CONSTRAINT UN_SIST_VERS_ARK_RIF UNIQUE (ID_SISTEMA_VERSANTE, ID_USER_IAM) USING INDEX UN_SIST_VERS_ARK_RIF;

-- changeset root:1753259446745-725
CREATE UNIQUE INDEX UN_SIS_VERS ON APL_SISTEMA_VERSANTE(NM_SISTEMA_VERSANTE);

-- changeset root:1753259446745-726
ALTER TABLE APL_SISTEMA_VERSANTE ADD CONSTRAINT UN_SIS_VERS UNIQUE (NM_SISTEMA_VERSANTE) USING INDEX UN_SIS_VERS;

-- changeset root:1753259446745-727
CREATE UNIQUE INDEX UN_SIS_VERS_USR_REF ON APL_SISTEMA_VERSANTE_USER_REF(ID_SISTEMA_VERSANTE, ID_USER_IAM_REF);

-- changeset root:1753259446745-728
ALTER TABLE APL_SISTEMA_VERSANTE_USER_REF ADD CONSTRAINT UN_SIS_VERS_USR_REF UNIQUE (ID_SISTEMA_VERSANTE, ID_USER_IAM_REF) USING INDEX UN_SIS_VERS_USR_REF;

-- changeset root:1753259446745-729
CREATE UNIQUE INDEX UN_SOLL_FATT_ENTE ON ORG_SOLLECITO_FATTURA_ENTE(ID_FATTURA_ENTE, CD_REGISTRO_SOLLECITO, AA_VAR_SOLLECITO, CD_KEY_VAR_SOLLECITO);

-- changeset root:1753259446745-730
ALTER TABLE ORG_SOLLECITO_FATTURA_ENTE ADD CONSTRAINT UN_SOLL_FATT_ENTE UNIQUE (ID_FATTURA_ENTE, CD_REGISTRO_SOLLECITO, AA_VAR_SOLLECITO, CD_KEY_VAR_SOLLECITO) USING INDEX UN_SOLL_FATT_ENTE;

-- changeset root:1753259446745-731
CREATE UNIQUE INDEX UN_SRV ON APL_SERVIZIO_WEB(ID_APPLIC, NM_SERVIZIO_WEB);

-- changeset root:1753259446745-732
ALTER TABLE APL_SERVIZIO_WEB ADD CONSTRAINT UN_SRV UNIQUE (ID_APPLIC, NM_SERVIZIO_WEB) USING INDEX UN_SRV;

-- changeset root:1753259446745-733
CREATE UNIQUE INDEX UN_STATO_FATT_ENTE ON ORG_STATO_FATTURA_ENTE(ID_FATTURA_ENTE, DT_REG_STATO_FATTURA_ENTE);

-- changeset root:1753259446745-734
ALTER TABLE ORG_STATO_FATTURA_ENTE ADD CONSTRAINT UN_STATO_FATT_ENTE UNIQUE (ID_FATTURA_ENTE, DT_REG_STATO_FATTURA_ENTE) USING INDEX UN_STATO_FATT_ENTE;

-- changeset root:1753259446745-735
CREATE UNIQUE INDEX UN_STATO_USR ON USR_STATO_USER(ID_USER_IAM, TS_STATO);

-- changeset root:1753259446745-736
ALTER TABLE USR_STATO_USER ADD CONSTRAINT UN_STATO_USR UNIQUE (ID_USER_IAM, TS_STATO) USING INDEX UN_STATO_USR;

-- changeset root:1753259446745-737
CREATE UNIQUE INDEX UN_STO_ENTE_AMB_CONV ON ORG_STO_ENTE_AMBIENTE_CONVENZ(ID_ENTE_CONVENZ, DT_INI_VAL);

-- changeset root:1753259446745-738
ALTER TABLE ORG_STO_ENTE_AMBIENTE_CONVENZ ADD CONSTRAINT UN_STO_ENTE_AMB_CONV UNIQUE (ID_ENTE_CONVENZ, DT_INI_VAL) USING INDEX UN_STO_ENTE_AMB_CONV;

-- changeset root:1753259446745-739
CREATE UNIQUE INDEX UN_STO_ENTE_CONVENZ ON ORG_STO_ENTE_CONVENZ(ID_ENTE_CONVENZ, DT_INI_VAL);

-- changeset root:1753259446745-740
ALTER TABLE ORG_STO_ENTE_CONVENZ ADD CONSTRAINT UN_STO_ENTE_CONVENZ UNIQUE (ID_ENTE_CONVENZ, DT_INI_VAL) USING INDEX UN_STO_ENTE_CONVENZ;

-- changeset root:1753259446745-741
CREATE UNIQUE INDEX UN_STRUT_ENTE_CONVENZ ON ORG_ENTE_CONVENZ_ORG(ID_ENTE_CONVENZ, ID_ORGANIZ_IAM, DT_INI_VAL);

-- changeset root:1753259446745-742
ALTER TABLE ORG_ENTE_CONVENZ_ORG ADD CONSTRAINT UN_STRUT_ENTE_CONVENZ UNIQUE (ID_ENTE_CONVENZ, ID_ORGANIZ_IAM, DT_INI_VAL) USING INDEX UN_STRUT_ENTE_CONVENZ;

-- changeset root:1753259446745-743
CREATE UNIQUE INDEX UN_SUPT_EST_ENTE_CONV ON ORG_SUPT_ESTERNO_ENTE_CONVENZ(ID_ENTE_FORNIT_EST, ID_ENTE_PRODUT, DT_INI_VAL);

-- changeset root:1753259446745-744
ALTER TABLE ORG_SUPT_ESTERNO_ENTE_CONVENZ ADD CONSTRAINT UN_SUPT_EST_ENTE_CONV UNIQUE (ID_ENTE_FORNIT_EST, ID_ENTE_PRODUT, DT_INI_VAL) USING INDEX UN_SUPT_EST_ENTE_CONV;

-- changeset root:1753259446745-745
CREATE UNIQUE INDEX UN_TARIF ON ORG_TARIFFARIO(ID_TIPO_ACCORDO, NM_TARIFFARIO);

-- changeset root:1753259446745-746
ALTER TABLE ORG_TARIFFARIO ADD CONSTRAINT UN_TARIF UNIQUE (ID_TIPO_ACCORDO, NM_TARIFFARIO) USING INDEX UN_TARIF;

-- changeset root:1753259446745-747
CREATE UNIQUE INDEX UN_TARIFFA_ACCOR ON ORG_TARIFFA_ACCORDO(ID_ACCORDO_ENTE, ID_TIPO_SERVIZIO);

-- changeset root:1753259446745-748
ALTER TABLE ORG_TARIFFA_ACCORDO ADD CONSTRAINT UN_TARIFFA_ACCOR UNIQUE (ID_ACCORDO_ENTE, ID_TIPO_SERVIZIO) USING INDEX UN_TARIFFA_ACCOR;

-- changeset root:1753259446745-749
CREATE UNIQUE INDEX UN_TARIFFA_NM ON ORG_TARIFFA(ID_TARIFFARIO, NM_TARIFFA);

-- changeset root:1753259446745-750
ALTER TABLE ORG_TARIFFA ADD CONSTRAINT UN_TARIFFA_NM UNIQUE (ID_TARIFFARIO, NM_TARIFFA) USING INDEX UN_TARIFFA_NM;

-- changeset root:1753259446745-751
CREATE UNIQUE INDEX UN_TI_ACCOR ON ORG_TIPO_ACCORDO(CD_TIPO_ACCORDO);

-- changeset root:1753259446745-752
ALTER TABLE ORG_TIPO_ACCORDO ADD CONSTRAINT UN_TI_ACCOR UNIQUE (CD_TIPO_ACCORDO) USING INDEX UN_TI_ACCOR;

-- changeset root:1753259446745-753
CREATE UNIQUE INDEX UN_TI_DATO ON USR_TIPO_DATO_IAM(ID_ORGANIZ_IAM, ID_CLASSE_TIPO_DATO, ID_TIPO_DATO_APPLIC);

-- changeset root:1753259446745-754
ALTER TABLE USR_TIPO_DATO_IAM ADD CONSTRAINT UN_TI_DATO UNIQUE (ID_ORGANIZ_IAM, ID_CLASSE_TIPO_DATO, ID_TIPO_DATO_APPLIC) USING INDEX UN_TI_DATO;

-- changeset root:1753259446745-755
CREATE UNIQUE INDEX UN_TI_EVN ON APL_TIPO_EVENTO(ID_APPLIC, NM_TIPO_EVENTO);

-- changeset root:1753259446745-756
ALTER TABLE APL_TIPO_EVENTO ADD CONSTRAINT UN_TI_EVN UNIQUE (ID_APPLIC, NM_TIPO_EVENTO) USING INDEX UN_TI_EVN;

-- changeset root:1753259446745-757
CREATE UNIQUE INDEX UN_TI_EVN_OGG ON APL_TIPO_EVENTO_OGGETTO(ID_TIPO_EVENTO, ID_TIPO_OGGETTO);

-- changeset root:1753259446745-758
ALTER TABLE APL_TIPO_EVENTO_OGGETTO ADD CONSTRAINT UN_TI_EVN_OGG UNIQUE (ID_TIPO_EVENTO, ID_TIPO_OGGETTO) USING INDEX UN_TI_EVN_OGG;

-- changeset root:1753259446745-759
CREATE UNIQUE INDEX UN_TI_EVN_OGG_TRIG ON APL_TIPO_EVENTO_OGGETTO_TRIG(ID_TIPO_EVENTO_OGGETTO, ID_TIPO_EVENTO_TRIG, ID_TIPO_OGGETTO_TRIG);

-- changeset root:1753259446745-760
ALTER TABLE APL_TIPO_EVENTO_OGGETTO_TRIG ADD CONSTRAINT UN_TI_EVN_OGG_TRIG UNIQUE (ID_TIPO_EVENTO_OGGETTO, ID_TIPO_EVENTO_TRIG, ID_TIPO_OGGETTO_TRIG) USING INDEX UN_TI_EVN_OGG_TRIG;

-- changeset root:1753259446745-761
CREATE UNIQUE INDEX UN_TI_OGG ON APL_TIPO_OGGETTO(ID_APPLIC, NM_TIPO_OGGETTO);

-- changeset root:1753259446745-762
ALTER TABLE APL_TIPO_OGGETTO ADD CONSTRAINT UN_TI_OGG UNIQUE (ID_APPLIC, NM_TIPO_OGGETTO) USING INDEX UN_TI_OGG;

-- changeset root:1753259446745-763
CREATE UNIQUE INDEX UN_TI_ORG ON APL_TIPO_ORGANIZ(ID_APPLIC, NM_TIPO_ORGANIZ);

-- changeset root:1753259446745-764
ALTER TABLE APL_TIPO_ORGANIZ ADD CONSTRAINT UN_TI_ORG UNIQUE (ID_APPLIC, NM_TIPO_ORGANIZ) USING INDEX UN_TI_ORG;

-- changeset root:1753259446745-765
CREATE UNIQUE INDEX UN_TI_SERV ON ORG_TIPO_SERVIZIO(CD_TIPO_SERVIZIO);

-- changeset root:1753259446745-766
ALTER TABLE ORG_TIPO_SERVIZIO ADD CONSTRAINT UN_TI_SERV UNIQUE (CD_TIPO_SERVIZIO) USING INDEX UN_TI_SERV;

-- changeset root:1753259446745-767
CREATE UNIQUE INDEX UN_USO_MODL_COM ON DEC_USO_MODELLO_COMUNIC(ID_MODELLO_COMUNIC, PG_USO);

-- changeset root:1753259446745-768
ALTER TABLE DEC_USO_MODELLO_COMUNIC ADD CONSTRAINT UN_USO_MODL_COM UNIQUE (ID_MODELLO_COMUNIC, PG_USO) USING INDEX UN_USO_MODL_COM;

-- changeset root:1753259446745-769
CREATE UNIQUE INDEX UN_USO_RUO_APL ON PRF_USO_RUOLO_APPLIC(ID_RUOLO, ID_APPLIC);

-- changeset root:1753259446745-770
ALTER TABLE PRF_USO_RUOLO_APPLIC ADD CONSTRAINT UN_USO_RUO_APL UNIQUE (ID_RUOLO, ID_APPLIC) USING INDEX UN_USO_RUO_APL;

-- changeset root:1753259446745-771
CREATE UNIQUE INDEX UN_USO_RUO_DICH ON USR_USO_RUOLO_DICH(ID_DICH_ABIL_ORGANIZ, TI_SCOPO_RUOLO, ID_ORGANIZ_IAM_RUOLO, ID_RUOLO);

-- changeset root:1753259446745-772
ALTER TABLE USR_USO_RUOLO_DICH ADD CONSTRAINT UN_USO_RUO_DICH UNIQUE (ID_DICH_ABIL_ORGANIZ, TI_SCOPO_RUOLO, ID_ORGANIZ_IAM_RUOLO, ID_RUOLO) USING INDEX UN_USO_RUO_DICH;

-- changeset root:1753259446745-773
CREATE UNIQUE INDEX UN_USO_RUO_USR_DEF ON USR_USO_RUOLO_USER_DEFAULT(ID_USO_USER_APPLIC, ID_RUOLO);

-- changeset root:1753259446745-774
ALTER TABLE USR_USO_RUOLO_USER_DEFAULT ADD CONSTRAINT UN_USO_RUO_USR_DEF UNIQUE (ID_USO_USER_APPLIC, ID_RUOLO) USING INDEX UN_USO_RUO_USR_DEF;

-- changeset root:1753259446745-775
CREATE UNIQUE INDEX UN_USO_USR_APL ON USR_USO_USER_APPLIC(ID_USER_IAM, ID_APPLIC);

-- changeset root:1753259446745-776
ALTER TABLE USR_USO_USER_APPLIC ADD CONSTRAINT UN_USO_USR_APL UNIQUE (ID_USER_IAM, ID_APPLIC) USING INDEX UN_USO_USR_APL;

-- changeset root:1753259446745-777
CREATE UNIQUE INDEX UN_USR ON USR_USER(NM_USERID);

-- changeset root:1753259446745-778
ALTER TABLE USR_USER ADD CONSTRAINT UN_USR UNIQUE (NM_USERID) USING INDEX UN_USR;

-- changeset root:1753259446745-779
CREATE UNIQUE INDEX UN_VAR_ACC ON ORG_GESTIONE_ACCORDO(ID_ACCORDO_ENTE, PG_GEST_ACCORDO);

-- changeset root:1753259446745-780
ALTER TABLE ORG_GESTIONE_ACCORDO ADD CONSTRAINT UN_VAR_ACC UNIQUE (ID_ACCORDO_ENTE, PG_GEST_ACCORDO) USING INDEX UN_VAR_ACC;

-- changeset root:1753259446745-781
CREATE UNIQUE INDEX UN_VIG_ENTE_PRODUT ON ORG_VIGIL_ENTE_PRODUT(ID_ACCORDO_VIGIL, ID_ENTE_PRODUT, DT_INI_VAL);

-- changeset root:1753259446745-782
ALTER TABLE ORG_VIGIL_ENTE_PRODUT ADD CONSTRAINT UN_VIG_ENTE_PRODUT UNIQUE (ID_ACCORDO_VIGIL, ID_ENTE_PRODUT, DT_INI_VAL) USING INDEX UN_VIG_ENTE_PRODUT;

-- changeset root:1753259446745-783
CREATE INDEX IDX_ABIL_DATI_APP_COLLEG ON USR_ABIL_DATI(ID_APPART_COLLEG_ENTI);

-- changeset root:1753259446745-784
CREATE INDEX IDX_ABIL_DATI_DICH ON USR_ABIL_DATI(ID_DICH_ABIL_DATI);

-- changeset root:1753259446745-785
CREATE INDEX IDX_ABIL_DATI_SUPT_EST ON USR_ABIL_DATI(ID_SUPT_EST_ENTE_CONVENZ);

-- changeset root:1753259446745-786
CREATE INDEX IDX_ABIL_DATI_VIG_ENTE ON USR_ABIL_DATI(ID_VIGIL_ENTE_PRODUT);

-- changeset root:1753259446745-787
CREATE INDEX IDX_ABIL_ENTE_ACC_VIG ON USR_ABIL_ENTE_SIAM(ID_ACCORDO_VIGIL);

-- changeset root:1753259446745-788
CREATE INDEX IDX_ABIL_ENTE_APP_COLLEG ON USR_ABIL_ENTE_SIAM(ID_APPART_COLLEG_ENTI);

-- changeset root:1753259446745-789
CREATE INDEX IDX_ABIL_ENTE_DICH ON USR_ABIL_ENTE_SIAM(ID_DICH_ABIL_ENTE_CONVENZ);

-- changeset root:1753259446745-790
CREATE INDEX IDX_ABIL_ENTE_SUPT_EST ON USR_ABIL_ENTE_SIAM(ID_SUPT_EST_ENTE_CONVENZ);

-- changeset root:1753259446745-791
CREATE INDEX IDX_ABIL_ORG_APP_COLLEG ON USR_ABIL_ORGANIZ(ID_APPART_COLLEG_ENTI);

-- changeset root:1753259446745-792
CREATE INDEX IDX_ABIL_ORG_DICH ON USR_ABIL_ORGANIZ(ID_DICH_ABIL_ORGANIZ);

-- changeset root:1753259446745-793
CREATE INDEX IDX_ABIL_ORG_SUPT_EST ON USR_ABIL_ORGANIZ(ID_SUPT_EST_ENTE_CONVENZ);

-- changeset root:1753259446745-794
CREATE INDEX IDX_ABIL_ORG_VIG_ENTE ON USR_ABIL_ORGANIZ(ID_VIGIL_ENTE_PRODUT);

-- changeset root:1753259446745-795
CREATE INDEX IDX_ACCOR_ENTE_CLASSE ON ORG_ACCORDO_ENTE(ID_CLASSE_ENTE_CONVENZ);

-- changeset root:1753259446745-796
CREATE INDEX IDX_ACCOR_ENTE_TARIF ON ORG_ACCORDO_ENTE(ID_TARIFFARIO);

-- changeset root:1753259446745-797
CREATE INDEX IDX_ACCOR_ENTE_TI_ACCOR ON ORG_ACCORDO_ENTE(ID_TIPO_ACCORDO);

-- changeset root:1753259446745-798
CREATE INDEX IDX_ACC_VIG_CONSERV ON ORG_ACCORDO_VIGIL(ID_ENTE_CONSERV);

-- changeset root:1753259446745-799
CREATE INDEX IDX_ALLINEA_RUO ON PRF_ALLINEA_RUOLO(ID_RUOLO);

-- changeset root:1753259446745-800
CREATE INDEX IDX_AMB_ENTE_CONVENZ_CONSERV ON ORG_AMBIENTE_ENTE_CONVENZ(ID_ENTE_CONSERV);

-- changeset root:1753259446745-801
CREATE INDEX IDX_AMB_ENTE_CONVENZ_GESTORE ON ORG_AMBIENTE_ENTE_CONVENZ(ID_ENTE_GESTORE);

-- changeset root:1753259446745-802
CREATE INDEX IDX_AMB_TRT_PADRE ON ORG_AMBITO_TERRIT(ID_AMBITO_TERRIT_PADRE);

-- changeset root:1753259446745-803
CREATE INDEX IDX_APP_COLLEG_ENTI_ENTE ON ORG_APPART_COLLEG_ENTI(ID_ENTE_CONVENZ);

-- changeset root:1753259446745-804
CREATE INDEX IDX_APP_USR_RICH ON USR_APPART_USER_RICH(ID_RICH_GEST_USER);

-- changeset root:1753259446745-805
CREATE INDEX IDX_APP_USR_RICH_NOTIF_1 ON USR_APPART_USER_RICH(ID_NOTIFICA_AZIONE_1);

-- changeset root:1753259446745-806
CREATE INDEX IDX_APP_USR_RICH_NOTIF_2 ON USR_APPART_USER_RICH(ID_NOTIFICA_AZIONE_2);

-- changeset root:1753259446745-807
CREATE INDEX IDX_APP_USR_RICH_USR_CODIF ON USR_APPART_USER_RICH(ID_USER_IAM);

-- changeset root:1753259446745-808
CREATE INDEX IDX_APP_USR_RICH_USR_NOCODIF ON USR_APPART_USER_RICH(NM_COGNOME_USER, NM_NOME_USER);

-- changeset root:1753259446745-809
CREATE INDEX IDX_AUT_AZIONE ON PRF_AUTOR(ID_AZIONE_PAGINA);

-- changeset root:1753259446745-810
CREATE INDEX IDX_AUT_ENTRY_MENU ON PRF_AUTOR(ID_ENTRY_MENU);

-- changeset root:1753259446745-811
CREATE INDEX IDX_AUT_PAGINA_WEB ON PRF_AUTOR(ID_PAGINA_WEB);

-- changeset root:1753259446745-812
CREATE INDEX IDX_AUT_RUO_APL ON PRF_AUTOR(ID_USO_RUOLO_APPLIC, TI_DICH_AUTOR);

-- changeset root:1753259446745-813
CREATE INDEX IDX_AUT_SERV_WEB ON PRF_AUTOR(ID_SERVIZIO_WEB);

-- changeset root:1753259446745-814
CREATE INDEX IDX_AZN_COMP_SW_TI_EVN ON APL_AZIONE_COMP_SW(ID_TIPO_EVENTO);

-- changeset root:1753259446745-815
CREATE INDEX IDX_AZN_PAG_TI_EVN ON APL_AZIONE_PAGINA(ID_TIPO_EVENTO);

-- changeset root:1753259446745-816
CREATE INDEX IDX_COLLEG_ENTI_CONV_CAPO ON ORG_COLLEG_ENTI_CONVENZ(ID_ENTE_CONVENZ_CAPOFILA);

-- changeset root:1753259446745-817
CREATE INDEX IDX_DICH_ABIL_DATI_APP_COLLEG ON USR_DICH_ABIL_DATI(ID_APPART_COLLEG_ENTI);

-- changeset root:1753259446745-818
CREATE INDEX IDX_DICH_ABIL_DATI_SUPT_EST ON USR_DICH_ABIL_DATI(ID_SUPT_EST_ENTE_CONVENZ);

-- changeset root:1753259446745-819
CREATE INDEX IDX_DICH_ABIL_DATI_VIG_ENTE ON USR_DICH_ABIL_DATI(ID_VIGIL_ENTE_PRODUT);

-- changeset root:1753259446745-820
CREATE INDEX IDX_DICH_ABIL_ENTE_AMB ON USR_DICH_ABIL_ENTE_CONVENZ(ID_AMBIENTE_ENTE_CONVENZ);

-- changeset root:1753259446745-821
CREATE INDEX IDX_DICH_ABIL_ENTE_APP_COLLEG ON USR_DICH_ABIL_ENTE_CONVENZ(ID_APPART_COLLEG_ENTI);

-- changeset root:1753259446745-822
CREATE INDEX IDX_DICH_ABIL_ENTE_ENTE ON USR_DICH_ABIL_ENTE_CONVENZ(ID_ENTE_CONVENZ);

-- changeset root:1753259446745-823
CREATE INDEX IDX_DICH_ABIL_ORG ON USR_DICH_ABIL_ORGANIZ(ID_ORGANIZ_IAM);

-- changeset root:1753259446745-824
CREATE INDEX IDX_DICH_ABIL_ORG_APP_COLLEG ON USR_DICH_ABIL_ORGANIZ(ID_APPART_COLLEG_ENTI);

-- changeset root:1753259446745-825
CREATE INDEX IDX_DICH_ABIL_ORG_SUPT_EST ON USR_DICH_ABIL_ORGANIZ(ID_SUPT_EST_ENTE_CONVENZ);

-- changeset root:1753259446745-826
CREATE INDEX IDX_DICH_ABIL_ORG_VIG_ENTE ON USR_DICH_ABIL_ORGANIZ(ID_VIGIL_ENTE_PRODUT);

-- changeset root:1753259446745-827
CREATE INDEX IDX_DICH_ABIL_USR_APL ON USR_DICH_ABIL_ORGANIZ(ID_USO_USER_APPLIC, TI_SCOPO_DICH_ABIL_ORGANIZ);

-- changeset root:1753259446745-828
CREATE INDEX IDX_DICH_AUT_AZIONE ON PRF_DICH_AUTOR(ID_AZIONE_PAGINA);

-- changeset root:1753259446745-829
CREATE INDEX IDX_DICH_AUT_ENTRY_MENU_FOGLIA ON PRF_DICH_AUTOR(ID_ENTRY_MENU_FOGLIA);

-- changeset root:1753259446745-830
CREATE INDEX IDX_DICH_AUT_ENTRY_MENU_PADRE ON PRF_DICH_AUTOR(ID_ENTRY_MENU_PADRE);

-- changeset root:1753259446745-831
CREATE INDEX IDX_DICH_AUT_PAGINA_WEB ON PRF_DICH_AUTOR(ID_PAGINA_WEB);

-- changeset root:1753259446745-832
CREATE INDEX IDX_DICH_AUT_SERV_WEB ON PRF_DICH_AUTOR(ID_SERVIZIO_WEB);

-- changeset root:1753259446745-833
CREATE INDEX IDX_DICH_AUT_USO_APL ON PRF_DICH_AUTOR(ID_USO_RUOLO_APPLIC, TI_DICH_AUTOR);

-- changeset root:1753259446745-834
CREATE INDEX IDX_DIC_ABIL_DATI_DATO ON USR_DICH_ABIL_DATI(ID_TIPO_DATO_IAM);

-- changeset root:1753259446745-835
CREATE INDEX IDX_DIC_ABIL_DATI_ORG ON USR_DICH_ABIL_DATI(ID_ORGANIZ_IAM);

-- changeset root:1753259446745-836
CREATE INDEX IDX_DIC_ABIL_DATI_USR_APL ON USR_DICH_ABIL_DATI(ID_USO_USER_APPLIC, ID_CLASSE_TIPO_DATO, TI_SCOPO_DICH_ABIL_DATI);

-- changeset root:1753259446745-837
CREATE INDEX IDX_DISCIP_STRUT_ORG ON ORG_DISCIP_STRUT(ID_ORGANIZ_IAM);

-- changeset root:1753259446745-838
CREATE INDEX IDX_ENTE_ARK_RIF_USR ON ORG_ENTE_ARK_RIF(ID_USER_IAM);

-- changeset root:1753259446745-839
CREATE INDEX IDX_ENTE_CONVENZ_AMB ON ORG_ENTE_SIAM(ID_AMBIENTE_ENTE_CONVENZ);

-- changeset root:1753259446745-840
CREATE INDEX IDX_ENTE_CONVENZ_AMB_TRT ON ORG_ENTE_SIAM(ID_AMBITO_TERRIT);

-- changeset root:1753259446745-841
CREATE INDEX IDX_ENTE_CONVENZ_CAT_ENTE ON ORG_ENTE_SIAM(ID_CATEG_ENTE);

-- changeset root:1753259446745-842
CREATE INDEX IDX_ENTE_CONVENZ_NUOVO ON ORG_ENTE_SIAM(ID_ENTE_CONVENZ_NUOVO);

-- changeset root:1753259446745-843
CREATE INDEX IDX_ENTE_CONVENZ_ORG ON ORG_ENTE_CONVENZ_ORG(ID_ORGANIZ_IAM);

-- changeset root:1753259446745-844
CREATE INDEX IDX_ENTE_PRODUT_CORRISP ON ORG_ENTE_SIAM(ID_ENTE_PRODUT_CORRISP);

-- changeset root:1753259446745-845
CREATE INDEX IDX_ENTE_USR_RIF ON ORG_ENTE_USER_RIF(ID_USER_IAM);

-- changeset root:1753259446745-846
CREATE INDEX IDX_ENT_MENU_PADRE ON APL_ENTRY_MENU(ID_ENTRY_MENU_PADRE);

-- changeset root:1753259446745-847
CREATE INDEX IDX_FATT_ENTE_STATO_COR ON ORG_FATTURA_ENTE(ID_STATO_FATTURA_ENTE_COR);

-- changeset root:1753259446745-848
CREATE INDEX IDX_HELP_OL_TIPO_MENU ON APL_HELP_ON_LINE(TI_HELP_ON_LINE, ID_ENTRY_MENU, DT_INI_VAL);

-- changeset root:1753259446745-849
CREATE INDEX IDX_HELP_OL_TIPO_PAG ON APL_HELP_ON_LINE(TI_HELP_ON_LINE, ID_PAGINA_WEB, DT_INI_VAL);

-- changeset root:1753259446745-850
CREATE INDEX IDX_LOG_JOB_DT ON LOG_JOB(NM_JOB, TI_REG_LOG_JOB, DT_REG_LOG_JOB);

-- changeset root:1753259446745-851
CREATE INDEX IDX_LOG_JOB_SERVER ON LOG_JOB(CD_IND_SERVER, DT_VIRTUAL_REG);

-- changeset root:1753259446745-852
CREATE INDEX IDX_MOD_INFO_ACCOR_CD ON ORG_MODULO_INFO_ACCORDO(ID_ACCORDO_ENTE, CD_MODULO_INFO);

-- changeset root:1753259446745-853
CREATE INDEX IDX_MOD_INFO_ACCOR_UD ON ORG_MODULO_INFO_ACCORDO(ID_ACCORDO_ENTE, CD_REGISTRO_MODULO_INFO, AA_MODULO_INFO, CD_KEY_MODULO_INFO);

-- changeset root:1753259446745-854
CREATE INDEX IDX_NEWS_APL ON APL_NEWS_APPLIC(ID_APPLIC);

-- changeset root:1753259446745-855
CREATE INDEX IDX_ORG_IAM1_PADRE ON USR_ORGANIZ_IAM(ID_ORGANIZ_IAM_PADRE);

-- changeset root:1753259446745-856
CREATE INDEX IDX_ORG_IAM_ENTE_CONSERV ON USR_ORGANIZ_IAM(ID_ENTE_CONSERV);

-- changeset root:1753259446745-857
CREATE INDEX IDX_ORG_IAM_ENTE_GESTORE ON USR_ORGANIZ_IAM(ID_ENTE_GESTORE);

-- changeset root:1753259446745-858
CREATE INDEX IDX_QRY_TI_OGG_ACCESSO ON APL_QUERY_TIPO_OGGETTO(ID_TIPO_OGGETTO_ACCESSO);

-- changeset root:1753259446745-859
CREATE INDEX IDX_QRY_TI_OGG_SEL ON APL_QUERY_TIPO_OGGETTO(ID_TIPO_OGGETTO_SEL);

-- changeset root:1753259446745-860
CREATE INDEX IDX_RICH_GEST_USR_ENTE_CONV ON USR_RICH_GEST_USER(ID_ENTE_RICH);

-- changeset root:1753259446745-861
CREATE INDEX IDX_RICH_GEST_USR_NOTIF ON USR_RICH_GEST_USER(ID_NOTIFICA_RICH_EVASA);

-- changeset root:1753259446745-862
CREATE INDEX IDX_RICH_GEST_USR_RICH_CODIF ON USR_RICH_GEST_USER(ID_ORGANIZ_IAM, CD_REGISTRO_RICH_GEST_USER, AA_RICH_GEST_USER, CD_KEY_RICH_GEST_USER);

-- changeset root:1753259446745-863
CREATE INDEX IDX_RICH_GEST_USR_RICH_NOCODIF ON USR_RICH_GEST_USER(ID_ENTE_RICH, CD_RICH_GEST_USER);

-- changeset root:1753259446745-864
CREATE INDEX IDX_RICH_GEST_USR_USER_CODIF ON USR_RICH_GEST_USER(ID_USER_IAM_RICH);

-- changeset root:1753259446745-865
CREATE INDEX IDX_RICH_GEST_USR_USER_NOCODIF ON USR_RICH_GEST_USER(NM_USER_RICH);

-- changeset root:1753259446745-866
CREATE INDEX IDX_SERV_EROG_SIST_VERS ON ORG_SERVIZIO_EROG(ID_SISTEMA_VERSANTE);

-- changeset root:1753259446745-867
CREATE INDEX IDX_SERV_EROG_TARIFFA ON ORG_SERVIZIO_EROG(ID_TARIFFA);

-- changeset root:1753259446745-868
CREATE INDEX IDX_SERV_FATT_IVA ON ORG_SERVIZIO_FATTURA(ID_CD_IVA);

-- changeset root:1753259446745-869
CREATE INDEX IDX_SERV_FATT_SERV_EROG ON ORG_SERVIZIO_FATTURA(ID_SERVIZIO_EROGATO);

-- changeset root:1753259446745-870
CREATE INDEX IDX_SIST_VERS_ARK_RIF_USR ON APL_SISTEMA_VERS_ARK_RIF(ID_USER_IAM);

-- changeset root:1753259446745-871
CREATE INDEX IDX_SIS_VERS_USR_REF ON APL_SISTEMA_VERSANTE_USER_REF(ID_USER_IAM_REF);

-- changeset root:1753259446745-872
CREATE INDEX IDX_STATO_USR_NOTIF ON USR_STATO_USER(ID_NOTIFICA);

-- changeset root:1753259446745-873
CREATE INDEX IDX_STATO_USR_RICH ON USR_STATO_USER(ID_RICH_GEST_USER);

-- changeset root:1753259446745-874
CREATE INDEX IDX_STO_ENTE_AMB ON ORG_STO_ENTE_AMBIENTE_CONVENZ(ID_AMBIENTE_ENTE_CONVENZ);

-- changeset root:1753259446745-875
CREATE INDEX IDX_STO_ENTE_CONVENZ_AMB_TRT ON ORG_STO_ENTE_CONVENZ(ID_AMBITO_TERRIT);

-- changeset root:1753259446745-876
CREATE INDEX IDX_STO_ENTE_CONVENZ_CAT_ENTE ON ORG_STO_ENTE_CONVENZ(ID_CATEG_ENTE);

-- changeset root:1753259446745-877
CREATE INDEX IDX_SUPT_EST_ENTE_CONV_PRODUT ON ORG_SUPT_ESTERNO_ENTE_CONVENZ(ID_ENTE_PRODUT);

-- changeset root:1753259446745-878
CREATE INDEX IDX_TARIFFA_CLASSE_ENTE ON ORG_TARIFFA(ID_CLASSE_ENTE_CONVENZ);

-- changeset root:1753259446745-879
CREATE INDEX IDX_TARIFFA_TI_SERV ON ORG_TARIFFA(ID_TIPO_SERVIZIO);

-- changeset root:1753259446745-880
CREATE INDEX IDX_TI_EVN_OGG_TRIG_QRY_SEL ON APL_TIPO_EVENTO_OGGETTO_TRIG(ID_QUERY_TIPO_OGGETTO_SEL);

-- changeset root:1753259446745-881
CREATE INDEX IDX_TI_EVN_OGG_TRIG_QRY_TRIG ON APL_TIPO_EVENTO_OGGETTO_TRIG(ID_QUERY_TIPO_OGGETTO_TRIG);

-- changeset root:1753259446745-882
CREATE INDEX IDX_TI_EVN_TI_OGG ON APL_TIPO_EVENTO_OGGETTO(ID_TIPO_OGGETTO);

-- changeset root:1753259446745-883
CREATE INDEX IDX_TI_EVN_TI_OGG_QRY ON APL_TIPO_EVENTO_OGGETTO(ID_QUERY_TIPO_OGGETTO_FOTO);

-- changeset root:1753259446745-884
CREATE INDEX IDX_TI_OGG_PADRE ON APL_TIPO_OGGETTO(ID_TIPO_OGGETTO_PADRE);

-- changeset root:1753259446745-885
CREATE INDEX IDX_USO_RUO_APL ON PRF_USO_RUOLO_APPLIC(ID_APPLIC);

-- changeset root:1753259446745-886
CREATE INDEX IDX_USO_RUO_DEF ON USR_USO_RUOLO_USER_DEFAULT(ID_RUOLO);

-- changeset root:1753259446745-887
CREATE INDEX IDX_USO_RUO_DICH_ORG_RUO ON USR_USO_RUOLO_DICH(ID_ORGANIZ_IAM_RUOLO);

-- changeset root:1753259446745-888
CREATE INDEX IDX_USO_RUO_DICH_RUO ON USR_USO_RUOLO_DICH(ID_RUOLO);

-- changeset root:1753259446745-889
CREATE INDEX IDX_USO_USR_APL ON USR_USO_USER_APPLIC(ID_APPLIC);

-- changeset root:1753259446745-890
CREATE INDEX IDX_USR_AGENT ON USR_USER(ID_AGENTE);

-- changeset root:1753259446745-891
CREATE INDEX IDX_USR_DA_REPLIC ON LOG_USER_DA_REPLIC(ID_USER_IAM);

-- changeset root:1753259446745-892
CREATE INDEX IDX_USR_DA_REPLIC_JOB ON LOG_USER_DA_REPLIC(ID_LOG_JOB);

-- changeset root:1753259446745-893
CREATE INDEX IDX_USR_ENTE_CONVENZ ON USR_USER(ID_ENTE_SIAM);

-- changeset root:1753259446745-894
CREATE INDEX IDX_USR_SIS_VERS ON USR_USER(ID_SISTEMA_VERSANTE);

-- changeset root:1753259446745-895
CREATE INDEX IDX_VAL_PAR_APL_AMB_CONV ON IAM_VALORE_PARAM_APPLIC(ID_AMBIENTE_ENTE_CONVENZ);

-- changeset root:1753259446745-896
CREATE INDEX IDX_VAL_PAR_APL_ENTE_CONV ON IAM_VALORE_PARAM_APPLIC(ID_ENTE_CONVENZ);

-- changeset root:1753259446745-897
ALTER TABLE ORG_TARIFFA_AA_ACCORDO ADD CONSTRAINT FK_AA_ACC_TP_SERV FOREIGN KEY (ID_TIPO_SERVIZIO) REFERENCES ORG_TIPO_SERVIZIO (ID_TIPO_SERVIZIO);

-- changeset root:1753259446745-898
ALTER TABLE USR_ABIL_DATI ADD CONSTRAINT FK_ABIL_DATI_APP_COLLEG FOREIGN KEY (ID_APPART_COLLEG_ENTI) REFERENCES ORG_APPART_COLLEG_ENTI (ID_APPART_COLLEG_ENTI) ON DELETE CASCADE;

-- changeset root:1753259446745-899
ALTER TABLE USR_ABIL_DATI ADD CONSTRAINT FK_ABIL_DATI_DICH FOREIGN KEY (ID_DICH_ABIL_DATI) REFERENCES USR_DICH_ABIL_DATI (ID_DICH_ABIL_DATI) ON DELETE CASCADE;

-- changeset root:1753259446745-900
ALTER TABLE USR_ABIL_DATI ADD CONSTRAINT FK_ABIL_DATI_SUPT_EST FOREIGN KEY (ID_SUPT_EST_ENTE_CONVENZ) REFERENCES ORG_SUPT_ESTERNO_ENTE_CONVENZ (ID_SUPT_EST_ENTE_CONVENZ) ON DELETE CASCADE;

-- changeset root:1753259446745-901
ALTER TABLE USR_ABIL_DATI ADD CONSTRAINT FK_ABIL_DATI_TI_DATO FOREIGN KEY (ID_TIPO_DATO_IAM) REFERENCES USR_TIPO_DATO_IAM (ID_TIPO_DATO_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-902
ALTER TABLE USR_ABIL_DATI ADD CONSTRAINT FK_ABIL_DATI_USO_USR_APL FOREIGN KEY (ID_USO_USER_APPLIC) REFERENCES USR_USO_USER_APPLIC (ID_USO_USER_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-903
ALTER TABLE USR_ABIL_DATI ADD CONSTRAINT FK_ABIL_DATI_VIG_ENTE FOREIGN KEY (ID_VIGIL_ENTE_PRODUT) REFERENCES ORG_VIGIL_ENTE_PRODUT (ID_VIGIL_ENTE_PRODUT) ON DELETE CASCADE;

-- changeset root:1753259446745-904
ALTER TABLE USR_ABIL_ENTE_SIAM ADD CONSTRAINT FK_ABIL_ENTE_ACC_VIG FOREIGN KEY (ID_ACCORDO_VIGIL) REFERENCES ORG_ACCORDO_VIGIL (ID_ACCORDO_VIGIL) ON DELETE CASCADE;

-- changeset root:1753259446745-905
ALTER TABLE USR_ABIL_ENTE_SIAM ADD CONSTRAINT FK_ABIL_ENTE_APP_COLLEG FOREIGN KEY (ID_APPART_COLLEG_ENTI) REFERENCES ORG_APPART_COLLEG_ENTI (ID_APPART_COLLEG_ENTI) ON DELETE CASCADE;

-- changeset root:1753259446745-906
ALTER TABLE USR_ABIL_ENTE_SIAM ADD CONSTRAINT FK_ABIL_ENTE_DICH FOREIGN KEY (ID_DICH_ABIL_ENTE_CONVENZ) REFERENCES USR_DICH_ABIL_ENTE_CONVENZ (ID_DICH_ABIL_ENTE_CONVENZ) ON DELETE CASCADE;

-- changeset root:1753259446745-907
ALTER TABLE USR_ABIL_ENTE_SIAM ADD CONSTRAINT FK_ABIL_ENTE_ENTE_CONVENZ FOREIGN KEY (ID_ENTE_SIAM) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM) ON DELETE CASCADE;

-- changeset root:1753259446745-908
ALTER TABLE USR_ABIL_ENTE_SIAM ADD CONSTRAINT FK_ABIL_ENTE_SUPT_EST FOREIGN KEY (ID_SUPT_EST_ENTE_CONVENZ) REFERENCES ORG_SUPT_ESTERNO_ENTE_CONVENZ (ID_SUPT_EST_ENTE_CONVENZ) ON DELETE CASCADE;

-- changeset root:1753259446745-909
ALTER TABLE USR_ABIL_ENTE_SIAM ADD CONSTRAINT FK_ABIL_ENTE_USR FOREIGN KEY (ID_USER_IAM) REFERENCES USR_USER (ID_USER_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-910
ALTER TABLE USR_ABIL_ORGANIZ ADD CONSTRAINT FK_ABIL_ORG_APP_COLLEG FOREIGN KEY (ID_APPART_COLLEG_ENTI) REFERENCES ORG_APPART_COLLEG_ENTI (ID_APPART_COLLEG_ENTI) ON DELETE CASCADE;

-- changeset root:1753259446745-911
ALTER TABLE USR_ABIL_ORGANIZ ADD CONSTRAINT FK_ABIL_ORG_DICH FOREIGN KEY (ID_DICH_ABIL_ORGANIZ) REFERENCES USR_DICH_ABIL_ORGANIZ (ID_DICH_ABIL_ORGANIZ) ON DELETE CASCADE;

-- changeset root:1753259446745-912
ALTER TABLE USR_ABIL_ORGANIZ ADD CONSTRAINT FK_ABIL_ORG_ORG_IAM FOREIGN KEY (ID_ORGANIZ_IAM) REFERENCES USR_ORGANIZ_IAM (ID_ORGANIZ_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-913
ALTER TABLE USR_ABIL_ORGANIZ ADD CONSTRAINT FK_ABIL_ORG_SUPT_EST_ENTE FOREIGN KEY (ID_SUPT_EST_ENTE_CONVENZ) REFERENCES ORG_SUPT_ESTERNO_ENTE_CONVENZ (ID_SUPT_EST_ENTE_CONVENZ) ON DELETE CASCADE;

-- changeset root:1753259446745-914
ALTER TABLE USR_ABIL_ORGANIZ ADD CONSTRAINT FK_ABIL_ORG_USO_USR_APL FOREIGN KEY (ID_USO_USER_APPLIC) REFERENCES USR_USO_USER_APPLIC (ID_USO_USER_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-915
ALTER TABLE USR_ABIL_ORGANIZ ADD CONSTRAINT FK_ABIL_ORG_VIG_ENTE FOREIGN KEY (ID_VIGIL_ENTE_PRODUT) REFERENCES ORG_VIGIL_ENTE_PRODUT (ID_VIGIL_ENTE_PRODUT) ON DELETE CASCADE;

-- changeset root:1753259446745-916
ALTER TABLE ORG_ACCORDO_ENTE ADD CONSTRAINT FK_ACCOR_ENTE_CD_IVA FOREIGN KEY (ID_CD_IVA) REFERENCES ORG_CD_IVA (ID_CD_IVA);

-- changeset root:1753259446745-917
ALTER TABLE ORG_ACCORDO_ENTE ADD CONSTRAINT FK_ACCOR_ENTE_CLA_ENTE_CONVENZ FOREIGN KEY (ID_CLASSE_ENTE_CONVENZ) REFERENCES ORG_CLASSE_ENTE_CONVENZ (ID_CLASSE_ENTE_CONVENZ);

-- changeset root:1753259446745-918
ALTER TABLE ORG_ACCORDO_ENTE ADD CONSTRAINT FK_ACCOR_ENTE_CLUSTER FOREIGN KEY (ID_CLUSTER_ACCORDO) REFERENCES ORG_CLUSTER_ACCORDO (ID_CLUSTER_ACCORDO);

-- changeset root:1753259446745-919
ALTER TABLE ORG_ACCORDO_ENTE ADD CONSTRAINT FK_ACCOR_ENTE_CONVENZ FOREIGN KEY (ID_ENTE_CONVENZ) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM) ON DELETE CASCADE;

-- changeset root:1753259446745-920
ALTER TABLE ORG_ACCORDO_ENTE ADD CONSTRAINT FK_ACCOR_ENTE_CONVENZ_AMMIN FOREIGN KEY (ID_ENTE_CONVENZ_AMMINISTRATORE) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-921
ALTER TABLE ORG_ACCORDO_ENTE ADD CONSTRAINT FK_ACCOR_ENTE_CONVENZ_CONSERV FOREIGN KEY (ID_ENTE_CONVENZ_CONSERV) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-922
ALTER TABLE ORG_ACCORDO_ENTE ADD CONSTRAINT FK_ACCOR_ENTE_CONVENZ_GESTORE FOREIGN KEY (ID_ENTE_CONVENZ_GESTORE) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-923
ALTER TABLE ORG_ACCORDO_ENTE ADD CONSTRAINT FK_ACCOR_ENTE_FASCIA_MAN FOREIGN KEY (ID_FASCIA_STORAGE_MANUALE_ACCORDO) REFERENCES ORG_FASCIA_STORAGE_ACCORDO (ID_FASCIA_STORAGE_ACCORDO);

-- changeset root:1753259446745-924
ALTER TABLE ORG_ACCORDO_ENTE ADD CONSTRAINT FK_ACCOR_ENTE_FASCIA_STD FOREIGN KEY (ID_FASCIA_STORAGE_STANDARD_ACCORDO) REFERENCES ORG_FASCIA_STORAGE_ACCORDO (ID_FASCIA_STORAGE_ACCORDO);

-- changeset root:1753259446745-925
ALTER TABLE ORG_ACCORDO_ENTE ADD CONSTRAINT FK_ACCOR_ENTE_TARIF FOREIGN KEY (ID_TARIFFARIO) REFERENCES ORG_TARIFFARIO (ID_TARIFFARIO);

-- changeset root:1753259446745-926
ALTER TABLE ORG_ACCORDO_ENTE ADD CONSTRAINT FK_ACCOR_ENTE_TI_ACCOR FOREIGN KEY (ID_TIPO_ACCORDO) REFERENCES ORG_TIPO_ACCORDO (ID_TIPO_ACCORDO);

-- changeset root:1753259446745-927
ALTER TABLE ORG_ACCORDO_VIGIL ADD CONSTRAINT FK_ACC_VIG_ENTE_CONSERV FOREIGN KEY (ID_ENTE_CONSERV) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-928
ALTER TABLE ORG_ACCORDO_VIGIL ADD CONSTRAINT FK_ACC_VIG_ORGANO_VIGIL FOREIGN KEY (ID_ENTE_ORGANO_VIGIL) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-929
ALTER TABLE PRF_ALLINEA_RUOLO ADD CONSTRAINT FK_ALLINEA_RUO_RUO FOREIGN KEY (ID_RUOLO) REFERENCES PRF_RUOLO (ID_RUOLO) ON DELETE CASCADE;

-- changeset root:1753259446745-930
ALTER TABLE ORG_AMBIENTE_ENTE_CONVENZ ADD CONSTRAINT FK_AMB_ENTE_CONVENZ_CONSERV FOREIGN KEY (ID_ENTE_CONSERV) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-931
ALTER TABLE ORG_AMBIENTE_ENTE_CONVENZ ADD CONSTRAINT FK_AMB_ENTE_CONVENZ_GESTORE FOREIGN KEY (ID_ENTE_GESTORE) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-932
ALTER TABLE APL_NOTA_RILASCIO ADD CONSTRAINT FK_APL_NOTA_RILASCIO_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC);

-- changeset root:1753259446745-933
ALTER TABLE ORG_APPART_COLLEG_ENTI ADD CONSTRAINT FK_APP_COLLEG_ENTI_COLLEG FOREIGN KEY (ID_COLLEG_ENTI_CONVENZ) REFERENCES ORG_COLLEG_ENTI_CONVENZ (ID_COLLEG_ENTI_CONVENZ) ON DELETE CASCADE;

-- changeset root:1753259446745-934
ALTER TABLE ORG_APPART_COLLEG_ENTI ADD CONSTRAINT FK_APP_COLLEG_ENTI_ENTE_CONV FOREIGN KEY (ID_ENTE_CONVENZ) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-935
ALTER TABLE USR_APPART_USER_RICH ADD CONSTRAINT FK_APP_USR_RICH FOREIGN KEY (ID_RICH_GEST_USER) REFERENCES USR_RICH_GEST_USER (ID_RICH_GEST_USER) ON DELETE CASCADE;

-- changeset root:1753259446745-936
ALTER TABLE USR_APPART_USER_RICH ADD CONSTRAINT FK_APP_USR_RICH_ENTE_USR FOREIGN KEY (ID_ENTE_USER) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-937
ALTER TABLE USR_APPART_USER_RICH ADD CONSTRAINT FK_APP_USR_RICH_NOTIF_1 FOREIGN KEY (ID_NOTIFICA_AZIONE_1) REFERENCES NTF_NOTIFICA (ID_NOTIFICA);

-- changeset root:1753259446745-938
ALTER TABLE USR_APPART_USER_RICH ADD CONSTRAINT FK_APP_USR_RICH_NOTIF_2 FOREIGN KEY (ID_NOTIFICA_AZIONE_2) REFERENCES NTF_NOTIFICA (ID_NOTIFICA);

-- changeset root:1753259446745-939
ALTER TABLE USR_APPART_USER_RICH ADD CONSTRAINT FK_APP_USR_RICH_USR FOREIGN KEY (ID_USER_IAM) REFERENCES USR_USER (ID_USER_IAM);

-- changeset root:1753259446745-940
ALTER TABLE PRF_AUTOR ADD CONSTRAINT FK_AUT_AZN_PAG FOREIGN KEY (ID_AZIONE_PAGINA) REFERENCES APL_AZIONE_PAGINA (ID_AZIONE_PAGINA) ON DELETE CASCADE;

-- changeset root:1753259446745-941
ALTER TABLE PRF_AUTOR ADD CONSTRAINT FK_AUT_ENT_MENU FOREIGN KEY (ID_ENTRY_MENU) REFERENCES APL_ENTRY_MENU (ID_ENTRY_MENU) ON DELETE CASCADE;

-- changeset root:1753259446745-942
ALTER TABLE PRF_AUTOR ADD CONSTRAINT FK_AUT_PAG FOREIGN KEY (ID_PAGINA_WEB) REFERENCES APL_PAGINA_WEB (ID_PAGINA_WEB) ON DELETE CASCADE;

-- changeset root:1753259446745-943
ALTER TABLE PRF_AUTOR ADD CONSTRAINT FK_AUT_SRV FOREIGN KEY (ID_SERVIZIO_WEB) REFERENCES APL_SERVIZIO_WEB (ID_SERVIZIO_WEB) ON DELETE CASCADE;

-- changeset root:1753259446745-944
ALTER TABLE PRF_AUTOR ADD CONSTRAINT FK_AUT_USO_RUO_APL FOREIGN KEY (ID_USO_RUOLO_APPLIC) REFERENCES PRF_USO_RUOLO_APPLIC (ID_USO_RUOLO_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-945
ALTER TABLE APL_AZIONE_COMP_SW ADD CONSTRAINT FK_AZN_COMP_SW FOREIGN KEY (ID_COMP_SW) REFERENCES APL_COMP_SW (ID_COMP_SW) ON DELETE CASCADE;

-- changeset root:1753259446745-946
ALTER TABLE APL_AZIONE_COMP_SW ADD CONSTRAINT FK_AZN_COMP_SW_TI_EVN FOREIGN KEY (ID_TIPO_EVENTO) REFERENCES APL_TIPO_EVENTO (ID_TIPO_EVENTO) ON DELETE SET NULL;

-- changeset root:1753259446745-947
ALTER TABLE APL_AZIONE_PAGINA ADD CONSTRAINT FK_AZN_PAG FOREIGN KEY (ID_PAGINA_WEB) REFERENCES APL_PAGINA_WEB (ID_PAGINA_WEB) ON DELETE CASCADE;

-- changeset root:1753259446745-948
ALTER TABLE APL_AZIONE_PAGINA ADD CONSTRAINT FK_AZN_PAG_TI_EVN FOREIGN KEY (ID_TIPO_EVENTO) REFERENCES APL_TIPO_EVENTO (ID_TIPO_EVENTO) ON DELETE SET NULL;

-- changeset root:1753259446745-949
ALTER TABLE APL_CLASSE_TIPO_DATO ADD CONSTRAINT FK_CLA_TI_DATO_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-950
ALTER TABLE ORG_COLLEG_ENTI_CONVENZ ADD CONSTRAINT FK_COLLEG_ENTI_CONV_CAPO FOREIGN KEY (ID_ENTE_CONVENZ_CAPOFILA) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-951
ALTER TABLE DEC_COL_QUERY_MODELLO_COMUNIC ADD CONSTRAINT FK_COL_QRY_MODL_COM FOREIGN KEY (ID_QUERY_MODELLO_COMUNIC) REFERENCES DEC_QUERY_MODELLO_COMUNIC (ID_QUERY_MODELLO_COMUNIC) ON DELETE CASCADE;

-- changeset root:1753259446745-952
ALTER TABLE APL_COMP_SW ADD CONSTRAINT FK_COMP_SW_AGENT FOREIGN KEY (ID_AGENTE) REFERENCES LOG_AGENTE (ID_AGENTE);

-- changeset root:1753259446745-953
ALTER TABLE APL_COMP_SW ADD CONSTRAINT FK_COMP_SW_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-954
ALTER TABLE USR_DICH_ABIL_DATI ADD CONSTRAINT FK_DICH_ABIL_DATI_APP_COLLEG FOREIGN KEY (ID_APPART_COLLEG_ENTI) REFERENCES ORG_APPART_COLLEG_ENTI (ID_APPART_COLLEG_ENTI) ON DELETE CASCADE;

-- changeset root:1753259446745-955
ALTER TABLE USR_DICH_ABIL_DATI ADD CONSTRAINT FK_DICH_ABIL_DATI_SUPT_EST FOREIGN KEY (ID_SUPT_EST_ENTE_CONVENZ) REFERENCES ORG_SUPT_ESTERNO_ENTE_CONVENZ (ID_SUPT_EST_ENTE_CONVENZ) ON DELETE CASCADE;

-- changeset root:1753259446745-956
ALTER TABLE USR_DICH_ABIL_DATI ADD CONSTRAINT FK_DICH_ABIL_DATI_VIG_ENTE FOREIGN KEY (ID_VIGIL_ENTE_PRODUT) REFERENCES ORG_VIGIL_ENTE_PRODUT (ID_VIGIL_ENTE_PRODUT) ON DELETE CASCADE;

-- changeset root:1753259446745-957
ALTER TABLE USR_DICH_ABIL_ENTE_CONVENZ ADD CONSTRAINT FK_DICH_ABIL_ENTE_AMB FOREIGN KEY (ID_AMBIENTE_ENTE_CONVENZ) REFERENCES ORG_AMBIENTE_ENTE_CONVENZ (ID_AMBIENTE_ENTE_CONVENZ);

-- changeset root:1753259446745-958
ALTER TABLE USR_DICH_ABIL_ENTE_CONVENZ ADD CONSTRAINT FK_DICH_ABIL_ENTE_APP_COLLEG FOREIGN KEY (ID_APPART_COLLEG_ENTI) REFERENCES ORG_APPART_COLLEG_ENTI (ID_APPART_COLLEG_ENTI) ON DELETE CASCADE;

-- changeset root:1753259446745-959
ALTER TABLE USR_DICH_ABIL_ENTE_CONVENZ ADD CONSTRAINT FK_DICH_ABIL_ENTE_ENTE FOREIGN KEY (ID_ENTE_CONVENZ) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-960
ALTER TABLE USR_DICH_ABIL_ENTE_CONVENZ ADD CONSTRAINT FK_DICH_ABIL_ENTE_USR FOREIGN KEY (ID_USER_IAM) REFERENCES USR_USER (ID_USER_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-961
ALTER TABLE USR_DICH_ABIL_ORGANIZ ADD CONSTRAINT FK_DICH_ABIL_ORG_APP_COLLEG FOREIGN KEY (ID_APPART_COLLEG_ENTI) REFERENCES ORG_APPART_COLLEG_ENTI (ID_APPART_COLLEG_ENTI) ON DELETE CASCADE;

-- changeset root:1753259446745-962
ALTER TABLE USR_DICH_ABIL_ORGANIZ ADD CONSTRAINT FK_DICH_ABIL_ORG_ORG_IAM FOREIGN KEY (ID_ORGANIZ_IAM) REFERENCES USR_ORGANIZ_IAM (ID_ORGANIZ_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-963
ALTER TABLE USR_DICH_ABIL_ORGANIZ ADD CONSTRAINT FK_DICH_ABIL_ORG_SUPT_EST FOREIGN KEY (ID_SUPT_EST_ENTE_CONVENZ) REFERENCES ORG_SUPT_ESTERNO_ENTE_CONVENZ (ID_SUPT_EST_ENTE_CONVENZ) ON DELETE CASCADE;

-- changeset root:1753259446745-964
ALTER TABLE USR_DICH_ABIL_ORGANIZ ADD CONSTRAINT FK_DICH_ABIL_ORG_USO_USR_APL FOREIGN KEY (ID_USO_USER_APPLIC) REFERENCES USR_USO_USER_APPLIC (ID_USO_USER_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-965
ALTER TABLE USR_DICH_ABIL_ORGANIZ ADD CONSTRAINT FK_DICH_ABIL_ORG_VIG_ENTE FOREIGN KEY (ID_VIGIL_ENTE_PRODUT) REFERENCES ORG_VIGIL_ENTE_PRODUT (ID_VIGIL_ENTE_PRODUT) ON DELETE CASCADE;

-- changeset root:1753259446745-966
ALTER TABLE PRF_DICH_AUTOR ADD CONSTRAINT FK_DICH_AUT_AZN_PAG FOREIGN KEY (ID_AZIONE_PAGINA) REFERENCES APL_AZIONE_PAGINA (ID_AZIONE_PAGINA) ON DELETE CASCADE;

-- changeset root:1753259446745-967
ALTER TABLE PRF_DICH_AUTOR ADD CONSTRAINT FK_DICH_AUT_ENT_MENU_FOGLIA FOREIGN KEY (ID_ENTRY_MENU_FOGLIA) REFERENCES APL_ENTRY_MENU (ID_ENTRY_MENU) ON DELETE CASCADE;

-- changeset root:1753259446745-968
ALTER TABLE PRF_DICH_AUTOR ADD CONSTRAINT FK_DICH_AUT_ENT_MENU_PADRE FOREIGN KEY (ID_ENTRY_MENU_PADRE) REFERENCES APL_ENTRY_MENU (ID_ENTRY_MENU) ON DELETE CASCADE;

-- changeset root:1753259446745-969
ALTER TABLE PRF_DICH_AUTOR ADD CONSTRAINT FK_DICH_AUT_PAG FOREIGN KEY (ID_PAGINA_WEB) REFERENCES APL_PAGINA_WEB (ID_PAGINA_WEB) ON DELETE CASCADE;

-- changeset root:1753259446745-970
ALTER TABLE PRF_DICH_AUTOR ADD CONSTRAINT FK_DICH_AUT_SRV FOREIGN KEY (ID_SERVIZIO_WEB) REFERENCES APL_SERVIZIO_WEB (ID_SERVIZIO_WEB) ON DELETE CASCADE;

-- changeset root:1753259446745-971
ALTER TABLE PRF_DICH_AUTOR ADD CONSTRAINT FK_DICH_AUT_USO_APL FOREIGN KEY (ID_USO_RUOLO_APPLIC) REFERENCES PRF_USO_RUOLO_APPLIC (ID_USO_RUOLO_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-972
ALTER TABLE USR_DICH_ABIL_DATI ADD CONSTRAINT FK_DIC_ABIL_DATI_CLA_TI_DATO FOREIGN KEY (ID_CLASSE_TIPO_DATO) REFERENCES APL_CLASSE_TIPO_DATO (ID_CLASSE_TIPO_DATO) ON DELETE CASCADE;

-- changeset root:1753259446745-973
ALTER TABLE USR_DICH_ABIL_DATI ADD CONSTRAINT FK_DIC_ABIL_DATI_ORG_IAM FOREIGN KEY (ID_ORGANIZ_IAM) REFERENCES USR_ORGANIZ_IAM (ID_ORGANIZ_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-974
ALTER TABLE USR_DICH_ABIL_DATI ADD CONSTRAINT FK_DIC_ABIL_DATI_TI_DATO FOREIGN KEY (ID_TIPO_DATO_IAM) REFERENCES USR_TIPO_DATO_IAM (ID_TIPO_DATO_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-975
ALTER TABLE USR_DICH_ABIL_DATI ADD CONSTRAINT FK_DIC_ABIL_DATI_USO_USR_APL FOREIGN KEY (ID_USO_USER_APPLIC) REFERENCES USR_USO_USER_APPLIC (ID_USO_USER_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-976
ALTER TABLE ORG_DISCIP_STRUT ADD CONSTRAINT FK_DISCIP_STRUT_ACCOR_ENTE FOREIGN KEY (ID_ACCORDO_ENTE) REFERENCES ORG_ACCORDO_ENTE (ID_ACCORDO_ENTE) ON DELETE CASCADE;

-- changeset root:1753259446745-977
ALTER TABLE ORG_DISCIP_STRUT ADD CONSTRAINT FK_DISCIP_STRUT_ID_ENTE_CONVENZ FOREIGN KEY (ID_ENTE_CONVENZ) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM) ON DELETE CASCADE;

-- changeset root:1753259446745-978
ALTER TABLE ORG_DISCIP_STRUT ADD CONSTRAINT FK_DISCIP_STRUT_ORG_IAM FOREIGN KEY (ID_ORGANIZ_IAM) REFERENCES USR_ORGANIZ_IAM (ID_ORGANIZ_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-979
ALTER TABLE ORG_ENTE_ARK_RIF ADD CONSTRAINT FK_ENTE_ARK_RIF FOREIGN KEY (ID_ENTE_CONVENZ) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM) ON DELETE CASCADE;

-- changeset root:1753259446745-980
ALTER TABLE ORG_ENTE_ARK_RIF ADD CONSTRAINT FK_ENTE_ARK_RIF_USR FOREIGN KEY (ID_USER_IAM) REFERENCES USR_USER (ID_USER_IAM);

-- changeset root:1753259446745-981
ALTER TABLE ORG_ENTE_CONVENZ_ORG ADD CONSTRAINT FK_ENTE_CONVEMZ_ORG FOREIGN KEY (ID_ORGANIZ_IAM) REFERENCES USR_ORGANIZ_IAM (ID_ORGANIZ_IAM);

-- changeset root:1753259446745-982
ALTER TABLE ORG_ENTE_CONVENZ_ORG ADD CONSTRAINT FK_ENTE_CONVEMZ_ORG_ENTE FOREIGN KEY (ID_ENTE_CONVENZ) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM) ON DELETE CASCADE;

-- changeset root:1753259446745-983
ALTER TABLE ORG_ENTE_SIAM ADD CONSTRAINT FK_ENTE_CONVENZ_AMB FOREIGN KEY (ID_AMBIENTE_ENTE_CONVENZ) REFERENCES ORG_AMBIENTE_ENTE_CONVENZ (ID_AMBIENTE_ENTE_CONVENZ) ON DELETE CASCADE;

-- changeset root:1753259446745-984
ALTER TABLE ORG_ENTE_SIAM ADD CONSTRAINT FK_ENTE_CONVENZ_AMB_TRT FOREIGN KEY (ID_AMBITO_TERRIT) REFERENCES ORG_AMBITO_TERRIT (ID_AMBITO_TERRIT);

-- changeset root:1753259446745-985
ALTER TABLE ORG_ENTE_SIAM ADD CONSTRAINT FK_ENTE_CONVENZ_CAT FOREIGN KEY (ID_CATEG_ENTE) REFERENCES SACER.ORG_CATEG_ENTE (ID_CATEG_ENTE);

-- changeset root:1753259446745-986
ALTER TABLE ORG_ENTE_SIAM ADD CONSTRAINT FK_ENTE_CONVENZ_CD_IVA FOREIGN KEY (ID_CD_IVA) REFERENCES ORG_CD_IVA (ID_CD_IVA);

-- changeset root:1753259446745-987
ALTER TABLE ORG_ENTE_SIAM ADD CONSTRAINT FK_ENTE_CONVENZ_CREA FOREIGN KEY (ID_ENTE_CONVENZ_CREAZIONE) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-988
ALTER TABLE ORG_ENTE_SIAM ADD CONSTRAINT FK_ENTE_CONVENZ_NUOVO FOREIGN KEY (ID_ENTE_CONVENZ_NUOVO) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-989
ALTER TABLE ORG_ENTE_SIAM ADD CONSTRAINT FK_ENTE_CONVENZ_PROV FOREIGN KEY (ID_PROV_SEDE_LEGALE) REFERENCES ORG_AMBITO_TERRIT (ID_AMBITO_TERRIT);

-- changeset root:1753259446745-990
ALTER TABLE ORG_ENTE_SIAM ADD CONSTRAINT FK_ENTE_PRODUT_CORRISP FOREIGN KEY (ID_ENTE_PRODUT_CORRISP) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-991
ALTER TABLE ORG_ENTE_USER_RIF ADD CONSTRAINT FK_ENTE_USR_RIF FOREIGN KEY (ID_ENTE_CONVENZ) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM) ON DELETE CASCADE;

-- changeset root:1753259446745-992
ALTER TABLE ORG_ENTE_USER_RIF ADD CONSTRAINT FK_ENTE_USR_RIF_USR FOREIGN KEY (ID_USER_IAM) REFERENCES USR_USER (ID_USER_IAM);

-- changeset root:1753259446745-993
ALTER TABLE APL_ENTRY_MENU ADD CONSTRAINT FK_ENT_MENU_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-994
ALTER TABLE APL_ENTRY_MENU ADD CONSTRAINT FK_ENT_MENU_ENT_MENU_PADRE FOREIGN KEY (ID_ENTRY_MENU_PADRE) REFERENCES APL_ENTRY_MENU (ID_ENTRY_MENU) ON DELETE CASCADE;

-- changeset root:1753259446745-995
ALTER TABLE ORG_CLUSTER_ACCORDO ADD CONSTRAINT FK_FASCIA_STORAGE_ACCORDO FOREIGN KEY (ID_FASCIA_STORAGE_ACCORDO) REFERENCES ORG_FASCIA_STORAGE_ACCORDO (ID_FASCIA_STORAGE_ACCORDO);

-- changeset root:1753259446745-996
ALTER TABLE ORG_FATTURA_ENTE ADD CONSTRAINT FK_FATT_ENTE_CONVENZ FOREIGN KEY (ID_ENTE_CONVENZ) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM) ON DELETE CASCADE;

-- changeset root:1753259446745-997
ALTER TABLE ORG_FATTURA_ENTE ADD CONSTRAINT FK_FATT_ENTE_STORNATA FOREIGN KEY (ID_FATTURA_ENTE_STORNATA) REFERENCES ORG_FATTURA_ENTE (ID_FATTURA_ENTE);

-- changeset root:1753259446745-998
ALTER TABLE ORG_GESTIONE_ACCORDO ADD CONSTRAINT FK_GEST_ACCORDO_TIPI_GEST FOREIGN KEY (ID_TIPO_GESTIONE_ACCORDO) REFERENCES ORG_TIPI_GESTIONE_ACCORDO (ID_TIPO_GESTIONE_ACCORDO);

-- changeset root:1753259446745-999
ALTER TABLE APL_HELP_ON_LINE ADD CONSTRAINT FK_HELP_OL_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-1000
ALTER TABLE APL_HELP_ON_LINE ADD CONSTRAINT FK_HELP_OL_ENT_MENU FOREIGN KEY (ID_ENTRY_MENU) REFERENCES APL_ENTRY_MENU (ID_ENTRY_MENU);

-- changeset root:1753259446745-1001
ALTER TABLE APL_HELP_ON_LINE ADD CONSTRAINT FK_HELP_OL_PAG FOREIGN KEY (ID_PAGINA_WEB) REFERENCES APL_PAGINA_WEB (ID_PAGINA_WEB);

-- changeset root:1753259446745-1002
ALTER TABLE ORG_MODULO_INFO_ACCORDO ADD CONSTRAINT FK_ID_ENTE_CONVENZ FOREIGN KEY (ID_ENTE_CONVENZ) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM) ON DELETE CASCADE;

-- changeset root:1753259446745-1003
ALTER TABLE USR_IND_IP_USER ADD CONSTRAINT FK_IND_IP_USR FOREIGN KEY (ID_USER_IAM) REFERENCES USR_USER (ID_USER_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-1004
ALTER TABLE ORG_MODIF_FATTURA_ENTE ADD CONSTRAINT FK_MOD_FATT_ENTE FOREIGN KEY (ID_FATTURA_ENTE) REFERENCES ORG_FATTURA_ENTE (ID_FATTURA_ENTE) ON DELETE CASCADE;

-- changeset root:1753259446745-1005
ALTER TABLE ORG_MODULO_INFO_ACCORDO ADD CONSTRAINT FK_MOD_INFO_ACCOR_ENTE FOREIGN KEY (ID_ACCORDO_ENTE) REFERENCES ORG_ACCORDO_ENTE (ID_ACCORDO_ENTE) ON DELETE CASCADE;

-- changeset root:1753259446745-1006
ALTER TABLE APL_NEWS_APPLIC ADD CONSTRAINT FK_NEWS_APL_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-1007
ALTER TABLE APL_NEWS_APPLIC ADD CONSTRAINT FK_NEWS_APL_NEWS FOREIGN KEY (ID_NEWS) REFERENCES APL_NEWS (ID_NEWS) ON DELETE CASCADE;

-- changeset root:1753259446745-1008
ALTER TABLE NTF_NOTIFICA ADD CONSTRAINT FK_NOTIF_MODL_COM FOREIGN KEY (ID_MODELLO_COMUNIC) REFERENCES DEC_MODELLO_COMUNIC (ID_MODELLO_COMUNIC);

-- changeset root:1753259446745-1009
ALTER TABLE USR_OLD_PSW ADD CONSTRAINT FK_OLD_PSW_USR FOREIGN KEY (ID_USER_IAM) REFERENCES USR_USER (ID_USER_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-1010
ALTER TABLE ORG_AA_ACCORDO ADD CONSTRAINT FK_ORG_AA_ACCORDO FOREIGN KEY (ID_ACCORDO_ENTE) REFERENCES ORG_ACCORDO_ENTE (ID_ACCORDO_ENTE) ON DELETE CASCADE;

-- changeset root:1753259446745-1011
ALTER TABLE USR_ORGANIZ_IAM ADD CONSTRAINT FK_ORG_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-1012
ALTER TABLE USR_ORGANIZ_IAM ADD CONSTRAINT FK_ORG_IAM_ENTE_CONSERV FOREIGN KEY (ID_ENTE_CONSERV) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-1013
ALTER TABLE USR_ORGANIZ_IAM ADD CONSTRAINT FK_ORG_IAM_ENTE_GESTORE FOREIGN KEY (ID_ENTE_GESTORE) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-1014
ALTER TABLE USR_ORGANIZ_IAM ADD CONSTRAINT FK_ORG_ORG FOREIGN KEY (ID_ORGANIZ_IAM_PADRE) REFERENCES USR_ORGANIZ_IAM (ID_ORGANIZ_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-1015
ALTER TABLE USR_ORGANIZ_IAM ADD CONSTRAINT FK_ORG_TI_ORG FOREIGN KEY (ID_TIPO_ORGANIZ) REFERENCES APL_TIPO_ORGANIZ (ID_TIPO_ORGANIZ) ON DELETE CASCADE;

-- changeset root:1753259446745-1016
ALTER TABLE APL_PAGINA_WEB ADD CONSTRAINT FK_PAG_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-1017
ALTER TABLE APL_PAGINA_WEB ADD CONSTRAINT FK_PAG_ENT_MENU FOREIGN KEY (ID_ENTRY_MENU) REFERENCES APL_ENTRY_MENU (ID_ENTRY_MENU) ON DELETE CASCADE;

-- changeset root:1753259446745-1018
ALTER TABLE ORG_PAGAM_FATTURA_ENTE ADD CONSTRAINT FK_PAG_FATT_ENTE FOREIGN KEY (ID_FATTURA_ENTE) REFERENCES ORG_FATTURA_ENTE (ID_FATTURA_ENTE) ON DELETE CASCADE;

-- changeset root:1753259446745-1019
ALTER TABLE PRF_RUOLO_CATEGORIA ADD CONSTRAINT FK_PRF_CATEG_RUOLO FOREIGN KEY (ID_RUOLO) REFERENCES PRF_RUOLO (ID_RUOLO) ON DELETE CASCADE;

-- changeset root:1753259446745-1020
ALTER TABLE DEC_QUERY_MODELLO_COMUNIC ADD CONSTRAINT FK_QRY_MODL_COM FOREIGN KEY (ID_MODELLO_COMUNIC) REFERENCES DEC_MODELLO_COMUNIC (ID_MODELLO_COMUNIC) ON DELETE CASCADE;

-- changeset root:1753259446745-1021
ALTER TABLE APL_QUERY_TIPO_OGGETTO ADD CONSTRAINT FK_QRY_TI_OBJ FOREIGN KEY (ID_TIPO_OGGETTO) REFERENCES APL_TIPO_OGGETTO (ID_TIPO_OGGETTO) ON DELETE CASCADE;

-- changeset root:1753259446745-1022
ALTER TABLE APL_QUERY_TIPO_OGGETTO ADD CONSTRAINT FK_QRY_TI_OGG_ACCESSO FOREIGN KEY (ID_TIPO_OGGETTO_ACCESSO) REFERENCES APL_TIPO_OGGETTO (ID_TIPO_OGGETTO);

-- changeset root:1753259446745-1023
ALTER TABLE APL_QUERY_TIPO_OGGETTO ADD CONSTRAINT FK_QRY_TI_OGG_SEL FOREIGN KEY (ID_TIPO_OGGETTO_SEL) REFERENCES APL_TIPO_OGGETTO (ID_TIPO_OGGETTO);

-- changeset root:1753259446745-1024
ALTER TABLE USR_RICH_GEST_USER ADD CONSTRAINT FK_RICH_GEST_USR_ENTE_CONVENZ FOREIGN KEY (ID_ENTE_RICH) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-1025
ALTER TABLE USR_RICH_GEST_USER ADD CONSTRAINT FK_RICH_GEST_USR_NOTIF FOREIGN KEY (ID_NOTIFICA_RICH_EVASA) REFERENCES NTF_NOTIFICA (ID_NOTIFICA);

-- changeset root:1753259446745-1026
ALTER TABLE USR_RICH_GEST_USER ADD CONSTRAINT FK_RICH_GEST_USR_ORG_IAM FOREIGN KEY (ID_ORGANIZ_IAM) REFERENCES USR_ORGANIZ_IAM (ID_ORGANIZ_IAM);

-- changeset root:1753259446745-1027
ALTER TABLE USR_RICH_GEST_USER ADD CONSTRAINT FK_RICH_GEST_USR_RICH FOREIGN KEY (ID_USER_IAM_RICH) REFERENCES USR_USER (ID_USER_IAM);

-- changeset root:1753259446745-1028
ALTER TABLE ORG_SCAGLIONE_TARIFFA ADD CONSTRAINT FK_RNG_VAL_TARIFFA FOREIGN KEY (ID_TARIFFA) REFERENCES ORG_TARIFFA (ID_TARIFFA) ON DELETE CASCADE;

-- changeset root:1753259446745-1029
ALTER TABLE ORG_SERVIZIO_EROG ADD CONSTRAINT FK_SERV_EROG_ACCOR_ENTE FOREIGN KEY (ID_ACCORDO_ENTE) REFERENCES ORG_ACCORDO_ENTE (ID_ACCORDO_ENTE) ON DELETE CASCADE;

-- changeset root:1753259446745-1030
ALTER TABLE ORG_SERVIZIO_EROG ADD CONSTRAINT FK_SERV_EROG_SIS_VERS FOREIGN KEY (ID_SISTEMA_VERSANTE) REFERENCES APL_SISTEMA_VERSANTE (ID_SISTEMA_VERSANTE);

-- changeset root:1753259446745-1031
ALTER TABLE ORG_SERVIZIO_EROG ADD CONSTRAINT FK_SERV_EROG_TARIFFA FOREIGN KEY (ID_TARIFFA) REFERENCES ORG_TARIFFA (ID_TARIFFA);

-- changeset root:1753259446745-1032
ALTER TABLE ORG_SERVIZIO_EROG ADD CONSTRAINT FK_SERV_EROG_TARIF_AA_ACC FOREIGN KEY (ID_TARIFFA_AA_ACCORDO) REFERENCES ORG_TARIFFA_AA_ACCORDO (ID_TARIFFA_AA_ACCORDO);

-- changeset root:1753259446745-1033
ALTER TABLE ORG_SERVIZIO_EROG ADD CONSTRAINT FK_SERV_EROG_TARIF_ACCOR FOREIGN KEY (ID_TARIFFA_ACCORDO) REFERENCES ORG_TARIFFA_ACCORDO (ID_TARIFFA_ACCORDO);

-- changeset root:1753259446745-1034
ALTER TABLE ORG_SERVIZIO_FATTURA ADD CONSTRAINT FK_SERV_FATT_CD_IVA FOREIGN KEY (ID_CD_IVA) REFERENCES ORG_CD_IVA (ID_CD_IVA);

-- changeset root:1753259446745-1035
ALTER TABLE ORG_SERVIZIO_FATTURA ADD CONSTRAINT FK_SERV_FATT_ENTE FOREIGN KEY (ID_FATTURA_ENTE) REFERENCES ORG_FATTURA_ENTE (ID_FATTURA_ENTE) ON DELETE CASCADE;

-- changeset root:1753259446745-1036
ALTER TABLE ORG_SERVIZIO_FATTURA ADD CONSTRAINT FK_SERV_FATT_SERV_EROG FOREIGN KEY (ID_SERVIZIO_EROGATO) REFERENCES ORG_SERVIZIO_EROG (ID_SERVIZIO_EROGATO) ON DELETE CASCADE;

-- changeset root:1753259446745-1037
ALTER TABLE APL_SISTEMA_VERS_ARK_RIF ADD CONSTRAINT FK_SIST_VERS_ARK_RIF FOREIGN KEY (ID_SISTEMA_VERSANTE) REFERENCES APL_SISTEMA_VERSANTE (ID_SISTEMA_VERSANTE) ON DELETE CASCADE;

-- changeset root:1753259446745-1038
ALTER TABLE APL_SISTEMA_VERS_ARK_RIF ADD CONSTRAINT FK_SIST_VERS_ARK_RIF_USR FOREIGN KEY (ID_USER_IAM) REFERENCES USR_USER (ID_USER_IAM);

-- changeset root:1753259446745-1039
ALTER TABLE APL_SISTEMA_VERSANTE ADD CONSTRAINT FK_SIS_VERS_ENTE FOREIGN KEY (ID_ENTE_SIAM) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-1040
ALTER TABLE APL_SISTEMA_VERSANTE_USER_REF ADD CONSTRAINT FK_SIS_VERS_USR_REF_SIS FOREIGN KEY (ID_SISTEMA_VERSANTE) REFERENCES APL_SISTEMA_VERSANTE (ID_SISTEMA_VERSANTE) ON DELETE CASCADE;

-- changeset root:1753259446745-1041
ALTER TABLE APL_SISTEMA_VERSANTE_USER_REF ADD CONSTRAINT FK_SIS_VERS_USR_REF_USR FOREIGN KEY (ID_USER_IAM_REF) REFERENCES USR_USER (ID_USER_IAM);

-- changeset root:1753259446745-1042
ALTER TABLE ORG_SOLLECITO_FATTURA_ENTE ADD CONSTRAINT FK_SOLL_FATT_ENTE FOREIGN KEY (ID_FATTURA_ENTE) REFERENCES ORG_FATTURA_ENTE (ID_FATTURA_ENTE) ON DELETE CASCADE;

-- changeset root:1753259446745-1043
ALTER TABLE APL_SERVIZIO_WEB ADD CONSTRAINT FK_SRV_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-1044
ALTER TABLE ORG_STATO_FATTURA_ENTE ADD CONSTRAINT FK_STATO_FATT_ENTE FOREIGN KEY (ID_FATTURA_ENTE) REFERENCES ORG_FATTURA_ENTE (ID_FATTURA_ENTE) ON DELETE CASCADE;

-- changeset root:1753259446745-1045
ALTER TABLE USR_STATO_USER ADD CONSTRAINT FK_STATO_USR_NOTIF FOREIGN KEY (ID_NOTIFICA) REFERENCES NTF_NOTIFICA (ID_NOTIFICA);

-- changeset root:1753259446745-1046
ALTER TABLE USR_STATO_USER ADD CONSTRAINT FK_STATO_USR_RICH_GEST_USR FOREIGN KEY (ID_RICH_GEST_USER) REFERENCES USR_RICH_GEST_USER (ID_RICH_GEST_USER);

-- changeset root:1753259446745-1047
ALTER TABLE USR_STATO_USER ADD CONSTRAINT FK_STATO_USR_USR FOREIGN KEY (ID_USER_IAM) REFERENCES USR_USER (ID_USER_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-1048
ALTER TABLE ORG_STO_ENTE_AMBIENTE_CONVENZ ADD CONSTRAINT FK_STO_ENTE_AMB_CONV FOREIGN KEY (ID_AMBIENTE_ENTE_CONVENZ) REFERENCES ORG_AMBIENTE_ENTE_CONVENZ (ID_AMBIENTE_ENTE_CONVENZ) ON DELETE CASCADE;

-- changeset root:1753259446745-1049
ALTER TABLE ORG_STO_ENTE_AMBIENTE_CONVENZ ADD CONSTRAINT FK_STO_ENTE_AMB_ENT_CONVENZ FOREIGN KEY (ID_ENTE_CONVENZ) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM) ON DELETE CASCADE;

-- changeset root:1753259446745-1050
ALTER TABLE ORG_STO_ENTE_CONVENZ ADD CONSTRAINT FK_STO_ENTE_CONVENZ FOREIGN KEY (ID_ENTE_CONVENZ) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM) ON DELETE CASCADE;

-- changeset root:1753259446745-1051
ALTER TABLE ORG_STO_ENTE_CONVENZ ADD CONSTRAINT FK_STO_ENTE_CONVENZ_AMB_TRT FOREIGN KEY (ID_AMBITO_TERRIT) REFERENCES ORG_AMBITO_TERRIT (ID_AMBITO_TERRIT);

-- changeset root:1753259446745-1052
ALTER TABLE ORG_STO_ENTE_CONVENZ ADD CONSTRAINT FK_STO_ENTE_CONVENZ_CAT FOREIGN KEY (ID_CATEG_ENTE) REFERENCES SACER.ORG_CATEG_ENTE (ID_CATEG_ENTE);

-- changeset root:1753259446745-1053
ALTER TABLE ORG_STO_ENTE_CONVENZ ADD CONSTRAINT FK_STO_ENTE_CONVENZ_PROV FOREIGN KEY (ID_PROV_SEDE_LEGALE) REFERENCES ORG_AMBITO_TERRIT (ID_AMBITO_TERRIT);

-- changeset root:1753259446745-1054
ALTER TABLE ORG_SUPT_ESTERNO_ENTE_CONVENZ ADD CONSTRAINT FK_SUPT_EST_ENTE_CONV_FORNIT FOREIGN KEY (ID_ENTE_FORNIT_EST) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-1055
ALTER TABLE ORG_SUPT_ESTERNO_ENTE_CONVENZ ADD CONSTRAINT FK_SUPT_EST_ENTE_CONV_PRODUT FOREIGN KEY (ID_ENTE_PRODUT) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-1056
ALTER TABLE ORG_TARIFFA_ACCORDO ADD CONSTRAINT FK_TARIFFA_ACCOR FOREIGN KEY (ID_ACCORDO_ENTE) REFERENCES ORG_ACCORDO_ENTE (ID_ACCORDO_ENTE) ON DELETE CASCADE;

-- changeset root:1753259446745-1057
ALTER TABLE ORG_TARIFFA_ACCORDO ADD CONSTRAINT FK_TARIFFA_ACCOR_TI_SERV FOREIGN KEY (ID_TIPO_SERVIZIO) REFERENCES ORG_TIPO_SERVIZIO (ID_TIPO_SERVIZIO);

-- changeset root:1753259446745-1058
ALTER TABLE ORG_TARIFFA ADD CONSTRAINT FK_TARIFFA_CLA_ENTE_CONVENZ FOREIGN KEY (ID_CLASSE_ENTE_CONVENZ) REFERENCES ORG_CLASSE_ENTE_CONVENZ (ID_CLASSE_ENTE_CONVENZ);

-- changeset root:1753259446745-1059
ALTER TABLE ORG_TARIFFA ADD CONSTRAINT FK_TARIFFA_ORG_TARIF FOREIGN KEY (ID_TARIFFARIO) REFERENCES ORG_TARIFFARIO (ID_TARIFFARIO) ON DELETE CASCADE;

-- changeset root:1753259446745-1060
ALTER TABLE ORG_TARIFFARIO ADD CONSTRAINT FK_TARIF_TI_ACCOR FOREIGN KEY (ID_TIPO_ACCORDO) REFERENCES ORG_TIPO_ACCORDO (ID_TIPO_ACCORDO) ON DELETE CASCADE;

-- changeset root:1753259446745-1061
ALTER TABLE USR_TIPO_DATO_IAM ADD CONSTRAINT FK_TI_DATO_CLA_TI_DATO FOREIGN KEY (ID_CLASSE_TIPO_DATO) REFERENCES APL_CLASSE_TIPO_DATO (ID_CLASSE_TIPO_DATO) ON DELETE CASCADE;

-- changeset root:1753259446745-1062
ALTER TABLE USR_TIPO_DATO_IAM ADD CONSTRAINT FK_TI_DATO_ORG_IAM FOREIGN KEY (ID_ORGANIZ_IAM) REFERENCES USR_ORGANIZ_IAM (ID_ORGANIZ_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-1063
ALTER TABLE APL_TIPO_EVENTO ADD CONSTRAINT FK_TI_EVN_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-1064
ALTER TABLE APL_TIPO_EVENTO_OGGETTO_TRIG ADD CONSTRAINT FK_TI_EVN_OGG_TRIG FOREIGN KEY (ID_TIPO_EVENTO_OGGETTO) REFERENCES APL_TIPO_EVENTO_OGGETTO (ID_TIPO_EVENTO_OGGETTO) ON DELETE CASCADE;

-- changeset root:1753259446745-1065
ALTER TABLE APL_TIPO_EVENTO_OGGETTO_TRIG ADD CONSTRAINT FK_TI_EVN_OGG_TRIG_QRY_SEL FOREIGN KEY (ID_QUERY_TIPO_OGGETTO_SEL) REFERENCES APL_QUERY_TIPO_OGGETTO (ID_QUERY_TIPO_OGGETTO);

-- changeset root:1753259446745-1066
ALTER TABLE APL_TIPO_EVENTO_OGGETTO_TRIG ADD CONSTRAINT FK_TI_EVN_OGG_TRIG_QRY_TRIG FOREIGN KEY (ID_QUERY_TIPO_OGGETTO_TRIG) REFERENCES APL_QUERY_TIPO_OGGETTO (ID_QUERY_TIPO_OGGETTO);

-- changeset root:1753259446745-1067
ALTER TABLE APL_TIPO_EVENTO_OGGETTO_TRIG ADD CONSTRAINT FK_TI_EVN_OGG_TRIG_TI_EVN FOREIGN KEY (ID_TIPO_EVENTO_TRIG) REFERENCES APL_TIPO_EVENTO (ID_TIPO_EVENTO) ON DELETE CASCADE;

-- changeset root:1753259446745-1068
ALTER TABLE APL_TIPO_EVENTO_OGGETTO_TRIG ADD CONSTRAINT FK_TI_EVN_OGG_TRIG_TI_OGG FOREIGN KEY (ID_TIPO_OGGETTO_TRIG) REFERENCES APL_TIPO_OGGETTO (ID_TIPO_OGGETTO) ON DELETE CASCADE;

-- changeset root:1753259446745-1069
ALTER TABLE APL_TIPO_EVENTO_OGGETTO ADD CONSTRAINT FK_TI_EVN_TI_OGG FOREIGN KEY (ID_TIPO_OGGETTO) REFERENCES APL_TIPO_OGGETTO (ID_TIPO_OGGETTO) ON DELETE CASCADE;

-- changeset root:1753259446745-1070
ALTER TABLE APL_TIPO_EVENTO_OGGETTO ADD CONSTRAINT FK_TI_EVN_TI_OGG_QRY_FOTO FOREIGN KEY (ID_QUERY_TIPO_OGGETTO_FOTO) REFERENCES APL_QUERY_TIPO_OGGETTO (ID_QUERY_TIPO_OGGETTO) ON DELETE CASCADE;

-- changeset root:1753259446745-1071
ALTER TABLE APL_TIPO_EVENTO_OGGETTO ADD CONSTRAINT FK_TI_EVN_TI_OGG_TI_EVN FOREIGN KEY (ID_TIPO_EVENTO) REFERENCES APL_TIPO_EVENTO (ID_TIPO_EVENTO) ON DELETE CASCADE;

-- changeset root:1753259446745-1072
ALTER TABLE APL_TIPO_OGGETTO ADD CONSTRAINT FK_TI_OGG_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-1073
ALTER TABLE APL_TIPO_OGGETTO ADD CONSTRAINT FK_TI_OGG_PADRE FOREIGN KEY (ID_TIPO_OGGETTO_PADRE) REFERENCES APL_TIPO_OGGETTO (ID_TIPO_OGGETTO);

-- changeset root:1753259446745-1074
ALTER TABLE APL_TIPO_ORGANIZ ADD CONSTRAINT FK_TI_ORG_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-1075
ALTER TABLE PRF_USO_RUOLO_APPLIC ADD CONSTRAINT FK_USO_APL_RUO FOREIGN KEY (ID_RUOLO) REFERENCES PRF_RUOLO (ID_RUOLO) ON DELETE CASCADE;

-- changeset root:1753259446745-1076
ALTER TABLE DEC_USO_MODELLO_COMUNIC ADD CONSTRAINT FK_USO_MODL_COM FOREIGN KEY (ID_MODELLO_COMUNIC) REFERENCES DEC_MODELLO_COMUNIC (ID_MODELLO_COMUNIC) ON DELETE CASCADE;

-- changeset root:1753259446745-1077
ALTER TABLE DEC_USO_MODELLO_COMUNIC ADD CONSTRAINT FK_USO_MODL_COM_AMB FOREIGN KEY (ID_AMBIENTE_ENTE_CONVENZ) REFERENCES ORG_AMBIENTE_ENTE_CONVENZ (ID_AMBIENTE_ENTE_CONVENZ) ON DELETE CASCADE;

-- changeset root:1753259446745-1078
ALTER TABLE DEC_USO_MODELLO_COMUNIC ADD CONSTRAINT FK_USO_MODL_COM_ENTE_CONVENZ FOREIGN KEY (ID_ENTE_CONVENZ) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM) ON DELETE CASCADE;

-- changeset root:1753259446745-1079
ALTER TABLE PRF_USO_RUOLO_APPLIC ADD CONSTRAINT FK_USO_RUO_APL_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC);

-- changeset root:1753259446745-1080
ALTER TABLE USR_USO_RUOLO_DICH ADD CONSTRAINT FK_USO_RUO_DICH_DICH_ABIL_ORG FOREIGN KEY (ID_DICH_ABIL_ORGANIZ) REFERENCES USR_DICH_ABIL_ORGANIZ (ID_DICH_ABIL_ORGANIZ) ON DELETE CASCADE;

-- changeset root:1753259446745-1081
ALTER TABLE USR_USO_RUOLO_DICH ADD CONSTRAINT FK_USO_RUO_DICH_ORG FOREIGN KEY (ID_ORGANIZ_IAM_RUOLO) REFERENCES USR_ORGANIZ_IAM (ID_ORGANIZ_IAM);

-- changeset root:1753259446745-1082
ALTER TABLE USR_USO_RUOLO_DICH ADD CONSTRAINT FK_USO_RUO_DICH_RUO FOREIGN KEY (ID_RUOLO) REFERENCES PRF_RUOLO (ID_RUOLO);

-- changeset root:1753259446745-1083
ALTER TABLE USR_USO_RUOLO_USER_DEFAULT ADD CONSTRAINT FK_USO_RUO_USR_DEF_RUO FOREIGN KEY (ID_RUOLO) REFERENCES PRF_RUOLO (ID_RUOLO);

-- changeset root:1753259446745-1084
ALTER TABLE USR_USO_USER_APPLIC ADD CONSTRAINT FK_USO_USR_APL_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-1085
ALTER TABLE USR_USO_USER_APPLIC ADD CONSTRAINT FK_USO_USR_APL_USR FOREIGN KEY (ID_USER_IAM) REFERENCES USR_USER (ID_USER_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-1086
ALTER TABLE USR_USO_RUOLO_USER_DEFAULT ADD CONSTRAINT FK_USO_USR_RUO_USO_USR_APL FOREIGN KEY (ID_USO_USER_APPLIC) REFERENCES USR_USO_USER_APPLIC (ID_USO_USER_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-1087
ALTER TABLE USR_USER ADD CONSTRAINT FK_USR_AGENT FOREIGN KEY (ID_AGENTE) REFERENCES LOG_AGENTE (ID_AGENTE);

-- changeset root:1753259446745-1088
ALTER TABLE LOG_USER_DA_REPLIC ADD CONSTRAINT FK_USR_DA_REPLIC_APL FOREIGN KEY (ID_APPLIC) REFERENCES APL_APPLIC (ID_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-1089
ALTER TABLE LOG_USER_DA_REPLIC ADD CONSTRAINT FK_USR_DA_REPLIC_LOG_JOB FOREIGN KEY (ID_LOG_JOB) REFERENCES LOG_JOB (ID_LOG_JOB);

-- changeset root:1753259446745-1090
ALTER TABLE USR_USER ADD CONSTRAINT FK_USR_ENTE_SIAM_APPART FOREIGN KEY (ID_ENTE_SIAM) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-1091
ALTER TABLE USR_USER ADD CONSTRAINT FK_USR_SIS_VERS FOREIGN KEY (ID_SISTEMA_VERSANTE) REFERENCES APL_SISTEMA_VERSANTE (ID_SISTEMA_VERSANTE);

-- changeset root:1753259446745-1092
ALTER TABLE USR_USER_EXT ADD CONSTRAINT FK_USR_USER_EXT FOREIGN KEY (ID_USER_IAM) REFERENCES USR_USER (ID_USER_IAM) ON DELETE CASCADE;

-- changeset root:1753259446745-1093
ALTER TABLE IAM_VALORE_PARAM_APPLIC ADD CONSTRAINT FK_VAL_PAR_APL FOREIGN KEY (ID_PARAM_APPLIC) REFERENCES IAM_PARAM_APPLIC (ID_PARAM_APPLIC) ON DELETE CASCADE;

-- changeset root:1753259446745-1094
ALTER TABLE IAM_VALORE_PARAM_APPLIC ADD CONSTRAINT FK_VAL_PAR_APL_AMB FOREIGN KEY (ID_AMBIENTE_ENTE_CONVENZ) REFERENCES ORG_AMBIENTE_ENTE_CONVENZ (ID_AMBIENTE_ENTE_CONVENZ) ON DELETE CASCADE;

-- changeset root:1753259446745-1095
ALTER TABLE IAM_VALORE_PARAM_APPLIC ADD CONSTRAINT FK_VAL_PAR_APL_ENTE_CONVENZ FOREIGN KEY (ID_ENTE_CONVENZ) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM) ON DELETE CASCADE;

-- changeset root:1753259446745-1096
ALTER TABLE ORG_GESTIONE_ACCORDO ADD CONSTRAINT FK_VAR_ACC_ENTE FOREIGN KEY (ID_ACCORDO_ENTE) REFERENCES ORG_ACCORDO_ENTE (ID_ACCORDO_ENTE) ON DELETE CASCADE;

-- changeset root:1753259446745-1097
ALTER TABLE ORG_VIGIL_ENTE_PRODUT ADD CONSTRAINT FK_VIG_ENTE_CONVENZ FOREIGN KEY (ID_ENTE_PRODUT) REFERENCES ORG_ENTE_SIAM (ID_ENTE_SIAM);

-- changeset root:1753259446745-1098
ALTER TABLE ORG_VIGIL_ENTE_PRODUT ADD CONSTRAINT FK_VIG_ENTE_PRODUT_ACC_VIG FOREIGN KEY (ID_ACCORDO_VIGIL) REFERENCES ORG_ACCORDO_VIGIL (ID_ACCORDO_VIGIL);

